<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë°˜ë³„ ê²Œì‹œíŒ - ë¸”ë¼ì¸ì‰ê¸€ë¦¬ì‰¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Pretendard Variable", -apple-system, BlinkMacSystemFont,
        system-ui, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    body {
      background: #f4f6fb;
      padding: 30px 0 60px;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .title-big {
      font-size: 34px;
      font-weight: 900;
      margin-bottom: 6px;
    }

    .subtitle {
      font-size: 16px;
      color: #6b7280;
      margin-bottom: 20px;
    }

    /* ìƒë‹¨ í•„í„° + ë²„íŠ¼ ì¤„ */
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #4b5563;
    }

    .class-select {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 14px;
      min-width: 120px;
    }

    .top-btns {
      display: flex;
      gap: 8px;
    }

    .pill-btn {
      padding: 8px 18px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-primary {
      background: #2563eb;
      color: #ffffff;
    }

    .btn-secondary {
      background: #16a34a;
      color: #ffffff;
    }

    /* ê¸€ì“°ê¸° ì¹´ë“œ */
    .write-card {
      background: #ffffff;
      border-radius: 24px;
      padding: 18px 20px 20px;
      margin-bottom: 22px;
      box-shadow: 0 15px 32px rgba(15, 23, 42, 0.08);
    }

    .write-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .write-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }

    .write-row label {
      font-size: 14px;
      color: #4b5563;
    }

    .write-input,
    .write-select {
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      min-width: 120px;
    }

    .write-textarea {
      width: 100%;
      min-height: 80px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      resize: vertical;
      margin-bottom: 10px;
    }

    .write-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-cancel {
      background: #e5e7eb;
      color: #374151;
    }

    .btn-submit {
      background: #10b981;
      color: #ffffff;
    }

    /* ê²Œì‹œê¸€ ë¦¬ìŠ¤íŠ¸ */
    .post-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 10px;
    }

    .post-card {
      background: #ffffff;
      border-radius: 20px;
      padding: 16px 18px;
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.08);
    }

    .post-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
    }

    .post-title {
      font-size: 16px;
      font-weight: 700;
      color: #111827;
    }

    .post-meta {
      font-size: 12px;
      color: #6b7280;
      text-align: right;
    }

    .post-meta span + span::before {
      content: "Â· ";
      margin: 0 2px;
    }

    .post-class-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      font-size: 12px;
      margin-bottom: 4px;
    }

    .post-type-badge {
      display: inline-flex;
      align-items: center;
      padding: 1px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin-left: 6px;
    }

    .type-post {
      background: #fee2e2;
      color: #b91c1c;
    }

    .type-vocab {
      background: #d1fae5;
      color: #047857;
    }

    .type-sentence {
      background: #e0f2fe;
      color: #0369a1;
    }

    .post-content {
      font-size: 14px;
      color: #374151;
      white-space: pre-wrap;
      margin-top: 4px;
    }

    .empty-box {
      margin-top: 30px;
      padding: 16px 18px;
      border-radius: 18px;
      background: #e5e7eb;
      font-size: 14px;
      color: #4b5563;
      text-align: center;
    }

    .status-text {
      font-size: 13px;
      color: #6b7280;
      margin-top: 6px;
    }

    .status-text.error {
      color: #b91c1c;
    }

    @media (max-width: 640px) {
      .post-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .post-meta {
        text-align: left;
      }
      .top-bar {
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>

<div class="page">
  <div class="title-big">ë°˜ë³„ ê²Œì‹œíŒ</div>
  <div class="subtitle">ë°˜ì„ ì„ íƒí•˜ê³  ê³µì§€ì™€ ìˆ™ì œë¥¼ í™•ì¸í•˜ì„¸ìš”.</div>

  <div class="top-bar">
    <div class="filter-group">
      <span>ë°˜ ì„ íƒ</span>
      <select id="classFilter" class="class-select">
        <option value="all">ì „ì²´</option>
        <!-- JSì—ì„œ classes í…Œì´ë¸”ë¡œ ì±„ì›€ -->
      </select>
    </div>

    <div class="top-btns">
      <button id="writeToggleBtn" class="pill-btn btn-primary">
        âœï¸ ê¸€ì“°ê¸°
      </button>
      <button id="onlineHwBtn" class="pill-btn btn-secondary">
        ğŸ“š ì˜¨ë¼ì¸ ìˆ™ì œ
      </button>
    </div>
  </div>

  <!-- ê¸€ì“°ê¸° í¼ (ì„ ìƒë‹˜ë§Œ ë³´ì„) -->
  <div id="writeBox" class="write-card" style="display:none;">
    <div class="write-title">ìƒˆ ê¸€ ì“°ê¸°</div>

    <div class="write-row">
      <div>
        <label>ë°˜ ì„ íƒ</label><br />
        <select id="writeClass" class="write-select">
          <!-- JSì—ì„œ classes í…Œì´ë¸”ë¡œ ì±„ì›€ -->
        </select>
      </div>
      <div>
        <label>ì‘ì„±ì</label><br />
        <input id="writeAuthor" class="write-input" placeholder="ì˜ˆ: StellaìŒ¤" />
      </div>
      <div style="flex:1; min-width:180px;">
        <label>ì œëª©</label><br />
        <input id="writeTitle" class="write-input" style="width:100%;" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”." />
      </div>
    </div>

    <textarea id="writeContent" class="write-textarea" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. (ë¬¸ì œì§‘ ìˆ™ì œ, ê³µì§€ ë“±)"></textarea>

    <div class="write-actions">
      <button class="btn btn-cancel" id="cancelWriteBtn">ì·¨ì†Œ</button>
      <button class="btn btn-submit" id="submitWriteBtn">ë“±ë¡</button>
    </div>

    <div id="writeStatus" class="status-text"></div>
  </div>

  <!-- ê²Œì‹œê¸€ + ì˜¨ë¼ì¸ ìˆ™ì œ ë¦¬ìŠ¤íŠ¸ -->
  <div id="postList" class="post-list"></div>
  <div id="emptyBox" class="empty-box" style="display:none;">
    ì„ íƒëœ ë°˜ì— ë“±ë¡ëœ ê¸€ì´ ì•„ì§ ì—†ì–´ìš”.
  </div>
</div>

<!-- Supabase JS -->
<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
<script>
  const SUPABASE_URL = "https://bpdisxjhhibrgfpvtlmv.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZGlzeGpoaGlicmdmcHZ0bG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTkxODQsImV4cCI6MjA3OTUzNTE4NH0.jDZ6BGirOPuWUnt4ykjhng4PLft2ZjBuYAFzApUnlYU";

  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // DOM
  const classFilterEl  = document.getElementById("classFilter");
  const writeToggleBtn = document.getElementById("writeToggleBtn");
  const onlineHwBtn    = document.getElementById("onlineHwBtn");

  const writeBoxEl     = document.getElementById("writeBox");
  const writeClassEl   = document.getElementById("writeClass");
  const writeAuthorEl  = document.getElementById("writeAuthor");
  const writeTitleEl   = document.getElementById("writeTitle");
  const writeContentEl = document.getElementById("writeContent");
  const cancelWriteBtn = document.getElementById("cancelWriteBtn");
  const submitWriteBtn = document.getElementById("submitWriteBtn");
  const writeStatusEl  = document.getElementById("writeStatus");

  const postListEl     = document.getElementById("postList");
  const emptyBoxEl     = document.getElementById("emptyBox");

  // ìƒíƒœ
  let classes = [];     // [{id, name}, ...]
  let items   = [];     // ê²Œì‹œê¸€ + ì˜¨ë¼ì¸ ìˆ™ì œ
  let currentRole = "guest";  // "teacher" | "student" | "guest"
  let currentUserName = "";

  function setWriteStatus(msg, isError = false) {
    writeStatusEl.textContent = msg || "";
    writeStatusEl.classList.toggle("error", !!isError);
  }

  // --- ì—­í•  ê°ì§€ (ì„ ìƒë‹˜/í•™ìƒ/ê²ŒìŠ¤íŠ¸) ---
  async function detectRole() {
    try {
      const { data, error } = await client.auth.getUser();
      if (!error && data && data.user) {
        currentRole = "teacher";
        currentUserName =
          (data.user.user_metadata && data.user.user_metadata.display_name) ||
          data.user.email ||
          "ì„ ìƒë‹˜";
        applyRoleUI();
        return;
      }
    } catch (e) {
      console.error("auth í™•ì¸ ì¤‘ ì˜¤ë¥˜:", e);
    }

    // í•™ìƒ ë¡œê·¸ì¸ ì •ë³´(localStorage)ì— ë”°ë¼ student/guest íŒë‹¨ (ìˆìœ¼ë©´ student)
    try {
      const raw = localStorage.getItem("blossom_student");
      if (raw) {
        const s = JSON.parse(raw);
        currentRole = "student";
        currentUserName = s.name || s.login_id || "í•™ìƒ";
      } else {
        currentRole = "guest";
        currentUserName = "";
      }
    } catch (e) {
      currentRole = "guest";
      currentUserName = "";
    }
    applyRoleUI();
  }

  function applyRoleUI() {
    const isTeacher = currentRole === "teacher";
    writeToggleBtn.style.display = isTeacher ? "inline-flex" : "none";
    if (!isTeacher) {
      writeBoxEl.style.display = "none";
    }
  }

  // --- ë°˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ---
  async function loadClasses() {
    const { data, error } = await client
      .from("classes")
      .select("id, name")
      .order("name", { ascending: true });

    if (error) {
      console.error("classes ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
      return;
    }

    classes = data || [];

    // ìƒë‹¨ í•„í„° select ì±„ìš°ê¸°
    classFilterEl.innerHTML = '<option value="all">ì „ì²´</option>';
    classes.forEach(cls => {
      const opt = document.createElement("option");
      opt.value = cls.id;     // idë¡œ í•„í„°
      opt.textContent = cls.name;
      classFilterEl.appendChild(opt);
    });

    // ê¸€ì“°ê¸°ìš© ë°˜ ì„ íƒ
    writeClassEl.innerHTML = "";
    classes.forEach(cls => {
      const opt = document.createElement("option");
      opt.value = cls.id;
      opt.textContent = cls.name;
      writeClassEl.appendChild(opt);
    });
  }

  function getClassNameById(id) {
    const found = classes.find(c => String(c.id) === String(id));
    return found ? found.name : "";
  }

  function formatDate(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return "";
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    return `${y}-${m}-${day} ${hh}:${mm}`;
  }

  // --- ê²Œì‹œê¸€ + ì˜¨ë¼ì¸ ìˆ™ì œ ë¶ˆëŸ¬ì˜¤ê¸° ---
  async function loadItems() {
    // board_posts, vocab_homework, sentence_homework í•œ ë²ˆì— ê°€ì ¸ì˜¤ê¸°
    const [postsRes, vocabRes, sentenceRes] = await Promise.all([
      client.from("board_posts").select("*").order("created_at", { ascending: false }),
      client.from("vocab_homework").select("*").order("created_at", { ascending: false }),
      client.from("sentence_homework").select("*").order("created_at", { ascending: false }),
    ]);

    if (postsRes.error) {
      console.error("board_posts ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", postsRes.error);
    }
    if (vocabRes.error) {
      console.error("vocab_homework ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", vocabRes.error);
    }
    if (sentenceRes.error) {
      console.error("sentence_homework ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", sentenceRes.error);
    }

    const all = [];

    // ì¼ë°˜ ê²Œì‹œê¸€ (ë¬¸ì œì§‘ ìˆ™ì œ/ê³µì§€)
    (postsRes.data || []).forEach(row => {
      all.push({
        type: "post",
        id: row.id,
        class_id: row.class_id,
        class_name: getClassNameById(row.class_id),
        title: row.title || "(ì œëª© ì—†ìŒ)",
        content: row.content || "",
        author: row.author || "ì„ ìƒë‹˜",
        created_at: row.created_at || row.createdAt || new Date().toISOString(),
      });
    });

    // ì˜¨ë¼ì¸ ì–´íœ˜ ìˆ™ì œ
    (vocabRes.data || []).forEach(row => {
      const className = getClassNameById(row.class_id);
      const level = row.level != null ? row.level : "";
      const sets = row.set_numbers || "";
      const due = row.due_date ? `ë§ˆê°ì¼: ${row.due_date}` : "ë§ˆê°ì¼ ì—†ìŒ";
      all.push({
        type: "vocab",
        id: `vocab_${row.id}`,
        class_id: row.class_id,
        class_name: className,
        title: "ì˜¨ë¼ì¸ ì–´íœ˜ ìˆ™ì œ",
        content: `ë‹¨ê³„ ${level} / ì„¸íŠ¸ ${sets}\n${due}`,
        author: "ì˜¨ë¼ì¸ ìˆ™ì œ",
        created_at: row.created_at || new Date().toISOString(),
      });
    });

    // ì˜¨ë¼ì¸ ë¬¸ì¥ ìˆ™ì œ
    (sentenceRes.data || []).forEach(row => {
      const className = getClassNameById(row.class_id);
      const level = row.level != null ? row.level : "";
      const sets = row.set_numbers || "";
      const due = row.due_date ? `ë§ˆê°ì¼: ${row.due_date}` : "ë§ˆê°ì¼ ì—†ìŒ";
      all.push({
        type: "sentence",
        id: `sentence_${row.id}`,
        class_id: row.class_id,
        class_name: className,
        title: "ì˜¨ë¼ì¸ ë¬¸ì¥ ìˆ™ì œ",
        content: `ë‹¨ê³„ ${level} / ì„¸íŠ¸ ${sets}\n${due}`,
        author: "ì˜¨ë¼ì¸ ìˆ™ì œ",
        created_at: row.created_at || new Date().toISOString(),
      });
    });

    // ë‚ ì§œ ê¸°ì¤€ ìµœì‹ ìˆœ ì •ë ¬
    all.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

    items = all;
    renderItems();
  }

  // --- í™”ë©´ì— ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ ---
  function renderItems() {
    const selected = classFilterEl.value;  // "all" ë˜ëŠ” class_id
    postListEl.innerHTML = "";

    const filtered =
      selected === "all"
        ? items.slice()
        : items.filter(it => String(it.class_id) === String(selected));

    if (!filtered.length) {
      emptyBoxEl.style.display = "block";
      return;
    }
    emptyBoxEl.style.display = "none";

    filtered.forEach(p => {
      const card = document.createElement("div");
      card.className = "post-card";

      const header = document.createElement("div");
      header.className = "post-header";

      const left = document.createElement("div");
      const badge = document.createElement("div");
      badge.className = "post-class-badge";
      badge.textContent = p.class_name || "ì „ì²´";

      const typeBadge = document.createElement("span");
      typeBadge.className = "post-type-badge " +
        (p.type === "post"
          ? "type-post"
          : p.type === "vocab"
          ? "type-vocab"
          : "type-sentence");
      typeBadge.textContent =
        p.type === "post"
          ? "ê³µì§€/ìˆ™ì œ"
          : p.type === "vocab"
          ? "ì˜¨ë¼ì¸ ì–´íœ˜"
          : "ì˜¨ë¼ì¸ ë¬¸ì¥";

      const titleEl = document.createElement("div");
      titleEl.className = "post-title";
      titleEl.textContent = p.title;

      left.appendChild(badge);
      left.appendChild(typeBadge);
      left.appendChild(titleEl);

      const meta = document.createElement("div");
      meta.className = "post-meta";
      meta.innerHTML = `
        <span>${p.author || "ì„ ìƒë‹˜"}</span>
        <span>${formatDate(p.created_at)}</span>
      `;

      header.appendChild(left);
      header.appendChild(meta);

      const body = document.createElement("div");
      body.className = "post-content";
      body.textContent = p.content;

      card.appendChild(header);
      card.appendChild(body);

      postListEl.appendChild(card);
    });
  }

  // --- ê¸€ì“°ê¸° ë²„íŠ¼ ë™ì‘ ---
  writeToggleBtn.onclick = () => {
    if (currentRole !== "teacher") {
      alert("ì„ ìƒë‹˜ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì•¼ ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆì–´ìš”.");
      return;
    }
    const visible = writeBoxEl.style.display !== "none";
    writeBoxEl.style.display = visible ? "none" : "block";
    if (!visible) {
      writeTitleEl.value = "";
      writeContentEl.value = "";
      writeAuthorEl.value = currentUserName || "";
      setWriteStatus("");
    }
  };

  cancelWriteBtn.onclick = () => {
    writeBoxEl.style.display = "none";
    setWriteStatus("");
  };

  submitWriteBtn.onclick = async () => {
    if (currentRole !== "teacher") {
      alert("ì„ ìƒë‹˜ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì•¼ ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆì–´ìš”.");
      return;
    }

    const classId = writeClassEl.value;
    const author  = writeAuthorEl.value.trim() || currentUserName || "ì„ ìƒë‹˜";
    const title   = writeTitleEl.value.trim();
    const content = writeContentEl.value.trim();

    if (!classId) {
      setWriteStatus("ë°˜ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.", true);
      return;
    }
    if (!title || !content) {
      setWriteStatus("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.", true);
      return;
    }

    setWriteStatus("ì €ì¥ ì¤‘ì…ë‹ˆë‹¤â€¦");
    submitWriteBtn.disabled = true;

    const { error } = await client.from("board_posts").insert({
      class_id: classId,
      title,
      content,
      author,
    });

    submitWriteBtn.disabled = false;

    if (error) {
      console.error("ê²Œì‹œê¸€ ì €ì¥ ì˜¤ë¥˜:", error);
      setWriteStatus("ê¸€ì„ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", true);
      return;
    }

    setWriteStatus("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
    writeBoxEl.style.display = "none";

    // ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨
    await loadItems();
  };

  // ì˜¨ë¼ì¸ ìˆ™ì œ ë²„íŠ¼ â†’ homework-teacher.html ë¡œ ì´ë™
  onlineHwBtn.onclick = () => {
    // board.htmlê³¼ ê°™ì€ í´ë”ì— ìˆë‹¤ê³  ê°€ì •
    window.location.href = "homework-teacher.html";
  };

  // ë°˜ í•„í„° ë³€ê²½ ì‹œ
  classFilterEl.onchange = renderItems;

  // ì´ˆê¸° ì‹¤í–‰
  (async function init() {
    await detectRole();
    await loadClasses();
    await loadItems();
  })();
</script>

</body>
</html>