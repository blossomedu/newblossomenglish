<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>반별 게시판 - 블라썸잉글리쉬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Pretendard Variable", -apple-system, BlinkMacSystemFont,
        system-ui, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    body {
      background: #f4f6fb;
      padding: 30px 0 60px;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .title-big {
      font-size: 34px;
      font-weight: 900;
      margin-bottom: 6px;
    }

    .subtitle {
      font-size: 16px;
      color: #6b7280;
      margin-bottom: 20px;
    }

    /* 상단 선택 + 버튼 */
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #4b5563;
    }

    .class-select {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 14px;
      min-width: 120px;
    }

    .top-btns {
      display: flex;
      gap: 8px;
    }

    .pill-btn {
      padding: 8px 18px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    /* 글쓰기 = 민트 */
    .btn-primary {
      background: #9FE6B8;
      color: #ffffff;
    }

    /* 온라인 숙제 = 블루 */
    .btn-secondary {
      background: #00AEEF;
      color: #ffffff;
    }

    /* 관리 버튼 = 핑크 */
    .btn-manage {
      background: #FF6FB5;
      color: #ffffff;
    }

    /* 글쓰기 카드 */
    .write-card {
      background: #ffffff;
      border-radius: 24px;
      padding: 18px 20px 20px;
      margin-bottom: 22px;
      box-shadow: 0 15px 32px rgba(15, 23, 42, 0.08);
    }

    .write-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .write-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }

    .write-input,
    .write-select {
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      min-width: 120px;
    }

    .write-textarea {
      width: 100%;
      min-height: 80px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      resize: vertical;
      margin-bottom: 10px;
    }

    .write-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* 게시글 카드 */
    .post-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 10px;
    }

    .post-card {
      background: #ffffff;
      border-radius: 20px;
      padding: 16px 18px;
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.08);
    }

    .post-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
    }

    .post-title {
      font-size: 18px;
      font-weight: 800;
      color: #111827;
    }

    .post-class-badge {
      padding: 2px 10px;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      font-size: 12px;
      margin-bottom: 4px;
    }

    .post-type-badge {
      padding: 1px 8px;
      border-radius: 999px;
      background: #FFE5F3;
      color: #FF6FB5;
      font-size: 11px;
      margin-left: 6px;
    }

    .post-section-label {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .sec-offline { background: #FFE5F3; color: #FF6FB5; }
    .sec-vocab   { background: #d1fae5; color: #047857; }
    .sec-sentence{ background: #e0f2fe; color: #0369a1; }

    .post-content {
      font-size: 14px;
      margin-bottom: 10px;
      white-space: pre-wrap;
      color: #374151;
    }

    .empty-box {
      margin-top: 30px;
      padding: 16px 18px;
      border-radius: 18px;
      background: #e5e7eb;
      font-size: 14px;
      color: #4b5563;
      text-align: center;
    }

    /* 수정 / 삭제 버튼 */
    .post-actions {
      margin-top: 4px;
      display: flex;
      gap: 4px;
      font-size: 11px;
    }
    .post-action-btn {
      padding: 3px 8px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }
    .post-action-edit {
      background: #e0f2fe;
      color: #0369a1;
    }
    .post-action-delete {
      background: #fee2e2;
      color: #b91c1c;
    }

  </style>
</head>
<body>

  <!-- 글쓰기 박스 (선생님만 보임) -->
<div id="writeBox" class="write-card" style="display:none;">
  <div class="write-title" id="writeBoxTitle">새 글 쓰기</div>

  <div class="write-row">
    <div>
      <label>반 선택</label><br />
      <select id="writeClass" class="write-select"></select>
    </div>
    <div>
      <label>작성자</label><br />
      <input id="writeAuthor" class="write-input" placeholder="예: Stella쌤" />
    </div>
    <div style="flex:1; min-width:180px;">
      <label>제목</label><br />
      <input id="writeTitle" class="write-input" style="width:100%;" placeholder="예: 2025-10-25 숙제" />
    </div>
  </div>

  <textarea id="writeContent" class="write-textarea"
    placeholder="내용을 입력하세요. (문법/듣기/독해 숙제, 공지 등)"></textarea>

  <div class="write-actions">
    <button class="btn btn-cancel" id="cancelWriteBtn">취소</button>
    <button class="btn btn-submit" id="submitWriteBtn">등록</button>
  </div>

  <div id="writeStatus" class="status-text"></div>
</div>

  <script>
// 수정 중인지 상태 저장
let editingPostId = null;

// 글쓰기 토글
writeToggleBtn.onclick = () => {
  if (currentRole !== "teacher") {
    alert("선생님 계정으로 로그인해야 글을 작성할 수 있어요.");
    return;
  }

  const visible = writeBoxEl.style.display !== "none";

  if (visible) {
    // 닫힘
    writeBoxEl.style.display = "none";
    editingPostId = null;
    writeBoxTitle.textContent = "새 글 쓰기";
    submitWriteBtn.textContent = "등록";
  } else {
    // 새 글쓰기 모드
    writeBoxEl.style.display = "block";
    writeBoxTitle.textContent = "새 글 쓰기";
    submitWriteBtn.textContent = "등록";
    editingPostId = null;

    writeTitleEl.value = "";
    writeContentEl.value = "";
    writeAuthorEl.value = currentUserName || DEFAULT_AUTHOR_LABEL;
    setWriteStatus("");
  }
};

// 글 등록 or 수정
submitWriteBtn.onclick = async () => {
  if (currentRole !== "teacher") return;

  const classId = writeClassEl.value;
  const title = writeTitleEl.value.trim();
  const content = writeContentEl.value.trim();

  if (!classId || !title || !content) {
    setWriteStatus("모든 내용을 입력해 주세요.", true);
    return;
  }

  setWriteStatus("저장 중…");
  submitWriteBtn.disabled = true;

  if (editingPostId) {
    // ✏️ 수정 모드
    const { error } = await client
      .from("board_posts")
      .update({ title, content })
      .eq("id", editingPostId);

    submitWriteBtn.disabled = false;

    if (error) {
      setWriteStatus("수정 중 오류 발생", true);
      return;
    }

    setWriteStatus("수정되었습니다!");
  } else {
    // ➕ 새 글 등록
    const now = new Date().toISOString();
    const { error } = await client.from("board_posts").insert({
      class_id: classId,
      title,
      content,
      author_id: currentUserId,
      created_at: now
    });

    submitWriteBtn.disabled = false;

    if (error) {
      setWriteStatus("저장 중 오류 발생", true);
      return;
    }

    setWriteStatus("등록되었습니다!");
  }

  writeBoxEl.style.display = "none";
  editingPostId = null;
  await loadGroups();
};

// 취소 버튼
cancelWriteBtn.onclick = () => {
  writeBoxEl.style.display = "none";
  editingPostId = null;
  setWriteStatus("");
};

// 삭제 기능
async function deletePost(postId) {
  if (!confirm("정말 삭제할까요?")) return;

  const { error } = await client.from("board_posts").delete().eq("id", postId);

  if (error) {
    alert("삭제 중 오류 발생!");
    return;
  }

  await loadGroups();
}

// 수정모드 진입
function editPost(post) {
  editingPostId = post.id;

  writeBoxEl.style.display = "block";
  writeBoxTitle.textContent = "글 수정하기";
  submitWriteBtn.textContent = "수정";

  writeClassEl.value = post.class_id;
  writeTitleEl.value = post.title;
  writeContentEl.value = post.content;

  writeAuthorEl.value = currentUserName || DEFAULT_AUTHOR_LABEL;
}
</script>

  // 수정/삭제 버튼 (선생님만)
if (currentRole === "teacher") {
  const editRow = document.createElement("div");
  editRow.style.marginTop = "6px";
  editRow.style.display = "flex";
  editRow.style.gap = "8px";

  const editBtn = document.createElement("button");
  editBtn.textContent = "수정";
  editBtn.style.padding = "4px 10px";
  editBtn.style.fontSize = "12px";
  editBtn.style.borderRadius = "8px";
  editBtn.style.border = "none";
  editBtn.style.background = "#f9c74f";
  editBtn.style.color = "#fff";
  editBtn.onclick = () => editPost({
    id: p.id,
    title: p.title,
    content: p.content,
    class_id: g.class_id
  });

  const delBtn = document.createElement("button");
  delBtn.textContent = "삭제";
  delBtn.style.padding = "4px 10px";
  delBtn.style.fontSize = "12px";
  delBtn.style.borderRadius = "8px";
  delBtn.style.border = "none";
  delBtn.style.background = "#f94144";
  delBtn.style.color = "#fff";
  delBtn.onclick = () => deletePost(p.id);

  editRow.appendChild(editBtn);
  editRow.appendChild(delBtn);
  body.appendChild(editRow);
}
  
