<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë°˜ë³„ ê²Œì‹œíŒ - ë¸”ë¼ì¸ì‰ê¸€ë¦¬ì‰¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Pretendard Variable", -apple-system, BlinkMacSystemFont,
        system-ui, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    body {
      background: #f4f6fb;
      padding: 30px 0 60px;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .title-big {
      font-size: 34px;
      font-weight: 900;
      margin-bottom: 6px;
    }

    .subtitle {
      font-size: 16px;
      color: #6b7280;
      margin-bottom: 20px;
    }

    /* ìƒë‹¨ í•„í„° + ë²„íŠ¼ ì¤„ */
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #4b5563;
    }

    .class-select {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 14px;
      min-width: 120px;
    }

    .top-btns {
      display: flex;
      gap: 8px;
    }

    .pill-btn {
      padding: 8px 18px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      transition: opacity 0.2s;
    }
    .pill-btn:hover {
        opacity: 0.9;
    }

    /* 0. í™ˆ ë²„íŠ¼ (ë„¤ë¹„ê²Œì´ì…˜ìš© íšŒìƒ‰) [ì¶”ê°€ë¨] */
    .btn-home {
      background: #e5e7eb; /* ì—°í•œ íšŒìƒ‰ */
      color: #374151;      /* ì§„í•œ ê¸€ììƒ‰ */
      font-weight: 600;
    }

    /* 1. ê¸€ì“°ê¸° = ë¯¼íŠ¸ */
    .btn-primary {
      background: #9fe6b8;
      color: #ffffff;
    }

    /* 2. ì˜¨ë¼ì¸ ìˆ™ì œ = ë¸”ë£¨ */
    .btn-secondary {
      background: #00aeef;
      color: #ffffff;
    }

    /* 3. ê´€ë¦¬ = í•‘í¬ */
    .btn-manage {
      background: #ff6fb5;
      color: #ffffff;
    }

    /* ê¸€ì“°ê¸° ì¹´ë“œ */
    .write-card {
      background: #ffffff;
      border-radius: 24px;
      padding: 18px 20px 20px;
      margin-bottom: 22px;
      box-shadow: 0 15px 32px rgba(15, 23, 42, 0.08);
    }

    .write-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .write-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }

    .write-row label {
      font-size: 14px;
      color: #4b5563;
    }

    .write-input,
    .write-select {
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      min-width: 120px;
    }

    .write-textarea {
      width: 100%;
      min-height: 80px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      resize: vertical;
      margin-bottom: 10px;
    }

    .write-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-cancel {
      background: #e5e7eb;
      color: #374151;
    }

    .btn-submit {
      background: #10b981;
      color: #ffffff;
    }

    /* ê²Œì‹œê¸€ ë¦¬ìŠ¤íŠ¸ */
    .post-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 10px;
    }

    .post-card {
      background: #ffffff;
      border-radius: 20px;
      padding: 16px 18px;
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.08);
    }

    .post-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
    }

    .post-title {
      font-size: 18px;
      font-weight: 800;
      color: #111827;
    }

    .post-meta {
      font-size: 12px;
      color: #6b7280;
      text-align: right;
    }

    .post-meta span + span::before {
      content: "Â· ";
      margin: 0 2px;
    }

    .post-class-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      font-size: 12px;
      margin-bottom: 4px;
    }

    /* íƒ€ì… ë±ƒì§€ = í•‘í¬ */
    .post-type-badge {
      display: inline-flex;
      align-items: center;
      padding: 1px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin-left: 6px;
      background: #ffe5f3;
      color: #ff6fb5;
    }

    .post-section-label {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin-bottom: 4px;
    }

    /* í•„ê¸° = í•‘í¬ */
    .sec-offline {
      background: #ffe5f3;
      color: #ff6fb5;
    }

    /* ì–´íœ˜ = ë¯¼íŠ¸ */
    .sec-vocab {
      background: #d1fae5;
      color: #047857;
    }

    /* ë¬¸ì¥ = ë¸”ë£¨ */
    .sec-sentence {
      background: #e0f2fe;
      color: #0369a1;
    }

    .post-content {
      font-size: 14px;
      color: #374151;
      white-space: pre-wrap;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .empty-box {
      margin-top: 30px;
      padding: 16px 18px;
      border-radius: 18px;
      background: #e5e7eb;
      font-size: 14px;
      color: #4b5563;
      text-align: center;
    }

    .status-text {
      font-size: 13px;
      color: #6b7280;
      margin-top: 6px;
    }

    .status-text.error {
      color: #b91c1c;
    }

    /* í•„ê¸°/ì˜¨ë¼ì¸ ìˆ™ì œìš© ì‘ì€ ì•¡ì…˜ ë²„íŠ¼ */
    .action-bar {
      margin-top: 4px;
    }

    .action-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      margin-right: 4px;
      border-radius: 999px;
      border: none;
      font-size: 11px;
      cursor: pointer;
      white-space: nowrap;
    }

    .action-edit {
      background: #fee2e2;
      color: #b91c1c;
    }

    .action-delete {
      background: #e5e7eb;
      color: #374151;
    }

    /* ì˜¨ë¼ì¸ ìˆ™ì œìš© ë²„íŠ¼ì€ ì˜¤ë¥¸ìª½ì— ë¶™ë„ë¡ */
    .hw-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    @media (max-width: 640px) {
      .post-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .post-meta {
        text-align: left;
      }
      .top-bar {
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>

<div class="page">
  <div class="title-big">ë°˜ë³„ ê²Œì‹œíŒ</div>
  <div class="subtitle">ë°˜ì„ ì„ íƒí•˜ê³  ê³µì§€ì™€ ìˆ™ì œë¥¼ í™•ì¸í•˜ì„¸ìš”.</div>

  <div class="top-bar">
    <div class="filter-group">
      <span>ë°˜ ì„ íƒ</span>
      <select id="classFilter" class="class-select">
        <option value="all">ì „ì²´</option>
      </select>
    </div>

    <div class="top-btns">
      <button id="homeBtn" class="pill-btn btn-home" onclick="location.href='index.html'">
        ğŸ  í™ˆ
      </button>

      <button id="writeToggleBtn" class="pill-btn btn-primary">
        âœï¸ ê¸€ì“°ê¸°
      </button>
      <button id="onlineHwBtn" class="pill-btn btn-secondary">
        ğŸ“š ì˜¨ë¼ì¸ ìˆ™ì œ
      </button>
      <button id="manageBtn" class="pill-btn btn-manage">
        ğŸ›  ê´€ë¦¬
      </button>
    </div>
  </div>

  <div id="writeBox" class="write-card" style="display:none;">
    <div class="write-title" id="writeTitleLabel">ìƒˆ ê¸€ ì“°ê¸°</div>

    <div class="write-row">
      <div>
        <label>ë°˜ ì„ íƒ</label><br />
        <select id="writeClass" class="write-select"></select>
      </div>
      <div>
        <label>ì‘ì„±ì</label><br />
        <input id="writeAuthor" class="write-input" placeholder="ì˜ˆ: StellaìŒ¤" />
      </div>
      <div style="flex:1; min-width:180px;">
        <label>ì œëª©</label><br />
        <input id="writeTitle" class="write-input" style="width:100%;" placeholder="ì˜ˆ: 2025-10-25 ìˆ™ì œ" />
      </div>
    </div>

    <textarea id="writeContent" class="write-textarea" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. (ë¬¸ë²•/ë“£ê¸°/ë…í•´ ìˆ™ì œ, ê³µì§€ ë“±)"></textarea>

    <div class="write-actions">
      <button class="btn btn-cancel" id="cancelWriteBtn">ì·¨ì†Œ</button>
      <button class="btn btn-submit" id="submitWriteBtn">ë“±ë¡</button>
    </div>

    <div id="writeStatus" class="status-text"></div>
  </div>

  <div id="postList" class="post-list"></div>
  <div id="emptyBox" class="empty-box" style="display:none;">
    ì„ íƒëœ ë°˜ì— ë“±ë¡ëœ ê¸€ì´ ì•„ì§ ì—†ì–´ìš”.
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
<script>
  const SUPABASE_URL = "https://bpdisxjhhibrgfpvtlmv.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZGlzeGpoaGlicmdmcHZ0bG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTkxODQsImV4cCI6MjA3OTUzNTE4NH0.jDZ6BGirOPuWUnt4ykjhng4PLft2ZjBuYAFzApUnlYU";

  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const DEFAULT_AUTHOR_LABEL = "StellaìŒ¤";

  // DOM
  const classFilterEl   = document.getElementById("classFilter");
  const writeToggleBtn = document.getElementById("writeToggleBtn");
  const onlineHwBtn     = document.getElementById("onlineHwBtn");
  const manageBtn       = document.getElementById("manageBtn");
  // í™ˆ ë²„íŠ¼ì€ onclickì´ HTMLì— ìˆì–´ì„œ ë³„ë„ ë³€ìˆ˜ í•„ìš” ì—†ìŒ

  const writeBoxEl       = document.getElementById("writeBox");
  const writeTitleLabelEl = document.getElementById("writeTitleLabel");
  const writeClassEl     = document.getElementById("writeClass");
  const writeAuthorEl    = document.getElementById("writeAuthor");
  const writeTitleEl     = document.getElementById("writeTitle");
  const writeContentEl = document.getElementById("writeContent");
  const cancelWriteBtn = document.getElementById("cancelWriteBtn");
  const submitWriteBtn = document.getElementById("submitWriteBtn");
  const writeStatusEl    = document.getElementById("writeStatus");

  const postListEl       = document.getElementById("postList");
  const emptyBoxEl       = document.getElementById("emptyBox");

  // ìƒíƒœ
  let classes = [];           // [{id, name}, ...]
  let groups = [];            // ë‚ ì§œ+ë°˜ìœ¼ë¡œ ë¬¶ì€ ìˆ™ì œë“¤
  let currentRole = "guest"; // "teacher" | "student" | "guest"
  let currentUserName = "";
  let currentUserId = null;

  // ê¸€ ìˆ˜ì • ëª¨ë“œ
  let editingPostId = null;       // null ì´ë©´ ìƒˆ ê¸€, ì•„ë‹ˆë©´ board_posts ì˜ id

  function setWriteStatus(msg, isError = false) {
    writeStatusEl.textContent = msg || "";
    writeStatusEl.classList.toggle("error", !!isError);
  }

  // --- ì—­í•  ê°ì§€ (ì„ ìƒë‹˜/í•™ìƒ/ê²ŒìŠ¤íŠ¸) ---
  async function detectRole() {
    try {
      const { data, error } = await client.auth.getUser();
      if (!error && data && data.user) {
        currentRole = "teacher";
        currentUserId = data.user.id;
        currentUserName =
          (data.user.user_metadata && data.user.user_metadata.display_name) ||
          data.user.email ||
          DEFAULT_AUTHOR_LABEL;
        applyRoleUI();
        return;
      }
    } catch (e) {
      console.error("auth í™•ì¸ ì¤‘ ì˜¤ë¥˜:", e);
    }

    // í•™ìƒ(localStorage) í™•ì¸
    try {
      const raw = localStorage.getItem("blossom_student");
      if (raw) {
        const s = JSON.parse(raw);
        currentRole = "student";
        currentUserName = s.name || s.login_id || "í•™ìƒ";
      } else {
        currentRole = "guest";
        currentUserName = "";
      }
    } catch (e) {
      currentRole = "guest";
      currentUserName = "";
    }
    applyRoleUI();
  }

  function applyRoleUI() {
    const isTeacher = currentRole === "teacher";
    writeToggleBtn.style.display = isTeacher ? "inline-flex" : "none";
    onlineHwBtn.style.display = isTeacher ? "inline-flex" : "none";
    manageBtn.style.display = isTeacher ? "inline-flex" : "none";
    if (!isTeacher) {
      writeBoxEl.style.display = "none";
    }
  }

  // --- ë°˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ---
  async function loadClasses() {
    const { data, error } = await client
      .from("classes")
      .select("id, name")
      .order("name", { ascending: true });

    if (error) {
      console.error("classes ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
      return;
    }

    classes = data || [];

    // ìƒë‹¨ í•„í„°
    classFilterEl.innerHTML = '<option value="all">ì „ì²´</option>';
    classes.forEach(cls => {
      const opt = document.createElement("option");
      opt.value = cls.id;
      opt.textContent = cls.name;
      classFilterEl.appendChild(opt);
    });

    // ê¸€ì“°ê¸°ìš© ë°˜ ì„ íƒ
    writeClassEl.innerHTML = "";
    classes.forEach(cls => {
      const opt = document.createElement("option");
      opt.value = cls.id;
      opt.textContent = cls.name;
      writeClassEl.appendChild(opt);
    });
  }

  function getClassNameById(id) {
    const found = classes.find(c => String(c.id) === String(id));
    return found ? found.name : "";
  }

  function formatDateTime(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return "";
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    return `${y}-${m}-${day} ${hh}:${mm}`;
  }

  function toDateKeyFromISO(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return "";
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function dateKeyFromTitle(title) {
    if (!title) return "";
    const trimmed = title.trim();
    // 2025-10-25 í˜•íƒœë§Œ ì¸ì‹
    const m = trimmed.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (m) return `${m[1]}-${m[2]}-${m[3]}`;
    return "";
  }

  // --- board_posts + ì˜¨ë¼ì¸ ìˆ™ì œ ë¶ˆëŸ¬ì™€ì„œ ë‚ ì§œ+ë°˜ìœ¼ë¡œ ë¬¶ê¸° ---
  async function loadGroups() {
    const [postsRes, vocabRes, sentenceRes] = await Promise.all([
      client.from("board_posts")
        .select("id, class_id, title, content, created_at")
        .order("created_at", { ascending: false }),
      client.from("vocab_homework")
        .select("*")
        .order("created_at", { ascending: false }),
      client.from("sentence_homework")
        .select("*")
        .order("created_at", { ascending: false }),
    ]);

    if (postsRes.error) {
      console.error("board_posts ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", postsRes.error);
    }
    if (vocabRes.error) {
      console.error("vocab_homework ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", vocabRes.error);
    }
    if (sentenceRes.error) {
      console.error("sentence_homework ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", sentenceRes.error);
    }

    const map = {}; // key = class_id + '__' + dateKey

    function ensureGroup(class_id, dateKey, created_at) {
      const key = `${class_id}__${dateKey}`;
      if (!map[key]) {
        map[key] = {
          key,
          class_id,
          class_name: getClassNameById(class_id),
          dateKey,
          latestTime: created_at || null,
          posts: [],
          vocab: [],
          sentence: []
        };
      } else if (created_at) {
        if (!map[key].latestTime || new Date(created_at) > new Date(map[key].latestTime)) {
          map[key].latestTime = created_at;
        }
      }
      return map[key];
    }

    // í•„ê¸°(ê²Œì‹œíŒ) ê¸€
    (postsRes.data || []).forEach(row => {
      const titleDate = dateKeyFromTitle(row.title);
      const dateKey = titleDate || toDateKeyFromISO(row.created_at);
      if (!dateKey) return;

      const g = ensureGroup(row.class_id, dateKey, row.created_at);
      g.posts.push({
        id: row.id,
        title: row.title,
        content: row.content || "",
        created_at: row.created_at
      });
    });

    // ì˜¨ë¼ì¸ ì–´íœ˜ ìˆ™ì œ
    (vocabRes.data || []).forEach(row => {
      const baseDate = row.due_date || row.created_at;
      const dateKey = row.due_date || toDateKeyFromISO(row.created_at);
      if (!dateKey) return;

      const g = ensureGroup(row.class_id, dateKey, baseDate);
      g.vocab.push({
        id: row.id,
        level: row.level,
        sets: row.set_numbers,
        due_date: row.due_date,
        created_at: row.created_at
      });
    });

    // ì˜¨ë¼ì¸ ë¬¸ì¥ ìˆ™ì œ
    (sentenceRes.data || []).forEach(row => {
      const baseDate = row.due_date || row.created_at;
      const dateKey = row.due_date || toDateKeyFromISO(row.created_at);
      if (!dateKey) return;

      const g = ensureGroup(row.class_id, dateKey, baseDate);
      g.sentence.push({
        id: row.id,
        level: row.level,
        sets: row.set_numbers,
        due_date: row.due_date,
        created_at: row.created_at
      });
    });

    // map -> ë°°ì—´, ìµœì‹ ìˆœ ì •ë ¬
    groups = Object.values(map).sort((a, b) => {
      return new Date(b.latestTime || 0) - new Date(a.latestTime || 0);
    });

    renderGroups();
  }

  // --- í™”ë©´ì— ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (ë‚ ì§œ+ë°˜ ë¬¶ìŒ ê¸°ì¤€) ---
  function renderGroups() {
    const selected = classFilterEl.value;  // "all" ë˜ëŠ” class_id
    postListEl.innerHTML = "";

    const filtered =
      selected === "all"
        ? groups.slice()
        : groups.filter(g => String(g.class_id) === String(selected));

    if (!filtered.length) {
      emptyBoxEl.style.display = "block";
      return;
    }
    emptyBoxEl.style.display = "none";

    const isTeacher = currentRole === "teacher";

    filtered.forEach(g => {
      const card = document.createElement("div");
      card.className = "post-card";

      const header = document.createElement("div");
      header.className = "post-header";

      // ì™¼ìª½: ë°˜ ë±ƒì§€ + íƒ€ì… ë±ƒì§€ + ë‚ ì§œ
      const left = document.createElement("div");
      const classBadge = document.createElement("div");
      classBadge.className = "post-class-badge";
      classBadge.textContent = g.class_name || "ì „ì²´";

      const typeBadge = document.createElement("span");
      typeBadge.className = "post-type-badge";
      const hasOffline = g.posts.length > 0;
      const hasOnline = g.vocab.length > 0 || g.sentence.length > 0;
      if (hasOffline && hasOnline) {
        typeBadge.textContent = "í•„ê¸° + ì˜¨ë¼ì¸ ìˆ™ì œ";
      } else if (hasOffline) {
        typeBadge.textContent = "í•„ê¸° ìˆ™ì œ";
      } else {
        typeBadge.textContent = "ì˜¨ë¼ì¸ ìˆ™ì œ";
      }

      const titleEl = document.createElement("div");
      titleEl.className = "post-title";
      titleEl.textContent = g.dateKey;

      left.appendChild(classBadge);
      left.appendChild(typeBadge);
      left.appendChild(titleEl);

      // ì˜¤ë¥¸ìª½: ì‘ì„±ì/ì‹œê°„ (ì§€ê¸ˆì€ ê³ ì •)
      const meta = document.createElement("div");
      meta.className = "post-meta";
      meta.innerHTML = `
        <span>${DEFAULT_AUTHOR_LABEL}</span>
        <span>${formatDateTime(g.latestTime)}</span>
      `;

      header.appendChild(left);
      header.appendChild(meta);
      card.appendChild(header);

      // ë³¸ë¬¸
      const body = document.createElement("div");

      // --- í•„ê¸° ìˆ™ì œ / ê³µì§€ ---
      if (g.posts.length > 0) {
        const secLabel = document.createElement("div");
        secLabel.className = "post-section-label sec-offline";
        secLabel.textContent = "âœï¸ í•„ê¸° ìˆ™ì œ / ê³µì§€";
        body.appendChild(secLabel);

        g.posts.forEach(p => {
          const c = document.createElement("div");
          c.className = "post-content";
          c.textContent = p.content || p.title || "";
          body.appendChild(c);
        });

        if (isTeacher) {
          const actionBar = document.createElement("div");
          actionBar.className = "action-bar";

          const editBtn = document.createElement("button");
          editBtn.className = "action-btn action-edit";
          editBtn.textContent = "ìˆ˜ì •";

          const delBtn = document.createElement("button");
          delBtn.className = "action-btn action-delete";
          delBtn.textContent = "ì‚­ì œ";

          actionBar.appendChild(editBtn);
          actionBar.appendChild(delBtn);
          body.appendChild(actionBar);

          // ë‚ ì§œ+ë°˜ ë¬¶ìŒì˜ ì²« ê¸€ ê¸°ì¤€ìœ¼ë¡œ ìˆ˜ì •
          editBtn.onclick = () => {
            const first = g.posts[0];
            editingPostId = first.id;

            writeTitleLabelEl.textContent = "í•„ê¸° ìˆ™ì œ / ê³µì§€ ìˆ˜ì •";
            writeBoxEl.style.display = "block";

            writeClassEl.value = g.class_id;
            writeAuthorEl.value = currentUserName || DEFAULT_AUTHOR_LABEL;
            writeTitleEl.value = first.title || g.dateKey;
            // ì—¬ëŸ¬ ì¤„ì„ í•˜ë‚˜ë¡œ í•©ì³ì„œ ë³´ì—¬ì£¼ê¸°
            writeContentEl.value = g.posts.map(p => p.content || "").join("\n");
            submitWriteBtn.textContent = "ìˆ˜ì • ì™„ë£Œ";
            setWriteStatus("ì´ ë‚ ì§œì˜ í•„ê¸° ìˆ™ì œë¥¼ ìˆ˜ì •í•˜ê³  ìˆì–´ìš”.");
          };

          delBtn.onclick = async () => {
            if (!confirm(`${g.dateKey}ì˜ í•„ê¸° ìˆ™ì œë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?`)) return;
            const ids = g.posts.map(p => p.id);
            try {
              const { error } = await client
                .from("board_posts")
                .delete()
                .in("id", ids);
              if (error) {
                console.error("board_posts ì‚­ì œ ì˜¤ë¥˜:", error);
                alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
              } else {
                await loadGroups();
              }
            } catch (e) {
              console.error("board_posts ì‚­ì œ ì˜ˆì™¸:", e);
              alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
            }
          };
        }
      }

      // --- ì˜¨ë¼ì¸ ì–´íœ˜ ìˆ™ì œ ---
      if (g.vocab.length > 0) {
        const secLabel = document.createElement("div");
        secLabel.className = "post-section-label sec-vocab";
        secLabel.textContent = "ğŸ“š ì˜¨ë¼ì¸ ì–´íœ˜ ìˆ™ì œ";
        body.appendChild(secLabel);

        g.vocab.forEach(h => {
          const row = document.createElement("div");
          row.className = "post-content hw-row";

          const levelTxt = h.level != null ? `ë‹¨ê³„ ${h.level}` : "";
          const setTxt = h.sets ? ` / ì„¸íŠ¸ ${h.sets}` : "";
          const dueTxt = h.due_date ? `\në§ˆê°ì¼: ${h.due_date}` : "";

          const textSpan = document.createElement("span");
          textSpan.textContent = `${levelTxt}${setTxt}${dueTxt}`;
          row.appendChild(textSpan);

          if (isTeacher) {
            const btnBox = document.createElement("div");

            const editBtn = document.createElement("button");
            editBtn.className = "action-btn action-edit";
            editBtn.textContent = "ìˆ˜ì •";

            const delBtn = document.createElement("button");
            delBtn.className = "action-btn action-delete";
            delBtn.textContent = "ì‚­ì œ";

            btnBox.appendChild(editBtn);
            btnBox.appendChild(delBtn);
            row.appendChild(btnBox);

            editBtn.onclick = () => {
              const url =
                `homework-teacher.html?mode=edit&type=vocab&id=${encodeURIComponent(
                  h.id
                )}`;
              window.location.href = url;
            };

            delBtn.onclick = async () => {
              if (!confirm("ì´ ì˜¨ë¼ì¸ ì–´íœ˜ ìˆ™ì œë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
              try {
                const { error } = await client
                  .from("vocab_homework")
                  .delete()
                  .eq("id", h.id);
                if (error) {
                  console.error("vocab_homework ì‚­ì œ ì˜¤ë¥˜:", error);
                  alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
                } else {
                  await loadGroups();
                }
              } catch (e) {
                console.error("vocab_homework ì‚­ì œ ì˜ˆì™¸:", e);
                alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
              }
            };
          }

          body.appendChild(row);
        });
      }

      // --- ì˜¨ë¼ì¸ ë¬¸ì¥ ìˆ™ì œ ---
      if (g.sentence.length > 0) {
        const secLabel = document.createElement("div");
        secLabel.className = "post-section-label sec-sentence";
        secLabel.textContent = "ğŸ’¬ ì˜¨ë¼ì¸ ë¬¸ì¥ ìˆ™ì œ";
        body.appendChild(secLabel);

        g.sentence.forEach(h => {
          const row = document.createElement("div");
          row.className = "post-content hw-row";

          const levelTxt = h.level != null ? `ë‹¨ê³„ ${h.level}` : "";
          const setTxt = h.sets ? ` / ì„¸íŠ¸ ${h.sets}` : "";
          const dueTxt = h.due_date ? `\në§ˆê°ì¼: ${h.due_date}` : "";

          const textSpan = document.createElement("span");
          textSpan.textContent = `${levelTxt}${setTxt}${dueTxt}`;
          row.appendChild(textSpan);

          if (isTeacher) {
            const btnBox = document.createElement("div");

            const editBtn = document.createElement("button");
            editBtn.className = "action-btn action-edit";
            editBtn.textContent = "ìˆ˜ì •";

            const delBtn = document.createElement("button");
            delBtn.className = "action-btn action-delete";
            delBtn.textContent = "ì‚­ì œ";

            btnBox.appendChild(editBtn);
            btnBox.appendChild(delBtn);
            row.appendChild(btnBox);

            editBtn.onclick = () => {
              const url =
                `homework-teacher.html?mode=edit&type=sentence&id=${encodeURIComponent(
                  h.id
                )}`;
              window.location.href = url;
            };

            delBtn.onclick = async () => {
              if (!confirm("ì´ ì˜¨ë¼ì¸ ë¬¸ì¥ ìˆ™ì œë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
              try {
                const { error } = await client
                  .from("sentence_homework")
                  .delete()
                  .eq("id", h.id);
                if (error) {
                  console.error("sentence_homework ì‚­ì œ ì˜¤ë¥˜:", error);
                  alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
                } else {
                  await loadGroups();
                }
              } catch (e) {
                console.error("sentence_homework ì‚­ì œ ì˜ˆì™¸:", e);
                alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
              }
            };
          }

          body.appendChild(row);
        });
      }

      card.appendChild(body);
      postListEl.appendChild(card);
    });
  }

  // --- ê¸€ì“°ê¸° ë²„íŠ¼ ë™ì‘ ---
  writeToggleBtn.onclick = () => {
    if (currentRole !== "teacher") {
      alert("ì„ ìƒë‹˜ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì•¼ ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆì–´ìš”.");
      return;
    }
    const visible = writeBoxEl.style.display !== "none";
    if (visible) {
      writeBoxEl.style.display = "none";
      editingPostId = null;
      submitWriteBtn.textContent = "ë“±ë¡";
      writeTitleLabelEl.textContent = "ìƒˆ ê¸€ ì“°ê¸°";
      setWriteStatus("");
    } else {
      writeBoxEl.style.display = "block";
      editingPostId = null;
      writeTitleLabelEl.textContent = "ìƒˆ ê¸€ ì“°ê¸°";
      writeTitleEl.value = "";
      writeContentEl.value = "";
      writeAuthorEl.value = currentUserName || DEFAULT_AUTHOR_LABEL;
      submitWriteBtn.textContent = "ë“±ë¡";
      setWriteStatus("");
    }
  };

  cancelWriteBtn.onclick = () => {
    writeBoxEl.style.display = "none";
    editingPostId = null;
    submitWriteBtn.textContent = "ë“±ë¡";
    writeTitleLabelEl.textContent = "ìƒˆ ê¸€ ì“°ê¸°";
    setWriteStatus("");
  };

  // --- ê¸€ ë“±ë¡/ìˆ˜ì • (Supabase board_posts) ---
  // --- ê¸€ ë“±ë¡/ìˆ˜ì • (Supabase board_posts) ---
submitWriteBtn.onclick = async () => {
  if (currentRole !== "teacher") {
    alert("ì„ ìƒë‹˜ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì•¼ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.");
    return;
  }

  const classId = writeClassEl.value;
  const title   = writeTitleEl.value.trim();
  const content = writeContentEl.value.trim();

  setWriteStatus("ì €ì¥ ì¤‘...");
  submitWriteBtn.disabled = true;

  try {
    let response;
    
    if (editingPostId) {
      // ìˆ˜ì • ëª¨ë“œ
      response = await client
        .from("board_posts")
        .update({
          class_id: classId,
          title: title,
          content: content
          // updated_atì´ë‚˜ author_idëŠ” ì¼ë‹¨ ì œì™¸í•˜ê³  í…ŒìŠ¤íŠ¸í•©ì‹œë‹¤.
        })
        .eq("id", editingPostId);
    } else {
      // ìƒˆ ê¸€ ë“±ë¡
      response = await client
        .from("board_posts")
        .insert([{
          class_id: classId,
          title: title,
          content: content,
          author_id: currentUserId
        }]);
    }

    if (response.error) {
      // â˜… ì—¬ê¸°ê°€ í•µì‹¬ì…ë‹ˆë‹¤. Supabaseê°€ ë³´ë‚´ëŠ” ì§„ì§œ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ë„ì›ë‹ˆë‹¤.
      console.error("Supabase ìƒì„¸ ì—ëŸ¬:", response.error);
      setWriteStatus(`ì˜¤ë¥˜: ${response.error.message} (${response.error.code})`, true);
    } else {
      setWriteStatus("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
      setTimeout(() => {
        writeBoxEl.style.display = "none";
        editingPostId = null;
        location.reload(); // ì•ˆì „í•˜ê²Œ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ëª©ë¡ ê°±ì‹ 
      }, 1000);
    }

  } catch (e) {
    setWriteStatus("ì‹œìŠ¤í…œ ì˜¤ë¥˜: " + e.message, true);
  } finally {
    submitWriteBtn.disabled = false;
  }
};

  // ì˜¨ë¼ì¸ ìˆ™ì œ ë²„íŠ¼ â†’ homework-teacher.html ë¡œ ì´ë™
  onlineHwBtn.onclick = () => {
    if (currentRole !== "teacher") {
      alert("ì„ ìƒë‹˜ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì•¼ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.");
      return;
    }
    window.location.href = "homework-teacher.html";
  };

  // ê´€ë¦¬ ë²„íŠ¼ â†’ teacher-result.html ë¡œ ì´ë™
  manageBtn.onclick = () => {
    if (currentRole !== "teacher") {
      alert("ì„ ìƒë‹˜ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì•¼ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.");
      return;
    }
    window.location.href = "teacher-result.html";
  };

  // ë°˜ í•„í„° ë³€ê²½ ì‹œ
  classFilterEl.onchange = renderGroups;

  // ì´ˆê¸° ì‹¤í–‰
  (async function init() {
    await detectRole();
    await loadClasses();
    await loadGroups();
  })();
</script>

</body>
</html>
