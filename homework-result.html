<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>내 숙제 결과 - 블라썸잉글리쉬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Pretendard Variable", -apple-system, BlinkMacSystemFont,
        system-ui, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    body {
      background: #f4f6fb;
      padding: 30px 0 60px;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .title-big {
      font-size: 32px;
      font-weight: 900;
      margin-bottom: 6px;
    }

    .subtitle {
      font-size: 15px;
      color: #6b7280;
      margin-bottom: 18px;
    }

    .student-info {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 999px;
      background: #e0ecff;
      color: #1d4ed8;
      font-size: 13px;
      margin-bottom: 18px;
    }

    .tabs {
      display: inline-flex;
      padding: 4px;
      background: #e5e7eb;
      border-radius: 999px;
      gap: 4px;
      margin-bottom: 18px;
    }

    .tab-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 14px;
      cursor: pointer;
      background: transparent;
      color: #4b5563;
    }

    .tab-btn.active {
      background: #ffffff;
      color: #111827;
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.12);
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .result-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 6px;
    }

    .result-card {
      background: #ffffff;
      border-radius: 20px;
      padding: 16px 18px;
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.08);
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
    }

    .result-title {
      font-size: 16px;
      font-weight: 700;
      color: #111827;
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 2px;
    }

    .type-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 11px;
    }

    .badge-vocab {
      background: #d1fae5;
      color: #047857;
    }

    .badge-sentence {
      background: #e0f2fe;
      color: #0369a1;
    }

    .badge-class {
      background: #eef2ff;
      color: #3730a3;
    }

    .badge-date {
      background: #fee2e2;
      color: #b91c1c;
    }

    .result-meta {
      font-size: 12px;
      color: #6b7280;
      text-align: right;
    }

    .result-meta span + span::before {
      content: "· ";
      margin: 0 2px;
    }

    .result-body {
      font-size: 14px;
      color: #374151;
      margin-top: 4px;
      line-height: 1.6;
    }

    .result-score-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 4px;
    }

    .score-strong {
      font-weight: 700;
      color: #111827;
    }

    .score-percent {
      font-weight: 600;
      color: #2563eb;
    }

    .empty-box {
      margin-top: 24px;
      padding: 18px 16px;
      border-radius: 18px;
      background: #e5e7eb;
      font-size: 14px;
      color: #4b5563;
      text-align: center;
    }

    .status-text {
      font-size: 13px;
      color: #6b7280;
      margin-top: 10px;
    }

    .status-text.error {
      color: #b91c1c;
    }

    .login-box {
      margin-top: 30px;
      padding: 20px 18px;
      border-radius: 20px;
      background: #ffffff;
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.08);
      font-size: 14px;
      color: #374151;
    }

    .btn-primary {
      margin-top: 14px;
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: #ffffff;
      font-size: 14px;
      cursor: pointer;
    }

    @media (max-width: 640px) {
      .result-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .result-meta {
        text-align: left;
      }
    }
  </style>
</head>
<body>

<div class="page">
  <div class="title-big">내 숙제 결과</div>
  <div class="subtitle">온라인 어휘·문장 숙제의 점수를 확인할 수 있어요.</div>

  <!-- 로그인 안 되어 있으면 이 박스만 보이게 -->
  <div id="needLoginBox" class="login-box" style="display:none;">
    <div>학생 로그인이 필요합니다. 로그인 후 다시 이용해 주세요.</div>
    <button id="goLoginBtn" class="btn-primary">로그인 화면으로 이동</button>
  </div>

  <!-- 로그인 되어 있으면 아래 내용 보이게 -->
  <div id="contentBox" style="display:none;">
    <div id="studentInfo" class="student-info"></div>

    <div class="tabs">
      <button id="tabVocab" class="tab-btn active">어휘 숙제 결과</button>
      <button id="tabSentence" class="tab-btn">문장 숙제 결과</button>
    </div>

    <!-- 어휘 결과 -->
    <div id="sectionVocab" class="section active">
      <div id="vocabList" class="result-list"></div>
      <div id="vocabEmpty" class="empty-box" style="display:none;">
        아직 제출한 어휘 숙제가 없어요.
      </div>
    </div>

    <!-- 문장 결과 -->
    <div id="sectionSentence" class="section">
      <div id="sentenceList" class="result-list"></div>
      <div id="sentenceEmpty" class="empty-box" style="display:none;">
        아직 제출한 문장 숙제가 없어요.
      </div>
    </div>

    <div id="statusText" class="status-text"></div>
  </div>
</div>

<!-- Supabase JS -->
<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
<script>
  // === Supabase 설정 (board / homework 페이지와 동일) ===
  const SUPABASE_URL = "https://bpdisxjhhibrgfpvtlmv.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZGlzeGpoaGlicmdmcHZ0bG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTkxODQsImV4cCI6MjA3OTUzNTE4NH0.jDZ6BGirOPuWUnt4ykjhng4PLft2ZjBuYAFzApUnlYU";

  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // === DOM 요소 ===
  const needLoginBox  = document.getElementById("needLoginBox");
  const goLoginBtn    = document.getElementById("goLoginBtn");
  const contentBox    = document.getElementById("contentBox");
  const studentInfoEl = document.getElementById("studentInfo");

  const tabVocabBtn      = document.getElementById("tabVocab");
  const tabSentenceBtn   = document.getElementById("tabSentence");
  const sectionVocabEl   = document.getElementById("sectionVocab");
  const sectionSentenceEl= document.getElementById("sectionSentence");

  const vocabListEl      = document.getElementById("vocabList");
  const vocabEmptyEl     = document.getElementById("vocabEmpty");
  const sentenceListEl   = document.getElementById("sentenceList");
  const sentenceEmptyEl  = document.getElementById("sentenceEmpty");

  const statusTextEl     = document.getElementById("statusText");

  // === 로그인된 학생 정보 (localStorage) ===
  let currentStudent = null;   // { login_id, name }

  function setStatus(msg, isError = false) {
    statusTextEl.textContent = msg || "";
    statusTextEl.classList.toggle("error", !!isError);
  }

  function formatDate(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return "";
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    return `${y}-${m}-${day} ${hh}:${mm}`;
  }

  // --- 탭 전환 ---
  function activateTab(which) {
    if (which === "vocab") {
      tabVocabBtn.classList.add("active");
      tabSentenceBtn.classList.remove("active");
      sectionVocabEl.classList.add("active");
      sectionSentenceEl.classList.remove("active");
    } else {
      tabVocabBtn.classList.remove("active");
      tabSentenceBtn.classList.add("active");
      sectionVocabEl.classList.remove("active");
      sectionSentenceEl.classList.add("active");
    }
  }

  tabVocabBtn.onclick = () => activateTab("vocab");
  tabSentenceBtn.onclick = () => activateTab("sentence");

  goLoginBtn.onclick = () => {
    window.location.href = "login.html";
  };

  // === 숙제 결과 불러오기 ===
  /*
    ⚠️ 여기서는 아래처럼 테이블/컬럼을 "가정"했어.

    1) vocab_results
       - id (uuid)
       - vocab_homework_id (uuid, vocab_homework.id 참고)
       - student_login_id (text)  ← login.html에서 쓰는 학생 아이디와 같게
       - correct_count (int)
       - total_count (int)
       - submitted_at (timestamptz)

    2) sentence_results
       - id (uuid)
       - sentence_homework_id (uuid, sentence_homework.id 참고)
       - student_login_id (text)
       - correct_count (int)
       - total_count (int)
       - submitted_at (timestamptz)

    3) vocab_homework / sentence_homework 는 기존과 동일
       - id, class_id, level, set_numbers, due_date, created_at ...
  */

  async function loadVocabResults(studentLoginId) {
    // 결과
    const { data: resultRows, error: resultError } = await client
      .from("vocab_results")
      .select("*")
      .eq("student_login_id", studentLoginId)
      .order("submitted_at", { ascending: false });

    if (resultError) {
      console.error("vocab_results 오류:", resultError);
      throw new Error("어휘 숙제 결과를 불러오는 중 오류가 발생했어요.");
    }

    if (!resultRows || !resultRows.length) {
      vocabListEl.innerHTML = "";
      vocabEmptyEl.style.display = "block";
      return;
    }

    vocabEmptyEl.style.display = "none";

    // 관련된 숙제 정보 한번에 가져오기
    const hwIds = [...new Set(resultRows.map(r => r.vocab_homework_id))];
    const { data: hwRows, error: hwError } = await client
      .from("vocab_homework")
      .select("*")
      .in("id", hwIds);

    if (hwError) {
      console.error("vocab_homework 오류:", hwError);
      throw new Error("어휘 숙제 정보를 불러오는 중 오류가 발생했어요.");
    }

    const hwMap = {};
    (hwRows || []).forEach(h => {
      hwMap[h.id] = h;
    });

    vocabListEl.innerHTML = "";

    resultRows.forEach(row => {
      const hw = hwMap[row.vocab_homework_id] || {};
      const level = hw.level != null ? hw.level : "";
      const sets  = hw.set_numbers || "";
      const className = hw.class_name || ""; // 필요하면 나중에 컬럼 추가
      const dueText = hw.due_date ? `마감일: ${hw.due_date}` : "";

      const correct = row.correct_count ?? 0;
      const total   = row.total_count ?? 0;
      const percent = total > 0 ? Math.round((correct / total) * 100) : 0;

      const card = document.createElement("div");
      card.className = "result-card";

      const header = document.createElement("div");
      header.className = "result-header";

      const left = document.createElement("div");

      const badgeRow = document.createElement("div");
      badgeRow.className = "badge-row";

      const typeBadge = document.createElement("span");
      typeBadge.className = "type-badge badge-vocab";
      typeBadge.textContent = "온라인 어휘 숙제";

      badgeRow.appendChild(typeBadge);

      if (className) {
        const classBadge = document.createElement("span");
        classBadge.className = "type-badge badge-class";
        classBadge.textContent = className;
        badgeRow.appendChild(classBadge);
      }

      const dateBadge = document.createElement("span");
      dateBadge.className = "type-badge badge-date";
      dateBadge.textContent = formatDate(row.submitted_at);
      badgeRow.appendChild(dateBadge);

      const title = document.createElement("div");
      title.className = "result-title";
      title.textContent = `단계 ${level} / 세트 ${sets}`;

      left.appendChild(badgeRow);
      left.appendChild(title);

      const meta = document.createElement("div");
      meta.className = "result-meta";
      meta.innerHTML = `
        <span>점수 ${correct} / ${total}</span>
        <span>${percent}%</span>
      `;

      header.appendChild(left);
      header.appendChild(meta);

      const body = document.createElement("div");
      body.className = "result-body";

      const scoreRow = document.createElement("div");
      scoreRow.className = "result-score-row";
      scoreRow.innerHTML = `
        <span class="score-strong">맞힌 개수: ${correct} / ${total}</span>
        <span class="score-percent">${percent}%</span>
      `;

      const desc = document.createElement("div");
      desc.textContent = dueText || "제출 완료된 숙제입니다.";

      body.appendChild(scoreRow);
      body.appendChild(desc);

      card.appendChild(header);
      card.appendChild(body);

      vocabListEl.appendChild(card);
    });
  }

  async function loadSentenceResults(studentLoginId) {
    const { data: resultRows, error: resultError } = await client
      .from("sentence_results")
      .select("*")
      .eq("student_login_id", studentLoginId)
      .order("submitted_at", { ascending: false });

    if (resultError) {
      console.error("sentence_results 오류:", resultError);
      throw new Error("문장 숙제 결과를 불러오는 중 오류가 발생했어요.");
    }

    if (!resultRows || !resultRows.length) {
      sentenceListEl.innerHTML = "";
      sentenceEmptyEl.style.display = "block";
      return;
    }

    sentenceEmptyEl.style.display = "none";

    const hwIds = [...new Set(resultRows.map(r => r.sentence_homework_id))];
    const { data: hwRows, error: hwError } = await client
      .from("sentence_homework")
      .select("*")
      .in("id", hwIds);

    if (hwError) {
      console.error("sentence_homework 오류:", hwError);
      throw new Error("문장 숙제 정보를 불러오는 중 오류가 발생했어요.");
    }

    const hwMap = {};
    (hwRows || []).forEach(h => {
      hwMap[h.id] = h;
    });

    sentenceListEl.innerHTML = "";

    resultRows.forEach(row => {
      const hw = hwMap[row.sentence_homework_id] || {};
      const level = hw.level != null ? hw.level : "";
      const sets  = hw.set_numbers || "";
      const className = hw.class_name || "";
      const dueText = hw.due_date ? `마감일: ${hw.due_date}` : "";

      const correct = row.correct_count ?? 0;
      const total   = row.total_count ?? 0;
      const percent = total > 0 ? Math.round((correct / total) * 100) : 0;

      const card = document.createElement("div");
      card.className = "result-card";

      const header = document.createElement("div");
      header.className = "result-header";

      const left = document.createElement("div");

      const badgeRow = document.createElement("div");
      badgeRow.className = "badge-row";

      const typeBadge = document.createElement("span");
      typeBadge.className = "type-badge badge-sentence";
      typeBadge.textContent = "온라인 문장 숙제";
      badgeRow.appendChild(typeBadge);

      if (className) {
        const classBadge = document.createElement("span");
        classBadge.className = "type-badge badge-class";
        classBadge.textContent = className;
        badgeRow.appendChild(classBadge);
      }

      const dateBadge = document.createElement("span");
      dateBadge.className = "type-badge badge-date";
      dateBadge.textContent = formatDate(row.submitted_at);
      badgeRow.appendChild(dateBadge);

      const title = document.createElement("div");
      title.className = "result-title";
      title.textContent = `단계 ${level} / 세트 ${sets}`;

      left.appendChild(badgeRow);
      left.appendChild(title);

      const meta = document.createElement("div");
      meta.className = "result-meta";
      meta.innerHTML = `
        <span>점수 ${correct} / ${total}</span>
        <span>${percent}%</span>
      `;

      header.appendChild(left);
      header.appendChild(meta);

      const body = document.createElement("div");
      body.className = "result-body";

      const scoreRow = document.createElement("div");
      scoreRow.className = "result-score-row";
      scoreRow.innerHTML = `
        <span class="score-strong">맞힌 개수: ${correct} / ${total}</span>
        <span class="score-percent">${percent}%</span>
      `;

      const desc = document.createElement("div");
      desc.textContent = dueText || "제출 완료된 숙제입니다.";

      body.appendChild(scoreRow);
      body.appendChild(desc);

      card.appendChild(header);
      card.appendChild(body);

      sentenceListEl.appendChild(card);
    });
  }

  // === 초기 실행 ===
  (async function init() {
    // 1) 학생 로그인 정보 확인
    try {
      const raw = localStorage.getItem("blossom_student");
      if (!raw) {
        needLoginBox.style.display = "block";
        contentBox.style.display = "none";
        return;
      }
      const s = JSON.parse(raw);
      currentStudent = s;
    } catch (e) {
      console.error("학생 정보 파싱 오류:", e);
      needLoginBox.style.display = "block";
      contentBox.style.display = "none";
      return;
    }

    // 로그인 되어 있음
    needLoginBox.style.display = "none";
    contentBox.style.display = "block";

    const loginId = currentStudent.login_id || currentStudent.id || "";
    const name    = currentStudent.name || "";

    studentInfoEl.textContent = `학생: ${name || "이름 없음"} (${loginId || "아이디 없음"})`;

    if (!loginId) {
      setStatus("학생 아이디 정보를 찾을 수 없어요. 다시 로그인해 주세요.", true);
      return;
    }

    setStatus("숙제 결과를 불러오는 중입니다…");

    try {
      await Promise.all([
        loadVocabResults(loginId),
        loadSentenceResults(loginId),
      ]);
      setStatus("");
    } catch (e) {
      console.error(e);
      setStatus(e.message || "숙제 결과를 불러오는 중 오류가 발생했어요.", true);
    }
  })();
</script>

</body>
</html>