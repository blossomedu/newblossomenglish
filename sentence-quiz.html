<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë¬¸ì¥ í•™ìŠµ - BLOSSOM ENGLISH</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Jua&display=swap" />

  <style>
    /* === ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìœ ì§€) === */
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Pretendard Variable", sans-serif; }
    body { background: #f4f6fb; color: #111827; min-height: 100vh; }
    .page { max-width: 1100px; margin: 32px auto 48px; padding: 0 16px; }
    .main-title { font-size: 28px; font-weight: 800; margin-bottom: 20px; }
    .top-bar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    
    .mode-tab {
      padding: 9px 18px; border-radius: 999px; border: none; background: #eef1ff;
      color: #111827; font-size: 14px; display: inline-flex; align-items: center;
      gap: 6px; cursor: pointer; transition: all 0.15s ease; white-space: nowrap;
    }
    
    .mode-tab.active { background: #00AEEF; color: #ffffff; box-shadow: 0 12px 25px rgba(0, 174, 239, 0.35); }
    .mode-tab.active[data-mode="meaning"], .mode-tab.active[data-mode="listening"] {
      background: #FF6FB5; color: #ffffff; box-shadow: 0 12px 25px rgba(255, 111, 181, 0.45);
    }

       /* ì¹´ë“œ ë° í€´ì¦ˆ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìœ ì§€) */
    .card { background: #ffffff; border-radius: 28px; padding: 40px 60px 32px; box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08); min-height: 360px; position: relative; display: flex; flex-direction: column; justify-content: space-between; }
    .audio-badge { position: absolute; top: 18px; right: 26px; padding: 6px 14px; border-radius: 999px; background: #e5edff; font-size: 12px; color: #1d4ed8; display: none; }
    .center-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; gap: 12px; padding: 10px 8px; min-height: 260px; }
    .word-big { font-size: 72px; font-weight: 800; color: #b91c1c; font-family: "Jua", sans-serif; }
    .meaning-big { font-size: 40px; font-weight: 700; color: #111827; }
    .example-en { font-size: 18px; color: #4b5563; margin-top: 18px; }
    .example-ko { font-size: 16px; color: #6b7280; }
    .question-title { font-size: 30px; font-weight: 800; margin-bottom: 8px; }
    .choices-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px 24px; width: 100%; max-width: 620px; margin: 0 auto; }
    .choice-btn { width: 100%; min-height: 56px; padding: 16px; border-radius: 18px; border: 1px solid #e5e7eb; background: #f9fafb; font-size: 16px; cursor: pointer; transition: all 0.12s ease; }
    .choice-btn:hover { background: #eef2ff; }
    .choice-btn.correct { background: #dcfce7; border-color: #22c55e; color: #166534; font-weight: 600; }
    .choice-btn.wrong { background: #fee2e2; border-color: #f97373; color: #b91c1c; }
    .sentence-en { font-size: 26px; font-weight: 700; margin-bottom: 10px; }
    .sentence-ko { font-size: 18px; color: #4b5563; margin-bottom: 18px; }
    .sentence-row { display: flex; gap: 10px; width: 100%; max-width: 520px; margin: 0 auto; }
    .sentence-input { flex: 1; padding: 12px 16px; border-radius: 999px; border: 1px solid #d1d5db; font-size: 16px; }
    .check-btn { padding: 11px 18px; border-radius: 999px; background: #9AD7A0; border: none; color: #ffffff; font-size: 14px; cursor: pointer; white-space: nowrap; }
    .hint-text, .result-text { min-height: 22px; }
    .hint-text { margin-top: 10px; font-size: 14px; color: #f97316; }
    .result-text { margin-top: 6px; font-size: 14px; color: #4b5563; }
    .bottom-bar { display: flex; justify-content: space-between; align-items: center; margin-top: 24px; gap: 10px; font-size: 14px; color: #6b7280; }
    .bottom-right { display: flex; gap: 8px; }
    .nav-pill { padding: 9px 18px; border-radius: 999px; border: none; font-size: 14px; cursor: pointer; white-space: nowrap; }
    .pill-reset { background: #00AEEF; color: #ffffff; }
    .pill-back { background: #FF6FB5; color: #ffffff; }
    @media (max-width: 768px) { .card { padding: 28px 18px 24px; } .word-big { font-size: 54px; } .meaning-big { font-size: 30px; } .sentence-en { font-size: 22px; } }
  </style>
</head>
<body>
<div class="page">
  <h1 class="main-title" id="mainTitle">ë¬¸ì¥ í•™ìŠµ</h1>

  <div class="top-bar">
    <button class="mode-tab active" data-mode="study">ğŸ“š ë¹ˆì¹¸ ì™„ì„±</button>
    <button class="mode-tab" data-mode="meaning">âœ… ë¬¸ì¥ ë°°ì—´</button>
    <button class="mode-tab" data-mode="english">ğŸ”¤ ë¬¸ì¥ ê³ ë¥´ê¸°</button>
    <button class="mode-tab" data-mode="listening">âœï¸ ì§€ë¬¸ ì™„ì„±</button>
</div>

  <div class="card">
    <div class="audio-badge" id="audioBadge"></div>
    <div class="center-area" id="centerArea"></div>

    <div class="bottom-bar">
      <div id="progressText">0 / 0</div>
      <div class="bottom-right">
        <button class="nav-pill pill-reset" id="modeResetBtn">ë‹¤ì‹œ ì‹œì‘</button>
        <button class="nav-pill pill-back" id="backToUnitsBtn">ëŒì•„ê°€ê¸°</button>
      </div>
    </div>
  </div>
</div> 

<script src="words.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>

<script>
  // ---------- Supabase ì„¤ì • ----------
  const SUPABASE_URL = "https://bpdisxjhhibrgfpvtlmv.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZGlzeGpoaGlicmdmcHZ0bG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTkxODQsImV4cCI6MjA3OTUzNTE4NH0.jDZ6BGirOPuWUnt4ykjhng4PLft2ZjBuYAFzApUnlYU";
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // í•™ìƒ ì •ë³´
  let currentStudentLoginId = null;
  (function loadStudent() {
    try {
      const raw = localStorage.getItem("blossom_student");
      if (!raw) return;
      const s = JSON.parse(raw);
      currentStudentLoginId = s.login_id || s.id || null;
    } catch (e) { console.error(e); }
  })();

  // íŒŒë¼ë¯¸í„° ë° ë°ì´í„°
  const params = new URLSearchParams(window.location.search);
  let stage = params.get("stage") || "1";
  let unitKey = params.get("unit") || "1-1";

  if (/^\d+$/.test(unitKey)) unitKey = unitKey + "-1";

  const WORD_DB = window.WORD_DB || {};
  const words = WORD_DB[unitKey] || [];
  const wordCount = words.length;

  // DOM ìš”ì†Œ
  const mainTitle = document.getElementById("mainTitle");
  mainTitle.textContent = `ë¬¸ì¥ í•™ìŠµ ${unitKey}`;
  const centerArea = document.getElementById("centerArea");
  const audioBadge = document.getElementById("audioBadge");
  const progressText = document.getElementById("progressText");
  const modeTabs = document.querySelectorAll(".mode-tab");
  const modeResetBtn = document.getElementById("modeResetBtn");
  const backToUnitsBtn = document.getElementById("backToUnitsBtn");
  
  // ---------- ì´í•˜ ê¸°ì¡´ ë¡œì§ ìœ ì§€ ----------
  let currentMode = "study";
  let currentIndex = 0;
  const AUTO_QUIZ_MODES = ["meaning", "english", "listening"];
  let quizQueue = [], quizPos = 0, nextRoundQueue = [], quizFinished = false;
  let sentenceOrder = [], sentencePos = 0;
  let answerTimer = null;

  function setProgress(current, total) { progressText.textContent = `${current} / ${total}`; }
  function stopSpeech() { const synth = window.speechSynthesis; if(synth && (synth.speaking || synth.pending)) synth.cancel(); }
  function shuffleArray(arr) {
    const a = arr.slice();
    for(let i=a.length-1; i>0; i--){ const j = Math.floor(Math.random()*(i+1)); [a[i], a[j]] = [a[j], a[i]]; }
    return a;
  }

  function resetQuizFlow() {
    if(!wordCount) return;
    const base = []; for(let i=0; i<wordCount; i++) base.push(i);
    quizQueue = shuffleArray(base); nextRoundQueue = []; quizPos = 0; quizFinished = false;
  }
  function resetSentenceFlow() {
    if(!wordCount) return;
    const base = []; for(let i=0; i<wordCount; i++) base.push(i);
    sentenceOrder = shuffleArray(base); sentencePos = 0;
  }

  async function saveVocabResult() {
    if(!currentStudentLoginId || !wordCount) return;
    try {
      await client.from("vocab_results").insert({
        student_login_id: currentStudentLoginId,
        unit: unitKey,
        mode: currentMode,
        correct_count: wordCount,
        total_count: wordCount,
        submitted_at: new Date().toISOString()
      });
    } catch(e) { console.error(e); }
  }

  function showQuizFinished() {
    stopSpeech(); audioBadge.style.display = "none";
    centerArea.innerHTML = `
      <div class="question-title">ëª¨ë“  ë¬¸ì œë¥¼ ë‹¤ í’€ì—ˆì–´ìš”!</div>
      <div style="margin-top:10px;font-size:22px;color:#16a34a;font-weight:700;">100ì  ğŸ‰</div>
      <div style="margin-top:12px;font-size:14px;color:#6b7280;">ë‹¤ì‹œ ì—°ìŠµí•˜ë ¤ë©´ "ë‹¤ì‹œ ì‹œì‘"ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>`;
    setProgress(wordCount, wordCount);
    saveVocabResult();
  }

  function goNextQuestion(wrongIndex) {
    if(wrongIndex !== null && wrongIndex !== undefined) nextRoundQueue.push(wrongIndex);
    quizPos++;
    if(quizPos >= quizQueue.length) {
      if(nextRoundQueue.length > 0) {
        quizQueue = nextRoundQueue; nextRoundQueue = []; quizPos = 0; renderCurrent();
      } else {
        quizFinished = true; showQuizFinished();
      }
    } else { renderCurrent(); }
  }

  function speakWordTwice(word, cb) {
    const synth = window.speechSynthesis;
    if(!synth) { if(cb) cb(); return; }
    synth.cancel();
    const u1 = new SpeechSynthesisUtterance(word);
    const u2 = new SpeechSynthesisUtterance(word);
    u1.lang = "en-US"; u2.lang = "en-US"; u1.rate = 0.9; u2.rate = 0.9;
    
    u1.onend = () => setTimeout(() => synth.speak(u2), 1000);
    u2.onend = () => { if(cb) setTimeout(cb, 2600); };
    synth.speak(u1);
  }

  function renderStudy() {
    stopSpeech(); if(answerTimer) clearTimeout(answerTimer);
    if(!words.length) { centerArea.textContent = "ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤."; return; }
    const item = words[currentIndex];
    audioBadge.style.display = "none";
    centerArea.innerHTML = `
      <div class="word-big">${item.word}</div>
      <div class="meaning-big">${item.meaning}</div>
      <div class="example-en">${item.exampleEn}</div>
      <div class="example-ko">${item.exampleKo}</div>`;
    setProgress(currentIndex+1, wordCount);
    speakWordTwice(item.word, () => {
      if(currentMode !== "study") return;
      currentIndex = (currentIndex+1) % wordCount;
      renderStudy();
    });
  }

  function makeChoices(correctIdx) {
    const indices = [...Array(wordCount).keys()].filter(i => i !== correctIdx);
    for(let i=indices.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [indices[i], indices[j]] = [indices[j], indices[i]]; }
    const pick = indices.slice(0, 3);
    const all = [correctIdx, ...pick];
    for(let i=all.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [all[i], all[j]] = [all[j], all[i]]; }
    return all;
  }

  function renderQuizCommon(type) {
    stopSpeech(); if(answerTimer) clearTimeout(answerTimer);
    if(!words.length || (!quizQueue.length && !quizFinished)) resetQuizFlow();
    if(quizFinished) { showQuizFinished(); return; }

    const qIndex = quizQueue[quizPos];
    const item = words[qIndex];
    audioBadge.style.display = "none";
    centerArea.dataset.answered = "false";
    
    let questionHtml = "";
    if(type === "meaning") questionHtml = `<div class="question-title">${item.word}</div>`;
    else if(type === "english") questionHtml = `<div class="question-title">${item.meaning}</div>`;
    else if(type === "listening") questionHtml = `<div class="question-title">ë°œìŒì„ ë“£ê³  ë‹¨ì–´ë¥¼ ê³ ë¥´ì„¸ìš”.</div>`;

    centerArea.innerHTML = questionHtml;
    const grid = document.createElement("div"); grid.className = "choices-grid"; centerArea.appendChild(grid);

    const choices = makeChoices(qIndex);
    choices.forEach(idx => {
      const choice = words[idx];
      const btn = document.createElement("button"); btn.className = "choice-btn";
      
      let btnText = "";
      if(type === "meaning" || type === "listening") btnText = choice.meaning;
      else btnText = choice.word;
      
      btn.textContent = btnText;
      grid.appendChild(btn);
      
      btn.onclick = () => {
        if(centerArea.dataset.answered === "true") return;
        centerArea.dataset.answered = "true";
        if(answerTimer) clearTimeout(answerTimer);
        
        const isCorrect = (idx === qIndex);
        if(isCorrect) btn.classList.add("correct");
        else { btn.classList.add("wrong"); grid.childNodes.forEach(b => { if((type==="meaning"||type==="listening"?b.textContent===item.meaning:b.textContent===item.word)) b.classList.add("correct"); }); }
        
        setTimeout(() => goNextQuestion(isCorrect ? null : qIndex), 900);
      };
    });

    setProgress(Math.min(quizPos+1, wordCount), wordCount);
    if(type === "listening") speakWordTwice(item.word, null);
    answerTimer = setTimeout(() => {
        if(centerArea.dataset.answered === "false") {
            centerArea.dataset.answered = "true";
            goNextQuestion(qIndex);
        }
    }, 7000);
  }

  function renderSentenceQuiz() {
    stopSpeech(); if(answerTimer) clearTimeout(answerTimer);
    if(!words.length) return;
    if(!sentenceOrder.length) resetSentenceFlow();
    if(sentencePos >= wordCount) { showQuizFinished(); return; }

    const item = words[sentenceOrder[sentencePos]];
    const blanked = item.exampleEn.replace(new RegExp(item.word, "i"), "____");
    
    centerArea.innerHTML = `
      <div class="sentence-en">${blanked}</div>
      <div class="sentence-ko">${item.exampleKo}</div>`;
    
    const row = document.createElement("div"); row.className = "sentence-row";
    const input = document.createElement("input"); input.className = "sentence-input"; input.placeholder = "ë‹¨ì–´ ì…ë ¥";
    const btn = document.createElement("button"); btn.className = "check-btn"; btn.textContent = "í™•ì¸";
    row.appendChild(input); row.appendChild(btn); centerArea.appendChild(row);
    
    const hint = document.createElement("div"); hint.className = "hint-text"; centerArea.appendChild(hint);
    const res = document.createElement("div"); res.className = "result-text"; centerArea.appendChild(res);

    setProgress(sentencePos+1, wordCount);

    function check() {
      const val = input.value.trim().toLowerCase();
      if(!val) return;
      if(val === item.word.toLowerCase()) {
        input.style.borderColor = "#22c55e"; res.textContent = "ì •ë‹µ! ğŸ‘"; hint.textContent = "";
        setTimeout(() => { sentencePos++; renderSentenceQuiz(); }, 900);
      } else {
        input.style.borderColor = "#f97373"; hint.textContent = `íŒíŠ¸: "${item.word[0]}"ë¡œ ì‹œì‘`; res.textContent = "ë‹¤ì‹œ í•´ë³´ì„¸ìš”.";
      }
    }
    btn.onclick = check;
    input.onkeydown = (e) => { if(e.key === "Enter") check(); };
    input.focus();
  }

  function renderCurrent() {
    modeTabs.forEach(t => t.classList.toggle("active", t.dataset.mode === currentMode));
    if(currentMode === "study") renderStudy();
    else if(currentMode === "meaning") renderQuizCommon("meaning");
    else if(currentMode === "english") renderQuizCommon("english");
    else if(currentMode === "listening") renderQuizCommon("listening");
    else if(currentMode === "sentence") renderSentenceQuiz();
  }

  modeTabs.forEach(tab => {
    tab.onclick = () => {
      stopSpeech(); if(answerTimer) clearTimeout(answerTimer);
      currentMode = tab.dataset.mode;
      currentIndex = 0;
      if(AUTO_QUIZ_MODES.includes(currentMode)) resetQuizFlow();
      if(currentMode === "sentence") resetSentenceFlow();
      renderCurrent();
    };
  });

  modeResetBtn.onclick = () => {
    stopSpeech(); if(answerTimer) clearTimeout(answerTimer);
    currentIndex = 0; resetQuizFlow(); resetSentenceFlow(); renderCurrent();
  };
  backToUnitsBtn.onclick = () => window.history.back();

  renderCurrent();
</script>
</body>
</html>
