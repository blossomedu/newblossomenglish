<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì–´íœ˜ í•™ìŠµ - BLOSSOM ENGLISH</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Jua&display=swap" />

  <style>
    /* === ê¸°ë³¸ ìŠ¤íƒ€ì¼ === */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Pretendard Variable", sans-serif;
    }
    body {
      background: #f4f6fb;
      color: #111827;
      min-height: 100vh;
    }
    .page {
      max-width: 1100px;
      margin: 32px auto 48px;
      padding: 0 16px;
    }
    .main-title {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 20px;
    }
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .mode-tab {
      padding: 9px 18px;
      border-radius: 999px;
      border: none;
      background: #eef1ff;
      color: #111827;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .mode-tab.active {
      background: #00AEEF;
      color: #ffffff;
      box-shadow: 0 12px 25px rgba(0, 174, 239, 0.35);
    }
    .mode-tab.active[data-mode="meaning"],
    .mode-tab.active[data-mode="listening"] {
      background: #FF6FB5;
      color: #ffffff;
      box-shadow: 0 12px 25px rgba(255, 111, 181, 0.45);
    }

    /* ì–´íœ˜ ë³´ê¸° ë²„íŠ¼ */
    .mode-tab.print-btn {
      background: #ff7eb3;
      color: #ffffff;
      font-weight: 600;
    }
    .mode-tab.print-btn:hover {
      filter: brightness(0.95);
      box-shadow: 0 8px 20px rgba(255, 126, 179, 0.4);
    }

    /* ì¹´ë“œ ì˜ì—­ */
    .card {
      background: #ffffff;
      border-radius: 28px;
      padding: 40px 60px 32px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
      min-height: 360px;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .audio-badge {
      position: absolute;
      top: 18px;
      right: 26px;
      padding: 6px 14px;
      border-radius: 999px;
      background: #e5edff;
      font-size: 12px;
      color: #1d4ed8;
      display: none;
    }
    .center-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: 12px;
      padding: 10px 8px;
      min-height: 260px;
    }
    /* ë¬¸ì¥ ë¹ˆì¹¸ ëª¨ë“œì—ì„œ ì‚´ì§ ë” ì•„ë˜ë¡œ */
    .center-area.sentence-mode {
      padding-top: 30px;
    }

    .word-big {
      font-size: 72px;
      font-weight: 800;
      color: #b91c1c;
      font-family: "Jua", sans-serif;
    }
    .meaning-big {
      font-size: 40px;
      font-weight: 700;
      color: #111827;
    }
    .example-en {
      font-size: 18px;
      color: #4b5563;
      margin-top: 18px;
    }
    .example-ko {
      font-size: 16px;
      color: #6b7280;
    }

    .question-title {
      font-size: 30px;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .choices-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px 24px;
      width: 100%;
      max-width: 620px;
      margin: 0 auto;
    }

    /* âœ… ë³´ê¸° ë²„íŠ¼: í•­ìƒ ê°™ì€ ë†’ì´ + ê°€ìš´ë° ì •ë ¬ */
    .choice-btn {
      width: 100%;
      height: 72px;
      padding: 8px 16px;
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.12s ease;
      word-break: keep-all;
      white-space: pre-line;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .choice-btn:hover { background: #eef2ff; }
    .choice-btn.correct {
      background: #dcfce7;
      border-color: #22c55e;
      color: #166534;
      font-weight: 600;
    }
    .choice-btn.wrong {
      background: #fee2e2;
      border-color: #f97373;
      color: #b91c1c;
    }

    .sentence-en {
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 10px;
    }
    .sentence-ko {
      font-size: 18px;
      color: #4b5563;
      margin-bottom: 18px;
    }

    .sentence-row {
      display: flex;
      gap: 10px;
      width: 100%;
      max-width: 520px;
      margin: 0 auto;
      justify-content: center;
    }
    .sentence-input {
      flex: none;
      width: 70%;
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 16px;
    }
    .check-btn {
      padding: 11px 18px;
      border-radius: 999px;
      background: #9AD7A0;
      border: none;
      color: #ffffff;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }

    .hint-text, .result-text { min-height: 22px; }
    .hint-text { margin-top: 10px; font-size: 14px; color: #f97316; }
    .result-text { margin-top: 6px; font-size: 14px; color: #4b5563; }

    .bottom-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
      gap: 10px;
      font-size: 14px;
      color: #6b7280;
    }
    .bottom-right {
      display: flex;
      gap: 8px;
    }
    .nav-pill {
      padding: 9px 18px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }
    
    /* âœ¨ [ìˆ˜ì • ì™„ë£Œ] ë²„íŠ¼ ìƒ‰ìƒ (Home: ì´ˆë¡, ë‹¤ì‹œí’€ê¸°: íŒŒë‘, ëŒì•„ê°€ê¸°: í•‘í¬) */
    .pill-home  { background: #9AD7A0; color: #ffffff; }
    .pill-reset { background: #00AEEF; color: #ffffff; }
    .pill-back  { background: #FF6FB5; color: #ffffff; }

    @media (max-width: 768px) {
      .card { padding: 28px 18px 24px; }
      .word-big { font-size: 54px; }
      .meaning-big { font-size: 30px; }
      .sentence-en { font-size: 22px; }

      .sentence-input {
        width: 70%;
        max-width: 70%;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <h1 class="main-title" id="mainTitle">ì–´íœ˜ í•™ìŠµ</h1>

  <div class="top-bar">
    <button class="mode-tab active" data-mode="study">ğŸ“š í•™ìŠµ í•˜ê¸°</button>
    <button class="mode-tab" data-mode="meaning">âœ… ëœ» ì°¾ê¸°</button>
    <button class="mode-tab" data-mode="english">ğŸ”¤ ì˜ì–´ ì°¾ê¸°</button>
    <button class="mode-tab" data-mode="listening">ğŸ§ ë“£ê³  ì°¾ê¸°</button>
    <button class="mode-tab" data-mode="sentence">âœï¸ ë¬¸ì¥ ë¹ˆì¹¸</button>
    <button class="mode-tab print-btn" id="printVocabBtn">ğŸ–¨ï¸ ì–´íœ˜ ë³´ê¸°</button>
  </div>

  <div class="card">
    <div class="audio-badge" id="audioBadge"></div>
    <div class="center-area" id="centerArea"></div>

    <div class="bottom-bar">
      <div id="progressText">0 / 0</div>
      <div class="bottom-right">
        <button class="nav-pill pill-home" id="homeBtn">Home</button>
        <button class="nav-pill pill-reset" id="modeResetBtn">ë‹¤ì‹œ í’€ê¸°</button>
        <button class="nav-pill pill-back" id="backToUnitsBtn">ëŒì•„ê°€ê¸°</button>
      </div>
    </div>
  </div>
</div>

<script src="words.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>

<script>
  // ---------- Supabase ì„¤ì • ----------
  const SUPABASE_URL = "https://bpdisxjhhibrgfpvtlmv.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZGlzeGpoaGlicmdmcHZ0bG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTkxODQsImV4cCI6MjA3OTUzNTE4NH0.jDZ6BGirOPuWUnt4ykjhng4PLft2ZjBuYAFzApUnlYU";
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // í•™ìƒ ì •ë³´
  let currentStudentLoginId = null;
  (function loadStudent() {
    try {
      const raw = localStorage.getItem("blossom_student");
      if (!raw) return;
      const s = JSON.parse(raw);
      currentStudentLoginId = s.login_id || s.id || null;
    } catch (e) { console.error(e); }
  })();

  // íŒŒë¼ë¯¸í„° ë° ë°ì´í„°
  const params = new URLSearchParams(window.location.search);
  let stage = params.get("stage") || "1";
  let unitKey = params.get("unit") || "1-1";

  if (/^\d+$/.test(unitKey)) unitKey = unitKey + "-1";

  const WORD_DB = window.WORD_DB || {};
  const words = WORD_DB[unitKey] || [];
  const wordCount = words.length;

  // DOM ìš”ì†Œ
  const mainTitle = document.getElementById("mainTitle");
  mainTitle.textContent = "ì–´íœ˜ í•™ìŠµ " + unitKey;
  const centerArea = document.getElementById("centerArea");
  const audioBadge = document.getElementById("audioBadge");
  const progressText = document.getElementById("progressText");
  const modeTabs = document.querySelectorAll(".mode-tab:not(#printVocabBtn)");
  const modeResetBtn = document.getElementById("modeResetBtn");
  const backToUnitsBtn = document.getElementById("backToUnitsBtn");
  const homeBtn = document.getElementById("homeBtn");

  // --- ì–´íœ˜ ë³´ê¸° ë²„íŠ¼ ---
  const printVocabBtn = document.getElementById("printVocabBtn");
  if (printVocabBtn) {
    printVocabBtn.onclick = function () {
      const url = "vocab-list.html?unit=" + encodeURIComponent(unitKey);
      window.open(url, "_blank");
    };
  }

  // ---------- í€´ì¦ˆ ê³µí†µ ìƒíƒœ ----------
  let currentMode = "study";
  let currentIndex = 0;
  const AUTO_QUIZ_MODES = ["meaning", "english", "listening"];
  let quizQueue = [];
  let quizPos = 0;
  let nextRoundQueue = [];
  let quizFinished = false;
  let sentenceOrder = [];
  let sentencePos = 0;
  let answerTimer = null;

  // âœ… ê²°ê³¼ ì €ì¥ ì¤‘ë³µ ë°©ì§€
  let didSaveResult = false;

  function setProgress(current, total) {
    progressText.textContent = current + " / " + total;
  }

  function stopSpeech() {
    const synth = window.speechSynthesis;
    if (synth && (synth.speaking || synth.pending)) {
      try { synth.cancel(); } catch (e) { console.error(e); }
    }
  }

  function shuffleArray(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      const tmp = a[i];
      a[i] = a[j];
      a[j] = tmp;
    }
    return a;
  }

  function resetQuizFlow() {
    if (!wordCount) return;
    const base = [];
    for (let i = 0; i < wordCount; i++) base.push(i);
    quizQueue = shuffleArray(base);
    nextRoundQueue = [];
    quizPos = 0;
    quizFinished = false;
    didSaveResult = false;
  }

  function resetSentenceFlow() {
    if (!wordCount) return;
    const base = [];
    for (let i = 0; i < wordCount; i++) base.push(i);
    sentenceOrder = shuffleArray(base);
    sentencePos = 0;
    didSaveResult = false;
  }

  // âœ… ê²°ê³¼ ì €ì¥
  async function saveVocabResult() {
    if (!currentStudentLoginId) {
      console.warn("í•™ìƒ ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
      centerArea.insertAdjacentHTML(
        "beforeend",
        '<div style="margin-top:14px;font-size:13px;color:#b91c1c;">âš ï¸ í•™ìƒ ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ì–´ ê²°ê³¼ ì €ì¥ì´ ë˜ì§€ ì•Šì•˜ì–´ìš”.</div>'
      );
      return;
    }

    if (!wordCount) return;
    if (didSaveResult) return;

    const payload = {
      student_login_id: currentStudentLoginId,
      unit_key: unitKey,
      mode: currentMode,
      correct_count: wordCount,
      total_count: wordCount,
      submitted_at: new Date().toISOString(),
      homework_id: new URLSearchParams(location.search).get("homework_id")
    };

    try {
      const { data, error } = await client
        .from("vocab_results")
        .insert(payload)
        .select();

      if (error) {
        centerArea.insertAdjacentHTML(
          "beforeend",
          `<div style="margin-top:14px;font-size:13px;color:#b91c1c;">âš ï¸ ê²°ê³¼ ì €ì¥ ì‹¤íŒ¨: ${error.message}</div>`
        );
        return;
      }

      didSaveResult = true;
      centerArea.insertAdjacentHTML(
        "beforeend",
        `<div style="margin-top:14px;font-size:13px;color:#6b7280;">âœ… ê²°ê³¼ ì €ì¥ ì™„ë£Œ</div>`
      );
    } catch (e) {
      console.error("ì €ì¥ ì˜ˆì™¸:", e);
    }
  }

  function showQuizFinished() {
    stopSpeech();
    audioBadge.style.display = "none";
    centerArea.classList.remove("sentence-mode");
    centerArea.innerHTML =
      '<div class="question-title">ëª¨ë“  ë¬¸ì œë¥¼ ë‹¤ í’€ì—ˆì–´ìš”!</div>' +
      '<div style="margin-top:10px;font-size:22px;color:#16a34a;font-weight:700;">100ì  ğŸ‰</div>' +
      '<div style="margin-top:12px;font-size:14px;color:#6b7280;">ë‹¤ì‹œ ì—°ìŠµí•˜ë ¤ë©´ "ë‹¤ì‹œ í’€ê¸°"ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>';
    setProgress(wordCount, wordCount);

    saveVocabResult();
  }

  function goNextQuestion(wrongIndex) {
    if (wrongIndex !== null && wrongIndex !== undefined) {
      nextRoundQueue.push(wrongIndex);
    }
    quizPos++;
    if (quizPos >= quizQueue.length) {
      if (nextRoundQueue.length > 0) {
        quizQueue = nextRoundQueue;
        nextRoundQueue = [];
        quizPos = 0;
        renderCurrent();
      } else {
        quizFinished = true;
        showQuizFinished();
      }
    } else {
      renderCurrent();
    }
  }

  // === TTS ìŒì„± ì²˜ë¦¬ ===
  let TTS_VOICES = [];
  function loadVoices() {
    const synth = window.speechSynthesis;
    if (!synth) return;
    const voices = synth.getVoices();
    if (voices && voices.length) TTS_VOICES = voices;
  }
  function getEnglishVoice() {
    const synth = window.speechSynthesis;
    if (!synth) return null;
    const voices = (TTS_VOICES && TTS_VOICES.length) ? TTS_VOICES : synth.getVoices();
    if (!voices || !voices.length) return null;
    const enVoices = voices.filter(v => v.lang && v.lang.toLowerCase().indexOf("en") === 0);
    if (!enVoices.length) return null;
    const preferredNames = ["Samantha", "Alex", "Daniel", "Karen", "Moira", "Google US English"];
    for (let i = 0; i < preferredNames.length; i++) {
      const found = enVoices.find(v => v.name.indexOf(preferredNames[i]) !== -1);
      if (found) return found;
    }
    return enVoices[0];
  }
  function speakWordTwice(word, cb) {
    const synth = window.speechSynthesis;
    if (!synth) { if (cb) cb(); return; }
    try { synth.cancel(); } catch (e) {}

    const u1 = new SpeechSynthesisUtterance(word);
    const u2 = new SpeechSynthesisUtterance(word);
    u1.lang = "en-US"; u2.lang = "en-US";
    const voice = getEnglishVoice();
    if (voice) { u1.voice = voice; u2.voice = voice; }
    u1.rate = 0.8; u2.rate = 0.8;

    u1.onend = function () { setTimeout(() => { try { synth.speak(u2); } catch (e) { if (cb) cb(); } }, 2000); };
    u2.onend = function () { if (cb) cb(); };
    try { synth.speak(u1); } catch (e) { if (cb) cb(); }
  }
  (function initTTS() {
    if (!("speechSynthesis" in window)) return;
    loadVoices();
    if (typeof window.speechSynthesis.onvoiceschanged !== "undefined") {
      window.speechSynthesis.onvoiceschanged = loadVoices;
    }
  })();

  // === í™”ë©´ ë Œë”ë§ ===
  function renderStudy() {
    stopSpeech();
    if (answerTimer) clearTimeout(answerTimer);
    centerArea.classList.remove("sentence-mode");

    if (!words.length) {
      centerArea.textContent = "ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.";
      setProgress(0, 0);
      return;
    }
    const item = words[currentIndex];
    audioBadge.style.display = "none";
    centerArea.innerHTML =
      '<div class="word-big">' + item.word + "</div>" +
      '<div class="meaning-big">' + item.meaning + "</div>" +
      '<div class="example-en">' + item.exampleEn + "</div>" +
      '<div class="example-ko">' + item.exampleKo + "</div>";
    setProgress(currentIndex + 1, wordCount);

    speakWordTwice(item.word, function () {
      if (currentMode !== "study") return;
      currentIndex = (currentIndex + 1) % wordCount;
      renderStudy();
    });
  }

  function formatChoiceText(txt) {
    const MAX_LEN = 9;
    if (txt.length < MAX_LEN) return txt;
    const commaIndex = txt.indexOf(",");
    if (commaIndex === -1) return txt;
    return txt.slice(0, commaIndex + 1) + "\n" + txt.slice(commaIndex + 1).trim();
  }

  function makeChoices(correctIdx) {
    const indices = [];
    for (let i = 0; i < wordCount; i++) { if (i !== correctIdx) indices.push(i); }
    for (let i = indices.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [indices[i], indices[j]] = [indices[j], indices[i]];
    }
    const pick = indices.slice(0, 3);
    const all = [correctIdx].concat(pick);
    for (let i = all.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [all[i], all[j]] = [all[j], all[i]];
    }
    return all;
  }

  function renderQuizCommon(type) {
    stopSpeech();
    if (answerTimer) clearTimeout(answerTimer);
    centerArea.classList.remove("sentence-mode");

    if (!words.length || (!quizQueue.length && !quizFinished)) resetQuizFlow();
    if (quizFinished) { showQuizFinished(); return; }

    const qIndex = quizQueue[quizPos];
    const item = words[qIndex];
    audioBadge.style.display = "none";
    centerArea.dataset.answered = "false";

    let questionHtml = "";
    if (type === "meaning") questionHtml = '<div class="question-title">' + item.word + "</div>";
    else if (type === "english") questionHtml = '<div class="question-title">' + item.meaning + "</div>";
    else if (type === "listening") questionHtml = '<div class="question-title listening-title">ë°œìŒì„ ë“£ê³  ë‹¨ì–´ë¥¼ ê³ ë¥´ì„¸ìš”.</div>';

    centerArea.innerHTML = questionHtml;
    const grid = document.createElement("div");
    grid.className = "choices-grid";
    centerArea.appendChild(grid);

    const choices = makeChoices(qIndex);
    function normalize(s) { return (s || "").replace(/\s/g, ""); }

    choices.forEach(function (idx) {
      const choice = words[idx];
      const btn = document.createElement("button");
      btn.className = "choice-btn";
      let btnText = (type === "meaning" || type === "listening") ? choice.meaning : choice.word;
      btn.innerText = formatChoiceText(btnText);
      grid.appendChild(btn);

      btn.onclick = function () {
        if (centerArea.dataset.answered === "true") return;
        centerArea.dataset.answered = "true";
        if (answerTimer) clearTimeout(answerTimer);

        const isCorrect = (idx === qIndex);
        if (isCorrect) btn.classList.add("correct");
        else {
          btn.classList.add("wrong");
          grid.childNodes.forEach(function (b) {
            const correctText = (type === "meaning" || type === "listening") ? item.meaning : item.word;
            if (normalize(b.innerText) === normalize(correctText)) b.classList.add("correct");
          });
        }
        setTimeout(function () { goNextQuestion(isCorrect ? null : qIndex); }, 900);
      };
    });

    setProgress(Math.min(quizPos + 1, wordCount), wordCount);
    if (type === "listening") speakWordTwice(item.word, null);

    answerTimer = setTimeout(function () {
      if (centerArea.dataset.answered === "false") {
        centerArea.dataset.answered = "true";
        goNextQuestion(qIndex);
      }
    }, 13000);
  }

  // â–¼â–¼â–¼ [ìˆ˜ì •ëœ í•¨ìˆ˜] ìë™ í•¨ìˆ˜ ì œê±°í•˜ê³ , ì˜¤ì§ { } ìˆ˜ë™ ì²´í¬ + ë‹¨ìˆœ ë‹¨ì–´ ì²´í¬ë§Œ ìˆ˜í–‰ â–¼â–¼â–¼
  function renderSentenceQuiz() {
    stopSpeech();
    if (answerTimer) clearTimeout(answerTimer);

    if (!words.length) { centerArea.textContent = "ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤."; setProgress(0, 0); return; }
    if (!sentenceOrder.length) resetSentenceFlow();
    if (sentencePos >= wordCount) { showQuizFinished(); return; }

    const item = words[sentenceOrder[sentencePos]];
    let displaySentence = "";
    let manualAnswer = null; 

  // 1. ìˆ˜ë™ ì§€ì • ì²´í¬ ([...] ëª¨ë‘ ê°ì§€)
  // ëŒ€ê´„í˜¸ [ ]ë¥¼ ì°¾ê¸° ìœ„í•´ ì—­ìŠ¬ë˜ì‹œ(\)ë¥¼ ë¶™ì¸ ì •ê·œì‹ìœ¼ë¡œ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
  const manualMatches = [...item.exampleEn.matchAll(/\[(.*?)\]/g)];

  if (manualMatches.length > 0) {
    // âœ… ëª¨ë“  ëŒ€ê´„í˜¸ ì•ˆì˜ í…ìŠ¤íŠ¸ë¥¼ ê³µë°± í•œ ì¹¸ìœ¼ë¡œ í•©ì³ì„œ í•˜ë‚˜ì˜ ì •ë‹µìœ¼ë¡œ ë§Œë“¦
    manualAnswer = manualMatches.map(m => m[1].trim()).join(" "); 
    
    // ëª¨ë“  [ë‚´ìš©]ì„ ë°‘ì¤„ë¡œ êµì²´
    displaySentence = item.exampleEn.replace(/\[.*?\]/g, 
      '<span style="display:inline-block; border-bottom: 2px solid #333; min-width: 50px; text-align:center; color: transparent; user-select: none;">______</span>'
    );
  } else {
    // ğŸ¤– ìë™ ëª¨ë“œ (Fallback): [ ]ê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ì²˜ëŸ¼ ë‹¨ì–´ë¥¼ ì°¾ì•„ì„œ ë¹ˆì¹¸ ìƒì„±
    const regex = new RegExp(item.word, "gi");
    if (regex.test(item.exampleEn)) {
        displaySentence = item.exampleEn.replace(regex, 
          '<span style="border-bottom:2px solid #333;color:transparent;user-select:none;">______</span>'
        );
    } else {
        displaySentence = item.exampleEn;
    }
  }

    centerArea.classList.add("sentence-mode");
    centerArea.innerHTML =
      '<div class="sentence-en">' + displaySentence + "</div>" +
      '<div class="sentence-ko">' + item.exampleKo + "</div>";

    const row = document.createElement("div");
    row.className = "sentence-row";
    
    const input = document.createElement("input");
    input.className = "sentence-input";
    input.autocomplete = "off";

    // íŒíŠ¸(Placeholder)
    if (manualAnswer) {
        input.placeholder = "ë¹ˆì¹¸ì— ì•Œë§ì€ ë§ì„ ì…ë ¥í•˜ì„¸ìš”";
    } else {
        input.placeholder = "ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”";
    }

    const btn = document.createElement("button");
    btn.className = "check-btn";
    btn.textContent = "í™•ì¸";
    
    row.appendChild(input);
    row.appendChild(btn);
    centerArea.appendChild(row);

    const hint = document.createElement("div");
    hint.className = "hint-text";
    centerArea.appendChild(hint);
    const res = document.createElement("div");
    res.className = "result-text";
    centerArea.appendChild(res);

    setProgress(sentencePos + 1, wordCount);

   // 1. í•¨ìˆ˜ ì‹œì‘ ë¶€ë¶„ì— ìƒíƒœ ë³€ìˆ˜ ì„ ì–¸ (ì ê¸ˆ ì¥ì¹˜)
    let isProcessing = false; 

    function check() {
      // 2. ì´ë¯¸ ì •ë‹µì„ ë§ì¶°ì„œ ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°€ëŠ” ì¤‘ì´ë©´ ë¬´ì‹œ
      if (isProcessing) return; 

      const val = input.value.trim().toLowerCase();
      if (!val) return;

      const headword = item.word.toLowerCase();
      const answerText = manualAnswer ? manualAnswer.toLowerCase() : "";

      let isCorrect = (val === headword);
      if (answerText && val === answerText) {
          isCorrect = true;
      }

      if (isCorrect) {
        // 3. ì •ë‹µì¸ ê²½ìš° ì¦‰ì‹œ ì ê¸ˆ í™œì„±í™”
        isProcessing = true; 
        input.style.borderColor = "#22c55e";
        res.textContent = "ì •ë‹µ! ğŸ‘";
        hint.textContent = "";
        
        // 0.9ì´ˆ ë’¤ì— ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°€ë©° í•¨ìˆ˜ê°€ ë‹¤ì‹œ ì‹¤í–‰ë  ë•Œ ë³€ìˆ˜ë„ ì´ˆê¸°í™”ë¨
        setTimeout(function () { 
            sentencePos++; 
            renderSentenceQuiz(); 
        }, 900);
      } else {
       input.style.borderColor = "#f97373";

        // âœ… manualAnswer(ìˆ˜ë™ ì •ë‹µ)ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì˜ ì²« ê¸€ì, ì—†ìœ¼ë©´ í‘œì œì–´ì˜ ì²« ê¸€ìë§Œ ì¶”ì¶œ
        const targetForHint = manualAnswer || item.word;
        const firstChar = targetForHint.trim().charAt(0);
        
        // ì •ë‹µ(item.word) ëŒ€ì‹  ì²« ê¸€ì íŒíŠ¸ë§Œ ë³´ì—¬ì¤Œ
        hint.textContent = `íŒíŠ¸: "${firstChar}"ë¡œ ì‹œì‘`;
        
        res.textContent = "ë‹¤ì‹œ í•´ë³´ì„¸ìš”.";
      }
    }
    btn.onclick = check;
    input.onkeydown = function (e) { if (e.key === "Enter") check(); };
    setTimeout(() => input.focus(), 100);
  }

  function renderCurrent() {
    modeTabs.forEach(function (t) {
      t.classList.toggle("active", t.dataset.mode === currentMode);
    });
    if (currentMode === "study") renderStudy();
    else if (currentMode === "meaning") renderQuizCommon("meaning");
    else if (currentMode === "english") renderQuizCommon("english");
    else if (currentMode === "listening") renderQuizCommon("listening");
    else if (currentMode === "sentence") renderSentenceQuiz();
  }

  modeTabs.forEach(function (tab) {
    tab.onclick = function () {
      stopSpeech();
      if (answerTimer) clearTimeout(answerTimer);
      currentMode = tab.dataset.mode;
      currentIndex = 0;
      if (AUTO_QUIZ_MODES.indexOf(currentMode) !== -1) resetQuizFlow();
      if (currentMode === "sentence") resetSentenceFlow();
      renderCurrent();
    };
  });

  modeResetBtn.onclick = function () {
    stopSpeech();
    if (answerTimer) clearTimeout(answerTimer);
    currentIndex = 0;
    resetQuizFlow();
    resetSentenceFlow();
    renderCurrent();
  };

  backToUnitsBtn.onclick = function () {
    window.history.back();
  };

  homeBtn.onclick = function () {
    window.location.href = "index.html";
  };

  // ì´ˆê¸° ë Œë”ë§
  renderCurrent();
</script>
</body>
</html>






