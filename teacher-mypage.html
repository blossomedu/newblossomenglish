<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì„ ìƒë‹˜ ê´€ë¦¬ í˜ì´ì§€ - Blossom English</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --blue: #00AEEF;
      --mint: #9FE6B8;
      --pink: #FF6FB5;
      --gray: #f3f4f6;
      --bg: var(--gray);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Pretendard Variable", sans-serif; }
    body { background: var(--bg); padding: 40px 20px; color: #111827; }
    .page { max-width: 1000px; margin: 0 auto; }

    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .brand { font-size: 24px; font-weight: 800; color: #1f2937; }

    .top-actions { display: flex; gap: 8px; align-items: center; }
    .link-btn {
      border-radius: 999px;
      border: none;
      padding: 8px 18px;
      font-size: 14px;
      cursor: pointer;
      background: var(--blue);
      color: #ffffff;
      white-space: nowrap;
    }
    #home-btn { background: var(--mint); color: #ffffff; }
    #back-btn { background: #e5e7eb; color: #374151; }
    #back-btn:hover { background: #d1d5db; }

    .section-card { background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .card-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #f3f4f6; color: #374151; }

    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 700px; }
    th { background: #f9fafb; color: #4b5563; font-weight: 600; text-align: left; padding: 12px; border-bottom: 1px solid #e5e7eb; }
    td { padding: 12px; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }

    .controls { display: flex; gap: 8px; margin-bottom: 16px; align-items: center; flex-wrap: wrap; }
    .input-ui { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; height: 38px; outline: none; }
    .btn-search { background: var(--blue); color: white; border: none; padding: 0 20px; border-radius: 6px; font-weight: 600; cursor: pointer; height: 38px; }
    .btn-search:hover { filter: brightness(0.9); }

    /* ë°˜ë³„ í•™ìƒ ë³´ê¸° ì¡°íšŒí•˜ê¸° ë²„íŠ¼(í•‘í¬) */
    .btn-search-pink { background: var(--pink); color: white; border: none; padding: 0 20px; border-radius: 6px; font-weight: 700; cursor: pointer; height: 38px; }
    .btn-search-pink:hover { filter: brightness(0.93); }

    #studentNameInput, #studentNameInput2 { width: 160px; }

    .badge { padding: 4px 8px; border-radius: 99px; font-size: 11px; font-weight: 700; display: inline-block; }
    .badge-done { background: #dcfce7; color: #166534; }
    .badge-yet { background: #f3f4f6; color: #9ca3af; }
    .badge-new { background: #fee2e2; color: #991b1b; }

    .assign-select { padding: 6px; border-radius: 4px; border: 1px solid #d1d5db; }

    .btn-save {
      padding: 6px 10px;
      background: var(--mint);
      color: #064e3b;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 800;
      font-size: 12px;
      margin-left: 4px;
    }
    .btn-save:hover { filter: brightness(0.95); }
    .btn-save:active { transform: translateY(0.5px); }

    /* === [ì¶”ê°€ë¨] ìˆ™ì œ ë“±ë¡ìš© ìŠ¤íƒ€ì¼ === */
    .hw-form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      align-items: end;
      margin-bottom: 20px;
    }
    .form-group label { display: block; font-size: 13px; color: #4b5563; margin-bottom: 4px; font-weight: 600; }
    .full-width { grid-column: 1 / -1; }
    
    .pill-group {
      display: inline-flex;
      background: #e5e7eb;
      border-radius: 999px;
      padding: 3px;
    }
    .type-btn {
      border: none;
      border-radius: 999px;
      padding: 6px 16px;
      font-size: 13px;
      cursor: pointer;
      background: transparent;
      color: #4b5563;
      font-weight: 700;
    }
    .type-btn.active {
      background: var(--blue);
      color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* ìˆ™ì œ ìƒì„¸ ì„¤ì • (ì–´íœ˜ìš©) */
    .config-area {
      background: #f9fafb;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #e5e7eb;
      margin-bottom: 16px;
      display: block; /* ê¸°ë³¸ì€ ë³´ì„ */
    }
    .config-title { font-size: 14px; font-weight: 700; color: #374151; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;}
    .preset-btns button {
      font-size: 11px; padding: 4px 8px; border: 1px solid #d1d5db; background: white; border-radius: 4px; cursor: pointer; margin-left: 4px;
    }
    .config-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    .config-item select { width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #d1d5db; }
    .config-item label { font-size: 12px; color: #6b7280; display: block; margin-bottom: 4px; }

    .btn-register-hw {
      background: var(--pink);
      color: white;
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 800;
      cursor: pointer;
    }
    .btn-register-hw:hover { filter: brightness(0.95); }

    @media (max-width: 600px) {
      .config-grid { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
<div class="page">
  <div class="header">
    <div class="brand">ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ ê´€ë¦¬ í˜ì´ì§€</div>
    <div class="top-actions">
      <button class="link-btn" id="back-btn" type="button" onclick="history.back()">ë’¤ë¡œ</button>
      <button class="link-btn" id="home-btn" type="button" onclick="window.location.href='index.html'">Home</button>
    </div>
  </div>

  <div class="section-card">
    <div class="card-title">ğŸ“ ì˜¨ë¼ì¸ ìˆ™ì œ ë§Œë“¤ê¸°</div>
    
    <div class="hw-form-grid">
      <div class="form-group">
        <label>ë°˜ ì„ íƒ</label>
        <select id="hwClassSelect" class="input-ui" style="width:100%;">
          <option value="">ë°˜ì„ ì„ íƒí•˜ì„¸ìš”</option>
        </select>
      </div>

      <div class="form-group">
        <label>ìˆ™ì œ ì¢…ë¥˜</label>
        <div class="pill-group">
          <button id="btn-type-vocab" class="type-btn active" onclick="setHwType('vocab')">ì–´íœ˜</button>
          <button id="btn-type-sentence" class="type-btn" onclick="setHwType('sentence')">ë¬¸ì¥</button>
        </div>
      </div>

      <div class="form-group full-width">
        <label>í•™ìŠµ ì„¸íŠ¸ (ì˜ˆ: 1-1, 1-2)</label>
        <input id="hwSets" type="text" class="input-ui" style="width:100%;" placeholder="ì˜ˆ: 1-1 ë˜ëŠ” 1-1, 1-2">
      </div>

      <div class="form-group">
        <label>ë§ˆê°ì¼</label>
        <input id="hwDue" type="date" class="input-ui" style="width:100%;">
      </div>
    </div>

    <div id="vocabConfigArea" class="config-area">
      <div class="config-title">
        <span>ëª©í‘œ íšŸìˆ˜ ì„¤ì •</span>
        <div class="preset-btns">
          <button onclick="setCfg(1,1,1,1)">ê¸°ë³¸ 4ì¢…</button>
          <button onclick="setCfg(0,0,0,3)">ë¹ˆì¹¸x3</button>
          <button onclick="setCfg(0,0,0,0)">ì´ˆê¸°í™”</button>
        </div>
      </div>
      <div class="config-grid">
        <div class="config-item">
          <label>ëœ» ì°¾ê¸°</label>
          <select id="cfgMeaning"><option value="0">0</option><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option></select>
        </div>
        <div class="config-item">
          <label>ì˜ì–´ ì°¾ê¸°</label>
          <select id="cfgEnglish"><option value="0">0</option><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option></select>
        </div>
        <div class="config-item">
          <label>ë“£ê³  ì°¾ê¸°</label>
          <select id="cfgListening"><option value="0">0</option><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option></select>
        </div>
        <div class="config-item">
          <label>ë¬¸ì¥ ë¹ˆì¹¸</label>
          <select id="cfgSentence"><option value="0">0</option><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option></select>
        </div>
      </div>
    </div>

    <button class="btn-register-hw" onclick="registerHomework()">ìˆ™ì œ ë“±ë¡í•˜ê¸°</button>
  </div>

  <div class="section-card">
    <div class="card-title">ğŸ“… ë‚ ì§œë³„ ìˆ™ì œ ê²€ì‚¬</div>
    <div class="controls">
      <select id="classSelect" class="input-ui">
        <option value="">ë°˜ ì„ íƒ</option>
      </select>

      <input
        type="text"
        id="studentNameInput"
        class="input-ui"
        placeholder="í•™ìƒ ì´ë¦„ (ì„ íƒ)"
      >

      <input type="date" id="dateInput" class="input-ui">

      <button class="btn-search" onclick="loadHomework()">ì¡°íšŒí•˜ê¸°</button>
    </div>

    <div class="table-wrap">
      <table id="homeworkTable">
        <thead>
          <tr>
            <th width="15%">ì´ë¦„</th>
            <th width="15%">ìƒíƒœ</th>
            <th width="20%">ì ìˆ˜ / ëª¨ë“œ</th>
            <th width="20%">ë‹¨ì›(Unit)</th>
            <th width="30%">ì œì¶œ ì‹œê°„</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="5" style="text-align:center; padding:20px;">ë°˜ ë˜ëŠ” ì´ë¦„, ë‚ ì§œë¥¼ ì„ íƒí•˜ê³  [ì¡°íšŒí•˜ê¸°]ë¥¼ ëˆ„ë¥´ì„¸ìš”.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="section-card">
    <div class="card-title">ğŸ‘¥ ë°˜ë³„ í•™ìƒ ë³´ê¸°</div>
    <div class="controls">
      <select id="classSelect2" class="input-ui">
        <option value="">ë°˜ ì„ íƒ</option>
      </select>

      <input
        type="text"
        id="studentNameInput2"
        class="input-ui"
        placeholder="í•™ìƒ ì´ë¦„ (ì„ íƒ)"
      >

      <button class="btn-search-pink" onclick="loadStudentsByClass()">ì¡°íšŒí•˜ê¸°</button>
    </div>

    <div class="table-wrap">
      <table id="studentsTable">
        <thead>
          <tr>
            <th width="14%">ì´ë¦„</th>
            <th width="16%">ì•„ì´ë””</th>
            <th width="18%">ì—°ë½ì²˜</th>
            <th width="14%">ë°˜</th>
            <th width="14%">ê°€ì…ì¼</th>
            <th width="14%">ë°˜ ë³€ê²½</th>
            <th width="10%">ì €ì¥</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="7" style="text-align:center; padding:20px;">ë°˜ ë˜ëŠ” ì´ë¦„ìœ¼ë¡œ í•™ìƒì„ ì¡°íšŒí•  ìˆ˜ ìˆì–´ìš”.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="section-card">
    <div class="card-title">ğŸŒ± ì‹ ì…ìƒ ë°˜ ë°°ì •í•˜ê¸°</div>
    <div class="table-wrap">
      <table id="newStudentTable">
        <thead>
          <tr><th>ì´ë¦„</th><th>ì•„ì´ë””</th><th>ì—°ë½ì²˜</th><th>ìƒíƒœ</th><th>ë°˜ ì„ íƒ</th><th>ì €ì¥</th></tr>
        </thead>
        <tbody>
          <tr><td colspan="6" style="text-align:center; padding:20px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const SUPABASE_URL = "https://bpdisxjhhibrgfpvtlmv.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZGlzeGpoaGlicmdmcHZ0bG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTkxODQsImV4cCI6MjA3OTUzNTE4NH0.jDZ6BGirOPuWUnt4ykjhng4PLft2ZjBuYAFzApUnlYU";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let classList = [];
  let lastStudentsQuery = { classId: "", nameFilter: "" };
  let currentHwType = "vocab"; // ìˆ™ì œ ë“±ë¡ ê¸°ë³¸ê°’

  document.addEventListener("DOMContentLoaded", async () => {
    // ë‚ ì§œ ê¸°ë³¸ê°’ (ì˜¤ëŠ˜)
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    
    // ì¡°íšŒìš© ë‚ ì§œ
    document.getElementById("dateInput").value = `${yyyy}-${mm}-${dd}`;
    // ë“±ë¡ìš© ë‚ ì§œ (ë‚´ì¼ë¡œ ì„¤ì •í•´ë‘ë©´ í¸í•¨ - ì„ íƒì‚¬í•­)
    document.getElementById("hwDue").value = `${yyyy}-${mm}-${dd}`;

    await loadClasses();
    loadNewStudents();
  });

  // === 0. ìˆ™ì œ ë“±ë¡ ê´€ë ¨ í•¨ìˆ˜ë“¤ ===
  function setHwType(type) {
    currentHwType = type;
    const btnVocab = document.getElementById("btn-type-vocab");
    const btnSentence = document.getElementById("btn-type-sentence");
    const configArea = document.getElementById("vocabConfigArea");

    if (type === "vocab") {
      btnVocab.classList.add("active");
      btnSentence.classList.remove("active");
      configArea.style.display = "block"; // ì–´íœ˜ ì„¤ì • ë³´ì´ê¸°
    } else {
      btnSentence.classList.add("active");
      btnVocab.classList.remove("active");
      configArea.style.display = "none"; // ë¬¸ì¥ì€ ì„¤ì • ìˆ¨ê¸°ê¸°
    }
  }

  function setCfg(m, e, l, s) {
    document.getElementById("cfgMeaning").value = m;
    document.getElementById("cfgEnglish").value = e;
    document.getElementById("cfgListening").value = l;
    document.getElementById("cfgSentence").value = s;
  }

  async function registerHomework() {
    const classId = document.getElementById("hwClassSelect").value;
    const sets = document.getElementById("hwSets").value.trim();
    const due = document.getElementById("hwDue").value;

    if (!classId) return alert("ë°˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    if (!sets) return alert("í•™ìŠµ ì„¸íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    if (!due) return alert("ë§ˆê°ì¼ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.");

    // ë ˆë²¨ ì¶”ì¶œ (ë‹¨ìˆœíˆ ì²« ì…ë ¥ê°’ ì•ìë¦¬)
    const firstSet = sets.split(",")[0].trim();
    const levelMatch = firstSet.match(/^(\d+)-/);
    const level = levelMatch ? parseInt(levelMatch[1]) : 0;

    const payload = {
      class_id: classId,
      level: level,
      set_numbers: sets,
      due_date: due,
      created_at: new Date().toISOString()
    };

    // ì–´íœ˜ì¼ ê²½ìš° ì„¤ì •ê°’ ì¶”ê°€
    if (currentHwType === "vocab") {
      payload.tasks = {
        meaning: parseInt(document.getElementById("cfgMeaning").value),
        english: parseInt(document.getElementById("cfgEnglish").value),
        listening: parseInt(document.getElementById("cfgListening").value),
        sentence: parseInt(document.getElementById("cfgSentence").value)
      };
    }

    const tableName = currentHwType === "vocab" ? "vocab_homework" : "sentence_homework";

    try {
      const { error } = await supabaseClient.from(tableName).insert([payload]);

      if (error) throw error;

      alert("âœ… ìˆ™ì œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
      // ì…ë ¥ì°½ ì´ˆê¸°í™”
      document.getElementById("hwSets").value = "";
      // ë°˜, ë‚ ì§œëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ (ì—°ì† ë“±ë¡ í¸ì˜ì„±)
    } catch (err) {
      console.error("ë“±ë¡ ì‹¤íŒ¨:", err);
      alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
    }
  }

  // === ê¸°ì¡´ ë¡œì§ ===

  async function loadClasses() {
    const { data, error } = await supabaseClient.from('classes').select('*').order('name');

    // [ì¶”ê°€] ìˆ™ì œ ë“±ë¡ìš© ë“œë¡­ë‹¤ìš´
    const selectHw = document.getElementById("hwClassSelect");
    const select1 = document.getElementById("classSelect");
    const select2 = document.getElementById("classSelect2");
    
    if (selectHw) selectHw.innerHTML = '<option value="">ë°˜ì„ ì„ íƒí•˜ì„¸ìš”</option>';
    if (select1) select1.innerHTML = '<option value="">ë°˜ ì„ íƒ</option>';
    if (select2) select2.innerHTML = '<option value="">ë°˜ ì„ íƒ</option>';

    if (error) {
      console.error("ë°˜ ëª©ë¡ ì—ëŸ¬:", error);
      return;
    }

    classList = data;

    data.forEach(cls => {
      // ìˆ™ì œ ë“±ë¡ìš©
      if (selectHw) {
        const opt = document.createElement("option");
        opt.value = cls.id;
        opt.textContent = cls.name;
        selectHw.appendChild(opt);
      }
      
      // ê¸°ì¡´ ì¡°íšŒìš© 1
      if (select1) {
        const opt1 = document.createElement("option");
        opt1.value = cls.id;
        opt1.textContent = cls.name;
        select1.appendChild(opt1);
      }

      // ê¸°ì¡´ ì¡°íšŒìš© 2
      if (select2) {
        const opt2 = document.createElement("option");
        opt2.value = cls.id;
        opt2.textContent = cls.name;
        select2.appendChild(opt2);
      }
    });
  }

  async function loadNewStudents() {
    const tbody = document.querySelector("#newStudentTable tbody");

    const { data, error } = await supabaseClient
      .from('students')
      .select('*')
      .is('class_id', null)
      .order('created_at', { ascending: false });

    if (error) {
      console.error(error);
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px; color:#999;">ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜</td></tr>`;
      return;
    }

    tbody.innerHTML = "";
    if (!data || data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px; color:#999;">ì‹ ê·œ í•™ìƒ(ë¯¸ë°°ì •)ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
      return;
    }

    data.forEach(student => {
      const tr = document.createElement("tr");

      let options = '<option value="">ì„ íƒ</option>';
      classList.forEach(c => {
        options += `<option value="${c.id}">${c.name}</option>`;
      });

      tr.innerHTML = `
        <td style="font-weight:bold;">${student.name}</td>
        <td>${student.login_id}</td>
        <td>${student.parent_phone || '-'}</td>
        <td><span class="badge badge-new">ë¯¸ë°°ì •</span></td>
        <td><select class="assign-select" id="sel-${student.id}">${options}</select></td>
        <td><button class="btn-save" onclick="saveClass('${student.id}')">ì €ì¥</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function saveClass(studentId) {
    const sel = document.getElementById(`sel-${studentId}`);
    if (!sel || !sel.value) { alert("ë°˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

    const { error } = await supabaseClient
      .from('students')
      .update({ class_id: sel.value })
      .eq('id', studentId);

    if (error) {
      alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
      return;
    }

    alert("ë°˜ ë°°ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    loadNewStudents();
    if (lastStudentsQuery.classId || lastStudentsQuery.nameFilter) {
      loadStudentsByClass(true);
    }
  }

  async function loadStudentsByClass(isRerun = false) {
    const classId = document.getElementById("classSelect2").value;
    const nameFilter = document.getElementById("studentNameInput2").value.trim();
    const tbody = document.querySelector("#studentsTable tbody");

    if (!classId && !nameFilter) {
      alert("ë°˜ ë˜ëŠ” í•™ìƒ ì´ë¦„ ì¤‘ í•˜ë‚˜ëŠ” ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    if (!isRerun) {
      lastStudentsQuery = { classId, nameFilter };
    }

    const activeClassId = isRerun ? lastStudentsQuery.classId : classId;
    const activeNameFilter = isRerun ? lastStudentsQuery.nameFilter : nameFilter;

    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px;">ì¡°íšŒ ì¤‘...</td></tr>`;

    try {
      let query = supabaseClient
        .from('students')
        .select('id, name, login_id, parent_phone, class_id, created_at')
        .order('name');

      if (activeClassId) query = query.eq('class_id', activeClassId);
      if (activeNameFilter) query = query.ilike('name', `%${activeNameFilter}%`);

      const { data: students, error } = await query;
      if (error) throw error;

      tbody.innerHTML = "";

      if (!students || students.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px;">ì¡°ê±´ì— ë§ëŠ” í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
        return;
      }

      const classNameById = new Map(classList.map(c => [c.id, c.name]));

      students.forEach(s => {
        const tr = document.createElement("tr");
        const className = s.class_id ? (classNameById.get(s.class_id) || s.class_id) : 'ë¯¸ë°°ì •';
        const joinDate = s.created_at ? new Date(s.created_at).toLocaleDateString('ko-KR') : '-';

        let options = `<option value="">ë¯¸ë°°ì •</option>`;
        classList.forEach(c => {
          const selected = s.class_id === c.id ? "selected" : "";
          options += `<option value="${c.id}" ${selected}>${c.name}</option>`;
        });

        tr.innerHTML = `
          <td style="font-weight:700;">${s.name}</td>
          <td>${s.login_id || '-'}</td>
          <td>${s.parent_phone || '-'}</td>
          <td>${className}</td>
          <td>${joinDate}</td>
          <td>
            <select class="assign-select" id="cls-${s.id}">
              ${options}
            </select>
          </td>
          <td>
            <button class="btn-save" onclick="updateStudentClass('${s.id}')">ì €ì¥</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

    } catch (err) {
      console.error(err);
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px;">ì˜¤ë¥˜: ${err.message}</td></tr>`;
    }
  }

  async function updateStudentClass(studentId) {
    const sel = document.getElementById(`cls-${studentId}`);
    if (!sel) return;

    const newClassId = sel.value ? sel.value : null;

    const { error } = await supabaseClient
      .from('students')
      .update({ class_id: newClassId })
      .eq('id', studentId);

    if (error) {
      alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
      return;
    }

    alert("ë°˜ ë³€ê²½ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    loadNewStudents();
    loadStudentsByClass(true);
  }

  async function loadHomework() {
    const classId = document.getElementById("classSelect").value;
    const dateVal = document.getElementById("dateInput").value;
    const nameFilter = document.getElementById("studentNameInput").value.trim();
    const tbody = document.querySelector("#homeworkTable tbody");

    if (!classId && !nameFilter) {
      alert("ë°˜ ë˜ëŠ” í•™ìƒ ì´ë¦„ ì¤‘ í•˜ë‚˜ëŠ” ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    if (!dateVal) {
      alert("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }

    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px;">ì¡°íšŒ ì¤‘...</td></tr>`;

    try {
      let query = supabaseClient
        .from('students')
        .select('id, name, login_id')
        .order('name');

      if (classId) query = query.eq('class_id', classId);
      if (nameFilter) query = query.ilike('name', `%${nameFilter}%`);

      const { data: students, error: studentError } = await query;
      if (studentError) throw studentError;

      if (!students || students.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px;">ì¡°ê±´ì— ë§ëŠ” í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
        return;
      }

      const loginIds = students.map(s => s.login_id);

      const start = dateVal + " 00:00:00";
      const end   = dateVal + " 23:59:59";

      const { data: results, error: resultError } = await supabaseClient
        .from('vocab_results')
        .select('*')
        .in('student_login_id', loginIds)
        .gte('submitted_at', start)
        .lte('submitted_at', end)
        .order('submitted_at', { ascending: false });

      if (resultError) throw resultError;

      tbody.innerHTML = "";

      students.forEach(std => {
        const myResults = (results || []).filter(r => r.student_login_id === std.login_id);

        if (myResults.length > 0) {
          myResults.forEach(res => {
            const tr = document.createElement("tr");
            const timeStr = new Date(res.submitted_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

            tr.innerHTML = `
              <td style="font-weight:700;">${std.name}</td>
              <td><span class="badge badge-done">ì œì¶œ ì™„ë£Œ</span></td>
              <td>${res.correct_count}ì  <span style="color:#888; font-size:12px;">(${res.mode})</span></td>
              <td style="font-weight:bold; color:var(--blue);">${res.unit || '-'}</td>
              <td>${timeStr}</td>
            `;
            tbody.appendChild(tr);
          });
        } else {
          const tr = document.createElement("tr");
          tr.style.backgroundColor = "#fff5f5";
          tr.innerHTML = `
            <td>${std.name}</td>
            <td><span class="badge badge-yet">ë¯¸ì œì¶œ</span></td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
          `;
          tbody.appendChild(tr);
        }
      });

    } catch (err) {
      console.error(err);
      tbody.innerHTML = `<tr><td colspan="5">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}</td></tr>`;
    }
  }
</script>
</body>
</html>
