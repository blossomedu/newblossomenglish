<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì„ ìƒë‹˜ ê´€ë¦¬ í˜ì´ì§€ - Blossom English</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* === [ê³µí†µ ìŠ¤íƒ€ì¼] === */
    :root {
      --blue: #00AEEF;
      --mint: #9FE6B8;
      --pink: #FF6FB5;
      --gray: #f3f4f6;
      --bg: var(--gray);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Pretendard Variable", sans-serif; }
    body { background: var(--bg); padding: 40px 20px; color: #111827; }
    .page { max-width: 1000px; margin: 0 auto; }

    /* í—¤ë” */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .brand { font-size: 24px; font-weight: 800; color: #1f2937; }
    .top-actions { display: flex; gap: 8px; }
    .link-btn {
      border-radius: 999px; border: none; padding: 8px 18px; font-size: 14px; cursor: pointer;
      background: var(--blue); color: #fff; font-weight: 600;
    }
    #home-btn { background: var(--mint); }
    #back-btn { background: #e5e7eb; color: #374151; }

    /* ì¹´ë“œ ë°•ìŠ¤ */
    .section-card { background: white; border-radius: 20px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .card-title { font-size: 18px; font-weight: 800; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #f3f4f6; color: #374151; }

    /* ì…ë ¥ UI ê³µí†µ */
    .input-ui { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; height: 42px; outline: none; }
    .input-ui:focus { border-color: var(--blue); }
    .btn-search, .btn-search-pink {
      height: 42px; padding: 0 20px; border-radius: 8px; color: white; border: none; font-weight: 700; cursor: pointer;
    }
    .btn-search { background: var(--blue); }
    .btn-search-pink { background: var(--pink); }

    /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 700px; }
    th { background: #f9fafb; color: #6b7280; font-weight: 700; text-align: left; padding: 12px; border-bottom: 1px solid #e5e7eb; }
    td { padding: 12px; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
    
    .badge { padding: 4px 8px; border-radius: 99px; font-size: 11px; font-weight: 700; }
    .badge-done { background: #dcfce7; color: #166534; } /* ì´ˆë¡ */
    .badge-yet { background: #fee2e2; color: #991b1b; }  /* ë¹¨ê°• */
    .badge-new { background: #fef3c7; color: #92400e; }  /* ë…¸ë‘ */

    .btn-save { padding: 6px 12px; background: var(--mint); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 12px; }

    /* === [âœ¨í•µì‹¬] ìˆ™ì œ ë§Œë“¤ê¸° ìŠ¤íƒ€ì¼ (í•™ìƒ í˜ì´ì§€ ì´ì‹) === */
    .hw-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 16px; align-items: end; }
    .form-group label { display: block; font-size: 13px; font-weight: 700; color: #4b5563; margin-bottom: 6px; }
    .full-width { grid-column: 1 / -1; }

    /* ìˆ™ì œ ì¢…ë¥˜ í† ê¸€ ë²„íŠ¼ */
    .pill-group { display: inline-flex; background: #f3f4f6; border-radius: 99px; padding: 4px; gap: 4px; }
    .type-btn { border: none; border-radius: 99px; padding: 6px 16px; font-size: 13px; cursor: pointer; background: transparent; color: #6b7280; font-weight: 700; }
    .type-btn.active { background: var(--blue); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

    /* ì„¤ì • ë°•ìŠ¤ (íšŒìƒ‰ ë°°ê²½) */
    .vocab-config { background: #f9fafb; border-radius: 16px; padding: 16px; border: 1px solid #e5e7eb; margin-bottom: 16px; display: block; }
    
    /* í”„ë¦¬ì…‹ ë²„íŠ¼ (ê¸°ë³¸ 4ì¢… ë“±) */
    .preset-row { display: flex; gap: 8px; margin-bottom: 12px; }
    .preset-btn { 
      border: 1px solid #d1d5db; background: #fff; color: #374151; 
      font-size: 12px; font-weight: 700; padding: 6px 12px; border-radius: 99px; cursor: pointer; 
    }
    .preset-btn:hover { background: #f3f4f6; }

    /* ë“œë¡­ë‹¤ìš´ ê·¸ë¦¬ë“œ */
    .mini-select-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .mini-item { display: flex; align-items: center; justify-content: space-between; background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 8px 12px; }
    .mini-item.off { opacity: 0.5; background: #f3f4f6; }
    .mini-label { font-size: 13px; font-weight: 800; color: #1f2937; }
    .mini-select { border: 1px solid #d1d5db; border-radius: 99px; padding: 4px 8px; font-size: 13px; font-weight: 700; outline: none; text-align: center; }

    /* ë“±ë¡ ë²„íŠ¼ */
    .btn-register-hw { width: 100%; background: var(--pink); color: white; padding: 14px; border: none; border-radius: 12px; font-size: 16px; font-weight: 800; cursor: pointer; margin-top: 10px; }
    .btn-register-hw:hover { filter: brightness(0.95); }

    @media (max-width: 600px) { .mini-select-row { grid-template-columns: 1fr 1fr; } }
  </style>
</head>

<body>
<div class="page">
  <div class="header">
    <div class="brand">ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ ê´€ë¦¬ í˜ì´ì§€</div>
    <div class="top-actions">
      <button class="link-btn" id="back-btn" onclick="history.back()">ë’¤ë¡œ</button>
      <button class="link-btn" id="home-btn" onclick="window.location.href='index.html'">Home</button>
    </div>
  </div>

  <div class="section-card">
    <div class="card-title">ğŸ“ ì˜¨ë¼ì¸ ìˆ™ì œ ë§Œë“¤ê¸°</div>
    
    <div class="hw-grid">
      <div class="form-group">
        <label>ë°˜ ì„ íƒ</label>
        <select id="hwClassSelect" class="input-ui" style="width:100%;">
          <option value="">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>
        </select>
      </div>

      <div class="form-group">
        <label>ìˆ™ì œ ì¢…ë¥˜</label>
        <div class="pill-group">
          <button id="btn-vocab" class="type-btn active" onclick="setHwType('vocab')">ì–´íœ˜</button>
          <button id="btn-sentence" class="type-btn" onclick="setHwType('sentence')">ë¬¸ì¥</button>
        </div>
      </div>

      <div class="form-group">
        <label>ë§ˆê°ì¼</label>
        <input id="hwDue" type="date" class="input-ui" style="width:100%;">
      </div>

      <div class="form-group full-width">
        <label>í•™ìŠµ ì„¸íŠ¸ (ì˜ˆ: 1-1, 1-2)</label>
        <input id="hwSets" type="text" class="input-ui" style="width:100%;" placeholder="ì˜ˆ: 1-1 ë˜ëŠ” 1-1, 1-2">
      </div>
    </div>

    <div id="vocabConfigArea" class="vocab-config">
      <div class="preset-row">
        <button class="preset-btn" onclick="applyPreset(1,1,1,1)">ê¸°ë³¸ 4ì¢…</button>
        <button class="preset-btn" onclick="applyPreset(0,0,0,3)">ë¬¸ì¥ ë¹ˆì¹¸ Ã—3</button>
        <button class="preset-btn" onclick="applyPreset(0,0,0,0)">ì´ˆê¸°í™”</button>
      </div>

      <div class="mini-select-row">
        <div class="mini-item" id="box-meaning">
          <span class="mini-label">ëœ» ì°¾ê¸°</span>
          <select id="sel-meaning" class="mini-select" onchange="updateUI()">
            <option value="0">0</option><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option>
          </select>
        </div>
        <div class="mini-item" id="box-english">
          <span class="mini-label">ì˜ì–´ ì°¾ê¸°</span>
          <select id="sel-english" class="mini-select" onchange="updateUI()">
            <option value="0">0</option><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option>
          </select>
        </div>
        <div class="mini-item" id="box-listening">
          <span class="mini-label">ë“£ê³  ì°¾ê¸°</span>
          <select id="sel-listening" class="mini-select" onchange="updateUI()">
            <option value="0">0</option><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option>
          </select>
        </div>
        <div class="mini-item" id="box-sentence">
          <span class="mini-label">ë¬¸ì¥ ë¹ˆì¹¸</span>
          <select id="sel-sentence" class="mini-select" onchange="updateUI()">
            <option value="0">0</option><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option>
          </select>
        </div>
      </div>
    </div>

    <button class="btn-register-hw" onclick="registerHomework()">ìˆ™ì œ ë“±ë¡í•˜ê¸°</button>
  </div>

  <div class="section-card">
    <div class="card-title">ğŸ“… ë‚ ì§œë³„ ìˆ™ì œ ê²€ì‚¬</div>
    <div class="hw-grid" style="grid-template-columns: 150px 150px 1fr 120px; align-items: center;">
      <select id="classSelect" class="input-ui"><option value="">ë°˜ ì„ íƒ</option></select>
      <input type="text" id="studentNameInput" class="input-ui" placeholder="ì´ë¦„ ê²€ìƒ‰">
      <input type="date" id="dateInput" class="input-ui">
      <button class="btn-search" onclick="loadHomework()">ì¡°íšŒ</button>
    </div>
    <div class="table-wrap">
      <table id="homeworkTable">
        <thead>
          <tr><th width="15%">ì´ë¦„</th><th width="15%">ìƒíƒœ</th><th width="20%">ì ìˆ˜ / ëª¨ë“œ</th><th width="20%">ë‹¨ì›</th><th width="30%">ì‹œê°„</th></tr>
        </thead>
        <tbody>
          <tr><td colspan="5" style="text-align:center; padding:20px;">ì¡°ê±´ì„ ì„ íƒí•˜ê³  ì¡°íšŒë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="section-card">
    <div class="card-title">ğŸ‘¥ í•™ìƒ ê´€ë¦¬ (ë°˜ ë³€ê²½)</div>
    <div class="hw-grid" style="grid-template-columns: 150px 1fr 120px; align-items: center;">
      <select id="classSelect2" class="input-ui"><option value="">ë°˜ ì„ íƒ</option></select>
      <input type="text" id="studentNameInput2" class="input-ui" placeholder="ì´ë¦„ ê²€ìƒ‰">
      <button class="btn-search-pink" onclick="loadStudentsByClass()">ì¡°íšŒ</button>
    </div>
    <div class="table-wrap">
      <table id="studentsTable">
        <thead>
          <tr><th>ì´ë¦„</th><th>ì•„ì´ë””</th><th>ì—°ë½ì²˜</th><th>í˜„ì¬ ë°˜</th><th>ë°˜ ë³€ê²½</th><th>ì €ì¥</th></tr>
        </thead>
        <tbody>
          <tr><td colspan="6" style="text-align:center; padding:20px;">ë°˜ ë˜ëŠ” ì´ë¦„ì„ ê²€ìƒ‰í•´ì£¼ì„¸ìš”.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="section-card">
    <div class="card-title">ğŸŒ± ì‹ ì…ìƒ ë°°ì • (ë¯¸ë°°ì • ëª©ë¡)</div>
    <div class="table-wrap">
      <table id="newStudentTable">
        <thead>
          <tr><th>ì´ë¦„</th><th>ì•„ì´ë””</th><th>ì—°ë½ì²˜</th><th>ìƒíƒœ</th><th>ë°˜ ì„ íƒ</th><th>ì €ì¥</th></tr>
        </thead>
        <tbody>
          <tr><td colspan="6" style="text-align:center; padding:20px;">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // 1. Supabase ì´ˆê¸°í™” (ì„ ìƒë‹˜ í‚¤ í™•ì¸ë¨)
  const SUPABASE_URL = "https://bpdisxjhhibrgfpvtlmv.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZGlzeGpoaGlicmdmcHZ0bG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTkxODQsImV4cCI6MjA3OTUzNTE4NH0.jDZ6BGirOPuWUnt4ykjhng4PLft2ZjBuYAFzApUnlYU";
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentHwType = 'vocab'; // í˜„ì¬ ìˆ™ì œ ëª¨ë“œ (vocab / sentence)
  let classList = []; // ë°˜ ëª©ë¡ ì €ì¥ìš©

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
  document.addEventListener("DOMContentLoaded", async () => {
    console.log("í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ");
    
    // ë‚ ì§œ ê¸°ë³¸ê°’ ì„¸íŒ… (ì˜¤ëŠ˜ ë‚ ì§œ)
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("dateInput").value = today;
    document.getElementById("hwDue").value = today;

    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    await loadClasses();     // ë°˜ ëª©ë¡
    loadNewStudents();       // ì‹ ì…ìƒ ëª©ë¡
    updateUI();              // ì„¤ì •ì°½ UI ì´ˆê¸°í™”
  });

  /* =========================================
     [ê¸°ëŠ¥ 1] ìˆ™ì œ ë“±ë¡ & ì„¤ì • (í•™ìƒ í˜ì´ì§€ ì´ì‹ë¨)
     ========================================= */
  
  // ìˆ™ì œ íƒ€ì… ë³€ê²½ (ì–´íœ˜ <-> ë¬¸ì¥)
  function setHwType(type) {
    currentHwType = type;
    const configArea = document.getElementById("vocabConfigArea");
    const btnVocab = document.getElementById("btn-vocab");
    const btnSentence = document.getElementById("btn-sentence");

    if (type === 'vocab') {
      configArea.style.display = 'block'; // ì–´íœ˜ë©´ ì„¤ì •ì°½ ë³´ì„
      btnVocab.classList.add('active');
      btnSentence.classList.remove('active');
    } else {
      configArea.style.display = 'none';  // ë¬¸ì¥ì´ë©´ ì„¤ì •ì°½ ìˆ¨ê¹€
      btnSentence.classList.add('active');
      btnVocab.classList.remove('active');
    }
  }

  // í”„ë¦¬ì…‹ ë²„íŠ¼ í´ë¦­ ì‹œ (1,1,1,1 ë“±)
  function applyPreset(m, e, l, s) {
    document.getElementById("sel-meaning").value = m;
    document.getElementById("sel-english").value = e;
    document.getElementById("sel-listening").value = l;
    document.getElementById("sel-sentence").value = s;
    updateUI(); // UI ê°±ì‹  (0ì¸ í•­ëª© íë¦¬ê²Œ)
  }

  // ì„¤ì •ê°’ 0ì¼ ë•Œ íë¦¬ê²Œ ì²˜ë¦¬í•˜ëŠ” íš¨ê³¼
  function updateUI() {
    const m = document.getElementById("sel-meaning").value;
    const e = document.getElementById("sel-english").value;
    const l = document.getElementById("sel-listening").value;
    const s = document.getElementById("sel-sentence").value;

    document.getElementById("box-meaning").classList.toggle("off", m == 0);
    document.getElementById("box-english").classList.toggle("off", e == 0);
    document.getElementById("box-listening").classList.toggle("off", l == 0);
    document.getElementById("box-sentence").classList.toggle("off", s == 0);
  }

  // [ìˆ™ì œ ë“±ë¡] ë²„íŠ¼ í´ë¦­ ì‹œ DB ì €ì¥
  async function registerHomework() {
    const classId = document.getElementById("hwClassSelect").value;
    const sets = document.getElementById("hwSets").value.trim();
    const due = document.getElementById("hwDue").value;

    if (!classId) return alert("ë°˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    if (!sets) return alert("í•™ìŠµ ì„¸íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 1-1)");
    if (!due) return alert("ë§ˆê°ì¼ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.");

    // ë ˆë²¨ ì¶”ì¶œ (ë‹¨ìˆœíˆ ì²« ê¸€ì íŒŒì‹±)
    // ì˜ˆ: "1-1, 1-2" -> 1ë‹¨ê³„ë¡œ ì¸ì‹
    const firstSet = sets.split(",")[0].trim();
    const levelMatch = firstSet.match(/^(\d+)-/);
    const level = levelMatch ? parseInt(levelMatch[1]) : 0;

    const payload = {
      class_id: classId,
      level: level,
      set_numbers: sets,
      due_date: due,
      created_at: new Date().toISOString()
    };

    // ì–´íœ˜ ìˆ™ì œë¼ë©´ tasks(ëª©í‘œ íšŸìˆ˜)ë„ ê°™ì´ ì €ì¥
    if (currentHwType === 'vocab') {
      payload.tasks = {
        meaning: parseInt(document.getElementById("sel-meaning").value),
        english: parseInt(document.getElementById("sel-english").value),
        listening: parseInt(document.getElementById("sel-listening").value),
        sentence: parseInt(document.getElementById("sel-sentence").value)
      };
    }

    const tableName = currentHwType === 'vocab' ? 'vocab_homework' : 'sentence_homework';

    try {
      const { error } = await client.from(tableName).insert([payload]);
      
      if (error) throw error;

      alert("âœ… ìˆ™ì œê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
      document.getElementById("hwSets").value = ""; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
    } catch (err) {
      console.error(err);
      alert("ë“±ë¡ ì‹¤íŒ¨: " + err.message);
    }
  }

  /* =========================================
     [ê¸°ëŠ¥ 2,3,4] ê¸°ì¡´ ì¡°íšŒ ë° ê´€ë¦¬ ê¸°ëŠ¥
     ========================================= */

  // ë°˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (3ê°œì˜ ë“œë¡­ë‹¤ìš´ì— ëª¨ë‘ ì±„ì›€)
  async function loadClasses() {
    const { data, error } = await client.from('classes').select('*').order('name');
    if (error) { console.error("ë°˜ ë¡œë”© ì‹¤íŒ¨", error); return; }

    classList = data; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ë‚˜ì¤‘ì— ì´ë¦„ ì°¾ê¸°ìš©)

    // ì±„ìš¸ ë“œë¡­ë‹¤ìš´ë“¤
    const targets = [
      document.getElementById("hwClassSelect"), // ìˆ™ì œ ë“±ë¡ìš©
      document.getElementById("classSelect"),   // ìˆ™ì œ ì¡°íšŒìš©
      document.getElementById("classSelect2")   // í•™ìƒ ê´€ë¦¬ìš©
    ];

    targets.forEach(sel => {
      if(sel) {
        sel.innerHTML = '<option value="">ë°˜ ì„ íƒ</option>';
        data.forEach(cls => {
          const opt = document.createElement("option");
          opt.value = cls.id;
          opt.textContent = cls.name;
          sel.appendChild(opt);
        });
      }
    });
  }

  // ë‚ ì§œë³„ ìˆ™ì œ ì¡°íšŒ
  async function loadHomework() {
    const classId = document.getElementById("classSelect").value;
    const dateVal = document.getElementById("dateInput").value;
    const nameFilter = document.getElementById("studentNameInput").value.trim();
    const tbody = document.querySelector("#homeworkTable tbody");

    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px;">ì¡°íšŒ ì¤‘...</td></tr>`;

    // 1. í•™ìƒ ëª©ë¡ ë¨¼ì € ê°€ì ¸ì˜¤ê¸°
    let query = client.from('students').select('id, name, login_id').order('name');
    if (classId) query = query.eq('class_id', classId);
    if (nameFilter) query = query.ilike('name', `%${nameFilter}%`);

    const { data: students, error: err1 } = await query;
    if (err1 || !students.length) {
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px;">í•´ë‹¹í•˜ëŠ” í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
      return;
    }

    // 2. í•´ë‹¹ ë‚ ì§œì˜ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°
    const loginIds = students.map(s => s.login_id);
    const start = dateVal + " 00:00:00";
    const end   = dateVal + " 23:59:59";

    const { data: results, error: err2 } = await client
      .from('vocab_results')
      .select('*')
      .in('student_login_id', loginIds)
      .gte('submitted_at', start)
      .lte('submitted_at', end)
      .order('submitted_at', { ascending: false });

    if (err2) { console.error(err2); return; }

    // 3. í…Œì´ë¸” ê·¸ë¦¬ê¸°
    tbody.innerHTML = "";
    students.forEach(std => {
      // ì´ í•™ìƒì˜ ê²°ê³¼ ì°¾ê¸°
      const myRes = results.filter(r => r.student_login_id === std.login_id);

      if (myRes.length > 0) {
        myRes.forEach(r => {
          const time = new Date(r.submitted_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td style="font-weight:700;">${std.name}</td>
            <td><span class="badge badge-done">ì œì¶œ ì™„ë£Œ</span></td>
            <td>${r.correct_count}ì  <span style="color:#888; font-size:11px;">(${r.mode})</span></td>
            <td style="color:var(--blue); font-weight:700;">${r.unit_key || r.unit || '-'}</td>
            <td>${time}</td>
          `;
          tbody.appendChild(tr);
        });
      } else {
        // ë¯¸ì œì¶œ
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${std.name}</td>
          <td><span class="badge badge-yet">ë¯¸ì œì¶œ</span></td>
          <td>-</td>
          <td>-</td>
          <td>-</td>
        `;
        tbody.appendChild(tr);
      }
    });
  }

  // ë°˜ë³„ í•™ìƒ ì¡°íšŒ
  async function loadStudentsByClass() {
    const classId = document.getElementById("classSelect2").value;
    const nameFilter = document.getElementById("studentNameInput2").value.trim();
    const tbody = document.querySelector("#studentsTable tbody");

    let query = client.from('students').select('*').order('name');
    if (classId) query = query.eq('class_id', classId);
    if (nameFilter) query = query.ilike('name', `%${nameFilter}%`);

    const { data, error } = await query;
    if (error) return alert("ì¡°íšŒ ì‹¤íŒ¨");

    tbody.innerHTML = "";
    if (!data.length) {
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px;">í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
      return;
    }

    data.forEach(s => {
      // ë°˜ ì´ë¦„ ì°¾ê¸°
      const clsObj = classList.find(c => c.id === s.class_id);
      const clsName = clsObj ? clsObj.name : 'ë¯¸ë°°ì •';

      // ë°˜ ë³€ê²½ìš© ì˜µì…˜ ë§Œë“¤ê¸°
      let opts = `<option value="">ë¯¸ë°°ì •</option>`;
      classList.forEach(c => {
        const selected = c.id === s.class_id ? "selected" : "";
        opts += `<option value="${c.id}" ${selected}>${c.name}</option>`;
      });

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="font-weight:700;">${s.name}</td>
        <td>${s.login_id || '-'}</td>
        <td>${s.parent_phone || '-'}</td>
        <td>${clsName}</td>
        <td>
          <select id="sel-${s.id}" class="input-ui" style="height:32px; padding:2px;">
            ${opts}
          </select>
        </td>
        <td><button class="btn-save" onclick="updateStudent('${s.id}')">ì €ì¥</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  // í•™ìƒ ë°˜ ì •ë³´ ìˆ˜ì •
  async function updateStudent(id) {
    const sel = document.getElementById(`sel-${id}`);
    const newClassId = sel.value || null;

    const { error } = await client.from('students').update({ class_id: newClassId }).eq('id', id);
    if (error) alert("ìˆ˜ì • ì‹¤íŒ¨");
    else {
      alert("ë°˜ ë³€ê²½ ì™„ë£Œ!");
      loadStudentsByClass(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      loadNewStudents();     // ì‹ ì…ìƒ ëª©ë¡ë„ ê°±ì‹ 
    }
  }

  // ì‹ ì…ìƒ(ë¯¸ë°°ì •) ì¡°íšŒ
  async function loadNewStudents() {
    const tbody = document.querySelector("#newStudentTable tbody");
    const { data, error } = await client
      .from('students')
      .select('*')
      .is('class_id', null)
      .order('created_at', { ascending: false });

    if (error) return;

    tbody.innerHTML = "";
    if (!data.length) {
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px;">ì‹ ê·œ(ë¯¸ë°°ì •) í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
      return;
    }

    data.forEach(s => {
      let opts = `<option value="">ë°˜ ì„ íƒ</option>`;
      classList.forEach(c => {
        opts += `<option value="${c.id}">${c.name}</option>`;
      });

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="font-weight:700;">${s.name}</td>
        <td>${s.login_id}</td>
        <td>${s.parent_phone || '-'}</td>
        <td><span class="badge badge-new">ë¯¸ë°°ì •</span></td>
        <td><select id="new-${s.id}" class="input-ui" style="height:32px;">${opts}</select></td>
        <td><button class="btn-save" onclick="saveNewStudent('${s.id}')">ì €ì¥</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ì‹ ì…ìƒ ë°˜ ë°°ì • ì €ì¥
  async function saveNewStudent(id) {
    const sel = document.getElementById(`new-${id}`);
    if (!sel.value) return alert("ë°˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    
    const { error } = await client.from('students').update({ class_id: sel.value }).eq('id', id);
    if (error) alert("ì˜¤ë¥˜ ë°œìƒ");
    else {
      alert("ë°°ì • ì™„ë£Œ!");
      loadNewStudents();
    }
  }
</script>
</body>
</html>
