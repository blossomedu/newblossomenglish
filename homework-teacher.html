<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜¨ë¼ì¸ ìˆ™ì œ ë§Œë“¤ê¸° - ë¸”ë¼ì¸ì‰ê¸€ë¦¬ì‰¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />

  <style>
    :root {
      --blue: #00AEEF;
      --mint: #9FE6B8;
      --pink: #FF6FB5;
      --gray-bg: #e5e7eb;
      --gray-text: #374151;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Pretendard Variable", -apple-system, BlinkMacSystemFont,
        system-ui, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    body {
      background: #f4f6fb;
      padding: 30px 0 60px;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .title-big { font-size: 34px; font-weight: 900; color: #111; margin-bottom: 6px; }
    .subtitle { font-size: 16px; color: #6b7280; margin-bottom: 20px; }

    .top-bar { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 18px; height: 40px; }
    .top-btns { display: flex; gap: 8px; }
    .nav-btn {
      padding: 8px 18px; border-radius: 999px; border: none; font-size: 14px; font-weight: 600;
      cursor: pointer; display: inline-flex; align-items: center; gap: 6px; white-space: nowrap;
      transition: opacity 0.2s; text-decoration: none;
    }
    .nav-btn:hover { opacity: 0.9; }
    .btn-home { background: var(--gray-bg); color: var(--gray-text); }
    .btn-write { background: var(--mint); color: #ffffff; }
    .btn-hw { background: var(--blue); color: #ffffff; }
    .btn-manage { background: var(--pink); color: #ffffff; }

    .card {
      background: #ffffff; border-radius: 24px; padding: 24px;
      box-shadow: 0 15px 32px rgba(15, 23, 42, 0.08); margin-bottom: 22px;
    }

    .info-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 8px; font-size: 14px; color: #4b5563; }
    .badge { display: inline-flex; align-items: center; padding: 3px 10px; border-radius: 999px; background: #ffe4f6; color: var(--pink); font-size: 12px; margin-left: 6px; font-weight: 700; }

    .form-row { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 12px; align-items: flex-end; }
    .field { min-width: 140px; }
    .field label { display: block; font-size: 14px; font-weight: 600; color: #4b5563; margin-bottom: 6px; margin-left: 4px; }
    
    select, input[type="text"], input[type="date"], input[type="number"] {
      width: 100%; padding: 10px 14px; border-radius: 12px; border: 1px solid #d1d5db;
      font-size: 14px; background: #ffffff; transition: border-color 0.2s;
    }
    select:focus, input:focus { border-color: var(--blue); outline: none; }
    .wide-field { min-width: 260px; flex-grow: 1; }
    .half-field { min-width: 140px; max-width: 160px; }

    /* í† ê¸€ ë²„íŠ¼ */
    .pill-group { display: inline-flex; background: #f3f4f6; border-radius: 999px; padding: 4px; gap: 4px; width: 100%; height: 42px; align-items: center; justify-content: center; }
    .pill-btn { border: none; border-radius: 999px; padding: 0 14px; height: 100%; font-size: 13px; font-weight: 600; cursor: pointer; background: transparent; color: #6b7280; flex: 1; transition: all 0.2s; }
    .pill-btn.active { background: var(--blue); color: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .pill-btn.mint-active.active { background: var(--mint); color: #ffffff; }

    /* === [NEW] ìƒì„¸ ì˜µì…˜ ë° ë²„íŠ¼ ë ˆì´ì•„ì›ƒ ìŠ¤íƒ€ì¼ === */
    .options-area { margin-top: 20px; padding-top: 20px; border-top: 1px solid #f3f4f6; }
    
    .preset-row { display: flex; gap: 8px; margin-bottom: 12px; }
    .preset-btn { padding: 6px 14px; border-radius: 99px; font-size: 13px; font-weight: 600; border: none; cursor: pointer; transition: 0.2s; }
    .preset-basic { background: #e0f2fe; color: #0284c7; }
    .preset-sentence { background: #f3f4f6; color: #4b5563; }
    .preset-reset { background: #f3f4f6; color: #9ca3af; }
    .preset-btn:hover { opacity: 0.8; }

    /* ì˜µì…˜ë“¤ê³¼ ë“±ë¡ ë²„íŠ¼ì„ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ */
    .options-wrapper {
      display: flex;
      gap: 12px;
      align-items: stretch; /* ë†’ì´ ë§ì¶¤ */
    }

    /* ì˜µì…˜ ê·¸ë¦¬ë“œ (ì™¼ìª½ ì˜ì—­) */
    .options-grid { 
      display: grid; 
      grid-template-columns: repeat(4, 1fr); 
      gap: 10px; 
      flex-grow: 1; /* ë‚¨ì€ ê³µê°„ ì°¨ì§€ */
    }

    .option-box { 
      display: flex; align-items: center; justify-content: space-between; 
      border: 1px solid #d1d5db; border-radius: 12px; padding: 10px 14px; background: white; 
      min-width: 0; /* flex ì•ˆì—ì„œ ì¤„ì–´ë“¤ ìˆ˜ ìˆê²Œ */
    }
    .option-label { font-size: 13px; font-weight: 700; color: #374151; white-space: nowrap; margin-right: 4px; }
    .option-select { border: none; text-align: right; width: 100%; padding: 0; font-weight: 600; cursor: pointer; color: #111; min-width: 30px; }
    .option-select:focus { border: none; outline: none; }

    /* ë“±ë¡ ë²„íŠ¼ (ì˜¤ë¥¸ìª½ ë°°ì¹˜) */
    #save-btn { 
      background: var(--pink); 
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      padding: 0 24px;
      white-space: nowrap;
      transition: opacity 0.2s;
      margin-top: 0;
      width: auto;
      min-width: 120px;
    }
    #save-btn:hover { opacity: 0.95; }

    .status { margin-top: 8px; font-size: 13px; color: #6b7280; margin-left: 4px; }
    .status.error { color: #b91c1c; }
    .status.success { color: #10b981; font-weight: 600; }
    .hint { font-size: 12px; color: #9ca3af; margin-top: 8px; margin-left: 4px; }
    
    .list-title { font-size: 16px; font-weight: 800; margin-bottom: 12px; color: #111; }
    .hw-list { font-size: 14px; color: #4b5563; }
    .hw-item { padding: 10px 0; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; }
    .hw-item:last-child { border-bottom: none; }
    .hw-tag { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; margin-right: 8px; }
    .hw-tag.vocab { background: #fee2e2; color: #b91c1c; }
    .hw-tag.sentence { background: #e0f2fe; color: #0369a1; }

    /* ì¶œë ¥ ê´€ë ¨ - ê¸°ì¡´ ìœ ì§€ */
    .print-row { margin-top: 12px; display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end; }
    #word-count-input { text-align: center; }
    
    /* ì¸ì‡„ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì›ìƒë³µêµ¬ */
    .btn-field-note, .btn-field-test { min-width: 160px; flex: 1; }
    #btn-print-test { background: var(--pink); color: white; border: none; border-radius: 12px; padding: 0 24px; height: 42px; font-weight: 700; width: 100%; cursor: pointer; transition: opacity 0.2s; }
    #btn-print-note { background: var(--blue); color: white; border: none; border-radius: 12px; padding: 0 24px; height: 42px; font-weight: 700; width: 100%; cursor: pointer; transition: opacity 0.2s; }
    #btn-print-test:hover, #btn-print-note:hover { opacity: 0.9; }

    .mode-field { min-width: 220px; }
    #logout-btn { background: #f3f4f6; color: #666; font-size: 12px; padding: 5px 10px; border-radius: 6px; border:none; cursor: pointer; }

    @media (max-width: 768px) {
      .top-bar { justify-content: flex-start; overflow-x: auto; }
      .form-row { flex-direction: column; align-items: stretch; gap: 16px; }
      .wide-field, .half-field, .mode-field, .btn-field-note, .btn-field-test { min-width: 100%; }
      /* ëª¨ë°”ì¼ ëŒ€ì‘ */
      .options-wrapper { flex-direction: column; }
      .options-grid { grid-template-columns: repeat(2, 1fr); }
      #save-btn { width: 100%; padding: 14px 0; }
    }
  </style>
</head>
<body>
<div class="page">
  <div class="title-big">ì˜¨ë¼ì¸ ìˆ™ì œ ë§Œë“¤ê¸°</div>
  <div class="subtitle">
    ë°˜ì„ ì„ íƒí•˜ê³  ì–´íœ˜/ë¬¸ì¥ ìˆ™ì œë¥¼ ë“±ë¡í•˜ë©´, ë‚˜ì¤‘ì— í•™ìƒ ì§„ë„ì™€ ì—°ê²°í•´ì„œ ë³¼ ìˆ˜ ìˆì–´ìš”.
  </div>

  <div class="top-bar">
    <div class="top-btns">
      <button class="nav-btn btn-home" onclick="location.href='index.html'">ğŸ  í™ˆ</button>
      <button class="nav-btn btn-write" onclick="location.href='board.html'">âœï¸ ê¸€ì“°ê¸°</button>
      <button class="nav-btn btn-hw" onclick="location.reload()">ğŸ“š ì˜¨ë¼ì¸ ìˆ™ì œ</button>
      <button class="nav-btn btn-manage" onclick="location.href='teacher-result.html'">ğŸ›  ê´€ë¦¬</button>
    </div>
  </div>

  <div class="card">
    <div class="info-row">
      <div>
        ë¡œê·¸ì¸ ê³„ì •: <span id="teacher-email" style="font-weight:600; color:#333;">í™•ì¸ ì¤‘â€¦</span>
        <span class="badge">ì„ ìƒë‹˜ ì „ìš©</span>
      </div>
      <button id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div class="form-row">
      <div class="field" style="min-width:140px;">
        <label>ë°˜ ì„ íƒ</label>
        <select id="class-select"><option value="">ë°˜ì„ ì„ íƒí•˜ì„¸ìš”</option></select>
      </div>

      <div class="field" style="min-width:140px;">
        <label>ìˆ™ì œ ì¢…ë¥˜</label>
        <div class="pill-group">
          <button type="button" class="pill-btn active" id="type-vocab">ì–´íœ˜</button>
          <button type="button" class="pill-btn" id="type-sentence">ë¬¸ì¥</button>
        </div>
      </div>

      <div class="field wide-field">
        <label>í•™ìŠµ ì„¸íŠ¸ (ë‹¨ê³„-ì„¸íŠ¸)</label>
        <input id="set-input" type="text" placeholder="ì˜ˆ: 1-1 ë˜ëŠ” 1-1, 1-2, 1-3" />
      </div>

      <div class="field" style="max-width:160px; min-width: 140px;">
        <label>ë§ˆê°ì¼</label>
        <input id="due-input" type="date" />
      </div>
    </div>
    
    <div class="options-area">
        <div class="preset-row">
            <button type="button" class="preset-btn preset-basic" onclick="setPreset('basic')">ê¸°ë³¸ 4ì¢…</button>
            <button type="button" class="preset-btn preset-sentence" onclick="setPreset('sentence')">ë¬¸ì¥ ë¹ˆì¹¸ Ã—3</button>
            <button type="button" class="preset-btn preset-reset" onclick="setPreset('reset')">ì´ˆê¸°í™”</button>
        </div>

        <div class="options-wrapper">
            <div class="options-grid">
                <div class="option-box">
                    <span class="option-label">ëœ» ì°¾ê¸°</span>
                    <select id="opt_meaning" class="option-select">
                        <option value="0">0</option><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option>
                    </select>
                </div>
                <div class="option-box">
                    <span class="option-label">ì˜ì–´ ì°¾ê¸°</span>
                    <select id="opt_english" class="option-select">
                        <option value="0">0</option><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option>
                    </select>
                </div>
                <div class="option-box">
                    <span class="option-label">ë“£ê³  ì°¾ê¸°</span>
                    <select id="opt_listening" class="option-select">
                        <option value="0">0</option><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option>
                    </select>
                </div>
                <div class="option-box">
                    <span class="option-label">ë¬¸ì¥ ë¹ˆì¹¸</span>
                    <select id="opt_sentence" class="option-select">
                        <option value="0">0</option><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option>
                    </select>
                </div>
            </div>

            <button id="save-btn">ìˆ™ì œ ë“±ë¡</button>
        </div>

        <div class="hint">* ì–´íœ˜ëŠ” ê°™ì€ ë‹¨ê³„ë§Œ ì—¬ëŸ¬ ê°œ ì…ë ¥ ê°€ëŠ¥. ë¬¸ì¥ì€ 1-1 ë“± ì…ë ¥ ê°€ëŠ¥.</div>
        <div id="status-msg" class="status"></div>
    </div>
  </div>

  <div class="card">
    <div class="list-title">ë‹¨ì–´ ì‹œí—˜ì§€ / ì•”ê¸°ì¥ ì¶œë ¥</div>
    <div id="print-status" class="status" style="margin-top:0; margin-bottom:12px;">
      ì„ íƒëœ ë°˜: - / ìˆ™ì œ ì¢…ë¥˜: ì–´íœ˜ / ì„¸íŠ¸ ë²ˆí˜¸: - / ì‹œí—˜ ìœ í˜•: í•œê¸€ ì“°ê¸°(ëœ»)
    </div>

    <div class="print-row">
      <div class="field wide-field">
        <label>í•™ìŠµ ì„¸íŠ¸</label>
        <input id="print-set-input" type="text" placeholder="ì˜ˆ: 1-1 ë˜ëŠ” 1-1, 1-2" />
      </div>

      <div class="field mode-field">
        <label>ì‹œí—˜ ìœ í˜•</label>
        <div class="pill-group">
          <button type="button" class="pill-btn mint-active active" id="mode-ko">í•œê¸€ ì“°ê¸°(ëœ»)</button>
          <button type="button" class="pill-btn mint-active" id="mode-en">ì˜ì–´ ì“°ê¸°(ì² ì)</button>
        </div>
      </div>

      <div class="field half-field">
        <label>ë¬¸í•­ ìˆ˜</label>
        <input type="number" min="1" step="1" id="word-count-input" placeholder="ì˜ˆ: 20" />
      </div>

      <div class="field btn-field-test">
        <label style="visibility:hidden;">ì‹œí—˜ì§€</label>
        <button id="btn-print-test">ë‹¨ì–´ ì‹œí—˜ì§€ ì¶œë ¥</button>
      </div>

      <div class="field btn-field-note">
        <label style="visibility:hidden;">ì•”ê¸°ì¥</label>
        <button id="btn-print-note">ë‹¨ì–´ ì•”ê¸°ì¥ ì¶œë ¥</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="list-title">ì„ íƒí•œ ë°˜ì˜ ìµœê·¼ ìˆ™ì œ</div>
    <div style="font-size:14px; color:#6b7280; margin-bottom:12px;">
      ì–´íœ˜/ë¬¸ì¥ ìˆ™ì œë¥¼ ë“±ë¡í•˜ë©´ ì—¬ê¸°ì—ì„œ ë°”ë¡œ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.
    </div>
    <div id="hw-list" class="hw-list">
      ì•„ì§ ìˆ™ì œê°€ ì—†ì–´ìš”. ë°˜ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.
    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
<script>
  const SUPABASE_URL = "https://bpdisxjhhibrgfpvtlmv.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZGlzeGpoaGlicmdmcHZ0bG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTkxODQsImV4cCI6MjA3OTUzNTE4NH0.jDZ6BGirOPuWUnt4ykjhng4PLft2ZjBuYAFzApUnlYU";

  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // DOM Elements
  const teacherEmailEl = document.getElementById("teacher-email");
  const logoutBtn = document.getElementById("logout-btn");
  const classSelect = document.getElementById("class-select");
  const typeVocabBtn = document.getElementById("type-vocab");
  const typeSentenceBtn = document.getElementById("type-sentence");
  const setInput = document.getElementById("set-input");
  const dueInput = document.getElementById("due-input");
  const saveBtn = document.getElementById("save-btn");
  const statusMsgEl = document.getElementById("status-msg");
  const hwListEl = document.getElementById("hw-list");

  // Options DOM
  const optMeaning = document.getElementById("opt_meaning");
  const optEnglish = document.getElementById("opt_english");
  const optListening = document.getElementById("opt_listening");
  const optSentence = document.getElementById("opt_sentence");

  // Print DOM
  const printStatusEl = document.getElementById("print-status");
  const btnPrintTest = document.getElementById("btn-print-test");
  const btnPrintNote = document.getElementById("btn-print-note");
  const wordCountInput = document.getElementById("word-count-input");
  const modeKoBtn = document.getElementById("mode-ko");
  const modeEnBtn = document.getElementById("mode-en");
  const printSetInput = document.getElementById("print-set-input");

  let currentType = "vocab";
  let testMode = "ko";

  function setStatus(msg, type = "") {
    statusMsgEl.textContent = msg || "";
    statusMsgEl.className = "status" + (type ? " " + type : "");
  }

  // --- í”„ë¦¬ì…‹ ì„¤ì • í•¨ìˆ˜ ---
  window.setPreset = function(type) {
      if (type === 'basic') {
          optMeaning.value = "1"; optEnglish.value = "1"; optListening.value = "1"; optSentence.value = "1";
      } else if (type === 'sentence') {
          optMeaning.value = "0"; optEnglish.value = "0"; optListening.value = "0"; optSentence.value = "3";
      } else if (type === 'reset') {
          optMeaning.value = "0"; optEnglish.value = "0"; optListening.value = "0"; optSentence.value = "0";
      }
  }

  function setPrintStatus() {
    const classText = classSelect.options[classSelect.selectedIndex]?.text || "-";
    const typeText = currentType === "vocab" ? "ì–´íœ˜" : "ë¬¸ì¥";
    const setsText = printSetInput.value.trim() || "-";
    const modeText = testMode === "ko" ? "í•œê¸€ ì“°ê¸°(ëœ»)" : "ì˜ì–´ ì“°ê¸°(ì² ì)";
    printStatusEl.textContent = `ì„ íƒëœ ë°˜: ${classText} / ìˆ™ì œ ì¢…ë¥˜: ${typeText} / ì„¸íŠ¸ ë²ˆí˜¸: ${setsText} / ì‹œí—˜ ìœ í˜•: ${modeText}`;

    const enablePrint = (currentType === "vocab");
    btnPrintTest.disabled = !enablePrint;
    btnPrintNote.disabled = !enablePrint;
    modeKoBtn.disabled = !enablePrint;
    modeEnBtn.disabled = !enablePrint;
    wordCountInput.disabled = !enablePrint;
    printSetInput.disabled = !enablePrint;
  }

  async function checkTeacher() {
    const { data, error } = await client.auth.getUser();
    if (error || !data.user) {
      alert("ì„ ìƒë‹˜ ê³„ì •ìœ¼ë¡œ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.");
      window.location.href = "login.html";
      return;
    }
    teacherEmailEl.textContent = data.user.email || "(ì´ë©”ì¼ ì—†ìŒ)";
  }

  logoutBtn.onclick = async () => {
    await client.auth.signOut();
    window.location.href = "login.html";
  };

  async function loadClasses() {
    const { data, error } = await client.from("classes").select("id, name").order("name", { ascending: true });
    if (error) { console.error("ë°˜ ëª©ë¡ ì˜¤ë¥˜:", error); return; }
    classSelect.innerHTML = '<option value="">ë°˜ì„ ì„ íƒí•˜ì„¸ìš”</option>';
    (data || []).forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.name;
      classSelect.appendChild(opt);
    });
  }

  function parseLevelAndSets(setStr) {
    const parts = setStr.split(",").map(s => s.trim()).filter(Boolean);
    if (parts.length === 0) return null;
    const first = parts[0].split("-");
    if (first.length !== 2) return null;
    const level = Number(first[0]);
    if (!level) return null;
    const setNums = [];
    for (const p of parts) {
      const [lvStr, setStr2] = p.split("-");
      const lv = Number(lvStr);
      const sn = Number(setStr2);
      if (!lv || !sn || lv !== level) return null;
      setNums.push(sn);
    }
    return { level, sets: setNums, raw: parts.join(", ") };
  }

  // --- ìˆ™ì œ ì €ì¥ í•¨ìˆ˜ ---
  async function saveHomework() {
    const classId = classSelect.value;
    const rawSet  = setInput.value.trim();
    const due     = dueInput.value;

    if (!classId) return setStatus("ë°˜ì„ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.", "error");
    if (!rawSet) return setStatus("í•™ìŠµ ì„¸íŠ¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”. (ì˜ˆ: 1-1 ë˜ëŠ” 1-1, 1-2)", "error");
    
    const parsed = parseLevelAndSets(rawSet);
    if (!parsed) return setStatus("ì„¸íŠ¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”. ì˜ˆ: 1-1, 1-2, 1-3", "error");
    if (!due) return setStatus("ë§ˆê°ì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.", "error");

    setStatus("ìˆ™ì œë¥¼ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤â€¦");

    const tableName = currentType === "vocab" ? "vocab_homework" : "sentence_homework";
    
    // DB ì „ì†¡ ë°ì´í„° (ì˜µì…˜ í¬í•¨)
    const payload = {
      class_id: classId,
      level: parsed.level,
      set_numbers: parsed.raw,
      due_date: due,
      count_meaning: parseInt(optMeaning.value),
      count_english: parseInt(optEnglish.value),
      count_listening: parseInt(optListening.value),
      count_sentence: parseInt(optSentence.value)
    };

    const { error } = await client.from(tableName).insert(payload);

    if (error) {
      console.error("ìˆ™ì œ ì €ì¥ ì˜¤ë¥˜:", error);
      if(error.message.includes("column")) {
           return setStatus("DB ì˜¤ë¥˜: count_meaning ë“±ì˜ ì»¬ëŸ¼ì´ í…Œì´ë¸”ì— ì—†ìŠµë‹ˆë‹¤. (Supabase í™•ì¸ í•„ìš”)", "error");
      }
      return setStatus("ìˆ™ì œë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", "error");
    }

    setStatus("ìˆ™ì œê°€ ë“±ë¡ë˜ì—ˆì–´ìš”!", "success");
    await loadHomeworkList();
  }

  saveBtn.onclick = saveHomework;

  function setType(nextType) {
    currentType = nextType;
    if (nextType === "vocab") {
      typeVocabBtn.classList.add("active");
      typeSentenceBtn.classList.remove("active");
    } else {
      typeSentenceBtn.classList.add("active");
      typeVocabBtn.classList.remove("active");
    }
    setPrintStatus();
    loadHomeworkList();
  }

  typeVocabBtn.onclick = () => setType("vocab");
  typeSentenceBtn.onclick = () => setType("sentence");

  function setTestMode(nextMode) {
    testMode = nextMode;
    if (nextMode === "ko") {
      modeKoBtn.classList.add("active");
      modeEnBtn.classList.remove("active");
    } else {
      modeEnBtn.classList.add("active");
      modeKoBtn.classList.remove("active");
    }
    setPrintStatus();
  }

  modeKoBtn.onclick = () => setTestMode("ko");
  modeEnBtn.onclick = () => setTestMode("en");

  async function loadHomeworkList() {
    const classId = classSelect.value;
    if (!classId) {
      hwListEl.textContent = "ì•„ì§ ìˆ™ì œê°€ ì—†ì–´ìš”. ë°˜ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.";
      return;
    }
    const tableName = currentType === "vocab" ? "vocab_homework" : "sentence_homework";
    const { data, error } = await client.from(tableName)
      .select("id, level, set_numbers, due_date, created_at")
      .eq("class_id", classId)
      .order("created_at", { ascending: false }).limit(10);

    if (error) {
      console.error("ìˆ™ì œ ëª©ë¡ ì˜¤ë¥˜:", error);
      hwListEl.textContent = "ìˆ™ì œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.";
      return;
    }
    if (!data || data.length === 0) {
      hwListEl.textContent = "ì´ ë°˜ì—ëŠ” ì•„ì§ ë“±ë¡ëœ ìˆ™ì œê°€ ì—†ì–´ìš”.";
      return;
    }
    hwListEl.innerHTML = "";
    data.forEach(row => {
      const div = document.createElement("div");
      div.className = "hw-item";
      const tagSpan = document.createElement("span");
      tagSpan.className = "hw-tag " + (currentType === "vocab" ? "vocab" : "sentence");
      tagSpan.textContent = currentType === "vocab" ? "ì–´íœ˜" : "ë¬¸ì¥";
      const mainSpan = document.createElement("span");
      mainSpan.textContent = ` ë ˆë²¨ ${row.level} / ì„¸íŠ¸: ${row.set_numbers} / ë§ˆê°ì¼: ${row.due_date || "-"}`;
      div.appendChild(tagSpan);
      div.appendChild(mainSpan);
      hwListEl.appendChild(div);
    });
  }

  classSelect.onchange = () => { setPrintStatus(); loadHomeworkList(); };
  printSetInput.oninput = setPrintStatus;

  function openPrintWindow(kind) {
    if (currentType !== "vocab") { alert("ë‹¨ì–´ ì¶œë ¥ì€ 'ì–´íœ˜' ìˆ™ì œì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”."); return; }
    const rawSet = printSetInput.value.trim();
    const parsed = parseLevelAndSets(rawSet);
    if (!parsed) { alert("ì¶œë ¥í•  ì„¸íŠ¸ ë²ˆí˜¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ ì£¼ì„¸ìš”. (ì˜ˆ: 1-1, 1-2, 1-3)"); return; }
    const level = parsed.level;
    const sets = parsed.sets.join(",");
    if (kind === "note") {
      if (parsed.sets.length !== 1) { alert("ë‹¨ì–´ ì•”ê¸°ì¥ì€ í•œ ì„¸íŠ¸ë§Œ ì¶œë ¥í•  ìˆ˜ ìˆì–´ìš”. ì˜ˆ: 1-1"); return; }
      const unit = `${level}-${parsed.sets[0]}`;
      window.open(`print-vocab-note.html?unit=${encodeURIComponent(unit)}`, "_blank");
      return;
    }
    let countParam = "";
    const rawCount = wordCountInput.value.trim();
    if (rawCount) {
      const n = Number(rawCount);
      if (!n || n <= 0) { alert("ë¬¸í•­ ìˆ˜ëŠ” 1 ì´ìƒì˜ ìˆ«ìë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }
      countParam = `&count=${encodeURIComponent(Math.floor(n))}`;
    }
    const modeParam = `&mode=${encodeURIComponent(testMode)}`;
    window.open(`print-vocab-test.html?level=${level}&sets=${encodeURIComponent(sets)}${countParam}${modeParam}`, "_blank");
  }

  btnPrintNote.onclick = () => openPrintWindow("note");
  btnPrintTest.onclick = () => openPrintWindow("test");

  (async function init() {
    await checkTeacher();
    await loadClasses();
    setType("vocab");
    setTestMode("ko");
    setPrintStatus();
    dueInput.value = new Date().toISOString().split('T')[0];
  })();
</script>
</body>
</html>
