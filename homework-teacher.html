<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜¨ë¼ì¸ ìˆ™ì œ ë§Œë“¤ê¸° - ë¸”ë¼ì¸ì‰ê¸€ë¦¬ì‰¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Pretendard Variable", -apple-system, BlinkMacSystemFont,
        system-ui, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    body {
      background: #f4f6fb;
      padding: 24px 0 40px;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
      gap: 10px;
    }

    .title-big {
      font-size: 28px;
      font-weight: 900;
    }

    .subtitle {
      font-size: 14px;
      color: #6b7280;
      margin-top: 4px;
    }

    .link-btn {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      background: #2563eb;
      color: #ffffff;
      white-space: nowrap;
    }

    .card {
      background: #ffffff;
      border-radius: 24px;
      padding: 18px 20px 20px;
      box-shadow: 0 15px 32px rgba(15, 23, 42, 0.08);
      margin-bottom: 18px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
      gap: 8px;
      font-size: 14px;
      color: #4b5563;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      font-size: 12px;
      margin-left: 6px;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 12px;
      align-items: flex-end;
    }

    .field {
      min-width: 140px;
    }

    .field label {
      display: block;
      font-size: 13px;
      color: #4b5563;
      margin-bottom: 4px;
    }

    select,
    input[type="number"],
    input[type="text"],
    input[type="date"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      background: #ffffff;
    }

    .pill-group {
      display: inline-flex;
      background: #e5e7eb;
      border-radius: 999px;
      padding: 3px;
      gap: 4px;
    }

    .pill-btn {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      background: transparent;
      color: #4b5563;
      white-space: nowrap;
    }

    .pill-btn.active {
      background: #2563eb;
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
    }

    .primary-btn {
      border-radius: 999px;
      border: none;
      padding: 9px 18px;
      font-size: 14px;
      cursor: pointer;
      background: #10b981;
      color: #ffffff;
      white-space: nowrap;
    }

    .primary-btn[disabled] {
      opacity: 0.6;
      cursor: default;
    }

    .secondary-btn {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 7px 12px;
      font-size: 13px;
      cursor: pointer;
      background: #ffffff;
      color: #374151;
      white-space: nowrap;
    }

    .print-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .status {
      margin-top: 8px;
      font-size: 13px;
      color: #6b7280;
    }

    .status.error {
      color: #b91c1c;
    }

    .hint {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .list-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .hw-list {
      font-size: 13px;
      color: #4b5563;
    }

    .hw-item {
      padding: 6px 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .hw-item:last-child {
      border-bottom: none;
    }

    .hw-tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
    }

    .hw-tag.vocab {
      background: #fee2e2;
      color: #b91c1c;
    }

    .hw-tag.sentence {
      background: #e0f2fe;
      color: #0369a1;
    }

    @media (max-width: 768px) {
      .top-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .form-row {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <div class="top-row">
    <div>
      <div class="title-big">ì˜¨ë¼ì¸ ìˆ™ì œ ë§Œë“¤ê¸°</div>
      <div class="subtitle">
        ë°˜ì„ ì„ íƒí•˜ê³  ì–´íœ˜/ë¬¸ì¥ ìˆ™ì œë¥¼ ë“±ë¡í•˜ë©´, ë‚˜ì¤‘ì— í•™ìƒ ì§„ë„ì™€ ì—°ê²°í•´ì„œ ë³¼ ìˆ˜ ìˆì–´ìš”.
      </div>
    </div>
    <button class="link-btn" onclick="window.location.href='board.html'">
      â† ë©”ì¸ìœ¼ë¡œ
    </button>
  </div>

  <div class="card">
    <div class="info-row">
      <div>
        ë¡œê·¸ì¸ ê³„ì •:
        <span id="teacher-email">í™•ì¸ ì¤‘â€¦</span>
        <span class="badge">ì„ ìƒë‹˜ ì „ìš©</span>
      </div>
      <button class="link-btn" id="logout-btn" style="background:#ef4444;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <!-- ìˆ™ì œ ìƒì„± í¼ -->
    <div class="form-row">
      <div class="field" style="min-width:180px;">
        <label>ë°˜ ì„ íƒ</label>
        <select id="class-select">
          <option value="">ë°˜ì„ ì„ íƒí•˜ì„¸ìš”</option>
          <!-- JSë¡œ ì±„ì›Œì§ -->
        </select>
      </div>

      <div class="field">
        <label>ìˆ™ì œ ì¢…ë¥˜</label>
        <div class="pill-group">
          <button type="button" class="pill-btn active" id="type-vocab">ì–´íœ˜</button>
          <button type="button" class="pill-btn" id="type-sentence">ë¬¸ì¥</button>
        </div>
      </div>

      <div class="field" style="max-width:120px;">
        <label>ë‹¨ê³„ (Level)</label>
        <input id="level-input" type="number" min="1" step="1" value="1" />
      </div>

      <div class="field">
        <label>ì„¸íŠ¸ ë²ˆí˜¸</label>
        <input id="set-input" type="text" placeholder="ì˜ˆ: 3 ë˜ëŠ” 1,2,3" />
        <div class="hint">ì‰¼í‘œë¡œ ì—¬ëŸ¬ ê°œ ì…ë ¥ ê°€ëŠ¥ (ì˜ˆ: 3,4,5)</div>
      </div>

      <div class="field" style="max-width:170px;">
        <label>ë§ˆê°ì¼</label>
        <input id="due-input" type="date" />
      </div>

      <div class="field" style="min-width:120px;">
        <button class="primary-btn" id="save-btn">ìˆ™ì œ ë“±ë¡</button>
      </div>

      <!-- ğŸ”½ ìƒˆë¡œ ì¶”ê°€ëœ ì¶œë ¥ ë²„íŠ¼ ì˜ì—­ -->
      <div class="field" style="min-width:220px;">
        <label>ì¶œë ¥</label>
        <div class="print-buttons">
          <button type="button" class="secondary-btn" id="print-test-btn">
            ë‹¨ì–´ ì‹œí—˜ì§€
          </button>
          <button type="button" class="secondary-btn" id="print-memo-btn">
            ë‹¨ì–´ ì•”ê¸°ì¥
          </button>
        </div>
        <div class="hint">ë°˜/ì¢…ë¥˜/ë ˆë²¨/ì„¸íŠ¸ë¥¼ ì„¤ì •í•œ ë’¤ ì¶œë ¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.</div>
      </div>
    </div>

    <div id="status-msg" class="status"></div>
  </div>

  <!-- ìµœê·¼ ë“±ë¡ëœ ìˆ™ì œ ë¦¬ìŠ¤íŠ¸ (í™•ì¸ìš©) -->
  <div class="card">
    <div class="list-title">ì„ íƒí•œ ë°˜ì˜ ìµœê·¼ ìˆ™ì œ</div>
    <div class="hint">ì–´íœ˜/ë¬¸ì¥ ìˆ™ì œë¥¼ ë“±ë¡í•˜ë©´ ì—¬ê¸°ì—ì„œ ë°”ë¡œ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.</div>
    <div id="hw-list" class="hw-list" style="margin-top:8px;">
      ì•„ì§ ìˆ™ì œê°€ ì—†ì–´ìš”. ë°˜ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.
    </div>
  </div>
</div>

<!-- Supabase JS -->
<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
<script>
  // ---- Supabase í´ë¼ì´ì–¸íŠ¸ (login.htmlê³¼ ë™ì¼) ----
  const SUPABASE_URL = "https://bpdisxjhhibrgfpvtlmv.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZGlzeGpoaGlicmdmcHZ0bG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTkxODQsImV4cCI6MjA3OTUzNTE4NH0.jDZ6BGirOPuWUnt4ykjhng4PLft2ZjBuYAFzApUnlYU";

  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const teacherEmailEl = document.getElementById("teacher-email");
  const logoutBtn = document.getElementById("logout-btn");
  const classSelect = document.getElementById("class-select");
  const typeVocabBtn = document.getElementById("type-vocab");
  const typeSentenceBtn = document.getElementById("type-sentence");
  const levelInput = document.getElementById("level-input");
  const setInput = document.getElementById("set-input");
  const dueInput = document.getElementById("due-input");
  const saveBtn = document.getElementById("save-btn");
  const statusMsg = document.getElementById("status-msg");
  const hwListEl = document.getElementById("hw-list");

  const printTestBtn = document.getElementById("print-test-btn");
  const printMemoBtn = document.getElementById("print-memo-btn");

  let currentType = "vocab"; // 'vocab' or 'sentence'
  let classes = [];          // [{id, name}, ...]

  function setStatus(message, isError = false) {
    statusMsg.textContent = message || "";
    statusMsg.classList.toggle("error", !!isError);
  }

  // ---- 1) ë¡œê·¸ì¸ í™•ì¸ (ì„ ìƒë‹˜ë§Œ) ----
  async function checkAuth() {
    const { data, error } = await client.auth.getUser();
    if (error || !data.user) {
      window.location.href = "login.html";
      return;
    }
    teacherEmailEl.textContent = data.user.email || "(ì´ë©”ì¼ ì—†ìŒ)";
  }

  logoutBtn.onclick = async () => {
    await client.auth.signOut();
    localStorage.removeItem("blossom_student");
    window.location.href = "login.html";
  };

  // ---- 2) classes í…Œì´ë¸”ì—ì„œ ë°˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ----
  async function loadClasses() {
    const { data, error } = await client
      .from("classes")
      .select("id, name")
      .order("name", { ascending: true });

    if (error) {
      console.error(error);
      setStatus("ë°˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", true);
      return;
    }

    classes = data || [];
    classSelect.innerHTML = '<option value="">ë°˜ì„ ì„ íƒí•˜ì„¸ìš”</option>';

    classes.forEach(cls => {
      const opt = document.createElement("option");
      opt.value = cls.id;
      opt.textContent = cls.name;
      classSelect.appendChild(opt);
    });
  }

  // ---- 3) í˜„ì¬ ì„ íƒëœ ë°˜ì˜ ìˆ™ì œ ëª©ë¡ ë³´ì—¬ì£¼ê¸° ----
  async function loadHomeworkList() {
    const classId = classSelect.value;
    hwListEl.innerHTML = "";

    if (!classId) {
      hwListEl.textContent = "ì•„ì§ ìˆ™ì œê°€ ì—†ì–´ìš”. ë°˜ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.";
      return;
    }

    const [vocabRes, sentenceRes] = await Promise.all([
      client
        .from("vocab_homework")
        .select("id, level, set_numbers, due_date, created_at")
        .eq("class_id", classId)
        .order("created_at", { ascending: false })
        .limit(10),
      client
        .from("sentence_homework")
        .select("id, level, set_numbers, due_date, created_at")
        .eq("class_id", classId)
        .order("created_at", { ascending: false })
        .limit(10),
    ]);

    if (vocabRes.error) console.error(vocabRes.error);
    if (sentenceRes.error) console.error(sentenceRes.error);

    const vocabList = (vocabRes.data || []).map(row => ({
      type: "vocab",
      ...row,
    }));
    const sentenceList = (sentenceRes.data || []).map(row => ({
      type: "sentence",
      ...row,
    }));

    const all = [...vocabList, ...sentenceList];

    if (!all.length) {
      hwListEl.textContent = "ì´ ë°˜ì— ë“±ë¡ëœ ìˆ™ì œê°€ ì•„ì§ ì—†ì–´ìš”.";
      return;
    }

    all.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

    all.forEach(hw => {
      const div = document.createElement("div");
      div.className = "hw-item";

      const tag = document.createElement("span");
      tag.className = "hw-tag " + (hw.type === "vocab" ? "vocab" : "sentence");
      tag.textContent = hw.type === "vocab" ? "ì–´íœ˜" : "ë¬¸ì¥";

      const text = document.createElement("span");
      const due = hw.due_date ? ` (ë§ˆê°: ${hw.due_date})` : "";
      text.textContent = `ë‹¨ê³„ ${hw.level} / ì„¸íŠ¸ ${hw.set_numbers}${due}`;

      div.appendChild(tag);
      div.appendChild(text);

      hwListEl.appendChild(div);
    });
  }

  classSelect.onchange = loadHomeworkList;

  // ---- 4) ìˆ™ì œ ì¢…ë¥˜ í† ê¸€ ----
  function updateTypeButtons() {
    typeVocabBtn.classList.toggle("active", currentType === "vocab");
    typeSentenceBtn.classList.toggle("active", currentType === "sentence");
  }

  typeVocabBtn.onclick = () => {
    currentType = "vocab";
    updateTypeButtons();
  };

  typeSentenceBtn.onclick = () => {
    currentType = "sentence";
    updateTypeButtons();
  };

  // ---- 5) ìˆ™ì œ ë“±ë¡ ë²„íŠ¼ ----
  saveBtn.onclick = async () => {
    setStatus("");

    const classId = classSelect.value;
    const level = parseInt(levelInput.value, 10);
    const setNumbersRaw = setInput.value.trim();
    const dueDateRaw = dueInput.value;

    if (!classId) {
      setStatus("ì–´ëŠ ë°˜ ìˆ™ì œì¸ì§€ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.", true);
      return;
    }
    if (!level || level < 1) {
      setStatus("ë‹¨ê³„(Level)ë¥¼ 1 ì´ìƒì˜ ìˆ«ìë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.", true);
      return;
    }
    if (!setNumbersRaw) {
      setStatus("ì„¸íŠ¸ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”. (ì˜ˆ: 3 ë˜ëŠ” 1,2,3)", true);
      return;
    }

    const setNumbers = setNumbersRaw
      .split(",")
      .map(s => s.trim())
      .filter(Boolean)
      .join(",");

    const dueDate = dueDateRaw ? dueDateRaw : null;
    const tableName = currentType === "vocab" ? "vocab_homework" : "sentence_homework";

    saveBtn.disabled = true;
    setStatus("ìˆ™ì œë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦");

    const { error } = await client.from(tableName).insert({
      class_id: classId,
      level: level,
      set_numbers: setNumbers,
      due_date: dueDate,
    });

    saveBtn.disabled = false;

    if (error) {
      console.error(error);
      setStatus("ìˆ™ì œë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", true);
      return;
    }

    setStatus("ìˆ™ì œê°€ ì €ì¥ëì–´ìš”!");
    setInput.value = "";
    await loadHomeworkList();
  };

  // ---- 6) ì¶œë ¥ í˜ì´ì§€ ì—´ê¸°ìš© ê³µí†µ í•¨ìˆ˜ ----
  function getCurrentParams() {
    const classId = classSelect.value;
    const level = parseInt(levelInput.value, 10) || 1;
    const setNumbersRaw = setInput.value.trim();
    const setNumbers = setNumbersRaw
      .split(",")
      .map(s => s.trim())
      .filter(Boolean)
      .join(",");
    const dueDate = dueInput.value || "";
    const type = currentType; // 'vocab' or 'sentence'

    return { classId, level, setNumbers, dueDate, type };
  }

  function openPrintPage(kind) {
    const { classId, level, setNumbers, dueDate, type } = getCurrentParams();

    if (!classId) {
      alert("ë°˜ì„ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.");
      return;
    }
    if (!setNumbers) {
      alert("ì„¸íŠ¸ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
      return;
    }

    const params = new URLSearchParams({
      classId,
      level,
      sets: setNumbers,
      due: dueDate,
      type,
    });

    // kind: 'test' | 'memo'
    const url =
      kind === "test"
        ? `print-vocab-test.html?${params.toString()}`
        : `print-vocab-memo.html?${params.toString()}`;

    window.open(url, "_blank");
  }

  printTestBtn.onclick = () => openPrintPage("test");
  printMemoBtn.onclick = () => openPrintPage("memo");

  // ---- ì´ˆê¸° ì‹¤í–‰ ----
  (async function init() {
    await checkAuth();
    await loadClasses();
    updateTypeButtons();
  })();
</script>
</body>
</html>