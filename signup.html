document.getElementById("signup-form").addEventListener("submit", async (e) => {
  e.preventDefault();

  const rawId = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  const confirmPassword = document.getElementById("confirm-password").value.trim();
  const name = document.getElementById("name").value.trim();
  const role = document.getElementById("role").value;

  // 1. 비밀번호 확인
  if (password !== confirmPassword) {
    alert("비밀번호가 일치하지 않습니다!");
    return;
  }

  // 2. 이메일 형식 자동 변환
  const email = rawId.includes("@")
    ? rawId
    : `${rawId}@blossomedu.local`;

  // 3. Supabase 회원가입(auth) - 메타데이터 저장
  const { data: authData, error: authError } = await supabase.auth.signUp({
    email,
    password,
    options: {
      data: {
        name: name,
        role: role,
        login_id: rawId  // ★★★ DB 컬럼과 정확히 일치해야 함! ★★★
      }
    }
  });

  if (authError) {
    alert("회원가입 오류: " + authError.message);
    return;
  }

  // 4. auth.user가 생성되었는지 확인
  const user = authData.user;
  if (!user) {
    alert("회원가입 중 알 수 없는 오류가 발생했습니다.");
    return;
  }

  // 5. students 테이블에 사용자 정보 추가
  const { error: insertError } = await supabase
    .from("students")
    .insert({
      user_id: user.id,       // 외래키
      login_id: rawId,        // ★ students 테이블 컬럼 이름과 동일해야 한다!
      password: password,     // ★ 너가 만든 password 컬럼
      name: name,             // ★ name 컬럼
      class_id: null          // 학급 연결은 나중에
    });

  if (insertError) {
    alert("학생 정보 저장 오류: " + insertError.message);
    return;
  }

  alert("회원가입이 완료되었습니다!");
  window.location.href = "login.html";
});