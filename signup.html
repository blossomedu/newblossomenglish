<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í•™ìƒ íšŒì›ê°€ì… - ë¸”ë¼ì¸ì‰ê¸€ë¦¬ì‰¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Pretendard Variable", -apple-system, BlinkMacSystemFont,
        system-ui, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    body {
      background: #f4f6fb;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 16px;
    }

    .card {
      width: 100%;
      max-width: 520px;
      background: #ffffff;
      border-radius: 32px;
      padding: 40px 32px 32px;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.12);
    }

    .title {
      font-size: 26px;
      font-weight: 900;
      margin-bottom: 6px;
    }

    .subtitle {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 24px;
    }

    .field {
      margin-bottom: 18px;
    }

    .field-label {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .field-help {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .input {
      width: 100%;
      padding: 11px 14px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
      background: #f9fafb;
    }

    .input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
      background: #ffffff;
    }

    .btn-primary {
      width: 100%;
      margin-top: 8px;
      padding: 12px 18px;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: #ffffff;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 16px 35px rgba(37, 99, 235, 0.35);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .status {
      margin-top: 12px;
      font-size: 13px;
      color: #6b7280;
      min-height: 18px;
    }

    .status.error {
      color: #b91c1c;
    }

    .status.success {
      color: #16a34a;
    }

    .bottom-link {
      margin-top: 18px;
      font-size: 13px;
      text-align: center;
      color: #6b7280;
    }

    .bottom-link a {
      color: #2563eb;
      text-decoration: none;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="title">í•™ìƒ íšŒì›ê°€ì…</div>
    <div class="subtitle">ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ì–´+ìˆ«ì 7ì ì´ìƒìœ¼ë¡œ ë§Œë“¤ì–´ ì£¼ì„¸ìš”.</div>

    <div class="field">
      <div class="field-label">í•™ìƒ ì´ë¦„</div>
      <input id="nameInput" class="input" placeholder="ì˜ˆ: í™ê¸¸ë™" />
    </div>

    <div class="field">
      <div class="field-label">í•™ìƒ ì•„ì´ë””</div>
      <input id="idInput" class="input" placeholder="ì˜ˆ: blossom01" />
      <div class="field-help">ì˜ì–´+ìˆ«ì ì¡°í•© 7ì ì´ìƒ (ì˜ˆ: blossom01)</div>
    </div>

    <div class="field">
      <div class="field-label">ë¹„ë°€ë²ˆí˜¸</div>
      <input id="passwordInput" class="input" type="password" placeholder="ì˜ì–´+ìˆ«ì 7ì ì´ìƒ" />
    </div>

    <div class="field">
      <div class="field-label">ë¶€ëª¨ë‹˜ ì „í™”ë²ˆí˜¸</div>
      <input id="parentPhoneInput" class="input" placeholder="ì˜ˆ: 01012345678" />
    </div>

    <button id="signupBtn" class="btn-primary">íšŒì›ê°€ì… ì™„ë£Œ</button>

    <div id="statusText" class="status"></div>

    <div class="bottom-link">
      ì´ë¯¸ ì•„ì´ë””ê°€ ìˆë‚˜ìš”?
      <a href="login.html">ë¡œê·¸ì¸ í•˜ëŸ¬ ê°€ê¸°</a>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
  <script>
    // â–¶ Supabase ì„¤ì • (ë‹¤ë¥¸ í˜ì´ì§€ì™€ ë™ì¼í•˜ê²Œ)
    const SUPABASE_URL = "https://bpdisxjhhibrgfpvtlmv.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZGlzeGpoaGlicmdmcHZ0bG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTkxODQsImV4cCI6MjA3OTUzNTE4NH0.jDZ6BGirOPuWUnt4ykjhng4PLft2ZjBuYAFzApUnlYU";

    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const nameInput = document.getElementById("nameInput");
    const idInput = document.getElementById("idInput");
    const passwordInput = document.getElementById("passwordInput");
    const parentPhoneInput = document.getElementById("parentPhoneInput");
    const signupBtn = document.getElementById("signupBtn");
    const statusText = document.getElementById("statusText");

    function setStatus(msg, type) {
      statusText.textContent = msg || "";
      statusText.classList.remove("error", "success");
      if (type) statusText.classList.add(type);
    }

    function isValidIdOrPw(value) {
      // ì˜ì–´/ìˆ«ìë§Œ + 7ê¸€ì ì´ìƒ ì²´í¬
      if (!value || value.length < 7) return false;
      return /^[A-Za-z0-9]+$/.test(value);
    }

    signupBtn.onclick = async () => {
      const name = nameInput.value.trim();
      const studentId = idInput.value.trim();
      const password = passwordInput.value.trim();
      const parentPhone = parentPhoneInput.value.trim();

      // ğŸ” ê¸°ë³¸ ê²€ì‚¬
      if (!name) {
        setStatus("í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.", "error");
        nameInput.focus();
        return;
      }
      if (!isValidIdOrPw(studentId)) {
        setStatus("ì•„ì´ë””ëŠ” ì˜ì–´+ìˆ«ì 7ì ì´ìƒìœ¼ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.", "error");
        idInput.focus();
        return;
      }
      if (!isValidIdOrPw(password)) {
        setStatus("ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ì–´+ìˆ«ì 7ì ì´ìƒìœ¼ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.", "error");
        passwordInput.focus();
        return;
      }

      // ì „í™”ë²ˆí˜¸ëŠ” ê¼­ ìˆ«ìë§Œì€ ì•„ë‹ˆì–´ë„ ë˜ì§€ë§Œ, ëŒ€ì¶© í˜•ì‹ ì²´í¬
      if (parentPhone && !/^[0-9\-+]+$/.test(parentPhone)) {
        setStatus("ë¶€ëª¨ë‹˜ ì „í™”ë²ˆí˜¸ëŠ” ìˆ«ìë§Œ ì…ë ¥í•´ ì£¼ì„¸ìš”.", "error");
        parentPhoneInput.focus();
        return;
      }

      setStatus("ê°€ì… ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤â€¦ ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.");
      signupBtn.disabled = true;

      try {
        // â–¶ students í…Œì´ë¸”ì— ì €ì¥
        const { data, error } = await client
          .from("students")
          .insert({
            student_id: studentId,
            name: name,
            password: password,      // ì§€ê¸ˆì€ í‰ë¬¸ìœ¼ë¡œ ì €ì¥ (ë‚˜ì¤‘ì— ì•”í˜¸í™” ê³ ë ¤)
            parent_phone: parentPhone || null
          })
          .select()
          .single();

        if (error) {
          console.error(error);
          if (error.code === "23505") {
            // unique ìœ„ë°˜
            setStatus("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì•„ì´ë””ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.", "error");
          } else {
            setStatus("íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.", "error");
          }
          signupBtn.disabled = false;
          return;
        }

        // ê°€ì… ì„±ê³µ â†’ ë°”ë¡œ localStorageì— ì €ì¥ (ë¡œê·¸ì¸ ìœ ì§€ìš©)
        const studentInfo = {
          login_id: data.student_id,
          name: data.name,
          id: data.id
        };
        try {
          localStorage.setItem("blossom_student", JSON.stringify(studentInfo));
        } catch (e) {
          console.warn("localStorage ì €ì¥ ì‹¤íŒ¨:", e);
        }

        setStatus("íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆì–´ìš”! ì´ì œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.", "success");

        setTimeout(() => {
          window.location.href = "login.html";
        }, 1200);
      } catch (e) {
        console.error(e);
        setStatus("íšŒì›ê°€ì… ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", "error");
        signupBtn.disabled = false;
      }
    };
  </script>
</body>
</html>