<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ÌïôÍµê ÏãúÌóò - Î¨∏Ïû• ÌïôÏäµ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #f3f4f6;
      color: #111827;
    }

    .page {
      max-width: 1100px;
      margin: 32px auto 48px;
      padding: 0 16px;
    }

    .main-title {
      font-size: 26px;
      font-weight: 800;
      margin-bottom: 20px;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .mode-tab {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: #e5e7eb;
      color: #111827;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .mode-tab.active {
      background: #2563eb;
      color: #ffffff;
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.4);
    }

    .card {
      background: #ffffff;
      border-radius: 24px;
      padding: 24px 20px 20px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
      min-height: 380px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .center-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: center;
      gap: 18px;
      text-align: left;
      padding: 8px;
    }

    .question-text {
      font-size: 18px;
      font-weight: 700;
      white-space: pre-line;
    }

    .sentence-en {
      font-size: 22px;
      margin-top: 6px;
      white-space: pre-line;
    }

    .sentence-kr {
      font-size: 16px;
      color: #4b5563;
      margin-top: 4px;
    }

    .blank-line {
      display: inline-block;
      min-width: 150px;
      border-bottom: 2px solid #111827;
      margin: 0 4px;
    }

    .hint-text {
      font-size: 14px;
      color: #f97316;
      min-height: 20px;
    }

    .explanation-text {
      font-size: 14px;
      color: #4b5563;
      min-height: 20px;
    }

    .bottom-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 18px;
      gap: 10px;
      font-size: 14px;
      color: #6b7280;
    }

    .bottom-right {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }

    .nav-pill {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }

    .pill-reset {
      background: #2563eb;
      color: #ffffff;
    }

    .pill-back {
      background: #f9739a;
      color: #ffffff;
    }

    .pill-reset.pill-back-color {
      background: #f9739a;
      color: #ffffff;
    }

    /* ===== Í≥µÌÜµ Î≤àÌò∏ ÎèôÍ∑∏ÎùºÎØ∏ ===== */

    .choice-number-circle {
      flex-shrink: 0;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1.5px solid #d1d5db;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }

    /* ===== (1) ÎπàÏπ∏ ÏôÑÏÑ± ===== */

    .blank-choice-area {
      min-height: 130px;
      background: #e5f0ff;
      border-radius: 20px;
      padding: 20px 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 16px;
    }

    .choices-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 18px 16px;
      width: 100%;
      max-width: 480px;
    }

    .choice-btn {
      width: 100%;
      min-height: 48px;
      padding: 10px 16px;
      border-radius: 999px;
      border: 1.5px solid #d1d5db;
      background: #ffffff;
      font-size: 16px;
      cursor: pointer;
      text-align: left;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
    }

    .choice-btn:hover {
      background: #e0edff;
      border-color: #93c5fd;
    }

    .choice-btn.correct {
      background: #dcfce7;
      border-color: #22c55e;
      color: #166534;
      font-weight: 600;
    }

    .choice-btn.wrong {
      background: #fee2e2;
      border-color: #f97373;
      color: #b91c1c;
    }

    /* ===== (2) Î¨∏Ïû• Î∞∞Ïó¥ ===== */

    .answer-row {
      min-height: 72px;
      background: #e5f0ff;
      border-radius: 20px;
      padding: 16px 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 18px;
      align-items: center;
      margin-bottom: 14px;
    }

    .word-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      min-height: 60px;
    }

    .word-chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border-radius: 999px;
      background: #ffffff;
      border: 1.5px solid #d1d5db;
      cursor: pointer;
      font-size: 18px;
      font-weight: 500;
      transition: 0.15s ease;
    }

    .word-chip:hover {
      background: #e0edff;
      border-color: #93c5fd;
    }

    .word-chip.selected {
      background: #dbeafe;
      border-color: #60a5fa;
      transform: scale(1.04);
    }

    /* ===== (3) Î¨∏Ïû• ÏôÑÏÑ±(ÌÉÄÏù¥Ìïë) ===== */

    .typing-area {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .typing-box-area {
      width: 100%;
      min-height: 120px;
      background: #e5f0ff;
      border-radius: 20px;
      padding: 20px 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 6px;
    }

    .typing-sentence-box {
      background: transparent;
      border-radius: 0;
      padding: 0;
      min-height: 0;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      font-size: 20px;
      max-width: 820px;
      width: 100%;
    }

    .typing-input-wrap {
      width: 100%;
      max-width: 520px;
      margin-top: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .inline-blank-input {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 90px;
      height: 38px;
      padding: 0 10px;
      border-radius: 999px;
      border: 1.5px solid #d1d5db;
      background: #ffffff;
      font-size: 18px;
      font-weight: 500;
      text-align: center;
      outline: none;
      margin: 0 4px;
      transition: all 0.15s ease;
    }

    .inline-blank-input:focus {
      border-color: #a5b4fc;
      background: #e5e7ff;
    }

    .inline-blank-input.correct {
      background: #dcfce7;
      border-color: #22c55e;
    }

    .inline-blank-input.wrong {
      background: #fee2e2;
      border-color: #f97373;
    }

    .typing-check-btn {
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      background: #22c55e;
      color: #ffffff;
      font-size: 15px;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.15s ease, transform 0.1s ease;
    }

    .typing-check-btn:hover:not(:disabled) {
      background: #16a34a;
      transform: translateY(-1px);
    }

    .typing-check-btn:disabled {
      opacity: 0.7;
      cursor: default;
      transform: none;
    }

    /* ===== (4) Î¨∏Ïû• Í≥†Î•¥Í∏∞ ===== */

    .choice-outer {
      margin-top: 14px;
      background: #e5f0ff;
      border-radius: 20px;
      padding: 20px 22px;
    }

    .choice-option-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .choice-option-btn {
      width: 100%;
      display: flex;
      align-items: center;
      border-radius: 999px;
      border: 1.5px solid #d1d5db;
      background: #ffffff;
      padding: 12px 18px;
      font-size: 16px;
      cursor: pointer;
      text-align: left;
      transition: all 0.15s ease;
    }

    .choice-option-btn:hover {
      border-color: #93c5fd;
      background: #eff6ff;
    }

    .choice-option-btn.selected {
      border-color: #f9739a;
      box-shadow: 0 0 0 2px rgba(249, 115, 155, 0.3);
    }

    .choice-result {
      margin-top: 14px;
      min-height: 20px;
      font-size: 14px;
      font-weight: 600;
    }

    .choice-result.correct {
      color: #16a34a;
    }

    .choice-result.wrong {
      color: #ef4444;
    }

    /* ===== (5) ÏßÄÎ¨∏ ÏôÑÏÑ± ===== */

    .passage-area {
      margin-top: 14px;
      background: #e5f0ff;
      border-radius: 20px;
      padding: 20px 22px;
    }

    .passage-text {
      font-size: 17px;
      line-height: 1.6;
      color: #111827;
    }

    .passage-blank {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 90px;
      height: 34px;
      padding: 0 10px;
      margin: 0 4px;
      border-radius: 999px;
      border: 1.5px solid #d1d5db;
      background: #ffffff;
      font-size: 17px;
      font-weight: 500;
      vertical-align: middle;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .passage-blank.selected {
      border-color: #60a5fa;
      box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.35);
    }

    .passage-blank.correct {
      background: #dcfce7;
      border-color: #22c55e;
      color: #166534;
    }

    .passage-blank.wrong {
      background: #fee2e2;
      border-color: #f97373;
      color: #b91c1c;
    }

    /* Î™®Î∞îÏùº ÎåÄÏùë */

    @media (max-width: 600px) {
      .card {
        padding: 20px 16px 16px;
      }

      .sentence-en {
        font-size: 20px;
      }

      .choice-btn {
        font-size: 15px;
      }

      .word-chip {
        font-size: 16px;
      }

      .typing-sentence-box {
        font-size: 18px;
      }

      .inline-blank-input {
        min-width: 70px;
        height: 34px;
        font-size: 16px;
      }

      .passage-text {
        font-size: 16px;
      }

      .passage-blank {
        min-width: 80px;
        font-size: 15px;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <h1 class="main-title" id="mainTitle">ÌïôÍµê ÏãúÌóò - Î¨∏Ïû• ÌïôÏäµ</h1>

  <div class="top-bar">
    <button class="mode-tab" data-mode="blank">ÎπàÏπ∏ ÏôÑÏÑ±</button>
    <button class="mode-tab" data-mode="order">Î¨∏Ïû• Î∞∞Ïó¥</button>
    <button class="mode-tab" data-mode="type">Î¨∏Ïû• ÏôÑÏÑ±</button>
    <button class="mode-tab" data-mode="choose">Î¨∏Ïû• Í≥†Î•¥Í∏∞</button>
    <button class="mode-tab" data-mode="passage">ÏßÄÎ¨∏ ÏôÑÏÑ±</button>
  </div>

  <div class="card">
    <div class="center-area" id="centerArea"></div>

    <div class="bottom-bar">
      <div id="progressText">0 / 0</div>
      <div class="bottom-right">
        <button type="button" class="nav-pill pill-reset" id="modeResetBtn">
          Îã§Ïãú ÌíÄÍ∏∞
        </button>
        <button type="button" class="nav-pill pill-back" id="backToUnitsBtn">
          ÎèåÏïÑÍ∞ÄÍ∏∞
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ÌïôÍµê ÏãúÌóòÏö© Îç∞Ïù¥ÌÑ∞ -->
<script src="sentence-school.js"></script>

<script>
  const params   = new URLSearchParams(window.location.search);
  const schoolId = params.get("school") || "";
  const setKey   = params.get("set") || params.get("unit") || "1-1";

  const mainTitle      = document.getElementById("mainTitle");
  const centerArea     = document.getElementById("centerArea");
  const progressText   = document.getElementById("progressText");
  const modeTabs       = document.querySelectorAll(".mode-tab");
  const modeResetBtn   = document.getElementById("modeResetBtn");
  const backToUnitsBtn = document.getElementById("backToUnitsBtn");

  mainTitle.textContent = `ÌïôÍµê ÏãúÌóò - Î¨∏Ïû• ÌïôÏäµ (${setKey})`;

  // sentence-school.js ÏóêÏÑú Î¨∏Ï†ú Í∞ÄÏ†∏Ïò§Í∏∞ (Î∞©Ïñ¥Ï†ÅÏúºÎ°ú Ï≤òÎ¶¨)
  const RAW_DB =
    window.SENTENCE_SCHOOL_DB ||
    window.SENTENCE_DB ||
    window.SENTENCE_SCHOOL ||
    {};

  let allQuestions = [];
  if (Array.isArray(RAW_DB)) {
    allQuestions = RAW_DB;
  } else if (RAW_DB[setKey]) {
    allQuestions = RAW_DB[setKey];
  } else {
    // Ï≤´ Î≤àÏß∏ ÌÇ§ Í∞íÏù¥ÎùºÎèÑ ÏÇ¨Ïö©
    const firstKey = Object.keys(RAW_DB)[0];
    if (firstKey) allQuestions = RAW_DB[firstKey];
  }
  if (!Array.isArray(allQuestions)) allQuestions = [];

  // type: blank / order / type / choose / passage
  const questionsByType = {
    blank:   [],
    order:   [],
    type:    [],
    choose:  [],
    passage: []
  };

  allQuestions.forEach(q => {
    if (!q || !q.type) return;
    if (questionsByType[q.type]) {
      questionsByType[q.type].push(q);
    }
  });

  // Í∏∞Î≥∏ Î™®ÎìúÎäî Î¨∏Ï†ú ÏûàÎäî Ïú†Ìòï Ï§ë Ï≤´ Î≤àÏß∏
  const modeOrder = ["blank", "order", "type", "choose", "passage"];
  let currentMode = "blank";
  for (const m of modeOrder) {
    if (questionsByType[m] && questionsByType[m].length) {
      currentMode = m;
      break;
    }
  }

  const modeIndex = { blank: 0, order: 0, type: 0, choose: 0, passage: 0 };
  const wrongQuestions = {
    blank:   [],
    order:   [],
    type:    [],
    choose:  [],
    passage: []
  };

  function shuffle(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  let activeTimers = [];
  let activeIntervals = [];

  function clearTimers() {
    activeTimers.forEach(id => clearTimeout(id));
    activeIntervals.forEach(id => clearInterval(id));
    activeTimers = [];
    activeIntervals = [];
  }

  function setTimer(fn, ms) {
    const id = setTimeout(fn, ms);
    activeTimers.push(id);
    return id;
  }

  function setIntervalTimer(fn, ms) {
    const id = setInterval(fn, ms);
    activeIntervals.push(id);
    return id;
  }

  function setProgress(idx, total) {
    progressText.textContent = total ? `${idx + 1} / ${total}` : "0 / 0";
  }

  function clearCenter() {
    centerArea.innerHTML = "";
  }

  function renderNoQuestion() {
    clearCenter();
    const a = document.createElement("div");
    a.className = "question-text";
    a.textContent = "Ïù¥ Ïú†ÌòïÏùò Î¨∏Ï†úÍ∞Ä ÏóÜÏäµÎãàÎã§.";
    centerArea.appendChild(a);

    const b = document.createElement("div");
    b.className = "sentence-en";
    b.textContent = "Î¨∏Ï†úÎ•º Ï∂îÍ∞ÄÌïòÎ©¥ Î∞îÎ°ú Ïó¨Í∏∞ÏÑú ÌíÄ Ïàò ÏûàÏñ¥Ïöî.";
    centerArea.appendChild(b);

    setProgress(0, 0);
  }

  function enqueueRetryQuestion(type, q) {
    if (q._retryAddedFor && q._retryAddedFor[type]) return;
    if (!q._retryAddedFor) q._retryAddedFor = {};
    q._retryAddedFor[type] = true;
    questionsByType[type].push(q);
  }

  function goNext() {
    const list = questionsByType[currentMode];
    if (!list || !list.length) {
      renderNoQuestion();
      return;
    }

    modeIndex[currentMode]++;
    const idx   = modeIndex[currentMode];
    const total = list.length;

    if (idx >= total) {
      clearCenter();
      const done = document.createElement("div");
      done.className = "question-text";
      done.textContent = "Ïù¥ Ïú†ÌòïÏùò Î¨∏Ï†úÎ•º Î™®Îëê ÌíÄÏóàÏäµÎãàÎã§. üòä";
      centerArea.appendChild(done);
      setProgress(total, total);
    } else {
      renderCurrent();
    }
  }

  /* ========== (1) ÎπàÏπ∏ ÏôÑÏÑ± ========== */

  function renderBlankQuestion(q, idx, total) {
    clearTimers();
    clearCenter();

    const qDiv = document.createElement("div");
    qDiv.className = "question-text";
    qDiv.textContent = "ÎπàÏπ∏Ïóê ÏïåÎßûÏùÄ ÎßêÏùÑ Í≥†Î•¥ÏÑ∏Ïöî.";
    centerArea.appendChild(qDiv);

    const sDiv = document.createElement("div");
    sDiv.className = "sentence-en";
    sDiv.innerHTML = (q.question || "").replace(
      "____",
      "<span class='blank-line'></span>"
    );
    centerArea.appendChild(sDiv);

    const choiceArea = document.createElement("div");
    choiceArea.className = "blank-choice-area";
    centerArea.appendChild(choiceArea);

    const grid = document.createElement("div");
    grid.className = "choices-grid";
    choiceArea.appendChild(grid);

    const hintDiv = document.createElement("div");
    hintDiv.className = "hint-text";
    centerArea.appendChild(hintDiv);

    const expDiv = document.createElement("div");
    expDiv.className = "explanation-text";
    centerArea.appendChild(expDiv);

    let answered = false;
    const options = q.options || [];
    const correctIndex =
      typeof q.answerIndex === "number" ? q.answerIndex : 0;

    options.forEach((opt, i) => {
      const btn = document.createElement("button");
      btn.className = "choice-btn";

      const numDiv = document.createElement("div");
      numDiv.className = "choice-number-circle";
      numDiv.textContent = String(i + 1);

      const textDiv = document.createElement("div");
      textDiv.textContent = opt;

      btn.appendChild(numDiv);
      btn.appendChild(textDiv);
      grid.appendChild(btn);

      btn.onclick = () => {
        if (answered) return;

        const isCorrect = i === correctIndex;

        if (isCorrect) {
          answered = true;
          clearTimers();
          btn.classList.add("correct");
          hintDiv.textContent = "";
          expDiv.textContent = q.explanation || "Ï†ïÎãµÏûÖÎãàÎã§!";
          setTimer(goNext, 1000);
        } else {
          btn.classList.add("wrong");
          hintDiv.textContent = "ÌûåÌä∏: Îã§Ïãú ÏÉùÍ∞ÅÌï¥ Î≥¥ÏÑ∏Ïöî.";
          enqueueRetryQuestion("blank", q);
        }
      };
    });

    // ÏûêÎèô Ï†ïÎãµ Í≥µÍ∞ú (15Ï¥à)
    setTimer(() => {
      if (answered) return;
      answered = true;

      [...grid.children].forEach((b, idxBtn) => {
        if (idxBtn === correctIndex) b.classList.add("correct");
      });

      hintDiv.textContent = "ÏãúÍ∞ÑÏù¥ ÏßÄÎÇò Ï†ïÎãµÏù¥ Í≥µÍ∞úÎêòÏóàÏäµÎãàÎã§.";
      expDiv.textContent = q.explanation || "";

      enqueueRetryQuestion("blank", q);
      setTimer(goNext, 1500);
    }, 15000);

    setProgress(idx, total);
  }

  /* ========== (2) Î¨∏Ïû• Î∞∞Ïó¥ ========== */

  function renderOrderQuestion(q, idx, total) {
    clearTimers();
    clearCenter();

    const qDiv = document.createElement("div");
    qDiv.className = "question-text";
    qDiv.textContent =
      q.question || "Îã§Ïùå Îã®Ïñ¥Î•º Î∞îÎ•¥Í≤å Î∞∞Ïó¥ÌïòÏó¨ Î¨∏Ïû•ÏùÑ ÎßåÎìúÏãúÏò§.";
    centerArea.appendChild(qDiv);

    if (q.meaningKo) {
      const ko = document.createElement("div");
      ko.className = "sentence-kr";
      ko.textContent = q.meaningKo;
      centerArea.appendChild(ko);
    }

    const correctWords = (q.answerEn || "")
      .trim()
      .split(" ")
      .map(w => w.trim())
      .filter(Boolean);

    let currentIndex = 0;
    let finished = false;
    let pool = shuffle(correctWords.slice());

    const answerRow = document.createElement("div");
    answerRow.className = "answer-row";
    centerArea.appendChild(answerRow);

    const slots = [];
    correctWords.forEach(() => {
      const slot = document.createElement("div");
      slot.style.minWidth       = "70px";
      slot.style.minHeight      = "40px";
      slot.style.borderRadius   = "999px";
      slot.style.border         = "1.5px solid #d1d5db";
      slot.style.background     = "#ffffff";
      slot.style.display        = "flex";
      slot.style.alignItems     = "center";
      slot.style.justifyContent = "center";
      slot.style.fontSize       = "18px";
      slot.style.fontWeight     = "500";
      slot.textContent = "";
      answerRow.appendChild(slot);
      slots.push(slot);
    });

    const chipsWrap = document.createElement("div");
    chipsWrap.className = "word-chips";
    centerArea.appendChild(chipsWrap);

    const hintDiv = document.createElement("div");
    hintDiv.className = "hint-text";
    centerArea.appendChild(hintDiv);

    function refreshChips() {
      chipsWrap.innerHTML = "";

      pool.forEach((word, i) => {
        const chip = document.createElement("div");
        chip.className = "word-chip";
        chip.textContent = word;

        chip.onclick = () => {
          if (finished) return;

          const expected = correctWords[currentIndex];
          if (!expected) return;

          if (word === expected) {
            const slot = slots[currentIndex];
            slot.textContent      = word;
            slot.style.background = "#dbeafe";
            slot.style.borderColor= "#60a5fa";

            pool.splice(i, 1);
            currentIndex++;
            refreshChips();

            if (currentIndex >= correctWords.length) {
              finished = true;
              hintDiv.textContent = "Ï†ïÎãµÏûÖÎãàÎã§!";
              setTimer(goNext, 1000);
            }
          } else {
            const originalBg     = chip.style.background;
            const originalBorder = chip.style.borderColor;

            chip.style.background  = "#fee2e2";
            chip.style.borderColor = "#f97373";
            hintDiv.textContent    = "Ìï¥Îãπ ÏúÑÏπòÏóê Îì§Ïñ¥Í∞à Îã®Ïñ¥Í∞Ä ÏïÑÎãàÏóêÏöî.";

            if (!q._countedWrongOrder) {
              q._countedWrongOrder = true;
              wrongQuestions.order.push(q);
              enqueueRetryQuestion("order", q);
            }

            setTimeout(() => {
              chip.style.background  = originalBg || "#ffffff";
              chip.style.borderColor = originalBorder || "#d1d5db";
            }, 350);
          }
        };

        chipsWrap.appendChild(chip);
      });
    }

    // 30Ï¥à ÏßÄÎÇòÎ©¥ Ï†ïÎãµ Í≥µÍ∞ú
    setTimer(() => {
      if (finished) return;
      finished = true;

      correctWords.forEach((w, idxWord) => {
        const slot = slots[idxWord];
        slot.textContent      = w;
        slot.style.background = "#e0f2fe";
        slot.style.borderColor= "#93c5fd";
      });
      chipsWrap.innerHTML = "";
      hintDiv.textContent = "(ÏãúÍ∞ÑÏù¥ ÏßÄÎÇò Ï†ïÎãµÏù¥ Í≥µÍ∞úÎêòÏóàÏäµÎãàÎã§.)";

      enqueueRetryQuestion("order", q);
      setTimer(goNext, 5000);
    }, 30000);

    refreshChips();
    setProgress(idx, total);
  }

  /* ========== (3) Î¨∏Ïû• ÏôÑÏÑ±(ÌÉÄÏù¥Ìïë) ========== */

  function renderTypeQuestion(q, idx, total) {
    clearTimers();
    clearCenter();

    const qDiv = document.createElement("div");
    qDiv.className = "question-text";
    qDiv.textContent = "ÎπàÏπ∏ÏùÑ Ï±ÑÏõå Î¨∏Ïû•ÏùÑ ÏôÑÏÑ±ÌïòÏÑ∏Ïöî.";
    centerArea.appendChild(qDiv);

    if (q.meaningKo) {
      const kr = document.createElement("div");
      kr.className = "sentence-kr";
      kr.textContent = q.meaningKo;
      centerArea.appendChild(kr);
    }

    const typingArea = document.createElement("div");
    typingArea.className = "typing-area";
    centerArea.appendChild(typingArea);

    const boxArea = document.createElement("div");
    boxArea.className = "typing-box-area";
    typingArea.appendChild(boxArea);

    const sentenceBox = document.createElement("div");
    sentenceBox.className = "typing-sentence-box";
    boxArea.appendChild(sentenceBox);

    const rawSentence = String(q.answerEn || "");
    const tokens = rawSentence
      .split(" ")
      .map(t => t.trim())
      .filter(Boolean);

    let blankTargets = [];
    if (q.blankWords) {
      blankTargets = String(q.blankWords)
        .split(",")
        .map(w => w.trim().toLowerCase())
        .filter(Boolean);
    }

    if (!blankTargets.length && tokens.length) {
      const midToken = tokens[Math.floor(tokens.length / 2)];
      const coreMid = midToken.replace(/[.,!?]+$/g, "");
      blankTargets = [coreMid.toLowerCase()];
    }

    const blankInputs = [];

    tokens.forEach((token, tokenIdx) => {
      const core = token.replace(/[.,!?]+$/g, "");
      const punctMatch = token.match(/[.,!?]+$/g);
      const punctuation = punctMatch ? punctMatch[0] : "";
      const normCore = core.toLowerCase();

      const isBlankTarget = blankTargets.includes(normCore);

      if (isBlankTarget) {
        const input = document.createElement("input");
        input.type = "text";
        input.className = "inline-blank-input";
        input.dataset.answer = normCore;

        const estimatedWidth = Math.max(core.length * 10 + 20, 60);
        input.style.width = estimatedWidth + "px";

        blankInputs.push(input);
        sentenceBox.appendChild(input);
        if (punctuation) {
          const spanP = document.createElement("span");
          spanP.textContent = punctuation;
          sentenceBox.appendChild(spanP);
        }
      } else {
        const span = document.createElement("span");
        span.textContent = core + (punctuation ? punctuation : "");
        sentenceBox.appendChild(span);
      }

      if (tokenIdx !== tokens.length - 1) {
        sentenceBox.appendChild(document.createTextNode(" "));
      }
    });

    const controls = document.createElement("div");
    controls.className = "typing-input-wrap";
    typingArea.appendChild(controls);

    const filler = document.createElement("div");
    filler.style.flex = "1";
    controls.appendChild(filler);

    const checkBtn = document.createElement("button");
    checkBtn.type = "button";
    checkBtn.className = "typing-check-btn";
    checkBtn.textContent = "ÌôïÏù∏";
    controls.appendChild(checkBtn);

    const hintDiv = document.createElement("div");
    hintDiv.className = "hint-text";
    centerArea.appendChild(hintDiv);

    const expDiv = document.createElement("div");
    expDiv.className = "explanation-text";
    centerArea.appendChild(expDiv);

    let finished = false;

    function handleCheck() {
      if (finished) return;

      let allFilled = true;
      let allCorrect = true;

      blankInputs.forEach(input => {
        const user = String(input.value || "").trim().toLowerCase();
        const ans  = String(input.dataset.answer || "").toLowerCase();

        if (!user) {
          allFilled = false;
          input.classList.remove("correct", "wrong");
          return;
        }

        if (user === ans) {
          input.classList.remove("wrong");
          input.classList.add("correct");
        } else {
          allCorrect = false;
          input.classList.remove("correct");
          input.classList.add("wrong");
        }
      });

      if (!allFilled) {
        hintDiv.textContent = "Î™®Îì† ÎπàÏπ∏ÏùÑ Î®ºÏ†Ä ÏûÖÎ†•Ìï¥ Î≥¥ÏÑ∏Ïöî.";
        return;
      }

      if (allCorrect) {
        finished = true;
        hintDiv.textContent = "";
        expDiv.textContent = "Ï†ïÎãµÏûÖÎãàÎã§! üëè";
        checkBtn.disabled = true;
        setTimer(goNext, 1200);
      } else {
        hintDiv.textContent = "Ï≤†ÏûêÏôÄ ÎùÑÏñ¥Ïì∞Í∏∞Î•º Îã§Ïãú Ìïú Î≤à ÌôïÏù∏Ìï¥ Î≥¥ÏÑ∏Ïöî.";
        expDiv.textContent = q.explanation || "";
        if (!q._countedWrongType) {
          q._countedWrongType = true;
          wrongQuestions.type.push(q);
          enqueueRetryQuestion("type", q);
        }
      }
    }

    checkBtn.onclick = handleCheck;

    blankInputs.forEach((input, idx) => {
      input.addEventListener("keydown", (e) => {
        if (e.key === " " || e.key === "Spacebar" || e.key === "Enter") {
          e.preventDefault();
          const lastIndex = blankInputs.length - 1;
          if (idx < lastIndex) {
            blankInputs[idx + 1].focus();
          } else {
            handleCheck();
          }
        }
      });
    });

    if (blankInputs[0]) {
      blankInputs[0].focus();
    }

    setProgress(idx, total);
  }

  /* ========== (4) Î¨∏Ïû• Í≥†Î•¥Í∏∞ (ÌÉÄÏù¥Î®∏ ÏóÜÏùå) ========== */

  function renderChooseQuestion(q, idx, total) {
    clearTimers();
    clearCenter();

    const questionText = q.question || "Îã§Ïùå Ï§ë Ïò¨Î∞îÎ•∏ Î¨∏Ïû•ÏùÑ Í≥†Î•¥ÏãúÏò§.";
    const options = q.options || [];
    const correctIndex =
      typeof q.answerIndex === "number" ? q.answerIndex : 0;

    const qDiv = document.createElement("div");
    qDiv.className = "question-text";
    qDiv.textContent = questionText;
    centerArea.appendChild(qDiv);

    const outer = document.createElement("div");
    outer.className = "choice-outer";
    centerArea.appendChild(outer);

    const list = document.createElement("div");
    list.className = "choice-option-list";
    outer.appendChild(list);

    const resultDiv = document.createElement("div");
    resultDiv.className = "choice-result";
    centerArea.appendChild(resultDiv);

    let answered = false;
    const buttons = [];

    options.forEach((text, i) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "choice-option-btn";

      const num = document.createElement("div");
      num.className = "choice-number-circle";
      num.textContent = String(i + 1);
      btn.appendChild(num);

      const spanText = document.createElement("div");
      spanText.className = "choice-option-text";
      spanText.textContent = text;
      btn.appendChild(spanText);

      btn.onclick = () => {
        if (answered) return;

        const isCorrect = i === correctIndex;

        buttons.forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");

        if (isCorrect) {
          answered = true;
          resultDiv.textContent = "Ï†ïÎãµÏûÖÎãàÎã§! üéâ";
          resultDiv.className = "choice-result correct";
          setTimer(goNext, 1000);
        } else {
          resultDiv.textContent = "ÌûåÌä∏: Îã§Ïãú Ìïú Î≤à ÏÉùÍ∞ÅÌï¥ Î≥¥ÏÑ∏Ïöî.";
          resultDiv.className = "choice-result wrong";
          enqueueRetryQuestion("choose", q);
        }
      };

      list.appendChild(btn);
      buttons.push(btn);
    });

    setProgress(idx, total);
  }

  /* ========== (5) ÏßÄÎ¨∏ ÏôÑÏÑ± (passage) ========== */
  /* ÏãúÍ∞Ñ Ï†úÌïú ÏóÜÏùå, ÌôïÏù∏ Î≤ÑÌäº ÏóÜÏù¥ ÏûêÎèô Ï±ÑÏ†ê */

  function renderPassageQuestion(q, idx, total) {
    clearTimers();
    clearCenter();

    const qDiv = document.createElement("div");
    qDiv.className = "question-text";
    qDiv.textContent =
      "ÏßÄÎ¨∏ÏùÑ ÏùΩÍ≥† ÎπàÏπ∏Ïóê ÏïåÎßûÏùÄ Îã®Ïñ¥Î•º ÎÑ£ÏúºÏÑ∏Ïöî. (Í∞Å Îã®Ïñ¥Îäî Ìïú Î≤àÎßå ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏñ¥Ïöî.)";
    centerArea.appendChild(qDiv);

    const passageArea = document.createElement("div");
    passageArea.className = "passage-area";
    centerArea.appendChild(passageArea);

    const passageTextBox = document.createElement("div");
    passageTextBox.className = "passage-text";
    passageArea.appendChild(passageTextBox);

    const passage = String(q.passage || "");
    const blanks = Array.isArray(q.blanks) ? q.blanks : [];
    const options = Array.isArray(q.options) ? q.options : [];

    const blankElems = [];
    const regex = /(\(\d+\)\s*____)/g;
    let lastIndex = 0;
    let match;
    let blankCount = 0;

    function appendText(text) {
      if (!text) return;
      const span = document.createElement("span");
      span.textContent = text;
      passageTextBox.appendChild(span);
    }

    while ((match = regex.exec(passage)) !== null) {
      const before = passage.slice(lastIndex, match.index);
      appendText(before);

      const blankSpan = document.createElement("span");
      blankSpan.className = "passage-blank";
      blankSpan.dataset.blankIndex = String(blankCount);
      blankSpan.textContent = "";
      passageTextBox.appendChild(blankSpan);

      blankElems.push(blankSpan);
      blankCount++;

      lastIndex = regex.lastIndex;
    }
    appendText(passage.slice(lastIndex));

    const chipsWrap = document.createElement("div");
    chipsWrap.className = "word-chips";
    chipsWrap.style.marginTop = "18px";
    centerArea.appendChild(chipsWrap);

    const hintDiv = document.createElement("div");
    hintDiv.className = "hint-text";
    centerArea.appendChild(hintDiv);

    const expDiv = document.createElement("div");
    expDiv.className = "explanation-text";
    centerArea.appendChild(expDiv);

    if (!blankElems.length || !options.length) {
      hintDiv.textContent = "Î¨∏Ìï≠ Îç∞Ïù¥ÌÑ∞Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.";
      setProgress(idx, total);
      return;
    }

    let selectedBlank = 0;
    const assignedOptionIndex = new Array(blankElems.length).fill(null);
    const optionAssignedBlank = new Array(options.length).fill(null);
    let finished = false;

    function updateBlankSelection() {
      blankElems.forEach((b, i) => {
        b.classList.toggle("selected", i === selectedBlank);
      });
    }

    blankElems.forEach((b, i) => {
      b.onclick = () => {
        if (finished) return;
        selectedBlank = i;
        updateBlankSelection();
      };
    });

    function autoCheckIfAllFilled() {
      for (let i = 0; i < blankElems.length; i++) {
        if (assignedOptionIndex[i] === null) {
          return;
        }
      }

      let allCorrect = true;

      blankElems.forEach((blankElem, i) => {
        const optIdx = assignedOptionIndex[i];
        const chosen = options[optIdx] || "";
        const answer = (blanks[i] || "").trim().toLowerCase();

        const isCorrect = chosen.trim().toLowerCase() === answer;

        blankElem.classList.remove("correct", "wrong");

        if (isCorrect) {
          blankElem.classList.add("correct");
        } else {
          blankElem.classList.add("wrong");
          allCorrect = false;
        }
      });

      if (allCorrect) {
        finished = true;
        hintDiv.textContent = "";
        expDiv.textContent = q.explanation || "Ï†ïÎãµÏûÖÎãàÎã§! ÏûòÌñàÏñ¥Ïöî. üëè";
        setTimer(goNext, 1500);
      } else {
        hintDiv.textContent = "ÌãÄÎ¶∞ ÎπàÏπ∏Ïù¥ ÏûàÏñ¥Ïöî. Îã§Ïãú Ìïú Î≤à ÌôïÏù∏Ìï¥ Î≥¥ÏÑ∏Ïöî.";
        expDiv.textContent = q.explanation || "";
        if (!q._countedWrong) {
          q._countedWrong = true;
          wrongQuestions.passage.push(q);
        }
      }
    }

    function createOptionChip(word, i) {
      const chip = document.createElement("div");
      chip.className = "word-chip";
      chip.textContent = word;

      chip.onclick = () => {
        if (finished) return;

        if (selectedBlank == null) {
          selectedBlank = 0;
          updateBlankSelection();
        }

        const currentBlank = selectedBlank;

        const prevBlankForThisOption = optionAssignedBlank[i];
        if (prevBlankForThisOption !== null) {
          if (prevBlankForThisOption === currentBlank) {
            optionAssignedBlank[i] = null;
            assignedOptionIndex[currentBlank] = null;
            blankElems[currentBlank].textContent = "";
            blankElems[currentBlank].classList.remove("correct", "wrong");
            chip.classList.remove("used");
            hintDiv.textContent = "";
            return;
          } else {
            assignedOptionIndex[prevBlankForThisOption] = null;
            blankElems[prevBlankForThisOption].textContent = "";
            blankElems[prevBlankForThisOption].classList.remove(
              "correct",
              "wrong"
            );
          }
        }

        const prevOptionIndexForBlank = assignedOptionIndex[currentBlank];
        if (
          prevOptionIndexForBlank !== null &&
          prevOptionIndexForBlank !== i
        ) {
          optionAssignedBlank[prevOptionIndexForBlank] = null;
          const prevChip = chipsWrap.children[prevOptionIndexForBlank];
          if (prevChip) prevChip.classList.remove("used");
        }

        assignedOptionIndex[currentBlank] = i;
        optionAssignedBlank[i] = currentBlank;

        blankElems[currentBlank].textContent = word;
        blankElems[currentBlank].classList.remove("correct", "wrong");
        chip.classList.add("used");
        hintDiv.textContent = "";

        let nextIndex = null;

        for (let b = currentBlank + 1; b < blankElems.length; b++) {
          if (assignedOptionIndex[b] === null) {
            nextIndex = b;
            break;
          }
        }

        if (nextIndex === null) {
          for (let b = 0; b < currentBlank; b++) {
            if (assignedOptionIndex[b] === null) {
              nextIndex = b;
              break;
            }
          }
        }

        if (nextIndex !== null) {
          selectedBlank = nextIndex;
          updateBlankSelection();
        }

        autoCheckIfAllFilled();
      };

      return chip;
    }

    options.forEach((word, i) => {
      const chip = createOptionChip(word, i);
      chipsWrap.appendChild(chip);
    });

    selectedBlank = 0;
    updateBlankSelection();

    setProgress(idx, total);
  }

  /* ========== Í≥µÌÜµ Î†åÎçîÎßÅ ========== */

  function renderQuestionObj(q, type) {
    const list  = questionsByType[type];
    const idx   = list.indexOf(q);
    const total = list.length;

    if (type === "blank")   return renderBlankQuestion(q, idx, total);
    if (type === "order")   return renderOrderQuestion(q, idx, total);
    if (type === "type")    return renderTypeQuestion(q, idx, total);
    if (type === "choose")  return renderChooseQuestion(q, idx, total);
    if (type === "passage") return renderPassageQuestion(q, idx, total);

    renderNoQuestion();
  }

  function renderCurrent() {
    clearTimers();

    modeTabs.forEach(tab => {
      tab.classList.toggle("active", tab.dataset.mode === currentMode);
    });

    // Î¨∏Ïû• Í≥†Î•¥Í∏∞ Î™®ÎìúÏùº Îïå Îã§Ïãú ÌíÄÍ∏∞ Î≤ÑÌäºÎèÑ ÌïëÌÅ¨ÏÉâ
    if (currentMode === "choose") {
      modeResetBtn.classList.add("pill-back-color");
    } else {
      modeResetBtn.classList.remove("pill-back-color");
    }

    let list = questionsByType[currentMode];
    if (!list || !list.length) {
      renderNoQuestion();
      return;
    }

    if (!list._shuffled) {
      list = shuffle(list);
      list._shuffled = true;
      questionsByType[currentMode] = list;
    }

    const idx = modeIndex[currentMode];
    const q   = list[idx];

    if (!q) {
      renderNoQuestion();
      return;
    }

    renderQuestionObj(q, currentMode);
  }

  /* ÌÉ≠ / Î≤ÑÌäº Ïù¥Î≤§Ìä∏ */

  modeTabs.forEach(tab => {
    tab.onclick = () => {
      currentMode = tab.dataset.mode;
      modeIndex[currentMode] = 0;
      renderCurrent();
    };
  });

  modeResetBtn.onclick = () => {
    clearTimers();
    Object.keys(modeIndex).forEach(k => (modeIndex[k] = 0));
    Object.keys(wrongQuestions).forEach(k => (wrongQuestions[k] = []));
    Object.keys(questionsByType).forEach(type => {
      const list = questionsByType[type];
      if (list && list.length) {
        const shuffled = shuffle(list);
        shuffled._shuffled = true;
        questionsByType[type] = shuffled;
      }
    });
    renderCurrent();
  };

  backToUnitsBtn.onclick = () => {
    clearTimers();
    if (schoolId) {
      // ÌïôÍµê ÏÑ∏Ìä∏ Î¶¨Ïä§Ìä∏Î°ú Ïù¥Îèô
      location.href =
        "sentence-school-detail.html?school=" + encodeURIComponent(schoolId);
    } else {
      window.history.back();
    }
  };

  renderCurrent();
</script>
</body>
</html>
