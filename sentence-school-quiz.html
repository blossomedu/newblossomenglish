<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í•™êµ ì‹œí—˜ - ë¬¸ì¥ í•™ìŠµ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #f3f4f6;
      color: #111827;
    }

    .page {
      max-width: 960px;
      margin: 24px auto 32px;
      padding: 0 16px;
    }

    .main-title {
      font-size: 28px;
      font-weight: 800;
      margin: 0 0 16px;
    }

    .top-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }

    .mode-tab {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 14px;
      background: #e5e7eb;
      color: #374151;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .mode-tab.active {
      background: #00aeef;
      color: #ffffff;
      box-shadow: 0 12px 25px rgba(0, 174, 239, 0.35);
    }

    /* íƒ­ë³„ í™œì„± ìƒ‰ */
    .mode-tab:nth-child(1).active {
      background: #00aeef;
    }
    .mode-tab:nth-child(2).active {
      background: #ff6fb5;
    }
    .mode-tab:nth-child(3).active {
      background: #00aeef;
    }
    .mode-tab:nth-child(4).active {
      background: #ff6fb5;
    }
    .mode-tab:nth-child(5).active {
      background: #00aeef;
    }

    .card {
      background: #ffffff;
      border-radius: 28px;
      padding: 32px 24px 24px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
      min-height: 380px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .center-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: center;
      gap: 20px;
      text-align: left;
      padding: 10px;
    }

    .question-text {
      font-size: 20px;
      font-weight: 700;
      white-space: pre-line;
    }

    .sentence-en {
      font-size: 24px;
      margin-top: 8px;
      white-space: pre-line;
    }

    .sentence-kr {
      font-size: 18px;
      color: #4b5563;
      margin-top: 4px;
    }

    .blank-line {
      display: inline-block;
      min-width: 180px;
      border-bottom: 2px solid #111827;
      margin: 0 4px;
    }

    /* ===== (1) ë¹ˆì¹¸ ì™„ì„± / (4) ë¬¸ì¥ ê³ ë¥´ê¸° ê³µí†µ ì¹´ë“œ ===== */

    .blank-choice-area {
      min-height: 140px;
      background: #eef4ff;
      border-radius: 22px;
      padding: 24px 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 18px;
    }

    .choices-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px 20px;
      width: 100%;
      max-width: 520px;
    }

    .choice-btn {
      width: 100%;
      min-height: 52px;
      border-radius: 999px;
      border: 1.5px solid #d0d7e6;
      background: #ffffff;
      cursor: pointer;
      font-size: 18px;
      font-weight: 500;
      padding: 8px 14px;
      text-align: left;
      transition: 0.15s ease;
    }

    .choice-btn:hover {
      background: #e5f0ff;
      border-color: #8ab4ff;
    }

    .choice-btn.correct {
      background: #dcfce7;
      border-color: #22c55e;
      color: #166534;
    }

    .choice-btn.wrong {
      background: #fee2e2;
      border-color: #f97373;
      color: #b91c1c;
    }

    .word-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 14px;
    }

    .word-chip {
      padding: 8px 18px;
      border-radius: 999px;
      background: #ffffff;
      border: 1.5px solid #d0d7e6;
      cursor: pointer;
      font-size: 20px;
      font-weight: 500;
      transition: 0.15s ease;
    }

    .word-chip:hover {
      background: #e8f0ff;
      border-color: #8ab4ff;
    }

    .word-chip.used {
      background: #d6e8ff;
      border-color: #5c9dff;
    }

    .word-chip.selected {
      background: #d6e8ff;
      border-color: #5c9dff;
      transform: scale(1.05);
    }

    /* ===== (3) ë¬¸ì¥ ì™„ì„±(íƒ€ì´í•‘) ===== */

    .typing-area {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
    }

    .typing-box-area {
      width: 100%;
      min-height: 140px;
      background: #eef4ff;
      border-radius: 22px;
      padding: 24px 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 8px;
    }

    .typing-sentence-box {
      background: transparent;
      border-radius: 0;
      padding: 0;
      min-height: 0;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      font-size: 22px;
      max-width: 820px;
      width: 100%;
    }

    .typing-input-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      max-width: 520px;
      margin-top: 16px;
    }

    .inline-blank-input {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 120px;
      height: 44px;
      padding: 0 18px;
      border-radius: 999px;
      border: 1.5px solid #d0d7e6;
      background: #ffffff;
      font-size: 20px;
      font-weight: 500;
      text-align: center;
      outline: none;
      margin: 0 6px;
      transition: all 0.15s ease;
    }

    .inline-blank-input:focus {
      border-color: #a5b4fc;
      background: #e5e7ff;
    }

    .inline-blank-input.correct {
      background: #dcfce7;
      border-color: #22c55e;
    }

    .inline-blank-input.wrong {
      background: #fee2e2;
      border-color: #f97373;
    }

    /* í™•ì¸ ë²„íŠ¼: ë¯¼íŠ¸ìƒ‰ (#9AD7A0) â€“ íƒ€ì´í•‘(type)ì—ì„œë§Œ ì‚¬ìš© */
    .typing-check-btn {
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      background: #9ad7a0;
      color: #ffffff;
      font-size: 16px;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.15s ease, transform 0.1s ease;
    }

    .typing-check-btn:hover:not(:disabled) {
      background: #86c48d;
      transform: translateY(-1px);
    }

    .typing-check-btn:disabled {
      opacity: 0.7;
      cursor: default;
      transform: none;
    }

    .typing-hint {
      font-size: 16px;
      color: #6b7280;
      margin-top: 4px;
    }

    .hint-text {
      font-size: 16px;
      color: #f97316;
      min-height: 22px;
    }

    .explanation-text {
      font-size: 16px;
      color: #4b5563;
      min-height: 22px;
    }

    /* ===== (5) ì§€ë¬¸ ì™„ì„± (passage) ===== */

    .passage-area {
      background: #eef4ff;
      border-radius: 22px;
      padding: 24px 26px;
      margin-top: 12px;
      font-size: 18px;
      line-height: 1.7;
      white-space: pre-line;
    }

    .passage-text {
      white-space: pre-line;
      font-size: 20px;
    }

    .passage-blank {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 110px;
      height: 34px; /* ë†’ì´ ì‚´ì§ ì¤„ì„ */
      padding: 0 16px;
      margin: 0 4px;
      border-radius: 999px;
      border: 1.5px solid #d0d7e6;
      background: #ffffff;
      font-size: 18px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .passage-blank.selected {
      border-color: #5c9dff;
      background: #e5f0ff;
      box-shadow: 0 0 0 2px rgba(92, 157, 255, 0.25);
    }

    .passage-blank.correct {
      background: #dcfce7;
      border-color: #22c55e;
      color: #166534;
    }

    .passage-blank.wrong {
      background: #fee2e2;
      border-color: #f97373;
      color: #b91c1c;
    }

    .bottom-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
      gap: 10px;
      font-size: 14px;
      color: #6b7280;
    }

    .bottom-right {
      display: flex;
      gap: 10px;
      margin-left: auto;
    }

    .nav-pill {
      padding: 9px 18px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }

    .pill-reset {
      background: #00aeef;
      color: #ffffff;
    }

    .pill-back {
      background: #ff6fb5;
      color: #ffffff;
    }

    @media (max-width: 600px) {
      .card {
        padding: 24px 18px 20px;
      }
      .sentence-en {
        font-size: 21px;
      }
      .choice-btn {
        font-size: 16px;
        min-height: 48px;
      }
      .word-chip {
        font-size: 18px;
      }
      .typing-sentence-box {
        font-size: 20px;
      }
      .inline-blank-input {
        font-size: 18px;
        min-width: 90px;
        height: 40px;
      }
      .passage-area {
        font-size: 17px;
        padding: 18px 18px;
      }
      .passage-blank {
        min-width: 90px;
        height: 32px; /* ëª¨ë°”ì¼ì—ì„œë„ ì¡°ê¸ˆ ì¤„ì¸ ë†’ì´ */
        font-size: 17px;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <h1 class="main-title" id="mainTitle">í•™êµ ì‹œí—˜</h1>

    <div class="top-bar">
      <button class="mode-tab active" data-mode="blank">ğŸ§© ë¹ˆì¹¸ ì™„ì„±</button>
      <button class="mode-tab" data-mode="order">ğŸ”€ ë¬¸ì¥ ë°°ì—´</button>
      <button class="mode-tab" data-mode="type">âœ ë¬¸ì¥ ì™„ì„±</button>
      <button class="mode-tab" data-mode="choose">âœ… ë¬¸ì¥ ê³ ë¥´ê¸°</button>
      <button class="mode-tab" data-mode="passage">ğŸ“– ì§€ë¬¸ ì™„ì„±</button>
    </div>

    <div class="card">
      <div class="center-area" id="centerArea"></div>

      <div class="bottom-bar">
        <div id="progressText">0 / 0</div>
        <div class="bottom-right">
          <button type="button" class="nav-pill pill-reset" id="modeResetBtn">
            ë‹¤ì‹œ í’€ê¸°
          </button>
          <button type="button" class="nav-pill pill-back" id="backToUnitsBtn">
            ëŒì•„ê°€ê¸°
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- â˜…â˜…â˜… í•™êµ ì‹œí—˜ ì „ìš© ë°ì´í„° íŒŒì¼ â˜…â˜…â˜… -->
  <script src="sentence-school.js"></script>

  <script>
    /* ================== íŒŒë¼ë¯¸í„° & íƒ€ì´í‹€ ================== */
    const params = new URLSearchParams(window.location.search);
    const rawUnit = params.get("unit") || "1-1"; // ì˜ˆ: 1-1 ë˜ëŠ” jsm1-1
    let schoolId = params.get("school") || "";

    // ì‹¤ì œ DBì—ì„œ ì‚¬ìš©í•  í‚¤ (1-1, 1-2 .)
    let unitKey = rawUnit;

    // rawUnitì´ jsm1-1, scm2-3 ì´ëŸ° íŒ¨í„´ì´ë©´ ë¶„ë¦¬
    const m = rawUnit.match(/^([a-z]+[0-9]+)-([0-9]+)$/i);
    if (m) {
      // m[1] = jsm1, m[2] = 1
      if (!schoolId) schoolId = m[1];

      const gradeMatch = m[1].match(/(\d+)$/); // jsm1 â†’ 1
      const grade = gradeMatch ? gradeMatch[1] : "1";
      const setNo = m[2]; // 1
      unitKey = `${grade}-${setNo}`; // 1-1
    }

    const mainTitle = document.getElementById("mainTitle");
    const centerArea = document.getElementById("centerArea");
    const progressText = document.getElementById("progressText");
    const modeTabs = document.querySelectorAll(".mode-tab");
    const modeResetBtn = document.getElementById("modeResetBtn");
    const backToUnitsBtn = document.getElementById("backToUnitsBtn");

    // í•™êµ ì´ë¦„ ë§¤í•‘
    const SCHOOL_LABELS = {
      jsm1: "ì ì‹ ì¤‘ 1",
      jsm2: "ì ì‹ ì¤‘ 2",
      jsm3: "ì ì‹ ì¤‘ 3",
      scm1: "ì‹ ì²œì¤‘ 1",
      scm2: "ì‹ ì²œì¤‘ 2",
      scm3: "ì‹ ì²œì¤‘ 3",
      jsh1: "ì ì‹ ê³  1",
      jsh2: "ì ì‹ ê³  2",
      jsh3: "ì ì‹ ê³  3",
    };

    const schoolLabel = SCHOOL_LABELS[schoolId] || "í•™êµ ì‹œí—˜";

    // íƒ€ì´í‹€: ì ì‹ ì¤‘ 1 1-1 ì´ëŸ° ëŠë‚Œ
    if (schoolId) {
      mainTitle.textContent = `${schoolLabel} ${unitKey}`;
    } else {
      mainTitle.textContent = `í•™êµ ì‹œí—˜ ${unitKey}`;
    }

    /* ================== DB ë¶ˆëŸ¬ì˜¤ê¸° ================== */
    const SENTENCE_DB = window.SENTENCE_SCHOOL_DB || {};
    const allQuestions = SENTENCE_DB[unitKey] || [];

    /* ìœ í˜•ë³„ ì €ì¥ */
    const questionsByType = {
      blank: [],
      order: [],
      type: [],
      choose: [],
      passage: [],
    };

    allQuestions.forEach((q) => {
      if (!q || !q.type) return;
      if (questionsByType[q.type]) {
        questionsByType[q.type].push(q);
      }
    });

    /* í˜„ì¬ ëª¨ë“œ / ì¸ë±ìŠ¤ */
    let currentMode = "blank";
    const modeIndex = {
      blank: 0,
      order: 0,
      type: 0,
      choose: 0,
      passage: 0,
    };

    /* í‹€ë¦° ë¬¸ì œ ë‹¤ì‹œ í (ì§€ê¸ˆì€ ì•ˆ ì“°ì§€ë§Œ ë‚¨ê²¨ë‘ ) */
    const wrongQuestions = {
      blank: [],
      order: [],
      type: [],
      choose: [],
      passage: [],
    };

    /* ì…”í”Œ */
    function shuffle(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    /* íƒ€ì´ë¨¸ (blank / choose / orderì—ì„œë§Œ ì‚¬ìš©) */
    let activeTimers = [];
    function clearTimers() {
      activeTimers.forEach((id) => clearTimeout(id));
      activeTimers = [];
    }
    function setTimer(fn, ms) {
      const id = setTimeout(fn, ms);
      activeTimers.push(id);
      return id;
    }

    /* ì§„í–‰ í‘œì‹œ */
    function setProgress(idx, total) {
      progressText.textContent = total ? `${idx + 1} / ${total}` : "0 / 0";
    }

    /* í™”ë©´ ì´ˆê¸°í™” */
    function clearCenter() {
      centerArea.innerHTML = "";
    }

    function renderNoQuestion() {
      clearCenter();
      const a = document.createElement("div");
      a.className = "question-text";
      a.textContent = "ì´ ìœ í˜•ì˜ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.";
      centerArea.appendChild(a);

      const b = document.createElement("div");
      b.className = "sentence-en";
      b.textContent = "ë¬¸ì œë¥¼ ì¶”ê°€í•˜ë©´ ë°”ë¡œ ì—¬ê¸°ì„œ í’€ ìˆ˜ ìˆì–´ìš”.";
      centerArea.appendChild(b);

      setProgress(0, 0);
    }

    /* ë²ˆí˜¸ ë™ê·¸ë¼ë¯¸ */
    const CIRCLED_NUMS = ["â‘ ", "â‘¡", "â‘¢", "â‘£", "â‘¤"];

    /* í‹€ë¦° ë¬¸ì œ ì¬ì¶œì œ í (ê°ê´€ì‹) */
    function enqueueRetryQuestion(type, q) {
      if (q._retryAdded) return;
      q._retryAdded = true;
      questionsByType[type].push(q);
    }

    /* ë‹¤ìŒ ë¬¸ì œ */
    function goNext() {
      const list = questionsByType[currentMode];
      if (!list || !list.length) {
        renderNoQuestion();
        return;
      }

      modeIndex[currentMode]++;
      const idx = modeIndex[currentMode];
      const total = list.length;

      if (idx >= total) {
        clearCenter();
        const done = document.createElement("div");
        done.className = "question-text";
        done.textContent = "ì´ ìœ í˜•ì˜ ë¬¸ì œë¥¼ ëª¨ë‘ í’€ì—ˆìŠµë‹ˆë‹¤. ğŸ˜Š";
        centerArea.appendChild(done);
        setProgress(total, total);
      } else {
        renderCurrent();
      }
    }

    /* ========== (1) ë¹ˆì¹¸ ì™„ì„± ========== */
    function renderBlankQuestion(q, idx, total) {
      clearTimers();
      clearCenter();

      const qDiv = document.createElement("div");
      qDiv.className = "question-text";
      qDiv.textContent = "ë¹ˆì¹¸ì— ì•Œë§ì€ ë§ì„ ê³ ë¥´ì„¸ìš”.";
      centerArea.appendChild(qDiv);

      const sDiv = document.createElement("div");
      sDiv.className = "sentence-en";
      sDiv.innerHTML = (q.question || "").replace(
        "____",
        "<span class='blank-line'></span>"
      );
      centerArea.appendChild(sDiv);

      const choiceArea = document.createElement("div");
      choiceArea.className = "blank-choice-area";
      centerArea.appendChild(choiceArea);

      const grid = document.createElement("div");
      grid.className = "choices-grid";
      choiceArea.appendChild(grid);

      const hintDiv = document.createElement("div");
      hintDiv.className = "hint-text";
      centerArea.appendChild(hintDiv);

      const expDiv = document.createElement("div");
      expDiv.className = "explanation-text";
      centerArea.appendChild(expDiv);

      let answered = false;
      const correctIndex =
        typeof q.answerIndex === "number" ? q.answerIndex : 0;

      (q.options || []).forEach((opt, i) => {
        const btn = document.createElement("button");
        btn.className = "choice-btn";
        btn.textContent = `${CIRCLED_NUMS[i]} ${opt}`;
        grid.appendChild(btn);

        btn.onclick = () => {
          if (answered) return;

          const isCorrect = i === correctIndex;

          if (isCorrect) {
            answered = true;
            clearTimers();
            btn.classList.add("correct");
            hintDiv.textContent = "";
            expDiv.textContent = q.explanation || "ì •ë‹µì…ë‹ˆë‹¤!";
            setTimer(goNext, 1000);
          } else {
            btn.classList.add("wrong");
            hintDiv.textContent = "íŒíŠ¸: ë‹¤ì‹œ ìƒê°í•´ ë³´ì„¸ìš”.";
            enqueueRetryQuestion("blank", q);
          }
        };
      });

      // 15ì´ˆ í›„ ìë™ ê³µê°œ
      setTimer(() => {
        if (answered) return;
        answered = true;

        [...grid.children].forEach((b, idxBtn) => {
          if (idxBtn === correctIndex) b.classList.add("correct");
        });

        hintDiv.textContent = "ì‹œê°„ì´ ì§€ë‚˜ ì •ë‹µì´ ê³µê°œë˜ì—ˆìŠµë‹ˆë‹¤.";
        expDiv.textContent = q.explanation || "";

        setTimer(goNext, 1500);
      }, 15000);

      setProgress(idx, total);
    }

    /* ========== (2) ë¬¸ì¥ ë°°ì—´ ========== */
    function renderOrderQuestion(q, idx, total) {
      clearTimers();
      clearCenter();

      const qDiv = document.createElement("div");
      qDiv.className = "question-text";
      qDiv.textContent =
        q.question || "ë‹¤ìŒ ë‹¨ì–´ë¥¼ ë°”ë¥´ê²Œ ë°°ì—´í•˜ì—¬ ë¬¸ì¥ì„ ë§Œë“œì‹œì˜¤.";
      centerArea.appendChild(qDiv);

      if (q.meaningKo) {
        const ko = document.createElement("div");
        ko.className = "sentence-kr";
        ko.textContent = q.meaningKo;
        centerArea.appendChild(ko);
      }

      const correctWords = (q.answerEn || "")
        .trim()
        .split(" ")
        .map((w) => w.trim())
        .filter(Boolean);

      let currentIndex = 0;
      let finished = false;
      let pool = shuffle(correctWords.slice());

      const answerRow = document.createElement("div");
      answerRow.className = "answer-row";
      centerArea.appendChild(answerRow);

      const slots = [];
      correctWords.forEach(() => {
        const slot = document.createElement("div");
        slot.style.minWidth = "80px";
        slot.style.minHeight = "44px";
        slot.style.borderRadius = "999px";
        slot.style.border = "1.5px solid #d0d7e6";
        slot.style.background = "#ffffff";
        slot.style.display = "flex";
        slot.style.alignItems = "center";
        slot.style.justifyContent = "center";
        slot.style.fontSize = "20px";
        slot.style.fontWeight = "500";
        slot.textContent = "";
        answerRow.appendChild(slot);
        slots.push(slot);
      });

      const chipsWrap = document.createElement("div");
      chipsWrap.className = "word-chips";
      centerArea.appendChild(chipsWrap);

      const hintDiv = document.createElement("div");
      hintDiv.className = "hint-text";
      centerArea.appendChild(hintDiv);

      function refreshChips() {
        chipsWrap.innerHTML = "";

        pool.forEach((word, i) => {
          const chip = document.createElement("div");
          chip.className = "word-chip";
          chip.textContent = word;

          chip.onclick = () => {
            if (finished) return;

            const expected = correctWords[currentIndex];
            if (!expected) return;

            if (word === expected) {
              const slot = slots[currentIndex];
              slot.textContent = word;
              slot.style.background = "#d6e8ff";
              slot.style.borderColor = "#5c9dff";

              pool.splice(i, 1);
              currentIndex++;
              refreshChips();

              if (currentIndex >= correctWords.length) {
                finished = true;
                hintDiv.textContent = "ì •ë‹µì…ë‹ˆë‹¤!";
                setTimer(goNext, 1000);
              }
            } else {
              const originalBg = chip.style.background;
              const originalBorder = chip.style.borderColor;

              chip.style.background = "#fee2e2";
              chip.style.borderColor = "#f97373";
              hintDiv.textContent = "í•´ë‹¹ ìœ„ì¹˜ì— ë“¤ì–´ê°ˆ ë‹¨ì–´ê°€ ì•„ë‹ˆì—ìš”.";

              if (!q._countedWrong) {
                q._countedWrong = true;
                wrongQuestions.order.push(q);
              }

              setTimeout(() => {
                chip.style.background = originalBg || "#ffffff";
                chip.style.borderColor = originalBorder || "#d0d7e6";
              }, 350);
            }
          };

          chipsWrap.appendChild(chip);
        });
      }

      // 30ì´ˆ í›„ ìë™ ì •ë‹µ ê³µê°œ
      setTimer(() => {
        if (finished) return;
        finished = true;

        correctWords.forEach((w, idxWord) => {
          const slot = slots[idxWord];
          slot.textContent = w;
          slot.style.background = "#e5f3ff";
          slot.style.borderColor = "#9cc4ff";
        });
        chipsWrap.innerHTML = "";
        hintDiv.textContent = "(ì‹œê°„ì´ ì§€ë‚˜ ì •ë‹µì´ ê³µê°œë˜ì—ˆìŠµë‹ˆë‹¤.)";

        setTimer(goNext, 5000);
      }, 30000);

      refreshChips();
      setProgress(idx, total);
    }

    /* ========== (3) ë¬¸ì¥ ì™„ì„± (íƒ€ì´í•‘) ========== */
    /* ì‹œê°„ ì œí•œ ì—†ìŒ */
    function renderTypeQuestion(q, idx, total) {
      clearTimers();
      clearCenter();

      const qDiv = document.createElement("div");
      qDiv.className = "question-text";
      qDiv.textContent = "ë¹ˆì¹¸ì„ ì±„ì›Œ ë¬¸ì¥ì„ ì™„ì„±í•˜ì„¸ìš”.";
      centerArea.appendChild(qDiv);

      if (q.meaningKo) {
        const kr = document.createElement("div");
        kr.className = "sentence-kr";
        kr.textContent = q.meaningKo;
        centerArea.appendChild(kr);
      }

      const typingHintTop = document.createElement("div");
      typingHintTop.className = "typing-hint";
      centerArea.appendChild(typingHintTop);

      const typingArea = document.createElement("div");
      typingArea.className = "typing-area";
      centerArea.appendChild(typingArea);

      const boxArea = document.createElement("div");
      boxArea.className = "typing-box-area";
      typingArea.appendChild(boxArea);

      const sentenceBox = document.createElement("div");
      sentenceBox.className = "typing-sentence-box";
      boxArea.appendChild(sentenceBox);

      const rawSentence = String(q.answerEn || "");
      const tokens = rawSentence
        .split(" ")
        .map((t) => t.trim())
        .filter(Boolean);

      let blankTargets = [];
      if (q.blankWords) {
        blankTargets = String(q.blankWords)
          .split(",")
          .map((w) => w.trim().toLowerCase())
          .filter(Boolean);
      } else {
        // ë³„ë„ ì§€ì •ì´ ì—†ìœ¼ë©´ ë§ˆì§€ë§‰ ë‹¨ì–´ë§Œ ë¹ˆì¹¸
        if (tokens.length > 0) {
          blankTargets = [tokens[tokens.length - 1].toLowerCase()];
        }
      }

      const blankInputs = [];

      tokens.forEach((word, i) => {
        const m = word.match(/^(.+?)([.,!?])$/);
        const core = m ? m[1] : word;
        const punctuation = m ? m[2] : "";

        const normCore = core.toLowerCase();
        const isBlankTarget = blankTargets.includes(normCore);

        if (isBlankTarget) {
          const input = document.createElement("input");
          input.type = "text";
          input.className = "inline-blank-input";
          input.dataset.answer = normCore;
          input.dataset.answerDisplay = core;
          blankInputs.push(input);
          sentenceBox.appendChild(input);
          if (punctuation) {
            const spanP = document.createElement("span");
            spanP.textContent = punctuation;
            sentenceBox.appendChild(spanP);
          }
        } else {
          const span = document.createElement("span");
          span.textContent = core + (punctuation ? punctuation : "");
          sentenceBox.appendChild(span);
        }

        sentenceBox.appendChild(document.createTextNode(" "));
      });

      const controls = document.createElement("div");
      controls.className = "typing-input-wrap";
      typingArea.appendChild(controls);

      const filler = document.createElement("div");
      filler.style.flex = "1";
      controls.appendChild(filler);

      const checkBtn = document.createElement("button");
      checkBtn.type = "button";
      checkBtn.className = "typing-check-btn";
      checkBtn.textContent = "í™•ì¸";
      controls.appendChild(checkBtn);

      const hintDiv = document.createElement("div");
      hintDiv.className = "hint-text";
      centerArea.appendChild(hintDiv);

      const expDiv = document.createElement("div");
      expDiv.className = "explanation-text";
      centerArea.appendChild(expDiv);

      let finished = false;

      function handleCheck() {
        if (finished) return;

        let allFilled = true;
        let allCorrect = true;

        blankInputs.forEach((input) => {
          const user = String(input.value || "").trim().toLowerCase();
          const ans = String(input.dataset.answer || "").toLowerCase();

          if (!user) {
            allFilled = false;
            input.classList.remove("correct", "wrong");
            return;
          }

          if (user === ans) {
            input.classList.remove("wrong");
            input.classList.add("correct");
          } else {
            allCorrect = false;
            input.classList.remove("correct");
            input.classList.add("wrong");
          }
        });

        if (!allFilled) {
          hintDiv.textContent = "ëª¨ë“  ë¹ˆì¹¸ì„ ë¨¼ì € ì…ë ¥í•´ ë³´ì„¸ìš”.";
          return;
        }

        if (allCorrect) {
          finished = true;
          hintDiv.textContent = "";
          expDiv.textContent = "ì •ë‹µì…ë‹ˆë‹¤! ğŸ‘";
          checkBtn.disabled = true;
          setTimer(goNext, 1200);
        } else {
          hintDiv.textContent = "ì² ìì™€ ë„ì–´ì“°ê¸°ë¥¼ ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸í•´ ë³´ì„¸ìš”.";
          expDiv.textContent = "";
          if (!q._countedWrong) {
            q._countedWrong = true;
            wrongQuestions.type.push(q);
          }
        }
      }

      checkBtn.onclick = handleCheck;

      blankInputs.forEach((input, idx) => {
        input.addEventListener("keydown", (e) => {
          if (e.key === " " || e.key === "Spacebar" || e.key === "Enter") {
            e.preventDefault();
            const lastIndex = blankInputs.length - 1;
            if (idx < lastIndex) {
              blankInputs[idx + 1].focus();
            } else {
              handleCheck();
            }
          }
        });
      });

      if (blankInputs[0]) {
        blankInputs[0].focus();
      }

      setProgress(idx, total);
    }

    /* ========== (4) ë¬¸ì¥ ê³ ë¥´ê¸° ========== */

    function renderChooseQuestion(q, idx, total) {
      clearTimers();
      clearCenter();

      const qDiv = document.createElement("div");
      qDiv.className = "question-text";
      qDiv.textContent = q.question || "ë‹¤ìŒ ì¤‘ ì˜¬ë°”ë¥¸ ë¬¸ì¥ì„ ê³ ë¥´ì‹œì˜¤.";
      centerArea.appendChild(qDiv);

      const choiceArea = document.createElement("div");
      choiceArea.className = "blank-choice-area";
      centerArea.appendChild(choiceArea);

      const grid = document.createElement("div");
      grid.className = "choices-grid";
      choiceArea.appendChild(grid);

      const hintDiv = document.createElement("div");
      hintDiv.className = "hint-text";
      centerArea.appendChild(hintDiv);

      const expDiv = document.createElement("div");
      expDiv.className = "explanation-text";
      centerArea.appendChild(expDiv);

      let answered = false;
      const correctIndex =
        typeof q.answerIndex === "number" ? q.answerIndex : 0;

      (q.options || []).forEach((opt, i) => {
        const btn = document.createElement("button");
        btn.className = "choice-btn";
        btn.textContent = `${CIRCLED_NUMS[i]} ${opt}`;
        grid.appendChild(btn);

        btn.onclick = () => {
          if (answered) return;

          const isCorrect = i === correctIndex;

          if (isCorrect) {
            answered = true;
            clearTimers();
            btn.classList.add("correct");
            hintDiv.textContent = "";
            expDiv.textContent = q.explanation || "ì •ë‹µì…ë‹ˆë‹¤!";
            setTimer(goNext, 1000);
          } else {
            btn.classList.add("wrong");
            hintDiv.textContent = "ë‹¤ë¥¸ ë¬¸ì¥ê³¼ ë¹„êµí•´ì„œ ë‹¤ì‹œ ìƒê°í•´ ë³´ì„¸ìš”.";
            enqueueRetryQuestion("choose", q);
          }
        };
      });

      // 15ì´ˆ í›„ ìë™ ê³µê°œ
      setTimer(() => {
        if (answered) return;
        answered = true;

        [...grid.children].forEach((b, idxBtn) => {
          if (idxBtn === correctIndex) b.classList.add("correct");
        });

        hintDiv.textContent = "ì‹œê°„ì´ ì§€ë‚˜ ì •ë‹µì´ ê³µê°œë˜ì—ˆìŠµë‹ˆë‹¤.";
        expDiv.textContent = q.explanation || "";

        setTimer(goNext, 2000);
      }, 15000);

      setProgress(idx, total);
    }

    /* ========== (5) ì§€ë¬¸ ì™„ì„± (passage) ========== */
    /* ì‹œê°„ ì œí•œ ì—†ìŒ, í™•ì¸ ë²„íŠ¼ ì—†ì´ ìë™ ì±„ì  */

    function renderPassageQuestion(q, idx, total) {
      clearTimers();
      clearCenter();

      const qDiv = document.createElement("div");
      qDiv.className = "question-text";
      qDiv.textContent =
        "ì§€ë¬¸ì„ ì½ê³  ë¹ˆì¹¸ì— ì•Œë§ì€ ë‹¨ì–´ë¥¼ ë„£ìœ¼ì„¸ìš”. (ê° ë‹¨ì–´ëŠ” í•œ ë²ˆë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.)";
      centerArea.appendChild(qDiv);

      const passageArea = document.createElement("div");
      passageArea.className = "passage-area";
      centerArea.appendChild(passageArea);

      const passageTextBox = document.createElement("div");
      passageTextBox.className = "passage-text";
      passageArea.appendChild(passageTextBox);

      const passage = String(q.passage || "");
      const blanks = Array.isArray(q.blanks) ? q.blanks : [];
      const options = Array.isArray(q.options) ? q.options : [];

      const blankElems = [];
      const regex = /(\(\d+\)\s*____)/g;
      let lastIndex = 0;
      let match;
      let blankCount = 0;

      function appendText(text) {
        if (!text) return;
        const span = document.createElement("span");
        span.textContent = text;
        passageTextBox.appendChild(span);
      }

      while ((match = regex.exec(passage)) !== null) {
        const before = passage.slice(lastIndex, match.index);
        appendText(before);

        const blankSpan = document.createElement("span");
        blankSpan.className = "passage-blank";
        blankSpan.dataset.blankIndex = String(blankCount);
        blankSpan.textContent = ""; // ì¤„(____) ëŒ€ì‹  ë¹„ì›Œë‘ 
        passageTextBox.appendChild(blankSpan);

        blankElems.push(blankSpan);
        blankCount++;

        lastIndex = regex.lastIndex;
      }
      appendText(passage.slice(lastIndex));

      const chipsWrap = document.createElement("div");
      chipsWrap.className = "word-chips";
      chipsWrap.style.marginTop = "18px";
      centerArea.appendChild(chipsWrap);

      const hintDiv = document.createElement("div");
      hintDiv.className = "hint-text";
      centerArea.appendChild(hintDiv);

      const expDiv = document.createElement("div");
      expDiv.className = "explanation-text";
      centerArea.appendChild(expDiv);

      if (!blankElems.length || !options.length) {
        hintDiv.textContent = "ë¬¸í•­ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
        setProgress(idx, total);
        return;
      }

      let selectedBlank = 0;
      const assignedOptionIndex = new Array(blankElems.length).fill(null);
      const optionAssignedBlank = new Array(options.length).fill(null);
      let finished = false;

      function updateBlankSelection() {
        blankElems.forEach((b, i) => {
          b.classList.toggle("selected", i === selectedBlank);
        });
      }

      blankElems.forEach((b, i) => {
        b.onclick = () => {
          if (finished) return;
          selectedBlank = i;
          updateBlankSelection();
        };
      });

      function autoCheckIfAllFilled() {
        // ëª¨ë‘ ì±„ì›Œì¡ŒëŠ”ì§€ í™•ì¸
        for (let i = 0; i < blankElems.length; i++) {
          if (assignedOptionIndex[i] === null) {
            return; // ì•„ì§ ë‹¤ ì•ˆ ì±„ì›Œì¡Œìœ¼ë©´ ì•„ë¬´ ê²ƒë„ ì•ˆ í•¨
          }
        }

        let allCorrect = true;

        blankElems.forEach((blankElem, i) => {
          const optIdx = assignedOptionIndex[i];
          const chosen = options[optIdx] || "";
          const answer = (blanks[i] || "").trim().toLowerCase();

          const isCorrect = chosen.trim().toLowerCase() === answer;

          blankElem.classList.remove("correct", "wrong");

          if (isCorrect) {
            blankElem.classList.add("correct");
          } else {
            blankElem.classList.add("wrong");
            allCorrect = false;
          }
        });

        if (allCorrect) {
          finished = true;
          hintDiv.textContent = "";
          expDiv.textContent = q.explanation || "ì •ë‹µì…ë‹ˆë‹¤! ì˜í–ˆì–´ìš”. ğŸ‘";
          setTimer(goNext, 1500);
        } else {
          hintDiv.textContent = "í‹€ë¦° ë¹ˆì¹¸ì´ ìˆì–´ìš”. ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸í•´ ë³´ì„¸ìš”.";
          expDiv.textContent = q.explanation || "";
          if (!q._countedWrong) {
            q._countedWrong = true;
            wrongQuestions.passage.push(q);
          }
        }
      }

      function createOptionChip(word, i) {
        const chip = document.createElement("div");
        chip.className = "word-chip";
        chip.textContent = word;

        chip.onclick = () => {
          if (finished) return;

          // ì•„ì§ ì–´ë–¤ ì¹¸ë„ ì„ íƒ ì•ˆ ë¼ ìˆìœ¼ë©´ 0ë²ˆ ì¹¸ë¶€í„°
          if (selectedBlank == null) {
            selectedBlank = 0;
            updateBlankSelection();
          }

          const currentBlank = selectedBlank;

          // ì´ ì¹©ì´ ì´ë¯¸ ë‹¤ë¥¸ ì¹¸ì— ë“¤ì–´ê°€ ìˆì—ˆëŠ”ì§€ í™•ì¸
          const prevBlankForThisOption = optionAssignedBlank[i];
          if (prevBlankForThisOption !== null) {
            if (prevBlankForThisOption === currentBlank) {
              // ê°™ì€ ì¹¸ì„ ë‹¤ì‹œ ëˆŒë €ë‹¤ë©´ â†’ ì·¨ì†Œ
              optionAssignedBlank[i] = null;
              assignedOptionIndex[currentBlank] = null;
              blankElems[currentBlank].textContent = "";
              blankElems[currentBlank].classList.remove("correct", "wrong");
              chip.classList.remove("used");
              hintDiv.textContent = "";
              return;
            } else {
              // ë‹¤ë¥¸ ì¹¸ì—ì„œ ê°€ì ¸ì˜¤ëŠ” ê²½ìš°, ì´ì „ ì¹¸ ë¹„ìš°ê¸°
              assignedOptionIndex[prevBlankForThisOption] = null;
              blankElems[prevBlankForThisOption].textContent = "";
              blankElems[prevBlankForThisOption].classList.remove(
                "correct",
                "wrong"
              );
            }
          }

          // í˜„ì¬ ì¹¸ì— ì´ë¯¸ ë‹¤ë¥¸ ë‹¨ì–´ê°€ ìˆì—ˆë‹¤ë©´ ê·¸ ì¹© ìƒíƒœ ì´ˆê¸°í™”
          const prevOptionIndexForBlank = assignedOptionIndex[currentBlank];
          if (prevOptionIndexForBlank !== null && prevOptionIndexForBlank !== i) {
            optionAssignedBlank[prevOptionIndexForBlank] = null;
            const prevChip = chipsWrap.children[prevOptionIndexForBlank];
            if (prevChip) prevChip.classList.remove("used");
          }

          // í˜„ì¬ ì¹¸ì— ì´ ì¹©ì„ í• ë‹¹
          assignedOptionIndex[currentBlank] = i;
          optionAssignedBlank[i] = currentBlank;

          blankElems[currentBlank].textContent = word;
          blankElems[currentBlank].classList.remove("correct", "wrong");
          chip.classList.add("used");
          hintDiv.textContent = "";

          // ë‹¨ì–´ë¥¼ ë„£ì€ ë’¤ ë‹¤ìŒ ë¹ˆì¹¸ìœ¼ë¡œ ìë™ ì´ë™
          let nextIndex = null;

          // 1) í˜„ì¬ ì¹¸ ë’¤ìª½ì—ì„œ ë¹„ì–´ ìˆëŠ” ì¹¸ ì°¾ê¸°
          for (let b = currentBlank + 1; b < blankElems.length; b++) {
            if (assignedOptionIndex[b] === null) {
              nextIndex = b;
              break;
            }
          }

          // 2) ë’¤ìª½ì— ì—†ìœ¼ë©´ ì•ìª½ì—ì„œ ë‹¤ì‹œ ì°¾ê¸°
          if (nextIndex === null) {
            for (let b = 0; b < currentBlank; b++) {
              if (assignedOptionIndex[b] === null) {
                nextIndex = b;
                break;
              }
            }
          }

          // 3) ë¹„ì–´ ìˆëŠ” ì¹¸ì´ ìˆìœ¼ë©´ ê±°ê¸°ë¡œ selection ì´ë™
          if (nextIndex !== null) {
            selectedBlank = nextIndex;
            updateBlankSelection();
          }

          // ëª¨ë“  ì¹¸ì´ ì±„ì›Œì¡Œë‹¤ë©´ ìë™ìœ¼ë¡œ ì±„ì 
          autoCheckIfAllFilled();
        };

        return chip;
      }

      options.forEach((word, i) => {
        const chip = createOptionChip(word, i);
        chipsWrap.appendChild(chip);
      });

      selectedBlank = 0;
      updateBlankSelection();

      setProgress(idx, total);
    }

    /* ========== ê³µí†µ ë Œë”ë§ ========== */

    function renderQuestionObj(q, type) {
      const list = questionsByType[type];
      const idx = list.indexOf(q);
      const total = list.length;

      if (type === "blank") return renderBlankQuestion(q, idx, total);
      if (type === "order") return renderOrderQuestion(q, idx, total);
      if (type === "type") return renderTypeQuestion(q, idx, total);
      if (type === "choose") return renderChooseQuestion(q, idx, total);
      if (type === "passage") return renderPassageQuestion(q, idx, total);

      renderNoQuestion();
    }

    function renderCurrent() {
      clearTimers();

      modeTabs.forEach((tab) => {
        tab.classList.toggle("active", tab.dataset.mode === currentMode);
      });

      let list = questionsByType[currentMode];
      if (!list || !list.length) {
        renderNoQuestion();
        return;
      }

      if (!list._shuffled) {
        list = shuffle(list);
        list._shuffled = true;
        questionsByType[currentMode] = list;
      }

      const idx = modeIndex[currentMode];
      const q = questionsByType[currentMode][idx];

      renderQuestionObj(q, currentMode);
    }

    /* íƒ­ / ë²„íŠ¼ ì´ë²¤íŠ¸ */

    modeTabs.forEach((tab) => {
      tab.onclick = () => {
        currentMode = tab.dataset.mode;
        modeIndex[currentMode] = 0;
        renderCurrent();
      };
    });

    modeResetBtn.onclick = () => {
      clearTimers();
      Object.keys(modeIndex).forEach((k) => (modeIndex[k] = 0));
      Object.keys(wrongQuestions).forEach((k) => (wrongQuestions[k] = []));
      Object.keys(questionsByType).forEach((type) => {
        const list = questionsByType[type];
        if (list && list.length) {
          const shuffled = shuffle(list);
          shuffled._shuffled = true;
          questionsByType[type] = shuffled;
        }
      });
      renderCurrent();
    };

    backToUnitsBtn.onclick = () => {
      clearTimers();
      if (schoolId) {
        // ì ì‹ ì¤‘ 1 ì„¸íŠ¸ ë¦¬ìŠ¤íŠ¸ë¡œ
        location.href = `sentence-school-detail.html?school=${encodeURIComponent(
          schoolId
        )}`;
      } else {
        window.history.back();
      }
    };

    renderCurrent();
  </script>
</body>
</html>
