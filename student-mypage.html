<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í•™ìƒ ë§ˆì´í˜ì´ì§€ - ë¸”ë¼ì¸ì‰ê¸€ë¦¬ì‰¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />

  <style>
    :root {
      --blue: #00AEEF;
      --mint: #9FE6B8;
      --pink: #FF6FB5;
      --bg: #f4f6fb;
      --gray: #6b7280;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Pretendard Variable", -apple-system, BlinkMacSystemFont,
        system-ui, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    body {
      background: var(--bg);
      padding: 30px 0 60px;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px;
      position: relative;
    }

    /* ìƒë‹¨ ë²„íŠ¼ */
    .top-actions {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 8px;
    }

    .pill-btn {
      border-radius: 999px;
      border: none;
      padding: 8px 18px;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
      font-weight: 600;
    }

    #home-btn {
      background: var(--mint);
      color: #ffffff;
    }

    #logout-btn {
      background: #e5e7eb;
      color: #374151;
    }

    #logout-btn:hover {
      background: #d1d5db;
    }

    h1.title {
      font-size: 32px;
      font-weight: 900;
      margin-bottom: 4px;
    }

    .subtitle-main {
      font-size: 15px;
      color: #6b7280;
      margin-bottom: 20px;
    }

    .section-card {
      background: #ffffff;
      border-radius: 24px;
      padding: 20px 22px 22px;
      box-shadow: 0 15px 32px rgba(15, 23, 42, 0.06);
      margin-bottom: 18px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 8px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .section-sub {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 12px;
    }

    .badge-small {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      background: #e5e7eb;
      color: #4b5563;
    }

    .info-row {
      font-size: 14px;
      color: #111827;
      line-height: 1.7;
    }

    .info-row span.label {
      color: #6b7280;
      margin-right: 6px;
    }

    .info-message {
      margin-top: 6px;
      font-size: 13px;
      color: #6b7280;
    }

    .info-message.emph {
      color: #047857;
      font-weight: 600;
    }

    .info-message.warn {
      color: #b91c1c;
    }

    /* ìš°ë¦¬ ë°˜ ìˆ™ì œ ì¹´ë“œ ì•ˆ ë¦¬ìŠ¤íŠ¸ */
    .class-hw-empty,
    .my-result-empty,
    .my-hw-empty,
    .class-online-empty {
      padding: 16px 14px;
      border-radius: 16px;
      background: #f3f4f6;
      font-size: 14px;
      color: #6b7280;
      text-align: center;
    }

    .hw-group-card {
      background: #f9fafb;
      border-radius: 18px;
      padding: 14px 16px;
      margin-bottom: 10px;
    }

    .hw-group-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
      gap: 8px;
    }

    .hw-group-date {
      font-size: 17px;
      font-weight: 800;
    }

    .hw-group-meta {
      font-size: 12px;
      color: #6b7280;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      margin-right: 4px;
    }

    .chip-class {
      background: #eef2ff;
      color: #3730a3;
    }

    .chip-type {
      background: #ffe5f3;
      color: #ff6fb5;
    }

    .chip-online-vocab {
      background: #d1fae5;
      color: #047857;
    }

    .chip-online-sentence {
      background: #e0f2fe;
      color: #0369a1;
    }

    .chip-warning {
      background: #fee2e2;
      color: #b91c1c;
    }

    .hw-text-line {
      font-size: 14px;
      color: #374151;
      white-space: pre-wrap;
      margin: 2px 0;
    }

    /* âœ… [ë³€ê²½] ë‚´ ì˜¨ë¼ì¸ ìˆ™ì œ ê²°ê³¼ - ìš”ì•½ ë¦¬ìŠ¤íŠ¸ */
    .unit-result-wrap {
      margin-top: 6px;
    }

    .unit-result-head {
      display: grid;
      grid-template-columns: 1.1fr 1fr 0.8fr 0.8fr;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid #e5e7eb;
      background: #f9fafb;
      border-radius: 14px;
      font-size: 12px;
      font-weight: 700;
      color: #4b5563;
    }

    .unit-result-row {
      border-bottom: 1px solid #e5e7eb;
      padding: 10px 12px;
      display: grid;
      grid-template-columns: 1.1fr 1fr 0.8fr 0.8fr;
      gap: 10px;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    .unit-result-row:hover {
      background: #f9fafb;
    }

    .unit-result-date {
      font-size: 13px;
      color: #374151;
      font-weight: 600;
    }

    .unit-result-unit {
      font-size: 13px;
      font-weight: 800;
      color: #111827;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      width: fit-content;
    }

    .status-x {
      background: #e5e7eb;
      color: #374151;
    }

    .status-tri {
      background: #FEF3C7;
      color: #92400E;
    }

    .status-o {
      background: #D1FAE5;
      color: #065F46;
    }

    .unit-result-time {
      font-size: 13px;
      color: #374151;
      font-weight: 700;
      text-align: right;
    }

    .unit-detail {
      display: none;
      padding: 10px 12px 12px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
    }

    .unit-detail.show {
      display: block;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 6px;
    }

    .detail-card {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 10px 12px;
    }

    .detail-title {
      font-size: 12px;
      font-weight: 900;
      color: #111827;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .detail-sub {
      font-size: 12px;
      color: #6b7280;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .detail-score {
      font-weight: 900;
      color: #111827;
    }

    /* ë‚´ ê°œì¸ ìˆ™ì œ ë“±ë¡ í¼ */
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
      margin-bottom: 8px;
    }

    .field {
      min-width: 130px;
    }

    .field label {
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 3px;
      display: block;
    }

    .input, .select, .input-date {
      width: 100%;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      outline: none;
      background: #ffffff;
    }

    .input:focus, .input-date:focus {
      border-color: #2563eb;
    }

    .pill-group {
      display: inline-flex;
      background: #e5e7eb;
      border-radius: 999px;
      padding: 3px;
      gap: 3px;
    }

    .pill-type-btn {
      border: none;
      border-radius: 999px;
      padding: 5px 12px;
      font-size: 12px;
      cursor: pointer;
      background: transparent;
      color: #4b5563;
      white-space: nowrap;
    }

    .pill-type-btn.active {
      background: var(--blue);
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(0, 174, 239, 0.35);
    }

    .btn-primary {
      border-radius: 999px;
      border: none;
      padding: 9px 16px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      background: var(--pink);
      color: #ffffff;
      font-weight: 600;
    }

    .btn-primary[disabled] {
      opacity: 0.6;
      cursor: default;
    }

    .status-text {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 6px;
      min-height: 16px;
    }

    .status-text.error {
      color: #b91c1c;
    }

    .status-text.success {
      color: #15803d;
    }

    .hint {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 8px;
    }

    .my-hw-list {
      margin-top: 6px;
    }

    .my-hw-item {
      padding: 6px 0;
      border-bottom: 1px solid #e5e7eb;
      font-size: 13px;
      color: #374151;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }

    .my-hw-item:last-child {
      border-bottom: none;
    }

    .my-hw-main {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .my-hw-meta {
      font-size: 12px;
      color: #6b7280;
    }

    .tag-type-vocab {
      background: #fee2e2;
      color: #b91c1c;
    }

    .tag-type-sentence {
      background: #e0f2fe;
      color: #0369a1;
    }

    @media (max-width: 768px) {
      .top-actions {
        position: static;
        justify-content: flex-end;
        margin-bottom: 10px;
      }
      .page {
        padding-top: 10px;
      }
      .section-card {
        padding: 16px 14px 18px;
      }

      .unit-result-head,
      .unit-result-row {
        grid-template-columns: 1fr 0.9fr 0.7fr 0.7fr;
      }

      .detail-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
<div class="page">
  <div class="top-actions">
    <button id="logout-btn" class="pill-btn">ë¡œê·¸ì•„ì›ƒ</button>
    <button id="home-btn" class="pill-btn">Home</button>
  </div>

  <h1 class="title">í•™ìƒ ë§ˆì´í˜ì´ì§€</h1>
  <div class="subtitle-main">
    ì˜¤ëŠ˜ ìˆ™ì œì™€ ì˜¨ë¼ì¸ í•™ìŠµ ê²°ê³¼ë¥¼ í•œ ê³³ì—ì„œ í™•ì¸í•´ ë³´ì„¸ìš”.
  </div>

  <!-- 1. ë‚´ ì •ë³´ -->
  <div class="section-card">
    <div class="section-header">
      <div class="section-title">ğŸ‘¤ ë‚´ ì •ë³´</div>
    </div>
    <div class="info-row">
      <div><span class="label">ì´ë¦„:</span><span id="info-name">-</span></div>
      <div><span class="label">ë°˜:</span><span id="info-class">-</span></div>
      <div><span class="label">ì•„ì´ë””:</span><span id="info-id">-</span></div>
    </div>
    <div id="info-message" class="info-message"></div>
  </div>

  <!-- 2. ìš°ë¦¬ ë°˜ ìˆ™ì œ (ì„ ìƒë‹˜ì´ ì˜¬ë¦° í•„ê¸° + ì˜¨ë¼ì¸ ìˆ™ì œ) -->
  <div class="section-card">
    <div class="section-header">
      <div class="section-title">
        ğŸ“š ìš°ë¦¬ ë°˜ ìˆ™ì œ
        <span id="class-badge" class="badge-small">-</span>
      </div>
    </div>
    <div class="section-sub">
      ì„ ìƒë‹˜ì´ ì˜¬ë¦° í•„ê¸° ìˆ™ì œì™€ ì˜¨ë¼ì¸ ì–´íœ˜/ë¬¸ì¥ ìˆ™ì œê°€ ë‚ ì§œë³„ë¡œ í•¨ê»˜ í‘œì‹œë¼ìš”.
    </div>
    <div id="class-hw-area"></div>
  </div>

  <!-- âœ… 3. ë‚´ ì˜¨ë¼ì¸ ìˆ™ì œ ê²°ê³¼ (ìš”ì•½ + í´ë¦­ ìƒì„¸) -->
  <div class="section-card">
    <div class="section-header">
      <div class="section-title">ğŸ“Š ë‚´ ì˜¨ë¼ì¸ ìˆ™ì œ ê²°ê³¼</div>
    </div>
    <div class="section-sub">
      ìœ ë‹›ë³„ë¡œ ìˆ™ì œë¥¼ ë‹¤ í–ˆëŠ”ì§€(O/â–³/X)ë¥¼ ë¨¼ì € ë³´ê³ , í´ë¦­í•˜ë©´ (ëœ»/ì˜ì–´/ë“£ê¸°/ë¬¸ì¥) ì„¸ë¶€ ê²°ê³¼ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”.
      <br>â€» ì•„ì§ ì œì¶œí•œ ê¸°ë¡ì´ ì—†ìœ¼ë©´ ì œì¶œ ì‹œê°„ì€ â€œ-â€ë¡œ í‘œì‹œë¼ìš”.
    </div>

    <div id="my-unit-results" class="unit-result-wrap">
      <div class="my-result-empty">ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
    </div>
  </div>

  <!-- 4. ë‚´ê°€ ë“±ë¡í•œ ì˜¨ë¼ì¸ ìˆ™ì œ (ê°œì¸ To-do) -->
  <div class="section-card">
    <div class="section-header">
      <div class="section-title">âœï¸ ë‚´ê°€ ë“±ë¡í•œ ì˜¨ë¼ì¸ ìˆ™ì œ</div>
    </div>
    <div class="section-sub">
      ì„ ìƒë‹˜ì´ ë§ë¡œ ì•Œë ¤ì¤€ ìˆ™ì œë¥¼ ë‚´ê°€ ì§ì ‘ ì ì–´ë‘˜ ìˆ˜ ìˆì–´ìš”. (ë°˜ ìˆ™ì œì™€ëŠ” ë³„ë„ë¡œ, ë‚˜ë§Œì˜ ì˜¨ë¼ì¸ ìˆ™ì œ ëª©ë¡ì…ë‹ˆë‹¤.)
    </div>

    <div class="form-row">
      <div class="field" style="min-width:150px;">
        <label>ìˆ™ì œ ì¢…ë¥˜</label>
        <div class="pill-group">
          <button type="button" id="type-vocab" class="pill-type-btn active">ì–´íœ˜</button>
          <button type="button" id="type-sentence" class="pill-type-btn">ë¬¸ì¥</button>
        </div>
      </div>

      <div class="field" style="flex:1; min-width:180px;">
        <label>ë‹¨ê³„-ì„¸íŠ¸ (ì˜ˆ: 1-1 ë˜ëŠ” 1-1, 1-2)</label>
        <input id="my-hw-set" class="input" type="text" placeholder="ì˜ˆ: 1-1 ë˜ëŠ” 1-1, 1-2" />
      </div>

      <div class="field" style="min-width:150px;">
        <label>ë§ˆê°ì¼</label>
        <input id="my-hw-due" class="input-date" type="date" />
      </div>

      <div class="field" style="min-width:120px;">
        <label>&nbsp;</label>
        <button id="my-hw-save-btn" class="btn-primary">ìˆ™ì œ ë“±ë¡</button>
      </div>
    </div>
    <div class="hint">
      ê°™ì€ ë‹¨ê³„ë§Œ ì—¬ëŸ¬ ê°œ ì…ë ¥í•  ìˆ˜ ìˆì–´ìš”. ì˜ˆ: 1-1, 1-2, 1-3
    </div>
    <div id="my-hw-status" class="status-text"></div>

    <div id="my-hw-list-wrapper">
      <div id="my-hw-empty" class="my-hw-empty">ì•„ì§ ë‚´ê°€ ë“±ë¡í•œ ì˜¨ë¼ì¸ ìˆ™ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
      <div id="my-hw-list" class="my-hw-list"></div>
    </div>
  </div>

  <!-- 5. ìš°ë¦¬ ë°˜ ì˜¨ë¼ì¸ ìˆ™ì œ ëª©ë¡ (ì„ ìƒë‹˜ì´ ë°˜ ì „ì²´ì— ì˜¬ë¦° ê²ƒë§Œ) -->
  <div class="section-card">
    <div class="section-header">
      <div class="section-title">ğŸ“ ìš°ë¦¬ ë°˜ ì˜¨ë¼ì¸ ìˆ™ì œ ëª©ë¡</div>
    </div>
    <div class="section-sub">
      ì„ ìƒë‹˜ì´ ë“±ë¡í•œ ì˜¨ë¼ì¸ ì–´íœ˜/ë¬¸ì¥ ìˆ™ì œë¥¼ í•œ ë²ˆì— ë³¼ ìˆ˜ ìˆì–´ìš”.
      ë‚˜ì¤‘ì— ì–´íœ˜/ë¬¸ì¥ í•™ìŠµ í˜ì´ì§€ì™€ ì—°ê²°í•´ì„œ, ì—¬ê¸°ì—ì„œ ë°”ë¡œ ìˆ™ì œ í’€ê¸° ë²„íŠ¼ì„ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”.
    </div>
    <div id="class-online-area"></div>
  </div>
</div>

<!-- Supabase JS -->
<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
<script>
  const SUPABASE_URL = "https://bpdisxjhhibrgfpvtlmv.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZGlzeGpoaGlicmdmcHZ0bG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTkxODQsImV4cCI6MjA3OTUzNTE4NH0.jDZ6BGirOPuWUnt4ykjhng4PLft2ZjBuYAFzApUnlYU";

  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // DOM
  const infoNameEl   = document.getElementById("info-name");
  const infoClassEl  = document.getElementById("info-class");
  const infoIdEl     = document.getElementById("info-id");
  const infoMsgEl    = document.getElementById("info-message");
  const classBadgeEl = document.getElementById("class-badge");

  const classHwArea  = document.getElementById("class-hw-area");

  const myUnitResultsEl = document.getElementById("my-unit-results");

  const myHwSetEl      = document.getElementById("my-hw-set");
  const myHwDueEl      = document.getElementById("my-hw-due");
  const myHwSaveBtn    = document.getElementById("my-hw-save-btn");
  const myHwStatusEl   = document.getElementById("my-hw-status");
  const myHwEmptyEl    = document.getElementById("my-hw-empty");
  const myHwListEl     = document.getElementById("my-hw-list");

  const classOnlineArea = document.getElementById("class-online-area");

  const typeVocabBtn    = document.getElementById("type-vocab");
  const typeSentenceBtn = document.getElementById("type-sentence");

  const logoutBtn = document.getElementById("logout-btn");
  const homeBtn   = document.getElementById("home-btn");

  let currentStudent = null;
  let currentClass   = null;
  let currentType    = "vocab"; // 'vocab' | 'sentence'

  // ---------- ê³µí†µ ìœ í‹¸ ----------
  function formatDate(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return "";
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function formatTime(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return "";
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    return `${hh}:${mm}`;
  }

  function toDateKey(iso) {
    return formatDate(iso);
  }

  function dateKeyFromTitle(title) {
    if (!title) return "";
    const trimmed = title.trim();
    const m = trimmed.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (m) return `${m[1]}-${m[2]}-${m[3]}`;
    return "";
  }

  function setMyHwStatus(msg, type) {
    myHwStatusEl.textContent = msg || "";
    myHwStatusEl.className = "status-text" + (type ? " " + type : "");
  }

  function parseLevelAndSets(setStr) {
    const parts = setStr
      .split(",")
      .map(s => s.trim())
      .filter(Boolean);
    if (!parts.length) return null;

    const first = parts[0].split("-");
    if (first.length !== 2) return null;
    const baseLevel = Number(first[0]);
    if (!baseLevel) return null;

    for (const p of parts) {
      const [lvStr, setNumStr] = p.split("-");
      const lv = Number(lvStr);
      const sn = Number(setNumStr);
      if (!lv || !sn || lv !== baseLevel) return null;
    }
    return {
      level: baseLevel,
      raw: parts.join(", ")
    };
  }

  // âœ… ëª¨ë“œ ë§¤í•‘(ì €ì¥ëœ mode ë¬¸ìì—´ì´ ì–´ë–¤ ê°’ì´ë“  ìµœëŒ€í•œ ìœ ì—°í•˜ê²Œ ì¡ìŒ)
  function normalizeVocabMode(modeRaw) {
    const m = String(modeRaw || "").toLowerCase();
    if (!m) return null;

    // ëœ»ì°¾ê¸°
    if (m.includes("ëœ»") || m.includes("meaning") || m.includes("kor") || m.includes("korean")) return "meaning";
    // ì˜ì–´ì°¾ê¸°
    if (m.includes("ì˜ì–´") || m.includes("eng") || m.includes("english")) return "english";
    // ë“£ê³ ì°¾ê¸°
    if (m.includes("ë“£") || m.includes("listen") || m.includes("hearing") || m.includes("audio")) return "listening";
    // ë¬¸ì¥ ë¹ˆì¹¸
    if (m.includes("ë¬¸ì¥") || m.includes("sentence") || m.includes("blank") || m.includes("cloze")) return "sentence";

    return null;
  }

  function modeLabel(modeKey) {
    if (modeKey === "meaning") return "ëœ»ì°¾ê¸°";
    if (modeKey === "english") return "ì˜ì–´ì°¾ê¸°";
    if (modeKey === "listening") return "ë“£ê³ ì°¾ê¸°";
    if (modeKey === "sentence") return "ë¬¸ì¥ ë¹ˆì¹¸";
    return "ê¸°íƒ€";
  }

  function pickStatus(completedCount) {
    if (completedCount <= 0) return { key: "x", text: "X" };
    if (completedCount >= 4) return { key: "o", text: "O" };
    return { key: "tri", text: "â–³" };
  }

  // ---------- 1. í•™ìƒ ì •ë³´ / ë°˜ ì •ë³´ ----------
  async function loadStudentFromLocalStorage() {
    try {
      const stored = localStorage.getItem("blossom_student");
      if (!stored) {
        alert("í•™ìƒ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.location.href = "login.html";
        return;
      }
      const s = JSON.parse(stored);
      currentStudent = s;

      infoNameEl.textContent = s.name || "-";
      infoIdEl.textContent   = s.login_id || "-";

      if (!s.class_id) {
        infoClassEl.textContent = "ë¯¸ë°°ì •";
        infoMsgEl.textContent = "ì•„ì§ ë°˜ì´ ë°°ì •ë˜ì§€ ì•Šì•˜ì–´ìš”. ì„ ìƒë‹˜ê»˜ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.";
        infoMsgEl.classList.add("warn");
        classBadgeEl.textContent = "ë°˜ ë¯¸ë°°ì •";
        classHwArea.innerHTML =
          '<div class="class-hw-empty">ë°˜ì´ ì•„ì§ ë°°ì •ë˜ì§€ ì•Šì•„ ìˆ™ì œë¥¼ ë³¼ ìˆ˜ ì—†ì–´ìš”.</div>';
        classOnlineArea.innerHTML =
          '<div class="class-online-empty">ë°˜ì´ ì•„ì§ ë°°ì •ë˜ì§€ ì•Šì•„ ì˜¨ë¼ì¸ ìˆ™ì œë¥¼ ë³¼ ìˆ˜ ì—†ì–´ìš”.</div>';
        return;
      }

      // ë°˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const { data: cls, error } = await client
        .from("classes")
        .select("id, name")
        .eq("id", s.class_id)
        .maybeSingle();

      if (error) {
        console.error("classes ì¡°íšŒ ì˜¤ë¥˜:", error);
      }

      if (cls) {
        currentClass = cls;
        infoClassEl.textContent = cls.name || "-";
        infoMsgEl.textContent = `í™˜ì˜í•©ë‹ˆë‹¤! ${cls.name} í•™ìƒì…ë‹ˆë‹¤.`;
        infoMsgEl.classList.add("emph");
        classBadgeEl.textContent = cls.name;
      } else {
        currentClass = null;
        infoClassEl.textContent = "ë¯¸ë°°ì •";
        infoMsgEl.textContent = "ë°˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”. ì„ ìƒë‹˜ê»˜ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.";
        infoMsgEl.classList.add("warn");
        classBadgeEl.textContent = "ë°˜ ì •ë³´ ì—†ìŒ";
      }
    } catch (e) {
      console.error("í•™ìƒ ì •ë³´ í™•ì¸ ì˜¤ë¥˜:", e);
      alert("ë¡œê·¸ì¸ ì •ë³´ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.");
      window.location.href = "login.html";
    }
  }

  // ---------- 2. ìš°ë¦¬ ë°˜ ìˆ™ì œ (board_posts + vocab_homework + sentence_homework) ----------
  async function loadClassHomework() {
    if (!currentClass || !currentClass.id) return;

    classHwArea.innerHTML =
      '<div class="class-hw-empty">ìš°ë¦¬ ë°˜ ìˆ™ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';

    try {
      const classId = currentClass.id;

      const [postsRes, vocabRes, sentenceRes] = await Promise.all([
        client.from("board_posts")
          .select("id, class_id, title, content, created_at")
          .eq("class_id", classId)
          .order("created_at", { ascending: false }),
        client.from("vocab_homework")
          .select("id, class_id, level, set_numbers, due_date, created_at")
          .eq("class_id", classId)
          .order("created_at", { ascending: false }),
        client.from("sentence_homework")
          .select("id, class_id, level, set_numbers, due_date, created_at")
          .eq("class_id", classId)
          .order("created_at", { ascending: false })
      ]);

      if (postsRes.error)   console.error("board_posts ì˜¤ë¥˜:", postsRes.error);
      if (vocabRes.error)   console.error("vocab_homework ì˜¤ë¥˜:", vocabRes.error);
      if (sentenceRes.error) console.error("sentence_homework ì˜¤ë¥˜:", sentenceRes.error);

      const groupsMap = {}; // key = dateKey

      function ensureGroup(dateKey) {
        if (!groupsMap[dateKey]) {
          groupsMap[dateKey] = {
            dateKey,
            latestTime: null,
            posts: [],
            vocab: [],
            sentence: []
          };
        }
        return groupsMap[dateKey];
      }

      // í•„ê¸° ìˆ™ì œ
      (postsRes.data || []).forEach(row => {
        const dk = dateKeyFromTitle(row.title) || toDateKey(row.created_at);
        if (!dk) return;
        const g = ensureGroup(dk);
        g.posts.push(row);
        if (!g.latestTime || new Date(row.created_at) > new Date(g.latestTime)) {
          g.latestTime = row.created_at;
        }
      });

      // ì˜¨ë¼ì¸ ì–´íœ˜
      (vocabRes.data || []).forEach(row => {
        const baseDate = row.due_date || row.created_at;
        const dk = row.due_date || toDateKey(row.created_at);
        if (!dk) return;
        const g = ensureGroup(dk);
        g.vocab.push(row);
        if (!g.latestTime || new Date(baseDate) > new Date(g.latestTime)) {
          g.latestTime = baseDate;
        }
      });

      // ì˜¨ë¼ì¸ ë¬¸ì¥
      (sentenceRes.data || []).forEach(row => {
        const baseDate = row.due_date || row.created_at;
        const dk = row.due_date || toDateKey(row.created_at);
        if (!dk) return;
        const g = ensureGroup(dk);
        g.sentence.push(row);
        if (!g.latestTime || new Date(baseDate) > new Date(g.latestTime)) {
          g.latestTime = baseDate;
        }
      });

      const groups = Object.values(groupsMap).sort((a, b) => {
        return new Date(b.latestTime || 0) - new Date(a.latestTime || 0);
      });

      if (!groups.length) {
        classHwArea.innerHTML =
          '<div class="class-hw-empty">ì•„ì§ ìš°ë¦¬ ë°˜ì— ë“±ë¡ëœ ìˆ™ì œê°€ ì—†ì–´ìš”.</div>';
        return;
      }

      classHwArea.innerHTML = "";
      groups.forEach(g => {
        const card = document.createElement("div");
        card.className = "hw-group-card";

        const header = document.createElement("div");
        header.className = "hw-group-header";

        const left = document.createElement("div");
        const dt = document.createElement("div");
        dt.className = "hw-group-date";
        dt.textContent = g.dateKey;
        left.appendChild(dt);

        const chips = document.createElement("div");
        const chipClass = document.createElement("span");
        chipClass.className = "chip chip-class";
        chipClass.textContent = currentClass ? currentClass.name : "ìš°ë¦¬ ë°˜";
        chips.appendChild(chipClass);

        const chipType = document.createElement("span");
        chipType.className = "chip chip-type";
        const hasOffline = g.posts.length > 0;
        const hasVocab   = g.vocab.length > 0;
        const hasSentence= g.sentence.length > 0;

        if (hasOffline && (hasVocab || hasSentence)) {
          chipType.textContent = "í•„ê¸° + ì˜¨ë¼ì¸ ìˆ™ì œ";
        } else if (hasOffline) {
          chipType.textContent = "í•„ê¸° ìˆ™ì œ";
        } else {
          chipType.textContent = "ì˜¨ë¼ì¸ ìˆ™ì œ";
        }
        chips.appendChild(chipType);
        left.appendChild(chips);

        const meta = document.createElement("div");
        meta.className = "hw-group-meta";
        meta.textContent = g.latestTime ? `StellaìŒ¤ Â· ${formatDate(g.latestTime)} ${formatTime(g.latestTime)}` : "";

        header.appendChild(left);
        header.appendChild(meta);
        card.appendChild(header);

        // í•„ê¸° ìˆ™ì œ í…ìŠ¤íŠ¸
        if (g.posts.length > 0) {
          const chip = document.createElement("div");
          chip.className = "chip chip-warning";
          chip.textContent = "âœï¸ í•„ê¸° ìˆ™ì œ / ê³µì§€";
          card.appendChild(chip);

          g.posts.forEach(p => {
            const line = document.createElement("div");
            line.className = "hw-text-line";
            line.textContent = p.content || p.title || "";
            card.appendChild(line);
          });
        }

        // ì˜¨ë¼ì¸ ì–´íœ˜
        if (g.vocab.length > 0) {
          const chip = document.createElement("div");
          chip.className = "chip chip-online-vocab";
          chip.textContent = "ğŸ“š ì˜¨ë¼ì¸ ì–´íœ˜ ìˆ™ì œ";
          chip.style.marginTop = "6px";
          card.appendChild(chip);

          g.vocab.forEach(h => {
            const line = document.createElement("div");
            line.className = "hw-text-line";
            const dueTxt = h.due_date ? ` / ë§ˆê°ì¼: ${h.due_date}` : "";
            line.textContent = `ë‹¨ê³„ ${h.level} / ì„¸íŠ¸: ${h.set_numbers}${dueTxt}`;
            card.appendChild(line);
          });
        }

        // ì˜¨ë¼ì¸ ë¬¸ì¥
        if (g.sentence.length > 0) {
          const chip = document.createElement("div");
          chip.className = "chip chip-online-sentence";
          chip.textContent = "ğŸ’¬ ì˜¨ë¼ì¸ ë¬¸ì¥ ìˆ™ì œ";
          chip.style.marginTop = "6px";
          card.appendChild(chip);

          g.sentence.forEach(h => {
            const line = document.createElement("div");
            line.className = "hw-text-line";
            const dueTxt = h.due_date ? ` / ë§ˆê°ì¼: ${h.due_date}` : "";
            line.textContent = `ë‹¨ê³„ ${h.level} / ì„¸íŠ¸: ${h.set_numbers}${dueTxt}`;
            card.appendChild(line);
          });
        }

        classHwArea.appendChild(card);
      });
    } catch (e) {
      console.error("ìš°ë¦¬ ë°˜ ìˆ™ì œ ë¡œë”© ì˜¤ë¥˜:", e);
      classHwArea.innerHTML =
        '<div class="class-hw-empty">ìˆ™ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
    }
  }

  // âœ… [ë³€ê²½] 3. ë‚´ ì˜¨ë¼ì¸ ìˆ™ì œ ê²°ê³¼ (ìœ ë‹› ìš”ì•½ + í´ë¦­ ìƒì„¸)
  async function loadMyResults() {
    if (!currentStudent || !currentStudent.login_id) return;

    myUnitResultsEl.innerHTML = '<div class="my-result-empty">ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';

    try {
      const { data, error } = await client
        .from("vocab_results")
        .select("*")
        .eq("student_login_id", currentStudent.login_id)
        .order("submitted_at", { ascending: false })
        .limit(200);

      if (error) {
        console.error("vocab_results ì˜¤ë¥˜:", error);
        myUnitResultsEl.innerHTML =
          '<div class="my-result-empty">ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
        return;
      }

      if (!data || !data.length) {
        myUnitResultsEl.innerHTML =
          '<div class="my-result-empty">ì•„ì§ ì œì¶œí•œ ì˜¨ë¼ì¸ ìˆ™ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      // unitë³„ë¡œ 4ëª¨ë“œ ìµœì‹  ê¸°ë¡ë§Œ ë¬¶ê¸°
      // unitKey = row.unit (ì˜ˆ: "1-1")
      const unitMap = new Map();

      function ensureUnit(unitKey) {
        if (!unitMap.has(unitKey)) {
          unitMap.set(unitKey, {
            unit: unitKey,
            // 4ê°œ ëª¨ë“œë³„ ìµœì‹  ê²°ê³¼
            modes: {
              meaning: null,
              english: null,
              listening: null,
              sentence: null
            },
            lastCompletedAt: null
          });
        }
        return unitMap.get(unitKey);
      }

      (data || []).forEach(row => {
        const unitKey = row.unit || "-";
        const modeKey = normalizeVocabMode(row.mode);

        // 4ê°œ ëª¨ë“œê°€ ì•„ë‹ˆë©´ ìš”ì•½ ê³„ì‚°ì—” í¬í•¨ ì•ˆ í•¨(í‘œì‹œëŠ” ìƒì„¸ì—ë„ ì•ˆ í•¨)
        if (!modeKey) return;

        const u = ensureUnit(unitKey);

        // ê°™ì€ ìœ ë‹›/ëª¨ë“œì—ì„œ ê°€ì¥ ìµœì‹  ì œì¶œë§Œ ìœ ì§€
        const prev = u.modes[modeKey];
        if (!prev || new Date(row.submitted_at) > new Date(prev.submitted_at)) {
          u.modes[modeKey] = row;
        }

        // ìœ ë‹› ë§ˆì§€ë§‰ ì™„ë£Œ ì‹œê°„(4ê°œ ì¤‘ ê°€ì¥ ëŠ¦ì€ ì œì¶œ ì‹œê°„)
        if (row.submitted_at) {
          if (!u.lastCompletedAt || new Date(row.submitted_at) > new Date(u.lastCompletedAt)) {
            u.lastCompletedAt = row.submitted_at;
          }
        }
      });

      // unitMapì´ ë¹„ì–´ë²„ë¦´ ìˆ˜ ìˆìŒ(ëª¨ë“œ ë¬¸ìì—´ì´ ì˜ˆìƒê³¼ ë‹¤ë¥´ë©´)
      const units = Array.from(unitMap.values());
      if (!units.length) {
        myUnitResultsEl.innerHTML =
          '<div class="my-result-empty">ê²°ê³¼ëŠ” ìˆìœ¼ë‚˜ ëª¨ë“œ í˜•ì‹ì„ ì¸ì‹í•˜ì§€ ëª»í–ˆì–´ìš”. (mode ê°’ì„ í™•ì¸í•´ ì£¼ì„¸ìš”)</div>';
        return;
      }

      // ìµœì‹  ìœ ë‹› ìˆœ(ë§ˆì§€ë§‰ ì™„ë£Œ ì‹œê°„ ê¸°ì¤€)
      units.sort((a, b) => new Date(b.lastCompletedAt || 0) - new Date(a.lastCompletedAt || 0));

      // ë Œë”
      myUnitResultsEl.innerHTML = "";

      const head = document.createElement("div");
      head.className = "unit-result-head";
      head.innerHTML = `
        <div>ì œì¶œ ë‚ ì§œ</div>
        <div>ë‹¨ì›(Unit)</div>
        <div>Unit ìƒíƒœ</div>
        <div style="text-align:right;">ì œì¶œ ì‹œê°„</div>
      `;
      myUnitResultsEl.appendChild(head);

      units.forEach((u, idx) => {
        const completedCount = ["meaning","english","listening","sentence"].filter(k => !!u.modes[k]).length;
        const status = pickStatus(completedCount);

        const dateStr = u.lastCompletedAt ? formatDate(u.lastCompletedAt) : "-";
        const timeStr = u.lastCompletedAt ? formatTime(u.lastCompletedAt) : "-";

        const rowEl = document.createElement("div");
        rowEl.className = "unit-result-row";
        rowEl.setAttribute("data-idx", String(idx));

        rowEl.innerHTML = `
          <div class="unit-result-date">${dateStr || "-"}</div>
          <div class="unit-result-unit">${u.unit || "-"}</div>
          <div>
            <span class="status-pill ${
              status.key === "o" ? "status-o" : (status.key === "tri" ? "status-tri" : "status-x")
            }">${status.text}</span>
          </div>
          <div class="unit-result-time">${timeStr || "-"}</div>
        `;

        const detailEl = document.createElement("div");
        detailEl.className = "unit-detail";
        detailEl.id = `unit-detail-${idx}`;

        function detailCardHtml(modeKey) {
          const r = u.modes[modeKey];
          const score = (r && (r.correct_count ?? r.score ?? null) !== null)
            ? `${r.correct_count ?? r.score}`
            : "-";
          const t = r && r.submitted_at ? `${formatDate(r.submitted_at)} ${formatTime(r.submitted_at)}` : "-";
          return `
            <div class="detail-card">
              <div class="detail-title">
                <span>${modeLabel(modeKey)}</span>
                <span class="detail-score">${score}${score !== "-" ? "ì " : ""}</span>
              </div>
              <div class="detail-sub">
                <span>ì™„ë£Œ ì‹œê°„</span>
                <span>${t}</span>
              </div>
            </div>
          `;
        }

        detailEl.innerHTML = `
          <div style="font-size:12px; color:#6b7280; font-weight:700;">
            â€» ì•„ë˜ëŠ” (ëœ»/ì˜ì–´/ë“£ê¸°/ë¬¸ì¥) ëª¨ë“œë³„ ìµœì‹  ê¸°ë¡ì…ë‹ˆë‹¤.
          </div>
          <div class="detail-grid">
            ${detailCardHtml("meaning")}
            ${detailCardHtml("english")}
            ${detailCardHtml("listening")}
            ${detailCardHtml("sentence")}
          </div>
        `;

        rowEl.onclick = () => {
          detailEl.classList.toggle("show");
        };

        myUnitResultsEl.appendChild(rowEl);
        myUnitResultsEl.appendChild(detailEl);
      });

    } catch (e) {
      console.error("ë‚´ ê²°ê³¼ ë¡œë”© ì˜ˆì™¸:", e);
      myUnitResultsEl.innerHTML =
        '<div class="my-result-empty">ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
    }
  }

  // ---------- 4. ë‚´ê°€ ë“±ë¡í•œ ì˜¨ë¼ì¸ ìˆ™ì œ (student_homework) ----------
  function setType(nextType) {
    currentType = nextType;
    if (nextType === "vocab") {
      typeVocabBtn.classList.add("active");
      typeSentenceBtn.classList.remove("active");
    } else {
      typeSentenceBtn.classList.add("active");
      typeVocabBtn.classList.remove("active");
    }
  }

  typeVocabBtn.onclick = () => setType("vocab");
  typeSentenceBtn.onclick = () => setType("sentence");

  async function saveMyHomework(evt) {
    evt.preventDefault();

    if (!currentStudent || !currentStudent.login_id) {
      setMyHwStatus("í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.", "error");
      return;
    }

    const rawSet = myHwSetEl.value.trim();
    const due    = myHwDueEl.value;

    if (!rawSet) {
      setMyHwStatus("ë‹¨ê³„-ì„¸íŠ¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”. (ì˜ˆ: 1-1 ë˜ëŠ” 1-1, 1-2)", "error");
      return;
    }

    const parsed = parseLevelAndSets(rawSet);
    if (!parsed) {
      setMyHwStatus("ì„¸íŠ¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”. ì˜ˆ: 1-1, 1-2, 1-3", "error");
      return;
    }

    if (!due) {
      setMyHwStatus("ë§ˆê°ì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.", "error");
      return;
    }

    setMyHwStatus("ìˆ™ì œë¥¼ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤â€¦", "");

    myHwSaveBtn.disabled = true;

    try {
      const { error } = await client
        .from("student_homework")
        .insert({
          student_login_id: currentStudent.login_id,
          type: currentType,
          level: parsed.level,
          set_numbers: parsed.raw,
          due_date: due
        });

      if (error) {
        console.error("student_homework ì €ì¥ ì˜¤ë¥˜:", error);
        setMyHwStatus("ìˆ™ì œë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", "error");
        return;
      }

      setMyHwStatus("ë‚˜ì˜ ì˜¨ë¼ì¸ ìˆ™ì œê°€ ë“±ë¡ë˜ì—ˆì–´ìš”!", "success");
      myHwSetEl.value = "";

      await loadMyHomeworkList();
    } catch (e) {
      console.error("student_homework ì €ì¥ ì˜ˆì™¸:", e);
      setMyHwStatus("ìˆ™ì œë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", "error");
    } finally {
      myHwSaveBtn.disabled = false;
    }
  }

  myHwSaveBtn.onclick = saveMyHomework;

  async function loadMyHomeworkList() {
    if (!currentStudent || !currentStudent.login_id) return;

    try {
      const { data, error } = await client
        .from("student_homework")
        .select("*")
        .eq("student_login_id", currentStudent.login_id)
        .order("due_date", { ascending: true })
        .order("created_at", { ascending: false });

      if (error) {
        console.error("student_homework ëª©ë¡ ì˜¤ë¥˜:", error);
        myHwEmptyEl.textContent = "ë‚˜ì˜ ì˜¨ë¼ì¸ ìˆ™ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        myHwEmptyEl.style.display = "block";
        myHwListEl.innerHTML = "";
        return;
      }

      if (!data || !data.length) {
        myHwEmptyEl.textContent = "ì•„ì§ ë‚´ê°€ ë“±ë¡í•œ ì˜¨ë¼ì¸ ìˆ™ì œê°€ ì—†ìŠµë‹ˆë‹¤.";
        myHwEmptyEl.style.display = "block";
        myHwListEl.innerHTML = "";
        return;
      }

      myHwEmptyEl.style.display = "none";
      myHwListEl.innerHTML = "";

      data.forEach(row => {
        const item = document.createElement("div");
        item.className = "my-hw-item";

        const main = document.createElement("div");
        main.className = "my-hw-main";

        const tag = document.createElement("span");
        tag.className = "chip " + (row.type === "sentence" ? "tag-type-sentence" : "tag-type-vocab");
        tag.textContent = row.type === "sentence" ? "ë¬¸ì¥" : "ì–´íœ˜";
        main.appendChild(tag);

        const txt = document.createElement("span");
        txt.textContent = `ë ˆë²¨ ${row.level} / ì„¸íŠ¸: ${row.set_numbers}`;
        main.appendChild(txt);

        const meta = document.createElement("div");
        meta.className = "my-hw-meta";
        meta.textContent = row.due_date ? `ë§ˆê°ì¼: ${row.due_date}` : "ë§ˆê°ì¼: -";

        item.appendChild(main);
        item.appendChild(meta);

        myHwListEl.appendChild(item);
      });
    } catch (e) {
      console.error("student_homework ëª©ë¡ ì˜ˆì™¸:", e);
      myHwEmptyEl.textContent = "ë‚˜ì˜ ì˜¨ë¼ì¸ ìˆ™ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      myHwEmptyEl.style.display = "block";
      myHwListEl.innerHTML = "";
    }
  }

  // ---------- 5. ìš°ë¦¬ ë°˜ ì˜¨ë¼ì¸ ìˆ™ì œ ëª©ë¡ (ì„ ìƒë‹˜ ìš©) ----------
  async function loadClassOnlineHomeworkList() {
    if (!currentClass || !currentClass.id) return;

    classOnlineArea.innerHTML =
      '<div class="class-online-empty">ìš°ë¦¬ ë°˜ ì˜¨ë¼ì¸ ìˆ™ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';

    try {
      const classId = currentClass.id;

      const [vocabRes, sentenceRes] = await Promise.all([
        client.from("vocab_homework")
          .select("id, level, set_numbers, due_date, created_at")
          .eq("class_id", classId)
          .order("created_at", { ascending: false }),
        client.from("sentence_homework")
          .select("id, level, set_numbers, due_date, created_at")
          .eq("class_id", classId)
          .order("created_at", { ascending: false })
      ]);

      if (vocabRes.error)   console.error("vocab_homework ëª©ë¡ ì˜¤ë¥˜:", vocabRes.error);
      if (sentenceRes.error) console.error("sentence_homework ëª©ë¡ ì˜¤ë¥˜:", sentenceRes.error);

      const list = [];
      (vocabRes.data || []).forEach(row => {
        list.push({
          type: "vocab",
          level: row.level,
          sets: row.set_numbers,
          due: row.due_date,
          created_at: row.created_at
        });
      });
      (sentenceRes.data || []).forEach(row => {
        list.push({
          type: "sentence",
          level: row.level,
          sets: row.set_numbers,
          due: row.due_date,
          created_at: row.created_at
        });
      });

      list.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));

      if (!list.length) {
        classOnlineArea.innerHTML =
          '<div class="class-online-empty">ì´ ë°˜ì—ëŠ” ì•„ì§ ë“±ë¡ëœ ì˜¨ë¼ì¸ ìˆ™ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      classOnlineArea.innerHTML = "";
      list.forEach(row => {
        const item = document.createElement("div");
        item.className = "my-hw-item";

        const main = document.createElement("div");
        main.className = "my-hw-main";

        const tag = document.createElement("span");
        tag.className = "chip " + (row.type === "sentence" ? "tag-type-sentence" : "tag-type-vocab");
        tag.textContent = row.type === "sentence" ? "ë¬¸ì¥" : "ì–´íœ˜";
        main.appendChild(tag);

        const txt = document.createElement("span");
        txt.textContent = `ë ˆë²¨ ${row.level} / ì„¸íŠ¸: ${row.sets}`;
        main.appendChild(txt);

        const meta = document.createElement("div");
        meta.className = "my-hw-meta";
        const dateTxt = row.due ? `ë§ˆê°ì¼: ${row.due}` : "ë§ˆê°ì¼: -";
        meta.textContent = dateTxt;

        item.appendChild(main);
        item.appendChild(meta);

        classOnlineArea.appendChild(item);
      });
    } catch (e) {
      console.error("ë°˜ ì˜¨ë¼ì¸ ìˆ™ì œ ëª©ë¡ ì˜ˆì™¸:", e);
      classOnlineArea.innerHTML =
        '<div class="class-online-empty">ì˜¨ë¼ì¸ ìˆ™ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
    }
  }

  // ---------- ë¡œê·¸ì•„ì›ƒ / í™ˆ ----------
  logoutBtn.onclick = () => {
    localStorage.removeItem("blossom_student");
    window.location.href = "index.html";
  };
  homeBtn.onclick = () => {
    window.location.href = "index.html";
  };

  // ---------- ì´ˆê¸° ì‹¤í–‰ ----------
  (async function init() {
    await loadStudentFromLocalStorage();
    if (currentClass && currentClass.id) {
      await loadClassHomework();
      await loadClassOnlineHomeworkList();
    }
    await loadMyResults();
    await loadMyHomeworkList();
  })();
</script>
</body>
</html>
