<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í•™ìƒ ë§ˆì´í˜ì´ì§€ - ë¸”ë¼ì¸ì‰ê¸€ë¦¬ì‰¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />

  <style>
    :root {
      --blue: #00AEEF;
      --mint: #9FE6B8;
      --pink: #FF6FB5;
      --bg: #f4f6fb;
      --gray: #6b7280;

      /* âœ… í†µì¼ ê·œì¹™: íŒŒë‘=ë‚ ì§œ */
      --dateBlue: var(--blue);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Pretendard Variable", -apple-system, BlinkMacSystemFont,
        system-ui, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    body {
      background: var(--bg);
      padding: 30px 0 60px;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px;
      position: relative;
    }

    /* ìƒë‹¨ ë²„íŠ¼ */
    .top-actions {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 8px;
    }

    .pill-btn {
      border-radius: 999px;
      border: none;
      padding: 8px 18px;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
      font-weight: 600;
    }

    #home-btn {
      background: var(--mint);
      color: #ffffff;
    }

    #logout-btn {
      background: #e5e7eb;
      color: #374151;
    }

    #logout-btn:hover {
      background: #d1d5db;
    }

    h1.title {
      font-size: 32px;
      font-weight: 900;
      margin-bottom: 4px;
    }

    .subtitle-main {
      font-size: 15px;
      color: #6b7280;
      margin-bottom: 20px;
    }

    .section-card {
      background: #ffffff;
      border-radius: 24px;
      padding: 20px 22px 22px;
      box-shadow: 0 15px 32px rgba(15, 23, 42, 0.06);
      margin-bottom: 18px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 8px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .badge-small {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      background: #e5e7eb;
      color: #4b5563;
    }

    .info-row {
      font-size: 14px;
      color: #111827;
      line-height: 1.7;
    }

    .info-row span.label {
      color: #6b7280;
      margin-right: 6px;
    }

    .info-message {
      margin-top: 6px;
      font-size: 13px;
      color: #6b7280;
      display: none; /* âœ… ê¸°ë³¸ ìˆ¨ê¹€ (ê²½ê³  ë•Œë§Œ í‘œì‹œ) */
    }

    .info-message.warn {
      color: #b91c1c;
    }

    /* ë¹ˆ ìƒíƒœ */
    .class-hw-empty,
    .my-result-empty,
    .my-hw-empty {
      padding: 16px 14px;
      border-radius: 16px;
      background: #f3f4f6;
      font-size: 14px;
      color: #6b7280;
      text-align: center;
    }

    /* ===== ìš°ë¦¬ ë°˜ ìˆ™ì œ ===== */
    .hw-group-card {
      background: #f9fafb;
      border-radius: 18px;
      padding: 14px 16px;
      margin-bottom: 10px;
    }

    .hw-group-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
      gap: 8px;
    }

    .hw-group-date {
      font-size: 17px;
      font-weight: 900;
      color: var(--dateBlue); /* âœ… ë‚ ì§œ íŒŒë‘ */
    }

    .hw-group-meta {
      font-size: 12px;
      color: #6b7280;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      margin-right: 4px;
    }

    .chip-class {
      background: #eef2ff;
      color: #3730a3;
    }

    .chip-type {
      background: #ffe5f3;
      color: #ff6fb5;
    }

    .chip-online-vocab {
      background: #d1fae5;
      color: #047857;
    }

    .chip-online-sentence {
      background: #e0f2fe;
      color: #0369a1;
    }

    .chip-warning {
      background: #fee2e2;
      color: #b91c1c;
    }

    /* âœ… ìˆ™ì œ ë‚´ìš©ì€ ê²€ì •(ëˆˆ í¸í•˜ê²Œ) */
    .hw-text-line {
      font-size: 14px;
      color: #111827;
      font-weight: 600;
      white-space: pre-wrap;
      margin: 2px 0;
    }

    /* ===== ë‚´ ì˜¨ë¼ì¸ ìˆ™ì œ(ë“±ë¡ í¼) ===== */
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
      margin-bottom: 8px;
    }

    .field { min-width: 130px; }

    .field label {
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 3px;
      display: block;
    }

    .input, .input-date {
      width: 100%;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      outline: none;
      background: #ffffff;
    }

    .input:focus, .input-date:focus { border-color: #2563eb; }

    .pill-group {
      display: inline-flex;
      background: #e5e7eb;
      border-radius: 999px;
      padding: 3px;
      gap: 3px;
    }

    .pill-type-btn {
      border: none;
      border-radius: 999px;
      padding: 5px 12px;
      font-size: 12px;
      cursor: pointer;
      background: transparent;
      color: #4b5563;
      white-space: nowrap;
    }

    .pill-type-btn.active {
      background: var(--blue);
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(0, 174, 239, 0.35);
    }

    .btn-primary {
      border-radius: 999px;
      border: none;
      padding: 9px 16px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      background: var(--pink);
      color: #ffffff;
      font-weight: 700;
    }

    .btn-primary[disabled] {
      opacity: 0.6;
      cursor: default;
    }

    .status-text {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 6px;
      min-height: 16px;
    }
    .status-text.error { color: #b91c1c; }

    .hint {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 8px;
    }

    /* ===== ë‚´ ì˜¨ë¼ì¸ ìˆ™ì œ(ëª©ë¡) : ë‚ ì§œë³„ ì¹´ë“œ ===== */
    .my-hw-group-card {
      background: #f9fafb;
      border-radius: 18px;
      padding: 14px 16px;
      margin-bottom: 10px;
    }

    .my-hw-group-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
      gap: 8px;
    }

    .my-hw-group-date {
      font-size: 17px;
      font-weight: 900;
      color: var(--dateBlue); /* âœ… ë‚ ì§œ íŒŒë‘ */
    }

    .my-hw-item {
      padding: 8px 0;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
    }
    .my-hw-item:last-child { border-bottom: none; }

    .my-hw-main {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      min-width: 0;
    }

    /* âœ… ìˆ™ì œ í…ìŠ¤íŠ¸ëŠ” ê²€ì • */
    .my-hw-text {
      color: #111827;
      font-weight: 600;
      font-size: 13px;
      word-break: break-word;
    }

    .tag-type-vocab {
      background: #fee2e2;
      color: #b91c1c;
    }

    .tag-type-sentence {
      background: #e0f2fe;
      color: #0369a1;
    }

    /* ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ */
    .row-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .mini-btn {
      border: none;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
    }

    .mini-btn.edit {
      background: #e5e7eb;
      color: #374151;
    }
    .mini-btn.edit:hover { background: #d1d5db; }

    .mini-btn.delete {
      background: #fee2e2;
      color: #b91c1c;
    }
    .mini-btn.delete:hover { background: #fecaca; }

    .mini-btn.cancel {
      background: #f3f4f6;
      color: #374151;
    }
    .mini-btn.cancel:hover { background: #e5e7eb; }

    /* ===== ë‚´ ì˜¨ë¼ì¸ ìˆ™ì œ ê²°ê³¼(í…Œì´ë¸”/ë””í…Œì¼) ===== */
    .unit-result-wrap {
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
      background: #ffffff;
    }

    .unit-result-head {
      display: grid;
      grid-template-columns: 1.2fr 0.9fr 0.7fr 1.6fr;
      gap: 0;
      background: #f9fafb;
      color: #4b5563;
      font-weight: 700;
      font-size: 13px;
      border-bottom: 1px solid #e5e7eb;
    }

    .unit-result-head > div,
    .unit-result-summary > div {
      padding: 10px 12px;
      border-right: 1px solid #eef2f7;
    }
    .unit-result-head > div:last-child,
    .unit-result-summary > div:last-child { border-right: none; }

    .unit-row { border-bottom: 1px solid #e5e7eb; }
    .unit-row:last-child { border-bottom: none; }

    details.unit-row summary {
      list-style: none;
      cursor: pointer;
      user-select: none;
    }
    details.unit-row summary::-webkit-details-marker { display: none; }

    .unit-result-summary {
      display: grid;
      grid-template-columns: 1.2fr 0.9fr 0.7fr 1.6fr;
      align-items: center;
      font-size: 13px;
      color: #111827; /* âœ… ê¸°ë³¸ ê²€ì • */
    }

    .unit-result-summary:hover { background: #f9fafb; }

    /* âœ… ë‚ ì§œë§Œ íŒŒë‘ */
    .unit-result-summary > div:nth-child(1) {
      color: var(--dateBlue);
      font-weight: 900;
    }

    .unit-cell-strong { font-weight: 800; }

    .status-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 34px;
      height: 22px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
    }
    .status-o { background: #dcfce7; color: #166534; }
    .status-d { background: #fef3c7; color: #92400e; }
    .status-x { background: #fee2e2; color: #991b1b; }

    .unit-detail {
      padding: 10px 12px 12px;
      background: #ffffff;
    }

    .unit-detail-grid {
      border-radius: 14px;
      background: #f9fafb;
      padding: 10px 10px;
      display: grid;
      gap: 8px;
    }

    .task-row {
      display: grid;
      grid-template-columns: 1fr 80px 160px;
      gap: 8px;
      align-items: center;
      padding: 8px 10px;
      border-radius: 12px;
      background: #ffffff;
      border: 1px solid #eef2f7;
      font-size: 13px;
    }

    .task-name { font-weight: 700; color: #111827; }
    .task-status { text-align: center; font-weight: 900; }
    .task-time { text-align: right; color: #6b7280; font-size: 12px; }

    .unit-guide {
      font-size: 12px;
      color: #6b7280;
      margin-top: 8px;
      line-height: 1.4;
    }

    @media (max-width: 768px) {
      .top-actions {
        position: static;
        justify-content: flex-end;
        margin-bottom: 10px;
      }
      .page { padding-top: 10px; }
      .section-card { padding: 16px 14px 18px; }

      .unit-result-head,
      .unit-result-summary {
        grid-template-columns: 1.1fr 0.8fr 0.7fr 1.4fr;
      }

      .task-row { grid-template-columns: 1fr 70px 130px; }
    }
  </style>
</head>

<body>
<div class="page">
  <div class="top-actions">
    <button id="logout-btn" class="pill-btn">ë¡œê·¸ì•„ì›ƒ</button>
    <button id="home-btn" class="pill-btn">Home</button>
  </div>

  <h1 class="title">í•™ìƒ ë§ˆì´í˜ì´ì§€</h1>
  <div class="subtitle-main">
    ì˜¤ëŠ˜ ìˆ™ì œì™€ ì˜¨ë¼ì¸ í•™ìŠµ ê²°ê³¼ë¥¼ í•œ ê³³ì—ì„œ í™•ì¸í•´ ë³´ì„¸ìš”.
  </div>

  <!-- âœ… 1. ìš°ë¦¬ ë°˜ ìˆ™ì œ -->
  <div class="section-card">
    <div class="section-header">
      <div class="section-title">
        ğŸ“š ìš°ë¦¬ ë°˜ ìˆ™ì œ
        <span id="class-badge" class="badge-small">-</span>
      </div>
    </div>
    <div id="class-hw-area"></div>
  </div>

  <!-- âœ… 2. ë‚´ ì˜¨ë¼ì¸ ìˆ™ì œ (ì œëª© ë³€ê²½ + ìˆ˜ì •/ì‚­ì œ ì¶”ê°€) -->
  <div class="section-card">
    <div class="section-header">
      <div class="section-title">âœï¸ ë‚´ ì˜¨ë¼ì¸ ìˆ™ì œ</div>
    </div>

    <div class="form-row">
      <div class="field" style="min-width:150px;">
        <label>ìˆ™ì œ ì¢…ë¥˜</label>
        <div class="pill-group">
          <button type="button" id="type-vocab" class="pill-type-btn active">ì–´íœ˜</button>
          <button type="button" id="type-sentence" class="pill-type-btn">ë¬¸ì¥</button>
        </div>
      </div>

      <div class="field" style="flex:1; min-width:180px;">
        <label>ë‹¨ê³„-ì„¸íŠ¸ (ì˜ˆ: 1-1 ë˜ëŠ” 1-1, 1-2)</label>
        <input id="my-hw-set" class="input" type="text" placeholder="ì˜ˆ: 1-1 ë˜ëŠ” 1-1, 1-2" />
      </div>

      <div class="field" style="min-width:150px;">
        <label>ë§ˆê°ì¼</label>
        <input id="my-hw-due" class="input-date" type="date" />
      </div>

      <div class="field" style="min-width:120px;">
        <label>&nbsp;</label>
        <button id="my-hw-save-btn" class="btn-primary">ìˆ™ì œ ë“±ë¡</button>
      </div>

      <div class="field" style="min-width:120px; display:none;" id="my-hw-cancel-wrap">
        <label>&nbsp;</label>
        <button id="my-hw-cancel-btn" class="mini-btn cancel" type="button">ìˆ˜ì • ì·¨ì†Œ</button>
      </div>
    </div>

    <!-- âœ… 3ë²ˆ ë¬¸êµ¬ëŠ” ìœ ì§€ -->
    <div class="hint">
      ê°™ì€ ë‹¨ê³„ë§Œ ì—¬ëŸ¬ ê°œ ì…ë ¥í•  ìˆ˜ ìˆì–´ìš”. ì˜ˆ: 1-1, 1-2, 1-3
    </div>

    <div id="my-hw-status" class="status-text"></div>

    <div id="my-hw-list-wrapper">
      <div id="my-hw-empty" class="my-hw-empty">ì•„ì§ ë‚´ê°€ ë“±ë¡í•œ ì˜¨ë¼ì¸ ìˆ™ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
      <div id="my-hw-list" class="my-hw-list"></div>
    </div>
  </div>

  <!-- âœ… 3. ë‚´ ì˜¨ë¼ì¸ ìˆ™ì œ ê²°ê³¼ -->
  <div class="section-card">
    <div class="section-header">
      <div class="section-title">ğŸ“Š ë‚´ ì˜¨ë¼ì¸ ìˆ™ì œ ê²°ê³¼</div>
    </div>

    <!-- ë”ë¯¸ UI -->
    <div class="unit-result-wrap" id="unit-result-wrap">
      <div class="unit-result-head">
        <div>ë§ˆê° ë‚ ì§œ</div>
        <div>ë‹¨ì›(Unit)</div>
        <div>Unit ì „ì²´</div>
        <div>ì œì¶œ ì‹œê°„</div>
      </div>

      <!-- âœ… ê¸°ë³¸ì€ ì ‘í˜: open ì œê±° -->
      <details class="unit-row">
        <summary class="unit-result-summary">
          <div>2025-12-26</div>
          <div class="unit-cell-strong">1-1</div>
          <div><span class="status-pill status-x">âŒ</span></div>
          <div>--</div>
        </summary>
        <div class="unit-detail">
          <div class="unit-detail-grid">
            <div class="task-row">
              <div class="task-name">ëœ» ì°¾ê¸°</div>
              <div class="task-status" style="color:#991b1b;">âŒ</div>
              <div class="task-time">--</div>
            </div>
            <div class="task-row">
              <div class="task-name">ì˜ì–´ ì°¾ê¸°</div>
              <div class="task-status" style="color:#991b1b;">âŒ</div>
              <div class="task-time">--</div>
            </div>
            <div class="task-row">
              <div class="task-name">ë“£ê³  ì°¾ê¸°</div>
              <div class="task-status" style="color:#991b1b;">âŒ</div>
              <div class="task-time">--</div>
            </div>
            <div class="task-row">
              <div class="task-name">ë¬¸ì¥ ë¹ˆì¹¸</div>
              <div class="task-status" style="color:#991b1b;">âŒ</div>
              <div class="task-time">--</div>
            </div>
          </div>
          <div class="unit-guide">â€» 2ë‹¨ê³„ì—ì„œ Supabase ì—°ê²°í•˜ë©´ ì‹¤ì œ ë°ì´í„°ë¡œ ìë™ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
      </details>

      <details class="unit-row">
        <summary class="unit-result-summary">
          <div>2025-12-25</div>
          <div class="unit-cell-strong">1-2</div>
          <div><span class="status-pill status-d">â–³</span></div>
          <div>2025-12-26 18:42</div>
        </summary>
        <div class="unit-detail">
          <div class="unit-detail-grid">
            <div class="task-row">
              <div class="task-name">ëœ» ì°¾ê¸°</div>
              <div class="task-status" style="color:#166534;">â­•</div>
              <div class="task-time">2025-12-26 18:10</div>
            </div>
            <div class="task-row">
              <div class="task-name">ì˜ì–´ ì°¾ê¸°</div>
              <div class="task-status" style="color:#991b1b;">âŒ</div>
              <div class="task-time">--</div>
            </div>
            <div class="task-row">
              <div class="task-name">ë“£ê³  ì°¾ê¸°</div>
              <div class="task-status" style="color:#166534;">â­•</div>
              <div class="task-time">2025-12-26 18:42</div>
            </div>
            <div class="task-row">
              <div class="task-name">ë¬¸ì¥ ë¹ˆì¹¸</div>
              <div class="task-status" style="color:#991b1b;">âŒ</div>
              <div class="task-time">--</div>
            </div>
          </div>
        </div>
      </details>

      <details class="unit-row">
        <summary class="unit-result-summary">
          <div>2025-12-24</div>
          <div class="unit-cell-strong">1-3</div>
          <div><span class="status-pill status-o">â­•</span></div>
          <div>2025-12-26 19:05</div>
        </summary>
        <div class="unit-detail">
          <div class="unit-detail-grid">
            <div class="task-row">
              <div class="task-name">ëœ» ì°¾ê¸°</div>
              <div class="task-status" style="color:#166534;">â­•</div>
              <div class="task-time">2025-12-26 18:20</div>
            </div>
            <div class="task-row">
              <div class="task-name">ì˜ì–´ ì°¾ê¸°</div>
              <div class="task-status" style="color:#166534;">â­•</div>
              <div class="task-time">2025-12-26 18:33</div>
            </div>
            <div class="task-row">
              <div class="task-name">ë“£ê³  ì°¾ê¸°</div>
              <div class="task-status" style="color:#166534;">â­•</div>
              <div class="task-time">2025-12-26 18:51</div>
            </div>
            <div class="task-row">
              <div class="task-name">ë¬¸ì¥ ë¹ˆì¹¸</div>
              <div class="task-status" style="color:#166534;">â­•</div>
              <div class="task-time">2025-12-26 19:05</div>
            </div>
          </div>
        </div>
      </details>
    </div>
  </div>

  <!-- âœ… 4. ë‚´ ì •ë³´ -->
  <div class="section-card">
    <div class="section-header">
      <div class="section-title">ğŸ‘¤ ë‚´ ì •ë³´</div>
    </div>
    <div class="info-row">
      <div><span class="label">ì´ë¦„:</span><span id="info-name">-</span></div>
      <div><span class="label">ë°˜:</span><span id="info-class">-</span></div>
      <div><span class="label">ì•„ì´ë””:</span><span id="info-id">-</span></div>
    </div>
    <div id="info-message" class="info-message"></div>
  </div>

</div>

<!-- Supabase JS -->
<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
<script>
  const SUPABASE_URL = "https://bpdisxjhhibrgfpvtlmv.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZGlzeGpoaGlicmdmcHZ0bG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTkxODQsImV4cCI6MjA3OTUzNTE4NH0.jDZ6BGirOPuWUnt4ykjhng4PLft2ZjBuYAFzApUnlYU";

  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // DOM
  const infoNameEl   = document.getElementById("info-name");
  const infoClassEl  = document.getElementById("info-class");
  const infoIdEl     = document.getElementById("info-id");
  const infoMsgEl    = document.getElementById("info-message");
  const classBadgeEl = document.getElementById("class-badge");

  const classHwArea  = document.getElementById("class-hw-area");

  const myHwSetEl      = document.getElementById("my-hw-set");
  const myHwDueEl      = document.getElementById("my-hw-due");
  const myHwSaveBtn    = document.getElementById("my-hw-save-btn");
  const myHwStatusEl   = document.getElementById("my-hw-status");
  const myHwEmptyEl    = document.getElementById("my-hw-empty");
  const myHwListEl     = document.getElementById("my-hw-list");

  const myHwCancelWrap = document.getElementById("my-hw-cancel-wrap");
  const myHwCancelBtn  = document.getElementById("my-hw-cancel-btn");

  const typeVocabBtn    = document.getElementById("type-vocab");
  const typeSentenceBtn = document.getElementById("type-sentence");

  const logoutBtn = document.getElementById("logout-btn");
  const homeBtn   = document.getElementById("home-btn");

  let currentStudent = null;
  let currentClass   = null;
  let currentType    = "vocab"; // 'vocab' | 'sentence'
  let editingId      = null;    // âœ… ìˆ˜ì • ëª¨ë“œì¼ ë•Œ student_homework.id

  // ---------- ê³µí†µ ìœ í‹¸ ----------
  function formatDate(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return "";
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function formatTime(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return "";
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    return `${hh}:${mm}`;
  }

  function toDateKey(iso) {
    return formatDate(iso);
  }

  function dateKeyFromTitle(title) {
    if (!title) return "";
    const trimmed = title.trim();
    const m = trimmed.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (m) return `${m[1]}-${m[2]}-${m[3]}`;
    return "";
  }

  function setMyHwStatus(msg, type) {
    myHwStatusEl.textContent = msg || "";
    myHwStatusEl.className = "status-text" + (type ? " " + type : "");
  }

  function setInfoMessage(msg, mode) {
    infoMsgEl.textContent = msg || "";
    infoMsgEl.className = "info-message" + (mode ? " " + mode : "");
    infoMsgEl.style.display = msg ? "block" : "none";
  }

  function parseLevelAndSets(setStr) {
    const parts = setStr
      .split(",")
      .map(s => s.trim())
      .filter(Boolean);
    if (!parts.length) return null;

    const first = parts[0].split("-");
    if (first.length !== 2) return null;
    const baseLevel = Number(first[0]);
    if (!baseLevel) return null;

    for (const p of parts) {
      const [lvStr, setNumStr] = p.split("-");
      const lv = Number(lvStr);
      const sn = Number(setNumStr);
      if (!lv || !sn || lv !== baseLevel) return null;
    }
    return {
      level: baseLevel,
      raw: parts.join(", ")
    };
  }

  function setType(nextType) {
    currentType = nextType;
    if (nextType === "vocab") {
      typeVocabBtn.classList.add("active");
      typeSentenceBtn.classList.remove("active");
    } else {
      typeSentenceBtn.classList.add("active");
      typeVocabBtn.classList.remove("active");
    }
  }
  typeVocabBtn.onclick = () => setType("vocab");
  typeSentenceBtn.onclick = () => setType("sentence");

  function enterEditMode(row) {
    editingId = row.id;
    setType(row.type === "sentence" ? "sentence" : "vocab");
    myHwSetEl.value = `${row.level}-${String(row.set_numbers || "").split(",")[0]?.trim()?.split("-")[1] || ""}`.includes("-")
      ? (row.set_numbers ? row.set_numbers : "")
      : (row.set_numbers || "");
    // row.set_numbersëŠ” "1-1, 1-2" í˜•íƒœë¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    myHwSetEl.value = row.set_numbers || "";
    myHwDueEl.value = row.due_date || "";

    myHwSaveBtn.textContent = "ìˆ˜ì • ì €ì¥";
    myHwCancelWrap.style.display = "block";
    setMyHwStatus("", "");
    myHwSetEl.focus();
  }

  function exitEditMode() {
    editingId = null;
    myHwSaveBtn.textContent = "ìˆ™ì œ ë“±ë¡";
    myHwCancelWrap.style.display = "none";
    myHwSetEl.value = "";
    myHwDueEl.value = "";
    setMyHwStatus("", "");
  }
  myHwCancelBtn.onclick = exitEditMode;

  // ---------- í•™ìƒ ì •ë³´ / ë°˜ ì •ë³´ ----------
  async function loadStudentFromLocalStorage() {
    try {
      const stored = localStorage.getItem("blossom_student");
      if (!stored) {
        alert("í•™ìƒ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.location.href = "login.html";
        return;
      }
      const s = JSON.parse(stored);
      currentStudent = s;

      infoNameEl.textContent = s.name || "-";
      infoIdEl.textContent   = s.login_id || "-";
      setInfoMessage("", "");

      if (!s.class_id) {
        infoClassEl.textContent = "ë¯¸ë°°ì •";
        setInfoMessage("ì•„ì§ ë°˜ì´ ë°°ì •ë˜ì§€ ì•Šì•˜ì–´ìš”. ì„ ìƒë‹˜ê»˜ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.", "warn");
        classBadgeEl.textContent = "ë°˜ ë¯¸ë°°ì •";
        classHwArea.innerHTML =
          '<div class="class-hw-empty">ë°˜ì´ ì•„ì§ ë°°ì •ë˜ì§€ ì•Šì•„ ìˆ™ì œë¥¼ ë³¼ ìˆ˜ ì—†ì–´ìš”.</div>';
        return;
      }

      const { data: cls, error } = await client
        .from("classes")
        .select("id, name")
        .eq("id", s.class_id)
        .maybeSingle();

      if (error) console.error("classes ì¡°íšŒ ì˜¤ë¥˜:", error);

      if (cls) {
        currentClass = cls;
        infoClassEl.textContent = cls.name || "-";
        classBadgeEl.textContent = cls.name;
        setInfoMessage("", "");
      } else {
        currentClass = null;
        infoClassEl.textContent = "ë¯¸ë°°ì •";
        setInfoMessage("ë°˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”. ì„ ìƒë‹˜ê»˜ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.", "warn");
        classBadgeEl.textContent = "ë°˜ ì •ë³´ ì—†ìŒ";
      }
    } catch (e) {
      console.error("í•™ìƒ ì •ë³´ í™•ì¸ ì˜¤ë¥˜:", e);
      alert("ë¡œê·¸ì¸ ì •ë³´ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.");
      window.location.href = "login.html";
    }
  }

  // ---------- ìš°ë¦¬ ë°˜ ìˆ™ì œ ----------
  async function loadClassHomework() {
    if (!currentClass || !currentClass.id) return;

    classHwArea.innerHTML =
      '<div class="class-hw-empty">ìš°ë¦¬ ë°˜ ìˆ™ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';

    try {
      const classId = currentClass.id;

      const [postsRes, vocabRes, sentenceRes] = await Promise.all([
        client.from("board_posts")
          .select("id, class_id, title, content, created_at")
          .eq("class_id", classId)
          .order("created_at", { ascending: false }),
        client.from("vocab_homework")
          .select("id, class_id, level, set_numbers, due_date, created_at")
          .eq("class_id", classId)
          .order("created_at", { ascending: false }),
        client.from("sentence_homework")
          .select("id, class_id, level, set_numbers, due_date, created_at")
          .eq("class_id", classId)
          .order("created_at", { ascending: false })
      ]);

      if (postsRes.error)   console.error("board_posts ì˜¤ë¥˜:", postsRes.error);
      if (vocabRes.error)   console.error("vocab_homework ì˜¤ë¥˜:", vocabRes.error);
      if (sentenceRes.error) console.error("sentence_homework ì˜¤ë¥˜:", sentenceRes.error);

      const groupsMap = {};
      function ensureGroup(dateKey) {
        if (!groupsMap[dateKey]) {
          groupsMap[dateKey] = { dateKey, latestTime: null, posts: [], vocab: [], sentence: [] };
        }
        return groupsMap[dateKey];
      }

      (postsRes.data || []).forEach(row => {
        const dk = dateKeyFromTitle(row.title) || toDateKey(row.created_at);
        if (!dk) return;
        const g = ensureGroup(dk);
        g.posts.push(row);
        if (!g.latestTime || new Date(row.created_at) > new Date(g.latestTime)) g.latestTime = row.created_at;
      });

      (vocabRes.data || []).forEach(row => {
        const baseDate = row.due_date || row.created_at;
        const dk = row.due_date || toDateKey(row.created_at);
        if (!dk) return;
        const g = ensureGroup(dk);
        g.vocab.push(row);
        if (!g.latestTime || new Date(baseDate) > new Date(g.latestTime)) g.latestTime = baseDate;
      });

      (sentenceRes.data || []).forEach(row => {
        const baseDate = row.due_date || row.created_at;
        const dk = row.due_date || toDateKey(row.created_at);
        if (!dk) return;
        const g = ensureGroup(dk);
        g.sentence.push(row);
        if (!g.latestTime || new Date(baseDate) > new Date(g.latestTime)) g.latestTime = baseDate;
      });

      const groups = Object.values(groupsMap).sort((a, b) => {
        return new Date(b.latestTime || 0) - new Date(a.latestTime || 0);
      });

      if (!groups.length) {
        classHwArea.innerHTML =
          '<div class="class-hw-empty">ì•„ì§ ìš°ë¦¬ ë°˜ì— ë“±ë¡ëœ ìˆ™ì œê°€ ì—†ì–´ìš”.</div>';
        return;
      }

      classHwArea.innerHTML = "";
      groups.forEach(g => {
        const card = document.createElement("div");
        card.className = "hw-group-card";

        const header = document.createElement("div");
        header.className = "hw-group-header";

        const left = document.createElement("div");
        const dt = document.createElement("div");
        dt.className = "hw-group-date";
        dt.textContent = g.dateKey;
        left.appendChild(dt);

        const chips = document.createElement("div");
        const chipClass = document.createElement("span");
        chipClass.className = "chip chip-class";
        chipClass.textContent = currentClass ? currentClass.name : "ìš°ë¦¬ ë°˜";
        chips.appendChild(chipClass);

        const chipType = document.createElement("span");
        chipType.className = "chip chip-type";
        const hasOffline = g.posts.length > 0;
        const hasVocab   = g.vocab.length > 0;
        const hasSentence= g.sentence.length > 0;

        if (hasOffline && (hasVocab || hasSentence)) chipType.textContent = "í•„ê¸° + ì˜¨ë¼ì¸ ìˆ™ì œ";
        else if (hasOffline) chipType.textContent = "í•„ê¸° ìˆ™ì œ";
        else chipType.textContent = "ì˜¨ë¼ì¸ ìˆ™ì œ";

        chips.appendChild(chipType);
        left.appendChild(chips);

        const meta = document.createElement("div");
        meta.className = "hw-group-meta";
        meta.textContent = g.latestTime ? `StellaìŒ¤ Â· ${formatDate(g.latestTime)} ${formatTime(g.latestTime)}` : "";

        header.appendChild(left);
        header.appendChild(meta);
        card.appendChild(header);

        if (g.posts.length > 0) {
          const chip = document.createElement("div");
          chip.className = "chip chip-warning";
          chip.textContent = "âœï¸ í•„ê¸° ìˆ™ì œ / ê³µì§€";
          card.appendChild(chip);

          g.posts.forEach(p => {
            const line = document.createElement("div");
            line.className = "hw-text-line";
            line.textContent = p.content || p.title || "";
            card.appendChild(line);
          });
        }

        if (g.vocab.length > 0) {
          const chip = document.createElement("div");
          chip.className = "chip chip-online-vocab";
          chip.textContent = "ğŸ“š ì˜¨ë¼ì¸ ì–´íœ˜ ìˆ™ì œ";
          chip.style.marginTop = "6px";
          card.appendChild(chip);

          g.vocab.forEach(h => {
            const line = document.createElement("div");
            line.className = "hw-text-line";
            const dueTxt = h.due_date ? ` / ë§ˆê°ì¼: ${h.due_date}` : "";
            line.textContent = `ë‹¨ê³„ ${h.level} / ì„¸íŠ¸: ${h.set_numbers}${dueTxt}`;
            card.appendChild(line);
          });
        }

        if (g.sentence.length > 0) {
          const chip = document.createElement("div");
          chip.className = "chip chip-online-sentence";
          chip.textContent = "ğŸ’¬ ì˜¨ë¼ì¸ ë¬¸ì¥ ìˆ™ì œ";
          chip.style.marginTop = "6px";
          card.appendChild(chip);

          g.sentence.forEach(h => {
            const line = document.createElement("div");
            line.className = "hw-text-line";
            const dueTxt = h.due_date ? ` / ë§ˆê°ì¼: ${h.due_date}` : "";
            line.textContent = `ë‹¨ê³„ ${h.level} / ì„¸íŠ¸: ${h.set_numbers}${dueTxt}`;
            card.appendChild(line);
          });
        }

        classHwArea.appendChild(card);
      });
    } catch (e) {
      console.error("ìš°ë¦¬ ë°˜ ìˆ™ì œ ë¡œë”© ì˜¤ë¥˜:", e);
      classHwArea.innerHTML =
        '<div class="class-hw-empty">ìˆ™ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
    }
  }

  // ---------- ë‚´ ì˜¨ë¼ì¸ ìˆ™ì œ ì €ì¥(ë“±ë¡/ìˆ˜ì • ê³µìš©) ----------
  async function saveMyHomework(evt) {
    evt.preventDefault();

    if (!currentStudent || !currentStudent.login_id) {
      setMyHwStatus("í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.", "error");
      return;
    }

    const rawSet = myHwSetEl.value.trim();
    const due    = myHwDueEl.value;

    if (!rawSet) {
      setMyHwStatus("ë‹¨ê³„-ì„¸íŠ¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”. (ì˜ˆ: 1-1 ë˜ëŠ” 1-1, 1-2)", "error");
      return;
    }

    const parsed = parseLevelAndSets(rawSet);
    if (!parsed) {
      setMyHwStatus("ì„¸íŠ¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”. ì˜ˆ: 1-1, 1-2, 1-3", "error");
      return;
    }

    if (!due) {
      setMyHwStatus("ë§ˆê°ì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.", "error");
      return;
    }

    setMyHwStatus("", "");
    myHwSaveBtn.disabled = true;

    try {
      if (editingId) {
        // âœ… ìˆ˜ì •
        const { error } = await client
          .from("student_homework")
          .update({
            type: currentType,
            level: parsed.level,
            set_numbers: parsed.raw,
            due_date: due
          })
          .eq("id", editingId);

        if (error) {
          console.error("student_homework ìˆ˜ì • ì˜¤ë¥˜:", error);
          setMyHwStatus("ìˆ™ì œë¥¼ ìˆ˜ì •í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", "error");
          return;
        }

        await loadMyHomeworkList();
        exitEditMode();
      } else {
        // âœ… ë“±ë¡
        const { error } = await client
          .from("student_homework")
          .insert({
            student_login_id: currentStudent.login_id,
            type: currentType,
            level: parsed.level,
            set_numbers: parsed.raw,
            due_date: due
          });

        if (error) {
          console.error("student_homework ì €ì¥ ì˜¤ë¥˜:", error);
          setMyHwStatus("ìˆ™ì œë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", "error");
          return;
        }

        // âœ… ì„±ê³µ ë©”ì‹œì§€ ì œê±°: í™”ë©´ ê°±ì‹ ì´ ê³§ ì„±ê³µ
        myHwSetEl.value = "";
        await loadMyHomeworkList();
      }
    } catch (e) {
      console.error("student_homework ì €ì¥/ìˆ˜ì • ì˜ˆì™¸:", e);
      setMyHwStatus("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", "error");
    } finally {
      myHwSaveBtn.disabled = false;
    }
  }
  myHwSaveBtn.onclick = saveMyHomework;

  async function deleteMyHomework(row) {
    const ok = confirm("ì´ ìˆ™ì œë¥¼ ì‚­ì œí• ê¹Œìš”?");
    if (!ok) return;

    try {
      const { error } = await client
        .from("student_homework")
        .delete()
        .eq("id", row.id);

      if (error) {
        console.error("student_homework ì‚­ì œ ì˜¤ë¥˜:", error);
        setMyHwStatus("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", "error");
        return;
      }

      // ìˆ˜ì • ì¤‘ì´ë˜ í•­ëª©ì„ ì‚­ì œí–ˆë‹¤ë©´ í¸ì§‘ ëª¨ë“œ ì¢…ë£Œ
      if (editingId === row.id) exitEditMode();

      await loadMyHomeworkList();
      setMyHwStatus("", "");
    } catch (e) {
      console.error("student_homework ì‚­ì œ ì˜ˆì™¸:", e);
      setMyHwStatus("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", "error");
    }
  }

  // ---------- ë‚´ ì˜¨ë¼ì¸ ìˆ™ì œ ëª©ë¡(ë‚ ì§œë³„ ê·¸ë£¹ + ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼) ----------
  async function loadMyHomeworkList() {
    if (!currentStudent || !currentStudent.login_id) return;

    try {
      const { data, error } = await client
        .from("student_homework")
        .select("*")
        .eq("student_login_id", currentStudent.login_id)
        .order("due_date", { ascending: true })
        .order("created_at", { ascending: false });

      if (error) {
        console.error("student_homework ëª©ë¡ ì˜¤ë¥˜:", error);
        myHwEmptyEl.textContent = "ë‚´ ì˜¨ë¼ì¸ ìˆ™ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        myHwEmptyEl.style.display = "block";
        myHwListEl.innerHTML = "";
        return;
      }

      if (!data || !data.length) {
        myHwEmptyEl.textContent = "ì•„ì§ ë‚´ê°€ ë“±ë¡í•œ ì˜¨ë¼ì¸ ìˆ™ì œê°€ ì—†ìŠµë‹ˆë‹¤.";
        myHwEmptyEl.style.display = "block";
        myHwListEl.innerHTML = "";
        return;
      }

      myHwEmptyEl.style.display = "none";
      myHwListEl.innerHTML = "";

      const groups = {};
      (data || []).forEach(row => {
        const key = row.due_date || "ë§ˆê°ì¼ ì—†ìŒ";
        if (!groups[key]) groups[key] = [];
        groups[key].push(row);
      });

      Object.keys(groups).sort((a, b) => {
        if (a === "ë§ˆê°ì¼ ì—†ìŒ") return 1;
        if (b === "ë§ˆê°ì¼ ì—†ìŒ") return -1;
        return new Date(a) - new Date(b);
      }).forEach(date => {
        const card = document.createElement("div");
        card.className = "my-hw-group-card";

        const header = document.createElement("div");
        header.className = "my-hw-group-header";

        const dt = document.createElement("div");
        dt.className = "my-hw-group-date";
        dt.textContent = date;

        header.appendChild(dt);
        card.appendChild(header);

        groups[date].forEach(row => {
          const item = document.createElement("div");
          item.className = "my-hw-item";

          const main = document.createElement("div");
          main.className = "my-hw-main";

          const tag = document.createElement("span");
          tag.className = "chip " + (row.type === "sentence" ? "tag-type-sentence" : "tag-type-vocab");
          tag.textContent = row.type === "sentence" ? "ë¬¸ì¥" : "ì–´íœ˜";
          main.appendChild(tag);

          const txt = document.createElement("span");
          txt.className = "my-hw-text";
          txt.textContent = `ë ˆë²¨ ${row.level} / ì„¸íŠ¸: ${row.set_numbers}`;
          main.appendChild(txt);

          const actions = document.createElement("div");
          actions.className = "row-actions";

          const editBtn = document.createElement("button");
          editBtn.type = "button";
          editBtn.className = "mini-btn edit";
          editBtn.textContent = "ìˆ˜ì •";
          editBtn.onclick = () => enterEditMode(row);

          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "mini-btn delete";
          delBtn.textContent = "ì‚­ì œ";
          delBtn.onclick = () => deleteMyHomework(row);

          actions.appendChild(editBtn);
          actions.appendChild(delBtn);

          item.appendChild(main);
          item.appendChild(actions);

          card.appendChild(item);
        });

        myHwListEl.appendChild(card);
      });

    } catch (e) {
      console.error("student_homework ëª©ë¡ ì˜ˆì™¸:", e);
      myHwEmptyEl.textContent = "ë‚´ ì˜¨ë¼ì¸ ìˆ™ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      myHwEmptyEl.style.display = "block";
      myHwListEl.innerHTML = "";
    }
  }

  // ---------- ë¡œê·¸ì•„ì›ƒ / í™ˆ ----------
  logoutBtn.onclick = () => {
    localStorage.removeItem("blossom_student");
    window.location.href = "index.html";
  };
  homeBtn.onclick = () => {
    window.location.href = "index.html";
  };

  // ---------- ì´ˆê¸° ì‹¤í–‰ ----------
  (async function init() {
    await loadStudentFromLocalStorage();
    if (currentClass && currentClass.id) {
      await loadClassHomework();
    }
    await loadMyHomeworkList();
  })();
</script>
</body>
</html>
