<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í•™ìƒ ë§ˆì´í˜ì´ì§€ - ë¸”ë¼ì¸ì‰ê¸€ë¦¬ì‰¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />

  <style>
    :root {
      --blue: #00AEEF;
      --mint: #9FE6B8;
      --pink: #FF6FB5;
      --bg: #f4f6fb;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Pretendard Variable", -apple-system, BlinkMacSystemFont,
        system-ui, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    body {
      background: var(--bg);
      padding: 24px 0 40px;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
      gap: 10px;
    }

    .title-big {
      font-size: 28px;
      font-weight: 900;
    }

    .subtitle {
      font-size: 14px;
      color: #6b7280;
      margin-top: 4px;
    }

    .top-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .pill-btn {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }

    #home-btn {
      background: var(--mint);
      color: #ffffff;
    }

    #logout-btn {
      background: #e5e7eb;
      color: #374151;
    }

    #logout-btn:hover {
      background: #d1d5db;
    }

    .card {
      background: #ffffff;
      border-radius: 24px;
      padding: 18px 20px 20px;
      box-shadow: 0 15px 32px rgba(15, 23, 42, 0.08);
      margin-bottom: 18px;
    }

    .section-title {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .section-sub {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 10px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #4b5563;
      font-size: 12px;
      margin-left: 6px;
    }

    .badge-class {
      background: #eef2ff;
      color: #3730a3;
    }

    .info-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 14px;
      color: #4b5563;
      align-items: center;
    }

    .info-row span + span::before {
      content: "Â· ";
      margin: 0 4px;
    }

    /* ê²Œì‹œíŒ ìŠ¤íƒ€ì¼ (board.htmlì—ì„œ ê°€ì ¸ì˜´, í•™ìƒìš©ìœ¼ë¡œ ì¶•ì†Œ) */
    .post-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 6px;
    }

    .post-card {
      background: #ffffff;
      border-radius: 20px;
      padding: 14px 16px;
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.06);
    }

    .post-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }

    .post-title {
      font-size: 18px;
      font-weight: 800;
      color: #111827;
    }

    .post-meta {
      font-size: 12px;
      color: #6b7280;
      text-align: right;
    }

    .post-meta span + span::before {
      content: "Â· ";
      margin: 0 2px;
    }

    .post-class-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      font-size: 12px;
      margin-bottom: 4px;
    }

    .post-type-badge {
      display: inline-flex;
      align-items: center;
      padding: 1px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin-left: 6px;
      background: #ffe5f3;
      color: #ff6fb5;
    }

    .post-section-label {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin-bottom: 4px;
    }

    .sec-offline {
      background: #ffe5f3;
      color: #ff6fb5;
    }

    .sec-vocab {
      background: #d1fae5;
      color: #047857;
    }

    .sec-sentence {
      background: #e0f2fe;
      color: #0369a1;
    }

    .post-content {
      font-size: 14px;
      color: #374151;
      white-space: pre-wrap;
      margin-top: 2px;
      margin-bottom: 2px;
    }

    .hw-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .empty-box {
      margin-top: 16px;
      padding: 10px 12px;
      border-radius: 18px;
      background: #e5e7eb;
      font-size: 14px;
      color: #4b5563;
      text-align: center;
    }

    /* ê²°ê³¼ í…Œì´ë¸” */
    .table-wrap {
      overflow-x: auto;
      margin-top: 6px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      min-width: 650px;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }

    th {
      background: #f9fafb;
      color: #4b5563;
      font-weight: 600;
    }

    .empty-cell {
      text-align: center;
      padding: 18px 10px;
      color: #6b7280;
    }

    /* ì˜¨ë¼ì¸ ìˆ™ì œ ëª©ë¡ ìŠ¤íƒ€ì¼ (homework-teacherì—ì„œ ì¼ë¶€ ê°€ì ¸ì˜´) */
    .hw-list {
      font-size: 13px;
      color: #4b5563;
      margin-top: 6px;
    }

    .hw-item {
      padding: 6px 0;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .hw-item:last-child {
      border-bottom: none;
    }

    .hw-tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin-right: 4px;
    }

    .hw-tag.vocab {
      background: #fee2e2;
      color: #b91c1c;
    }

    .hw-tag.sentence {
      background: #e0f2fe;
      color: #0369a1;
    }

    .hint {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .status-text {
      font-size: 13px;
      color: #6b7280;
      margin-top: 6px;
    }

    @media (max-width: 768px) {
      .top-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .post-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .post-meta {
        text-align: left;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <div class="top-row">
    <div>
      <div class="title-big">í•™ìƒ ë§ˆì´í˜ì´ì§€</div>
      <div class="subtitle">
        ì˜¤ëŠ˜ ìˆ™ì œì™€ ì˜¨ë¼ì¸ í•™ìŠµ ê²°ê³¼ë¥¼ í•œ ê³³ì—ì„œ í™•ì¸í•´ ë³´ì„¸ìš”.
      </div>
    </div>
    <div class="top-actions">
      <button class="pill-btn" id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
      <button class="pill-btn" id="home-btn" type="button" onclick="window.location.href='index.html'">Home</button>
    </div>
  </div>

  <!-- í•™ìƒ ì •ë³´ ì¹´ë“œ -->
  <div class="card">
    <div class="section-title">
      ğŸ‘¤ ë‚´ ì •ë³´
    </div>
    <div class="info-row">
      <span>ì´ë¦„: <strong id="student-name">í™•ì¸ ì¤‘â€¦</strong></span>
      <span>ë°˜: <strong id="student-class">-</strong></span>
      <span>ì•„ì´ë””: <span id="student-login-id">-</span></span>
    </div>
    <div class="status-text" id="student-status"></div>
  </div>

  <!-- 1. ìš°ë¦¬ ë°˜ ìˆ™ì œ ì¹´ë“œ (í•„ê¸° + ì˜¨ë¼ì¸) -->
  <div class="card">
    <div class="section-title">
      ğŸ“… ìš°ë¦¬ ë°˜ ìˆ™ì œ
      <span class="badge badge-class" id="class-badge">ë°˜ í™•ì¸ ì¤‘â€¦</span>
    </div>
    <div class="section-sub">
      ì„ ìƒë‹˜ì´ ì˜¬ë¦° í•„ê¸° ìˆ™ì œì™€ ì˜¨ë¼ì¸ ì–´íœ˜/ë¬¸ì¥ ìˆ™ì œê°€ ë‚ ì§œë³„ë¡œ í•¨ê»˜ í‘œì‹œë¼ìš”.
    </div>

    <div id="class-homework-list" class="post-list"></div>
    <div id="class-homework-empty" class="empty-box" style="display:none;">
      ì•„ì§ ìš°ë¦¬ ë°˜ì— ë“±ë¡ëœ ìˆ™ì œê°€ ì—†ì–´ìš”.
    </div>
  </div>

  <!-- 2. ë‚´ ì˜¨ë¼ì¸ ìˆ™ì œ ê²°ê³¼ -->
  <div class="card">
    <div class="section-title">
      ğŸ“Š ë‚´ ì˜¨ë¼ì¸ ìˆ™ì œ ê²°ê³¼
    </div>
    <div class="section-sub">
      ë‹¨ì–´ ì‹œí—˜ ë“± ì˜¨ë¼ì¸ìœ¼ë¡œ í’€ì—ˆë˜ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”. (ì–´íœ˜ ê¸°ì¤€)
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th width="22%">ì œì¶œ ë‚ ì§œ</th>
            <th width="18%">ë‹¨ì›(Unit)</th>
            <th width="20%">ì ìˆ˜ / ëª¨ë“œ</th>
            <th width="20%">ì œì¶œ ì‹œê°„</th>
            <th width="20%">ë¹„ê³ </th>
          </tr>
        </thead>
        <tbody id="result-table-body">
          <tr>
            <td colspan="5" class="empty-cell">ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- 3. ìš°ë¦¬ ë°˜ ì˜¨ë¼ì¸ ìˆ™ì œ ëª©ë¡ (í–¥í›„ 'ìˆ™ì œ í’€ê¸°'ì™€ ì—°ê²° ì˜ˆì •) -->
  <div class="card">
    <div class="section-title">
      ğŸ“ ìš°ë¦¬ ë°˜ ì˜¨ë¼ì¸ ìˆ™ì œ ëª©ë¡
    </div>
    <div class="section-sub">
      ì„ ìƒë‹˜ì´ ë“±ë¡í•œ ì˜¨ë¼ì¸ ì–´íœ˜/ë¬¸ì¥ ìˆ™ì œë¥¼ í•œ ë²ˆì— ë³¼ ìˆ˜ ìˆì–´ìš”.
    </div>
    <div class="hint">
      ë‚˜ì¤‘ì— ì–´íœ˜/ë¬¸ì¥ í•™ìŠµ í˜ì´ì§€ì™€ ì—°ê²°í•´ì„œ, ì—¬ê¸°ì—ì„œ ë°”ë¡œ <strong>ìˆ™ì œ í’€ê¸°</strong> ë²„íŠ¼ì„ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”.
    </div>
    <div id="online-hw-list" class="hw-list">
      ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦
    </div>
  </div>
</div>

<!-- Supabase JS -->
<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
<script>
  // Supabase ì„¤ì •
  const SUPABASE_URL = "https://bpdisxjhhibrgfpvtlmv.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZGlzeGpoaGlicmdmcHZ0bG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTkxODQsImV4cCI6MjA3OTUzNTE4NH0.jDZ6BGirOPuWUnt4ykjhng4PLft2ZjBuYAFzApUnlYU";

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const DEFAULT_AUTHOR_LABEL = "StellaìŒ¤";

  // DOM
  const studentNameEl   = document.getElementById("student-name");
  const studentClassEl  = document.getElementById("student-class");
  const studentLoginEl  = document.getElementById("student-login-id");
  const studentStatusEl = document.getElementById("student-status");
  const classBadgeEl    = document.getElementById("class-badge");

  const classHwListEl   = document.getElementById("class-homework-list");
  const classHwEmptyEl  = document.getElementById("class-homework-empty");

  const resultTableBody = document.getElementById("result-table-body");
  const onlineHwListEl  = document.getElementById("online-hw-list");

  const logoutBtn = document.getElementById("logout-btn");

  // ìƒíƒœê°’
  let currentStudent = null; // {id, name, class_id, login_id}
  let currentClass   = null; // {id, name}
  let groups         = [];   // ë‚ ì§œ+ë°˜ìœ¼ë¡œ ë¬¶ì€ ìˆ™ì œë“¤

  // ë¡œê·¸ì•„ì›ƒ: localStorage ë¹„ìš°ê³  í™ˆìœ¼ë¡œ
  logoutBtn.onclick = () => {
    try {
      localStorage.removeItem("blossom_student");
    } catch (e) {
      console.error(e);
    }
    window.location.href = "index.html";
  };

  function setStudentStatus(msg, isError = false) {
    studentStatusEl.textContent = msg || "";
    if (isError) {
      studentStatusEl.style.color = "#b91c1c";
    } else {
      studentStatusEl.style.color = "#6b7280";
    }
  }

  // ë‚ ì§œ/ì‹œê°„ í¬ë§· ê³µí†µ í•¨ìˆ˜
  function formatDateTime(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return "";
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    return `${y}-${m}-${day} ${hh}:${mm}`;
  }

  function toDateKeyFromISO(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return "";
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function dateKeyFromTitle(title) {
    if (!title) return "";
    const trimmed = title.trim();
    const m = trimmed.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (m) return `${m[1]}-${m[2]}-${m[3]}`;
    return "";
  }

  // --- 1. localStorageì—ì„œ í•™ìƒ ì •ë³´ ì½ê¸° + DBì—ì„œ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ---
  async function loadCurrentStudent() {
    let stored = null;
    try {
      const raw = localStorage.getItem("blossom_student");
      if (raw) {
        stored = JSON.parse(raw);
      }
    } catch (e) {
      console.error("í•™ìƒ localStorage íŒŒì‹± ì˜¤ë¥˜:", e);
    }

    if (!stored || !stored.login_id) {
      alert("í•™ìƒ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
      window.location.href = "index.html";
      return;
    }

    const loginId = stored.login_id;
    const storedName = stored.name || "";

    try {
      const { data, error } = await supabaseClient
        .from("students")
        .select("id, name, class_id, login_id")
        .eq("login_id", loginId)
        .limit(1);

      if (error) {
        console.error("students ì¡°íšŒ ì˜¤ë¥˜:", error);
        setStudentStatus("í•™ìƒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", true);
        return;
      }

      if (!data || data.length === 0) {
        setStudentStatus("í•™ìƒ ì •ë³´ê°€ ì‹œìŠ¤í…œì— ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.", true);
        currentStudent = {
          id: null,
          name: storedName || "í•™ìƒ",
          class_id: null,
          login_id: loginId
        };
      } else {
        currentStudent = data[0];
      }

      // í™”ë©´ ë°˜ì˜
      studentNameEl.textContent = currentStudent.name || storedName || "í•™ìƒ";
      studentLoginEl.textContent = currentStudent.login_id || loginId;

      if (!currentStudent.class_id) {
        studentClassEl.textContent = "ë¯¸ë°°ì •";
        classBadgeEl.textContent = "ë°˜ ë¯¸ë°°ì •";
        setStudentStatus("ì•„ì§ ë°˜ì´ ë°°ì •ë˜ì§€ ì•Šì•˜ì–´ìš”. ì„ ìƒë‹˜ê»˜ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.");
      } else {
        await loadCurrentClass();
      }
    } catch (e) {
      console.error("loadCurrentStudent ì˜ˆì™¸:", e);
      setStudentStatus("í•™ìƒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", true);
    }
  }

  // --- 2. í•™ìƒì˜ ë°˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ---
  async function loadCurrentClass() {
    if (!currentStudent || !currentStudent.class_id) return;

    try {
      const { data, error } = await supabaseClient
        .from("classes")
        .select("id, name")
        .eq("id", currentStudent.class_id)
        .limit(1);

      if (error) {
        console.error("classes ì¡°íšŒ ì˜¤ë¥˜:", error);
        studentClassEl.textContent = "ì•Œ ìˆ˜ ì—†ìŒ";
        classBadgeEl.textContent = "ë°˜ ì •ë³´ ì˜¤ë¥˜";
        return;
      }

      if (!data || data.length === 0) {
        studentClassEl.textContent = "ì•Œ ìˆ˜ ì—†ìŒ";
        classBadgeEl.textContent = "ë°˜ ì •ë³´ ì—†ìŒ";
        return;
      }

      currentClass = data[0];
      studentClassEl.textContent = currentClass.name;
      classBadgeEl.textContent = currentClass.name;
      setStudentStatus(`í™˜ì˜í•©ë‹ˆë‹¤! ${currentClass.name} í•™ìƒì…ë‹ˆë‹¤.`);
    } catch (e) {
      console.error("loadCurrentClass ì˜ˆì™¸:", e);
      studentClassEl.textContent = "ì•Œ ìˆ˜ ì—†ìŒ";
      classBadgeEl.textContent = "ë°˜ ì •ë³´ ì˜¤ë¥˜";
    }
  }

  // --- 3. ìš°ë¦¬ ë°˜ ìˆ™ì œ(í•„ê¸° + ì˜¨ë¼ì¸) ë¶ˆëŸ¬ì˜¤ê¸° (board.html ë¡œì§ ì¶•ì•½) ---
  async function loadClassHomework() {
    classHwListEl.innerHTML = "";
    classHwEmptyEl.style.display = "none";

    if (!currentStudent || !currentStudent.class_id) {
      classHwEmptyEl.style.display = "block";
      classHwEmptyEl.textContent = "ë°˜ì´ ì•„ì§ ë°°ì •ë˜ì§€ ì•Šì•„ ìˆ™ì œë¥¼ ë³¼ ìˆ˜ ì—†ì–´ìš”.";
      return;
    }

    const classId = currentStudent.class_id;

    try {
      const [postsRes, vocabRes, sentenceRes] = await Promise.all([
        supabaseClient
          .from("board_posts")
          .select("id, class_id, title, content, created_at")
          .eq("class_id", classId)
          .order("created_at", { ascending: false }),
        supabaseClient
          .from("vocab_homework")
          .select("id, class_id, level, set_numbers, due_date, created_at")
          .eq("class_id", classId)
          .order("created_at", { ascending: false }),
        supabaseClient
          .from("sentence_homework")
          .select("id, class_id, level, set_numbers, due_date, created_at")
          .eq("class_id", classId)
          .order("created_at", { ascending: false })
      ]);

      if (postsRes.error)   console.error("board_posts ì˜¤ë¥˜:", postsRes.error);
      if (vocabRes.error)   console.error("vocab_homework ì˜¤ë¥˜:", vocabRes.error);
      if (sentenceRes.error)console.error("sentence_homework ì˜¤ë¥˜:", sentenceRes.error);

      const map = {}; // key = class_id + '__' + dateKey

      function ensureGroup(class_id, dateKey, created_at) {
        const key = `${class_id}__${dateKey}`;
        if (!map[key]) {
          map[key] = {
            key,
            class_id,
            class_name: currentClass ? currentClass.name : "",
            dateKey,
            latestTime: created_at || null,
            posts: [],
            vocab: [],
            sentence: []
          };
        } else if (created_at) {
          if (!map[key].latestTime || new Date(created_at) > new Date(map[key].latestTime)) {
            map[key].latestTime = created_at;
          }
        }
        return map[key];
      }

      // í•„ê¸°
      (postsRes.data || []).forEach(row => {
        const titleDate = dateKeyFromTitle(row.title);
        const dateKey = titleDate || toDateKeyFromISO(row.created_at);
        if (!dateKey) return;
        const g = ensureGroup(row.class_id, dateKey, row.created_at);
        g.posts.push({
          id: row.id,
          title: row.title,
          content: row.content || "",
          created_at: row.created_at
        });
      });

      // ì˜¨ë¼ì¸ ì–´íœ˜
      (vocabRes.data || []).forEach(row => {
        const baseDate = row.due_date || row.created_at;
        const dateKey = row.due_date || toDateKeyFromISO(row.created_at);
        if (!dateKey) return;
        const g = ensureGroup(row.class_id, dateKey, baseDate);
        g.vocab.push({
          id: row.id,
          level: row.level,
          sets: row.set_numbers,
          due_date: row.due_date,
          created_at: row.created_at
        });
      });

      // ì˜¨ë¼ì¸ ë¬¸ì¥
      (sentenceRes.data || []).forEach(row => {
        const baseDate = row.due_date || row.created_at;
        const dateKey = row.due_date || toDateKeyFromISO(row.created_at);
        if (!dateKey) return;
        const g = ensureGroup(row.class_id, dateKey, baseDate);
        g.sentence.push({
          id: row.id,
          level: row.level,
          sets: row.set_numbers,
          due_date: row.due_date,
          created_at: row.created_at
        });
      });

      groups = Object.values(map).sort((a, b) => {
        return new Date(b.latestTime || 0) - new Date(a.latestTime || 0);
      });

      renderClassHomework();
    } catch (e) {
      console.error("loadClassHomework ì˜ˆì™¸:", e);
      classHwEmptyEl.style.display = "block";
      classHwEmptyEl.textContent = "ìˆ™ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.";
    }
  }

  function renderClassHomework() {
    classHwListEl.innerHTML = "";

    if (!groups || groups.length === 0) {
      classHwEmptyEl.style.display = "block";
      classHwEmptyEl.textContent = "ì•„ì§ ìš°ë¦¬ ë°˜ì— ë“±ë¡ëœ ìˆ™ì œê°€ ì—†ì–´ìš”.";
      return;
    }

    classHwEmptyEl.style.display = "none";

    groups.forEach(g => {
      const card = document.createElement("div");
      card.className = "post-card";

      const header = document.createElement("div");
      header.className = "post-header";

      const left = document.createElement("div");
      const classBadge = document.createElement("div");
      classBadge.className = "post-class-badge";
      classBadge.textContent = g.class_name || "ìš°ë¦¬ ë°˜";

      const typeBadge = document.createElement("span");
      typeBadge.className = "post-type-badge";
      const hasOffline = g.posts.length > 0;
      const hasOnline = g.vocab.length > 0 || g.sentence.length > 0;
      if (hasOffline && hasOnline) {
        typeBadge.textContent = "í•„ê¸° + ì˜¨ë¼ì¸ ìˆ™ì œ";
      } else if (hasOffline) {
        typeBadge.textContent = "í•„ê¸° ìˆ™ì œ";
      } else {
        typeBadge.textContent = "ì˜¨ë¼ì¸ ìˆ™ì œ";
      }

      const titleEl = document.createElement("div");
      titleEl.className = "post-title";
      titleEl.textContent = g.dateKey;

      left.appendChild(classBadge);
      left.appendChild(typeBadge);
      left.appendChild(titleEl);

      const meta = document.createElement("div");
      meta.className = "post-meta";
      meta.innerHTML = `
        <span>${DEFAULT_AUTHOR_LABEL}</span>
        <span>${formatDateTime(g.latestTime)}</span>
      `;

      header.appendChild(left);
      header.appendChild(meta);
      card.appendChild(header);

      const body = document.createElement("div");

      // í•„ê¸° ìˆ™ì œ / ê³µì§€
      if (g.posts.length > 0) {
        const secLabel = document.createElement("div");
        secLabel.className = "post-section-label sec-offline";
        secLabel.textContent = "âœï¸ í•„ê¸° ìˆ™ì œ / ê³µì§€";
        body.appendChild(secLabel);

        g.posts.forEach(p => {
          const c = document.createElement("div");
          c.className = "post-content";
          c.textContent = p.content || p.title || "";
          body.appendChild(c);
        });
      }

      // ì˜¨ë¼ì¸ ì–´íœ˜ ìˆ™ì œ
      if (g.vocab.length > 0) {
        const secLabel = document.createElement("div");
        secLabel.className = "post-section-label sec-vocab";
        secLabel.textContent = "ğŸ“š ì˜¨ë¼ì¸ ì–´íœ˜ ìˆ™ì œ";
        body.appendChild(secLabel);

        g.vocab.forEach(h => {
          const row = document.createElement("div");
          row.className = "post-content hw-row";

          const levelTxt = h.level != null ? `ë‹¨ê³„ ${h.level}` : "";
          const setTxt   = h.sets ? ` / ì„¸íŠ¸ ${h.sets}` : "";
          const dueTxt   = h.due_date ? ` (ë§ˆê°ì¼: ${h.due_date})` : "";

          const textSpan = document.createElement("span");
          textSpan.textContent = `${levelTxt}${setTxt}${dueTxt}`;
          row.appendChild(textSpan);

          body.appendChild(row);
        });
      }

      // ì˜¨ë¼ì¸ ë¬¸ì¥ ìˆ™ì œ
      if (g.sentence.length > 0) {
        const secLabel = document.createElement("div");
        secLabel.className = "post-section-label sec-sentence";
        secLabel.textContent = "ğŸ’¬ ì˜¨ë¼ì¸ ë¬¸ì¥ ìˆ™ì œ";
        body.appendChild(secLabel);

        g.sentence.forEach(h => {
          const row = document.createElement("div");
          row.className = "post-content hw-row";

          const levelTxt = h.level != null ? `ë‹¨ê³„ ${h.level}` : "";
          const setTxt   = h.sets ? ` / ì„¸íŠ¸ ${h.sets}` : "";
          const dueTxt   = h.due_date ? ` (ë§ˆê°ì¼: ${h.due_date})` : "";

          const textSpan = document.createElement("span");
          textSpan.textContent = `${levelTxt}${setTxt}${dueTxt}`;
          row.appendChild(textSpan);

          body.appendChild(row);
        });
      }

      card.appendChild(body);
      classHwListEl.appendChild(card);
    });
  }

  // --- 4. ë‚´ ì˜¨ë¼ì¸ ìˆ™ì œ ê²°ê³¼ (vocab_results) ---
  async function loadMyResults() {
    resultTableBody.innerHTML =
      '<tr><td colspan="5" class="empty-cell">ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦</td></tr>';

    if (!currentStudent || !currentStudent.login_id) {
      resultTableBody.innerHTML =
        '<tr><td colspan="5" class="empty-cell">í•™ìƒ ì•„ì´ë””ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”.</td></tr>';
      return;
    }

    try {
      const { data, error } = await supabaseClient
        .from("vocab_results")
        .select("*")
        .eq("student_login_id", currentStudent.login_id)
        .order("submitted_at", { ascending: false })
        .limit(100);

      if (error) {
        console.error("vocab_results ì¡°íšŒ ì˜¤ë¥˜:", error);
        resultTableBody.innerHTML =
          '<tr><td colspan="5" class="empty-cell">ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.</td></tr>';
        return;
      }

      if (!data || data.length === 0) {
        resultTableBody.innerHTML =
          '<tr><td colspan="5" class="empty-cell">ì•„ì§ ì œì¶œí•œ ì˜¨ë¼ì¸ ìˆ™ì œê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      resultTableBody.innerHTML = "";

      data.forEach(row => {
        const tr = document.createElement("tr");

        const d = new Date(row.submitted_at);
        const dateStr = isNaN(d.getTime())
          ? "-"
          : `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
        const timeStr = isNaN(d.getTime())
          ? "-"
          : d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

        tr.innerHTML = `
          <td>${dateStr}</td>
          <td>${row.unit || "-"}</td>
          <td>${row.correct_count != null ? row.correct_count + "ì " : "-"} <span style="color:#6b7280; font-size:12px;">(${row.mode || "-"})</span></td>
          <td>${timeStr}</td>
          <td>${row.homework_id ? "ìˆ™ì œì™€ ì—°ê²°ë¨" : "-"}</td>
        `;
        resultTableBody.appendChild(tr);
      });
    } catch (e) {
      console.error("loadMyResults ì˜ˆì™¸:", e);
      resultTableBody.innerHTML =
        '<tr><td colspan="5" class="empty-cell">ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.</td></tr>';
    }
  }

  // --- 5. ìš°ë¦¬ ë°˜ ì˜¨ë¼ì¸ ìˆ™ì œ ëª©ë¡ (ì–´íœ˜ + ë¬¸ì¥) ---
  async function loadOnlineHomeworkList() {
    onlineHwListEl.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦";

    if (!currentStudent || !currentStudent.class_id) {
      onlineHwListEl.textContent = "ë°˜ì´ ë°°ì •ë˜ì§€ ì•Šì•„ ì˜¨ë¼ì¸ ìˆ™ì œë¥¼ ë³¼ ìˆ˜ ì—†ì–´ìš”.";
      return;
    }

    const classId = currentStudent.class_id;

    try {
      const [vocabRes, sentenceRes] = await Promise.all([
        supabaseClient
          .from("vocab_homework")
          .select("id, level, set_numbers, due_date, created_at")
          .eq("class_id", classId)
          .order("created_at", { ascending: false }),
        supabaseClient
          .from("sentence_homework")
          .select("id, level, set_numbers, due_date, created_at")
          .eq("class_id", classId)
          .order("created_at", { ascending: false })
      ]);

      if (vocabRes.error)   console.error("vocab_homework ëª©ë¡ ì˜¤ë¥˜:", vocabRes.error);
      if (sentenceRes.error)console.error("sentence_homework ëª©ë¡ ì˜¤ë¥˜:", sentenceRes.error);

      const merged = [];

      (vocabRes.data || []).forEach(row => {
        merged.push({
          type: "vocab",
          id: row.id,
          level: row.level,
          sets: row.set_numbers,
          due_date: row.due_date,
          created_at: row.created_at
        });
      });

      (sentenceRes.data || []).forEach(row => {
        merged.push({
          type: "sentence",
          id: row.id,
          level: row.level,
          sets: row.set_numbers,
          due_date: row.due_date,
          created_at: row.created_at
        });
      });

      if (merged.length === 0) {
        onlineHwListEl.textContent = "ìš°ë¦¬ ë°˜ì—ëŠ” ì•„ì§ ë“±ë¡ëœ ì˜¨ë¼ì¸ ìˆ™ì œê°€ ì—†ì–´ìš”.";
        return;
      }

      merged.sort((a, b) => {
        const da = a.due_date || a.created_at || "";
        const db = b.due_date || b.created_at || "";
        return new Date(db) - new Date(da);
      });

      onlineHwListEl.innerHTML = "";
      merged.forEach(row => {
        const div = document.createElement("div");
        div.className = "hw-item";

        const left = document.createElement("div");
        const tag = document.createElement("span");
        tag.className = "hw-tag " + (row.type === "vocab" ? "vocab" : "sentence");
        tag.textContent = row.type === "vocab" ? "ì–´íœ˜" : "ë¬¸ì¥";

        const text = document.createElement("span");
        const levelTxt = row.level != null ? `ë ˆë²¨ ${row.level}` : "";
        const setTxt   = row.sets ? ` / ì„¸íŠ¸: ${row.sets}` : "";
        const dueTxt   = row.due_date ? ` / ë§ˆê°ì¼: ${row.due_date}` : "";

        text.textContent = `${levelTxt}${setTxt}${dueTxt}`;
        left.appendChild(tag);
        left.appendChild(text);

        // ì—¬ê¸° ì˜¤ë¥¸ìª½ì— ë‚˜ì¤‘ì— "ìˆ™ì œ í’€ê¸°" ë²„íŠ¼ì„ ë¶™ì´ë©´ ë¨.
        const right = document.createElement("div");
        right.style.fontSize = "11px";
        right.style.color = "#9ca3af";
        right.textContent = "ì˜¨ë¼ì¸ í•™ìŠµ í˜ì´ì§€ì™€ ì—°ë™ ì˜ˆì •";

        div.appendChild(left);
        div.appendChild(right);
        onlineHwListEl.appendChild(div);
      });
    } catch (e) {
      console.error("loadOnlineHomeworkList ì˜ˆì™¸:", e);
      onlineHwListEl.textContent = "ì˜¨ë¼ì¸ ìˆ™ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.";
    }
  }

  // --- ì´ˆê¸° ì‹¤í–‰ ---
  (async function init() {
    await loadCurrentStudent();     // currentStudent, currentClass ì„¤ì •
    await loadClassHomework();      // 1. ìš°ë¦¬ ë°˜ ìˆ™ì œ
    await loadMyResults();          // 2. ë‚´ ê²°ê³¼
    await loadOnlineHomeworkList(); // 3. ì˜¨ë¼ì¸ ìˆ™ì œ ëª©ë¡
  })();
</script>
</body>
</html>
