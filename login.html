<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>블라썸잉글리쉬 로그인</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Pretendard Variable", -apple-system, BlinkMacSystemFont,
        system-ui, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    body {
      background: #f4f6fb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 24px;
    }

    .card {
      width: 100%;
      max-width: 480px;
      background: #ffffff;
      border-radius: 32px;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.16);
      padding: 28px 30px 30px;
    }

    .tabs {
      display: flex;
      background: #f3f4f6;
      border-radius: 999px;
      padding: 4px;
      margin-bottom: 26px;
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 10px 0;
      border-radius: 999px;
      font-size: 15px;
      font-weight: 600;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tab.active {
      background: #2563eb;
      color: #ffffff;
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.45);
    }

    h1 {
      font-size: 26px;
      font-weight: 800;
      margin-bottom: 18px;
    }

    .form-group {
      margin-bottom: 14px;
    }

    label {
      display: block;
      font-size: 13px;
      color: #4b5563;
      margin-bottom: 6px;
    }

    input[type="text"],
    input[type="password"],
    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
      background: #f9fafb;
    }

    input:focus,
    select:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
      background: #ffffff;
    }

    .btn-primary {
      width: 100%;
      margin-top: 8px;
      padding: 11px 0;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: #ffffff;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 14px 30px rgba(37, 99, 235, 0.45);
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(37, 99, 235, 0.5);
      background: #1d4ed8;
    }

    .btn-google {
      width: 100%;
      margin-top: 10px;
      padding: 10px 0;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-google span {
      font-size: 13px;
      color: #374151;
    }

    .helper-text {
      margin-top: 6px;
      font-size: 12px;
      color: #6b7280;
      text-align: center;
    }

    .error-box {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 12px;
      background: #fee2e2;
      color: #b91c1c;
      font-size: 13px;
      display: none;
    }

    .back-link {
      margin-top: 14px;
      font-size: 13px;
      text-align: center;
    }

    .back-link a {
      color: #2563eb;
      text-decoration: none;
      font-weight: 600;
    }

    .back-link a:hover {
      text-decoration: underline;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>
<div class="card">
  <!-- 탭 -->
  <div class="tabs">
    <div id="tab-login" class="tab active">로그인</div>
    <div id="tab-signup" class="tab">회원가입</div>
  </div>

  <!-- 로그인 폼 -->
  <div id="login-panel">
    <h1>로그인</h1>

    <form id="login-form">
      <div class="form-group">
        <label for="login-id">아이디 / 이메일</label>
        <input id="login-id" type="text" placeholder="예: stell 또는 stell@example.com" required />
      </div>

      <div class="form-group">
        <label for="login-password">비밀번호</label>
        <input id="login-password" type="password" placeholder="비밀번호" required />
      </div>

      <button type="submit" class="btn-primary">로그인</button>
    </form>

    <button id="google-login" class="btn-google">
      <img src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google" style="width:18px;height:18px;" />
      <span>구글 계정으로 로그인</span>
    </button>

    <div class="helper-text">
      구글 버튼은 이미 가입된 계정이 있어도 그대로 로그인 돼요.
    </div>

    <div class="error-box" id="login-error"></div>
  </div>

  <!-- 회원가입 폼 -->
  <div id="signup-panel" class="hidden">
    <h1>회원가입</h1>

    <form id="signup-form">
      <div class="form-group">
        <label for="signup-id">아이디 / 이메일</label>
        <input id="signup-id" type="text" placeholder="예: stell (이메일 없어도 돼요)" required />
      </div>

      <div class="form-group">
        <label for="signup-password">비밀번호</label>
        <input id="signup-password" type="password" placeholder="비밀번호 (최소 6자)" minlength="6" required />
      </div>

      <div class="form-group">
        <label for="signup-password-confirm">비밀번호 확인</label>
        <input id="signup-password-confirm" type="password" placeholder="비밀번호 다시 입력" minlength="6" required />
      </div>

      <div class="form-group">
        <label for="signup-name">이름 / 별명</label>
        <input id="signup-name" type="text" placeholder="예: 홍길동 / Stella" required />
      </div>

      <div class="form-group">
        <label for="signup-role">역할</label>
        <select id="signup-role" required>
          <option value="student">학생 / 학부모</option>
          <option value="teacher">선생님</option>
        </select>
      </div>

      <button type="submit" class="btn-primary">회원가입</button>
    </form>

    <button id="google-signup" class="btn-google">
      <img src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google" style="width:18px;height:18px;" />
      <span>구글 계정으로 가입/로그인</span>
    </button>

    <div class="helper-text">
      구글 버튼은 이미 가입된 계정이 있어도 그대로 로그인 돼요.
    </div>

    <div class="error-box" id="signup-error"></div>
  </div>

  <div class="back-link">
    <a href="index.html">← 블라썸잉글리쉬 홈으로 돌아가기</a>
  </div>
</div>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ===== Supabase 초기화 =====
  const SUPABASE_URL = "https://bpdisxjhhibrgfpvtlmv.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZGlzeGpoaGlicmdmcHZ0bG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTkxODQsImV4cCI6MjA3OTUzNTE4NH0.jDZ6BGirOPuWUnt4ykjhng4PLft2ZjBuYAFzApUnlYU";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // 아이디만 입력했을 때 → 내부용 이메일로 변환
  function toEmailFromId(idOrEmail) {
    const value = idOrEmail.trim();
    if (!value) return "";
    // 이미 이메일 형식이면 그대로 사용
    if (value.includes("@")) return value;
    // 아이디만 있으면 blossomsedu.net 도메인 붙이기
    return `${value}@blossomedu.net`;
  }

  // GitHub Pages 경로 고려해서 index.html로 리다이렉트
  function getIndexUrl() {
    const path = window.location.pathname;
    if (path.includes("login.html")) {
      return window.location.origin + path.replace("login.html", "index.html");
    }
    return window.location.origin + "/newblossomenglish/index.html";
  }

  // ===== 탭 전환 =====
  const tabLogin = document.getElementById("tab-login");
  const tabSignup = document.getElementById("tab-signup");
  const loginPanel = document.getElementById("login-panel");
  const signupPanel = document.getElementById("signup-panel");

  tabLogin.addEventListener("click", () => {
    tabLogin.classList.add("active");
    tabSignup.classList.remove("active");
    loginPanel.classList.remove("hidden");
    signupPanel.classList.add("hidden");
  });

  tabSignup.addEventListener("click", () => {
    tabSignup.classList.add("active");
    tabLogin.classList.remove("active");
    signupPanel.classList.remove("hidden");
    loginPanel.classList.add("hidden");
  });

  // ===== 로그인 처리 =====
  const loginForm = document.getElementById("login-form");
  const loginErrorBox = document.getElementById("login-error");

  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    loginErrorBox.style.display = "none";

    const rawId = document.getElementById("login-id").value;
    const password = document.getElementById("login-password").value;

    const email = toEmailFromId(rawId);

    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });

    if (error) {
      loginErrorBox.textContent = error.message;
      loginErrorBox.style.display = "block";
      return;
    }

    window.location.href = getIndexUrl();
  });

  // ===== 회원가입 처리 =====
  const signupForm = document.getElementById("signup-form");
  const signupErrorBox = document.getElementById("signup-error");

  signupForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    signupErrorBox.style.display = "none";

    const rawId = document.getElementById("signup-id").value;
    const password = document.getElementById("signup-password").value;
    const passwordConfirm = document.getElementById("signup-password-confirm").value;
    const name = document.getElementById("signup-name").value.trim();
    const role = document.getElementById("signup-role").value;

    if (password !== passwordConfirm) {
      signupErrorBox.textContent = "비밀번호가 서로 일치하지 않습니다.";
      signupErrorBox.style.display = "block";
      return;
    }

    const email = toEmailFromId(rawId);

    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: {
          name,
          role,
          userId: rawId.trim(),
        },
      },
    });

    if (error) {
      signupErrorBox.textContent = error.message;
      signupErrorBox.style.display = "block";
      return;
    }

    alert("회원가입이 완료되었습니다. 이제 로그인해 주세요!");
    tabLogin.click();
  });

  // ===== 구글 로그인 / 가입 =====
  async function signInWithGoogle() {
    const { error } = await supabase.auth.signInWithOAuth({
      provider: "google",
      options: {
        redirectTo: getIndexUrl(),
      },
    });

    if (error) {
      alert("구글 로그인 중 오류가 발생했습니다: " + error.message);
    }
  }

  document.getElementById("google-login").addEventListener("click", signInWithGoogle);
  document.getElementById("google-signup").addEventListener("click", signInWithGoogle);
</script>
</body>
</html>