<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>로그인 - 블라썸잉글리쉬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Pretendard Variable", -apple-system, BlinkMacSystemFont,
        system-ui, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }
    body {
      background: #f4f6fb;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 30px 16px;
    }
    .card {
      width: 100%;
      max-width: 480px;
      background: #ffffff;
      border-radius: 30px;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.16);
      padding: 32px 32px 28px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 22px;
    }
    .tab-btn {
      flex: 1;
      padding: 10px 0;
      border-radius: 999px;
      border: none;
      font-size: 15px;
      cursor: pointer;
      background: #e5e7eb;
      color: #4b5563;
    }
    .tab-btn.active {
      background: #2563eb;
      color: #ffffff;
      box-shadow: 0 12px 24px rgba(37, 99, 235, 0.35);
    }

    .title {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 18px;
    }

    .field {
      margin-bottom: 14px;
    }
    .field label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: #4b5563;
    }
    .input {
      width: 100%;
      padding: 11px 14px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }
    .select {
      width: 100%;
      padding: 11px 14px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      background: #fff;
    }

    .primary-btn {
      width: 100%;
      padding: 12px 0;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: #ffffff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
    }

    .google-btn {
      width: 100%;
      padding: 10px 0;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
    }

    .helper-text {
      margin-top: 8px;
      font-size: 12px;
      color: #6b7280;
      text-align: center;
    }

    .error-box {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      background: #fee2e2;
      color: #b91c1c;
      font-size: 13px;
      display: none;
    }
    .success-box {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      background: #dcfce7;
      color: #166534;
      font-size: 13px;
      display: none;
    }

    .back-link {
      margin-top: 14px;
      text-align: center;
      font-size: 13px;
    }
    .back-link a {
      color: #2563eb;
      text-decoration: none;
      font-weight: 600;
    }
  </style>
</head>
<body>

<div class="card">
  <!-- 탭: 로그인 / 회원가입 -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="login">로그인</button>
    <button class="tab-btn" data-tab="signup">회원가입</button>
  </div>

  <!-- 로그인 영역 -->
  <div id="loginPane">
    <div class="title">로그인</div>

    <div class="field">
      <label for="loginEmail">이메일</label>
      <input id="loginEmail" type="email" class="input" placeholder="example@naver.com" />
    </div>
    <div class="field">
      <label for="loginPassword">비밀번호</label>
      <input id="loginPassword" type="password" class="input" placeholder="비밀번호" />
    </div>

    <button id="loginBtn" class="primary-btn">로그인</button>
    <button id="googleLoginBtn" class="google-btn">구글 계정으로 로그인</button>

    <div class="helper-text">
      아직 계정이 없다면 위쪽 <b>회원가입</b> 탭을 눌러 주세요.
    </div>
  </div>

  <!-- 회원가입 영역 -->
  <div id="signupPane" style="display:none;">
    <div class="title">회원가입</div>

    <div class="field">
      <label for="signupEmail">이메일</label>
      <input id="signupEmail" type="email" class="input" placeholder="보호자 이메일도 가능해요" />
    </div>
    <div class="field">
      <label for="signupPassword">비밀번호</label>
      <input id="signupPassword" type="password" class="input" placeholder="비밀번호 (최소 6자)" />
    </div>
    <div class="field">
      <label for="signupPassword2">비밀번호 확인</label>
      <input id="signupPassword2" type="password" class="input" placeholder="비밀번호 다시 입력" />
    </div>
    <div class="field">
      <label for="signupName">이름 / 별명</label>
      <input id="signupName" type="text" class="input" placeholder="예: 홍길동 / Stella" />
    </div>
    <div class="field">
      <label for="signupRole">역할</label>
      <select id="signupRole" class="select">
        <option value="student">학생 / 학부모</option>
        <option value="teacher">선생님</option>
      </select>
    </div>

    <button id="signupBtn" class="primary-btn">회원가입</button>
    <button id="googleSignupBtn" class="google-btn">구글 계정으로 가입/로그인</button>

    <div class="helper-text">
      구글 버튼은 이미 가입된 계정이 있어도 그대로 로그인돼요.
    </div>
  </div>

  <!-- 메시지 영역 -->
  <div id="errorBox" class="error-box"></div>
  <div id="successBox" class="success-box"></div>

  <div class="back-link">
    <a href="index.html">← 블라썸잉글리쉬 홈으로 돌아가기</a>
  </div>
</div>

<!-- Supabase JS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const { createClient } = supabase;

  // 너가 알려준 프로젝트 정보
  const SUPABASE_URL = "https://bpdisxjhhibrgfpvtlmv.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZGlzeGpoaGlicmdmcHZ0bG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTkxODQsImV4cCI6MjA3OTUzNTE4NH0.jDZ6BGirOPuWUnt4ykjhng4PLft2ZjBuYAFzApUnlYU";

  const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const tabButtons = document.querySelectorAll(".tab-btn");
  const loginPane = document.getElementById("loginPane");
  const signupPane = document.getElementById("signupPane");
  const errorBox = document.getElementById("errorBox");
  const successBox = document.getElementById("successBox");

  function showError(msg) {
    if (!msg) {
      errorBox.style.display = "none";
      return;
    }
    errorBox.textContent = msg;
    errorBox.style.display = "block";
    successBox.style.display = "none";
  }

  function showSuccess(msg) {
    if (!msg) {
      successBox.style.display = "none";
      return;
    }
    successBox.textContent = msg;
    successBox.style.display = "block";
    errorBox.style.display = "none";
  }

  // 탭 전환
  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const tab = btn.dataset.tab;
      tabButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      if (tab === "login") {
        loginPane.style.display = "block";
        signupPane.style.display = "none";
      } else {
        loginPane.style.display = "none";
        signupPane.style.display = "block";
      }
      showError("");
      showSuccess("");
    });
  });

  // URL 파라미터로 모드 지정 가능: ?mode=signup
  const params = new URLSearchParams(window.location.search);
  if (params.get("mode") === "signup") {
    document.querySelector('.tab-btn[data-tab="signup"]').click();
  }

  // 로그인 처리
  document.getElementById("loginBtn").addEventListener("click", async () => {
    const email = document.getElementById("loginEmail").value.trim();
    const password = document.getElementById("loginPassword").value;

    if (!email || !password) {
      showError("이메일과 비밀번호를 모두 입력해 주세요.");
      return;
    }

    try {
      showError("");
      const { error } = await supa.auth.signInWithPassword({ email, password });
      if (error) {
        showError(error.message || "로그인에 실패했어요.");
      } else {
        showSuccess("로그인에 성공했어요! 잠시 후 메인 화면으로 이동합니다.");
        setTimeout(() => {
          window.location.href = "index.html";
        }, 900);
      }
    } catch (e) {
      console.error(e);
      showError("알 수 없는 오류가 발생했어요.");
    }
  });

  // 이메일 회원가입
  document.getElementById("signupBtn").addEventListener("click", async () => {
    const email = document.getElementById("signupEmail").value.trim();
    const password = document.getElementById("signupPassword").value;
    const password2 = document.getElementById("signupPassword2").value;
    const name = document.getElementById("signupName").value.trim();
    const role = document.getElementById("signupRole").value;

    if (!email || !password || !password2) {
      showError("이메일과 비밀번호를 모두 입력해 주세요.");
      return;
    }
    if (password !== password2) {
      showError("비밀번호가 서로 같지 않아요.");
      return;
    }
    if (password.length < 6) {
      showError("비밀번호는 최소 6자 이상이어야 해요.");
      return;
    }

    try {
      showError("");
      const { error } = await supa.auth.signUp({
        email,
        password,
        options: {
          data: {
            name: name || null,
            role: role || "student"
          }
        }
      });

      if (error) {
        showError(error.message || "회원가입에 실패했어요.");
      } else {
        showSuccess("회원가입 완료! 메일함에서 인증 메일을 확인해 주세요.");
      }
    } catch (e) {
      console.error(e);
      showError("알 수 없는 오류가 발생했어요.");
    }
  });

  // 구글 로그인 / 회원가입 (둘 다 동일)
  async function loginWithGoogle() {
    try {
      showError("");
      const redirectTo = window.location.origin + window.location.pathname.replace("login.html", "index.html");
      const { error } = await supa.auth.signInWithOAuth({
        provider: "google",
        options: { redirectTo }
      });
      if (error) {
        showError(error.message || "구글 로그인에 실패했어요.");
      }
      // 성공 시에는 Supabase가 redirectTo로 이동시킴
    } catch (e) {
      console.error(e);
      showError("구글 로그인 중 오류가 발생했어요.");
    }
  }

  document.getElementById("googleLoginBtn").addEventListener("click", loginWithGoogle);
  document.getElementById("googleSignupBtn").addEventListener("click", loginWithGoogle);
</script>

</body>
</html>