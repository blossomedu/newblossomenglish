<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë¡œê·¸ì¸ - ë¸”ë¼ì¸ì‰ê¸€ë¦¬ì‰¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Pretendard Variable", -apple-system, BlinkMacSystemFont,
        system-ui, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    body {
      background: #f4f6fb;
      padding: 40px 0 60px;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px;
    }

    h1 {
      font-size: 32px;
      font-weight: 900;
      margin-bottom: 6px;
    }

    .subtitle {
      font-size: 15px;
      color: #6b7280;
      margin-bottom: 24px;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 20px;
    }

    @media (max-width: 768px) {
      .cards {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #ffffff;
      border-radius: 24px;
      padding: 20px 22px 22px;
      box-shadow: 0 15px 32px rgba(15, 23, 42, 0.08);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      margin-bottom: 8px;
    }

    .badge-teacher {
      background: #eef2ff;
      color: #3730a3;
    }

    .badge-student {
      background: #ecfeff;
      color: #0369a1;
    }

    .card-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .card-sub {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 16px;
      line-height: 1.4;
    }

    .field {
      margin-bottom: 10px;
    }

    .field label {
      display: block;
      font-size: 13px;
      color: #4b5563;
      margin-bottom: 4px;
    }

    .input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      background: #ffffff;
    }

    .btn {
      width: 100%;
      padding: 9px 14px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-weight: 600;
      margin-top: 6px;
    }

    .btn-blue {
      background: #2563eb;
      color: #ffffff;
    }

    .btn-google {
      background: #ffffff;
      color: #111827;
      border: 1px solid #d1d5db;
    }

    .btn-gray {
      background: #e5e7eb;
      color: #374151;
    }

    .status {
      font-size: 12px;
      margin-top: 6px;
      min-height: 16px;
      color: #6b7280;
    }

    .status.error {
      color: #b91c1c;
    }

    .divider {
      height: 1px;
      background: #e5e7eb;
      margin: 14px 0 12px;
    }

    .section-title {
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 8px;
      color: #374151;
    }

    .hint {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .small-link {
      font-size: 12px;
      color: #2563eb;
      margin-top: 6px;
      cursor: pointer;
      text-decoration: underline;
      display: inline-block;
    }
  </style>
</head>
<body>

<div class="page">
  <h1>ë¡œê·¸ì¸</h1>
  <div class="subtitle">ì„ ìƒë‹˜ê³¼ í•™ìƒì´ í•œ í˜ì´ì§€ì—ì„œ ë¡œê·¸ì¸/ê°€ì…í•  ìˆ˜ ìˆì–´ìš”.</div>

  <div class="cards">

    <!-- ì„ ìƒë‹˜ ì¹´ë“œ -->
    <div class="card">
      <div class="badge badge-teacher">Teacher</div>
      <div class="card-title">ì„ ìƒë‹˜ ë¡œê·¸ì¸</div>
      <div class="card-sub">
        êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ë©´<br />
        ì˜¨ë¼ì¸ ìˆ™ì œì™€ ë°˜ë³„ ê²Œì‹œíŒì„ ê´€ë¦¬í•  ìˆ˜ ìˆì–´ìš”.
      </div>

      <button id="googleLoginBtn" class="btn btn-google">
        ğŸ”‘ êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
      </button>

      <div class="hint">
        ë³„ë„ íšŒì›ê°€ì… ì—†ì´, êµ¬ê¸€ ê³„ì •ì´ ê³§ ì„ ìƒë‹˜ ê³„ì •ì´ ë©ë‹ˆë‹¤.
      </div>

      <div id="teacherStatus" class="status"></div>
    </div>

    <!-- í•™ìƒ ì¹´ë“œ -->
    <div class="card">
      <div class="badge badge-student">Student</div>
      <div class="card-title">í•™ìƒ ë¡œê·¸ì¸ / ê°€ì…</div>
      <div class="card-sub">
        í•™ì›ì—ì„œ ë°›ì€ ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•˜ê±°ë‚˜,<br />
        ì•„ì§ ê³„ì •ì´ ì—†ë‹¤ë©´ ì•„ë˜ì—ì„œ ìƒˆë¡œ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”.
      </div>

      <!-- í•™ìƒ ë¡œê·¸ì¸ -->
      <div class="section-title">í•™ìƒ ë¡œê·¸ì¸</div>

      <div class="field">
        <label>í•™ìƒ ì•„ì´ë””</label>
        <input id="studentLoginId" class="input" type="text" placeholder="ì˜ˆ: 7MB-01" />
      </div>

      <div class="field">
        <label>ë¹„ë°€ë²ˆí˜¸</label>
        <input id="studentLoginPw" class="input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
      </div>

      <button id="studentLoginBtn" class="btn btn-gray">
        ğŸ‘¦ í•™ìƒìœ¼ë¡œ ë¡œê·¸ì¸
      </button>

      <div id="studentLoginStatus" class="status"></div>

      <div class="divider"></div>

      <!-- í•™ìƒ ê°€ì… -->
      <div class="section-title">í•™ìƒ íšŒì›ê°€ì…</div>

      <div class="field">
        <label>ìƒˆ í•™ìƒ ì•„ì´ë””</label>
        <input id="studentSignupId" class="input" type="text" placeholder="ì˜ˆ: 7MB-01" />
      </div>

      <div class="field">
        <label>ì´ë¦„</label>
        <input id="studentSignupName" class="input" type="text" placeholder="ì˜ˆ: í™ê¸¸ë™" />
      </div>

      <div class="field">
        <label>ë¹„ë°€ë²ˆí˜¸</label>
        <input id="studentSignupPw" class="input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
      </div>

      <button id="studentSignupBtn" class="btn btn-blue">
        âœ¨ í•™ìƒ ê³„ì • ë§Œë“¤ê¸°
      </button>

      <div class="hint">
        ë°˜(7MB, 10MB ë“±)ì€ ë‚˜ì¤‘ì— ì„ ìƒë‹˜ì´ ì„¤ì •í•´ ì¤„ ìˆ˜ ìˆì–´ìš”.
      </div>

      <div id="studentSignupStatus" class="status"></div>

      <span id="goIndexLink" class="small-link" style="display:none;">
        ì´ë¯¸ ë¡œê·¸ì¸ ìƒíƒœì˜ˆìš”. ë©”ì¸ìœ¼ë¡œ ì´ë™í•˜ê¸°
      </span>
    </div>

  </div>
</div>

<!-- Supabase JS -->
<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
<script>
  // ===== Supabase ì„¤ì • =====
  const SUPABASE_URL = "https://bpdisxjhhibrgfpvtlmv.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZGlzeGpoaGlicmdmcHZ0bG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTkxODQsImV4cCI6MjA3OTUzNTE4NH0.jDZ6BGirOPuWUnt4ykjhng4PLft2ZjBuYAFzApUnlYU";

  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const MAIN_PAGE = "index.html";
  const STUDENT_STORAGE_KEY = "blossom_student";

  // ===== DOM =====
  const googleLoginBtn       = document.getElementById("googleLoginBtn");
  const teacherStatusEl      = document.getElementById("teacherStatus");

  const studentLoginIdEl     = document.getElementById("studentLoginId");
  const studentLoginPwEl     = document.getElementById("studentLoginPw");
  const studentLoginBtn      = document.getElementById("studentLoginBtn");
  const studentLoginStatusEl = document.getElementById("studentLoginStatus");

  const studentSignupIdEl    = document.getElementById("studentSignupId");
  const studentSignupNameEl  = document.getElementById("studentSignupName");
  const studentSignupPwEl    = document.getElementById("studentSignupPw");
  const studentSignupBtn     = document.getElementById("studentSignupBtn");
  const studentSignupStatusEl= document.getElementById("studentSignupStatus");

  const goIndexLinkEl        = document.getElementById("goIndexLink");

  function setStatus(el, msg, isError = false) {
    el.textContent = msg || "";
    el.classList.toggle("error", !!isError);
  }

  // ===== ì´ë¯¸ ë¡œê·¸ì¸ë˜ì–´ ìˆìœ¼ë©´ ë°”ë¡œ indexë¡œ =====
  async function redirectIfAlreadyLoggedIn() {
    let teacherLoggedIn = false;
    let studentLoggedIn = false;

    // ì„ ìƒë‹˜(êµ¬ê¸€) ë¡œê·¸ì¸ ì—¬ë¶€
    try {
      const { data, error } = await client.auth.getUser();
      if (!error && data && data.user) {
        teacherLoggedIn = true;
      }
    } catch (e) {
      console.error("ì„ ìƒë‹˜ ë¡œê·¸ì¸ í™•ì¸ ì˜¤ë¥˜:", e);
    }

    // í•™ìƒ(localStorage) ë¡œê·¸ì¸ ì—¬ë¶€
    try {
      const raw = localStorage.getItem(STUDENT_STORAGE_KEY);
      if (raw) {
        studentLoggedIn = true;
      }
    } catch (e) {
      console.error("í•™ìƒ ë¡œê·¸ì¸ í™•ì¸ ì˜¤ë¥˜:", e);
    }

    if (teacherLoggedIn || studentLoggedIn) {
      // ì´ í˜ì´ì§€ë¥¼ ë‹¤ì‹œ ë“¤ì–´ì˜¨ ìƒíƒœë¼ë©´ ë©”ì¸ìœ¼ë¡œ ë°”ë¡œ ì´ë™
      window.location.href = MAIN_PAGE;
    }
  }

  redirectIfAlreadyLoggedIn();

  // ===== ì„ ìƒë‹˜: êµ¬ê¸€ ë¡œê·¸ì¸ =====
  googleLoginBtn.onclick = async () => {
    setStatus(teacherStatusEl, "êµ¬ê¸€ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤â€¦");
    try {
      const redirectTo =
        window.location.origin +
        window.location.pathname.replace(/[^/]+$/, "login.html");

      const { data, error } = await client.auth.signInWithOAuth({
        provider: "google",
        options: {
          redirectTo: redirectTo,
        },
      });

      if (error) {
        console.error("êµ¬ê¸€ ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
        setStatus(teacherStatusEl, "êµ¬ê¸€ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", true);
        return;
      }

      if (data && data.url) {
        window.location.href = data.url;
      }
    } catch (e) {
      console.error("êµ¬ê¸€ ë¡œê·¸ì¸ ì˜ˆì™¸:", e);
      setStatus(teacherStatusEl, "êµ¬ê¸€ ë¡œê·¸ì¸ ì¤‘ ì˜ˆì™¸ê°€ ë°œìƒí–ˆì–´ìš”.", true);
    }
  };

  // ===== OAuth ì½œë°±ìœ¼ë¡œ ëŒì•„ì™”ì„ ë•Œ: ì´ë¯¸ ë¡œê·¸ì¸ë˜ì—ˆìœ¼ë©´ indexë¡œ =====
  (async function handleOAuthReturn() {
    try {
      const { data, error } = await client.auth.getUser();
      if (!error && data && data.user) {
        // ì´ë¯¸ ì„ ìƒë‹˜ìœ¼ë¡œ ë¡œê·¸ì¸ëœ ìƒíƒœ â†’ ë©”ì¸ìœ¼ë¡œ
        window.location.href = MAIN_PAGE;
      }
    } catch (e) {
      console.error("OAuth ì½œë°± ì²˜ë¦¬ ì˜¤ë¥˜:", e);
    }
  })();

  // ===== í•™ìƒ ë¡œê·¸ì¸ =====
  studentLoginBtn.onclick = async () => {
    const loginId = studentLoginIdEl.value.trim();
    const pw      = studentLoginPwEl.value.trim();

    setStatus(studentLoginStatusEl, "");
    if (!loginId || !pw) {
      setStatus(studentLoginStatusEl, "í•™ìƒ ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.", true);
      return;
    }

    setStatus(studentLoginStatusEl, "ë¡œê·¸ì¸ ì¤‘ì…ë‹ˆë‹¤â€¦");
    studentLoginBtn.disabled = true;

    const { data, error } = await client
      .from("students")
      .select("login_id, name")
      .eq("login_id", loginId)
      .eq("password", pw)
      .maybeSingle();

    studentLoginBtn.disabled = false;

    if (error) {
      console.error("í•™ìƒ ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
      setStatus(studentLoginStatusEl, "ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", true);
      return;
    }

    if (!data) {
      setStatus(studentLoginStatusEl, "ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.", true);
      return;
    }

    // localStorageì— ì €ì¥
    try {
      const payload = {
        login_id: data.login_id,
        name: data.name,
        logged_at: new Date().toISOString(),
        role: "student",
      };
      localStorage.setItem(STUDENT_STORAGE_KEY, JSON.stringify(payload));
    } catch (e) {
      console.error("í•™ìƒ ì •ë³´ ì €ì¥ ì˜¤ë¥˜:", e);
    }

    setStatus(studentLoginStatusEl, "ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤! ë©”ì¸ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
    window.location.href = MAIN_PAGE;
  };

  // ===== í•™ìƒ íšŒì›ê°€ì… =====
  studentSignupBtn.onclick = async () => {
    const loginId = studentSignupIdEl.value.trim();
    const name    = studentSignupNameEl.value.trim();
    const pw      = studentSignupPwEl.value.trim();

    setStatus(studentSignupStatusEl, "");
    if (!loginId || !name || !pw) {
      setStatus(studentSignupStatusEl, "ì•„ì´ë””, ì´ë¦„, ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.", true);
      return;
    }

    setStatus(studentSignupStatusEl, "ê³„ì •ì„ ë§Œë“œëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦");
    studentSignupBtn.disabled = true;

    // ê°™ì€ ì•„ì´ë””ê°€ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
    const { data: existing, error: checkError } = await client
      .from("students")
      .select("id")
      .eq("login_id", loginId)
      .limit(1);

    if (checkError) {
      console.error("í•™ìƒ ì•„ì´ë”” ì¤‘ë³µ í™•ì¸ ì˜¤ë¥˜:", checkError);
      studentSignupBtn.disabled = false;
      setStatus(studentSignupStatusEl, "ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", true);
      return;
    }

    if (existing && existing.length > 0) {
      studentSignupBtn.disabled = false;
      setStatus(studentSignupStatusEl, "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì•„ì´ë””ë¥¼ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.", true);
      return;
    }

    // ìƒˆ í•™ìƒ insert
    const { data: inserted, error: insertError } = await client
      .from("students")
      .insert({
        login_id: loginId,
        name: name,
        password: pw,
      })
      .select("login_id, name")
      .maybeSingle();

    studentSignupBtn.disabled = false;

    if (insertError) {
      console.error("í•™ìƒ ê°€ì… ì˜¤ë¥˜:", insertError);
      setStatus(studentSignupStatusEl, "í•™ìƒ ê³„ì •ì„ ë§Œë“œëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", true);
      return;
    }

    // ê°€ì… ì„±ê³µ â†’ ë°”ë¡œ ë¡œê·¸ì¸ ì²˜ë¦¬
    try {
      const payload = {
        login_id: inserted.login_id,
        name: inserted.name,
        logged_at: new Date().toISOString(),
        role: "student",
      };
      localStorage.setItem(STUDENT_STORAGE_KEY, JSON.stringify(payload));
    } catch (e) {
      console.error("í•™ìƒ ì •ë³´ ì €ì¥ ì˜¤ë¥˜:", e);
    }

    setStatus(studentSignupStatusEl, "ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë©”ì¸ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
    window.location.href = MAIN_PAGE;
  };

  // ===== ì´ë¯¸ í•™ìƒ ì •ë³´ê°€ ìˆëŠ” ê²½ìš°: "ë©”ì¸ìœ¼ë¡œ ì´ë™" ë§í¬ ë³´ì´ê¸° =====
  (function checkStudentLocal() {
    try {
      const raw = localStorage.getItem(STUDENT_STORAGE_KEY);
      if (raw) {
        goIndexLinkEl.style.display = "inline-block";
        goIndexLinkEl.onclick = () => {
          window.location.href = MAIN_PAGE;
        };
      }
    } catch (e) {
      // ë¬´ì‹œ
    }
  })();
</script>

</body>
</html>