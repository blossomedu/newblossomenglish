<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë¡œê·¸ì¸ - ë¸”ë¼ì¸ì‰ê¸€ë¦¬ì‰¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Pretendard Variable", -apple-system, BlinkMacSystemFont,
        system-ui, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    body {
      background: #f4f6fb;
      padding: 40px 0 60px;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px;
    }

    h1 {
      font-size: 32px;
      font-weight: 900;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 15px;
      color: #6b7280;
      margin-bottom: 24px;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 20px;
    }

    @media (max-width: 768px) {
      .cards {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #ffffff;
      border-radius: 24px;
      padding: 20px 22px 22px;
      box-shadow: 0 15px 32px rgba(15, 23, 42, 0.08);
    }

    .card-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .card-sub {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 16px;
    }

    .field {
      margin-bottom: 10px;
    }

    .field label {
      display: block;
      font-size: 13px;
      color: #4b5563;
      margin-bottom: 4px;
    }

    .input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      background: #ffffff;
    }

    .btn {
      width: 100%;
      padding: 9px 14px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-primary {
      background: #2563eb;
      color: #ffffff;
      margin-top: 6px;
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #111827;
      margin-top: 6px;
    }

    .btn-google {
      background: #ffffff;
      color: #111827;
      border: 1px solid #d1d5db;
      margin-top: 8px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: #eef2ff;
      color: #3730a3;
      margin-bottom: 6px;
    }

    .status {
      font-size: 12px;
      margin-top: 6px;
      color: #6b7280;
    }

    .status.error {
      color: #b91c1c;
    }

    .hint {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .small-link {
      font-size: 12px;
      color: #2563eb;
      margin-top: 6px;
      cursor: pointer;
      text-decoration: underline;
    }
  </style>
</head>
<body>

<div class="page">
  <h1>ë¡œê·¸ì¸</h1>
  <div class="subtitle">ì„ ìƒë‹˜ / í•™ìƒ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ê³  ìˆ™ì œë¥¼ ê´€ë¦¬í•´ìš”.</div>

  <div class="cards">

    <!-- ì„ ìƒë‹˜ ë¡œê·¸ì¸ ì¹´ë“œ -->
    <div class="card">
      <div class="badge">Teacher</div>
      <div class="card-title">ì„ ìƒë‹˜ ë¡œê·¸ì¸</div>
      <div class="card-sub">
        êµ¬ê¸€ ê³„ì • ë˜ëŠ” ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸í•˜ë©´<br />
        ì˜¨ë¼ì¸ ìˆ™ì œ / ë°˜ë³„ ê²Œì‹œíŒì„ ê´€ë¦¬í•  ìˆ˜ ìˆì–´ìš”.
      </div>

      <div class="field">
        <label>ì´ë©”ì¼</label>
        <input id="teacherEmail" class="input" type="email" placeholder="teacher@example.com" />
      </div>

      <div class="field">
        <label>ë¹„ë°€ë²ˆí˜¸</label>
        <input id="teacherPassword" class="input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
      </div>

      <button id="teacherLoginBtn" class="btn btn-primary">
        ì„ ìƒë‹˜ ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸
      </button>

      <div class="hint">
        Supabase Authì— ë“±ë¡ëœ ì„ ìƒë‹˜ ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•´ìš”.
      </div>

      <button id="googleLoginBtn" class="btn btn-google">
        ğŸ”‘ êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
      </button>

      <div id="teacherStatus" class="status"></div>
    </div>

    <!-- í•™ìƒ ë¡œê·¸ì¸ ì¹´ë“œ -->
    <div class="card">
      <div class="badge" style="background:#ecfeff; color:#0369a1;">Student</div>
      <div class="card-title">í•™ìƒ ë¡œê·¸ì¸</div>
      <div class="card-sub">
        ê°„ë‹¨í•œ ì•„ì´ë””/ì´ë¦„ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ë©´<br />
        ë‚´ ìˆ™ì œì™€ ì„±ì ì„ ë³¼ ìˆ˜ ìˆì–´ìš”.
      </div>

      <div class="field">
        <label>í•™ìƒ ì•„ì´ë””</label>
        <input id="studentId" class="input" type="text" placeholder="ì˜ˆ: 7MB-01" />
      </div>

      <div class="field">
        <label>ì´ë¦„</label>
        <input id="studentName" class="input" type="text" placeholder="ì˜ˆ: í™ê¸¸ë™" />
      </div>

      <button id="studentLoginBtn" class="btn btn-secondary">
        í•™ìƒìœ¼ë¡œ ë¡œê·¸ì¸
      </button>

      <div class="hint">
        ì´ ì •ë³´ëŠ” ì´ ë¸Œë¼ìš°ì €(localStorage)ì—ë§Œ ì €ì¥ë¼ìš”.
      </div>

      <div id="studentStatus" class="status"></div>

      <div id="goIndexLink" class="small-link" style="display:none;">
        ì´ë¯¸ ë¡œê·¸ì¸ ìƒíƒœì˜ˆìš”. ë©”ì¸ìœ¼ë¡œ ì´ë™í•˜ê¸°
      </div>
    </div>

  </div>
</div>

<!-- Supabase JS -->
<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
<script>
  // ---- Supabase ì„¤ì • ----
  const SUPABASE_URL = "https://bpdisxjhhibrgfpvtlmv.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZGlzeGpoaGlicmdmcHZ0bG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTkxODQsImV4cCI6MjA3OTUzNTE4NH0.jDZ6BGirOPuWUnt4ykjhng4PLft2ZjBuYAFzApUnlYU";

  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ---- ê³µí†µ DOM ----
  const teacherEmailEl     = document.getElementById("teacherEmail");
  const teacherPasswordEl  = document.getElementById("teacherPassword");
  const teacherLoginBtn    = document.getElementById("teacherLoginBtn");
  const googleLoginBtn     = document.getElementById("googleLoginBtn");
  const teacherStatusEl    = document.getElementById("teacherStatus");

  const studentIdEl        = document.getElementById("studentId");
  const studentNameEl      = document.getElementById("studentName");
  const studentLoginBtn    = document.getElementById("studentLoginBtn");
  const studentStatusEl    = document.getElementById("studentStatus");
  const goIndexLinkEl      = document.getElementById("goIndexLink");

  const STUDENT_STORAGE_KEY = "blossom_student";
  const MAIN_PAGE = "index.html"; // ë¡œê·¸ì¸ í›„ ì´ë™í•  ë©”ì¸ í˜ì´ì§€

  function setTeacherStatus(msg, isError = false) {
    teacherStatusEl.textContent = msg || "";
    teacherStatusEl.classList.toggle("error", !!isError);
  }

  function setStudentStatus(msg, isError = false) {
    studentStatusEl.textContent = msg || "";
    studentStatusEl.classList.toggle("error", !!isError);
  }

  // ---- ì´ë¯¸ ë¡œê·¸ì¸ëœ ìƒíƒœë©´ ìë™ ì´ë™ ----
  async function redirectIfLoggedIn() {
    let teacherLoggedIn = false;

    try {
      const { data, error } = await client.auth.getUser();
      if (!error && data && data.user) {
        teacherLoggedIn = true;
      }
    } catch (e) {
      console.error("ì„ ìƒë‹˜ ë¡œê·¸ì¸ í™•ì¸ ì˜¤ë¥˜:", e);
    }

    let studentLoggedIn = false;
    try {
      const raw = localStorage.getItem(STUDENT_STORAGE_KEY);
      if (raw) {
        studentLoggedIn = true;
      }
    } catch (e) {
      console.error("í•™ìƒ ë¡œê·¸ì¸ í™•ì¸ ì˜¤ë¥˜:", e);
    }

    if (teacherLoggedIn || studentLoggedIn) {
      // ì´ë¯¸ ë‘˜ ì¤‘ í•˜ë‚˜ë¡œ ë¡œê·¸ì¸ëœ ìƒíƒœ â†’ ë°”ë¡œ ë©”ì¸ìœ¼ë¡œ
      window.location.href = MAIN_PAGE;
    }
  }

  // ì²˜ìŒ ë¡œë”© ì‹œ ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²´í¬
  redirectIfLoggedIn();

  // ---- ì„ ìƒë‹˜: ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸ ----
  teacherLoginBtn.onclick = async () => {
    const email = teacherEmailEl.value.trim();
    const password = teacherPasswordEl.value;

    if (!email || !password) {
      setTeacherStatus("ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.", true);
      return;
    }

    setTeacherStatus("ë¡œê·¸ì¸ ì¤‘ì…ë‹ˆë‹¤â€¦");
    teacherLoginBtn.disabled = true;

    const { data, error } = await client.auth.signInWithPassword({
      email,
      password,
    });

    teacherLoginBtn.disabled = false;

    if (error) {
      console.error("ì„ ìƒë‹˜ ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
      setTeacherStatus("ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆì–´ìš”. ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.", true);
      return;
    }

    setTeacherStatus("ë¡œê·¸ì¸ ì„±ê³µ! ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
    window.location.href = MAIN_PAGE;
  };

  // ---- ì„ ìƒë‹˜: êµ¬ê¸€ ë¡œê·¸ì¸ ----
  googleLoginBtn.onclick = async () => {
    setTeacherStatus("êµ¬ê¸€ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤â€¦");
    try {
      // í˜„ì¬ login.htmlì˜ í´ë” ê¸°ì¤€ìœ¼ë¡œ redirect
      const redirectTo =
        window.location.origin +
        window.location.pathname.replace(/[^/]+$/, "login.html");

      const { data, error } = await client.auth.signInWithOAuth({
        provider: "google",
        options: {
          redirectTo: redirectTo,
        },
      });

      if (error) {
        console.error("êµ¬ê¸€ ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
        setTeacherStatus("êµ¬ê¸€ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.", true);
        return;
      }

      // ì¼ë¶€ í™˜ê²½ì—ì„œëŠ” data.urlë¡œ ìˆ˜ë™ ì´ë™ í•„ìš”
      if (data && data.url) {
        window.location.href = data.url;
      }
    } catch (e) {
      console.error("êµ¬ê¸€ ë¡œê·¸ì¸ ì˜ˆì™¸:", e);
      setTeacherStatus("êµ¬ê¸€ ë¡œê·¸ì¸ ì¤‘ ì˜ˆì™¸ê°€ ë°œìƒí–ˆì–´ìš”.", true);
    }
  };

  // ---- OAuth ë¦¬ë‹¤ì´ë ‰íŠ¸ë¡œ login.htmlì— ëŒì•„ì™”ì„ ë•Œ: ìë™ìœ¼ë¡œ indexë¡œ ë³´ë‚´ê¸° ----
  (async function handleOAuthCallback() {
    try {
      const { data, error } = await client.auth.getUser();
      if (!error && data && data.user) {
        // ì´ë¯¸ ì„ ìƒë‹˜ìœ¼ë¡œ ë¡œê·¸ì¸ëœ ìƒíƒœ â†’ ë©”ì¸ìœ¼ë¡œ
        window.location.href = MAIN_PAGE;
      }
    } catch (e) {
      console.error("OAuth ì½œë°± ì²˜ë¦¬ ì˜¤ë¥˜:", e);
    }
  })();

  // ---- í•™ìƒ ë¡œê·¸ì¸ (localStorage) ----
  studentLoginBtn.onclick = () => {
    const sid = studentIdEl.value.trim();
    const name = studentNameEl.value.trim();

    if (!sid || !name) {
      setStudentStatus("í•™ìƒ ì•„ì´ë””ì™€ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.", true);
      return;
    }

    const payload = {
      login_id: sid,
      name: name,
      logged_at: new Date().toISOString(),
    };

    try {
      localStorage.setItem(STUDENT_STORAGE_KEY, JSON.stringify(payload));
    } catch (e) {
      console.error("í•™ìƒ ì •ë³´ ì €ì¥ ì˜¤ë¥˜:", e);
      setStudentStatus("ì´ ë¸Œë¼ìš°ì €ì— ì •ë³´ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ì–´ìš”.", true);
      return;
    }

    setStudentStatus("ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤! ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
    window.location.href = MAIN_PAGE;
  };

  // ---- ì´ë¯¸ í•™ìƒ ë¡œê·¸ì¸ ì •ë³´ê°€ ìˆì„ ë•Œ ì•ˆë‚´ ë§í¬ ë³´ì—¬ì£¼ê¸° ----
  (function checkStudentLocal() {
    try {
      const raw = localStorage.getItem(STUDENT_STORAGE_KEY);
      if (raw) {
        goIndexLinkEl.style.display = "block";
        goIndexLinkEl.onclick = () => {
          window.location.href = MAIN_PAGE;
        };
      }
    } catch (e) {
      // ë¬´ì‹œ
    }
  })();
</script>

</body>
</html>