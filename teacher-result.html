<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì„ ìƒë‹˜ ê´€ë¦¬ í˜ì´ì§€ - Blossom English</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* === [board.htmlì—ì„œ ê°€ì ¸ì˜¨ ê³µí†µ ìŠ¤íƒ€ì¼] === */
    :root {
      --blue: #00AEEF;
      --mint: #9FE6B8;
      --pink: #FF6FB5;
      --gray-bg: #e5e7eb;
      --gray-text: #374151;
      --pass-color: #10b981; /* í†µê³¼ ì´ˆë¡ìƒ‰ */
      --fail-color: #ef4444; /* ê³¼ë½ ë¹¨ê°„ìƒ‰ */
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Pretendard Variable", -apple-system, BlinkMacSystemFont,
        system-ui, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    body {
      background: #f4f6fb;
      padding: 30px 0 60px;
      color: #111827;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* --- íƒ€ì´í‹€ ì˜ì—­ --- */
    .title-big {
      font-size: 34px;
      font-weight: 900;
      margin-bottom: 6px;
      color: #111;
    }

    .subtitle {
      font-size: 16px;
      color: #6b7280;
      margin-bottom: 20px;
    }

    /* --- ìƒë‹¨ ë²„íŠ¼ ì¤„ --- */
    .top-bar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
      min-height: 40px;
    }

    .top-btns {
      display: flex;
      gap: 8px;
    }

    .pill-btn {
      padding: 8px 18px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      transition: opacity 0.2s;
      text-decoration: none;
      font-weight: 600;
    }
    .pill-btn:hover { opacity: 0.9; }

    .btn-home { background: #e5e7eb; color: #374151; }
    .btn-primary { background: #9fe6b8; color: #ffffff; }
    .btn-secondary { background: #00aeef; color: #ffffff; }
    .btn-manage { background: #ff6fb5; color: #ffffff; }

    /* === [ê´€ë¦¬ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼] === */
    .section-card { 
      background: white; 
      border-radius: 24px;
      padding: 30px; 
      margin-bottom: 24px; 
      box-shadow: 0 15px 32px rgba(15, 23, 42, 0.08); 
    }
    
    .card-title { 
      font-size: 20px; 
      font-weight: 800; 
      margin-bottom: 20px; 
      color: #374151;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ (ì•„ë˜ìª½ ê¸°ëŠ¥ìš©) */
    .table-wrap { overflow-x: auto; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 700px; }
    th { 
      background: #f9fafb; 
      color: #4b5563; 
      font-weight: 700; 
      text-align: left; 
      padding: 14px; 
      border-bottom: 2px solid #e5e7eb; 
    }
    td { 
      padding: 14px; 
      border-bottom: 1px solid #e5e7eb; 
      vertical-align: middle; 
      color: #374151;
    }
    tr:last-child td { border-bottom: none; }

    /* ì»¨íŠ¸ë¡¤ëŸ¬ (ê²€ìƒ‰ì°½ ë“±) */
    .controls { display: flex; gap: 8px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
    
    .input-ui { 
      padding: 10px 14px; 
      border: 1px solid #d1d5db; 
      border-radius: 12px; 
      font-size: 14px; 
      height: 42px; 
      outline: none; 
      background: #fff;
      transition: border-color 0.2s;
    }
    .input-ui:focus { border-color: var(--blue); }

    .btn-search { 
      background: var(--blue); color: white; border: none; 
      padding: 0 24px; border-radius: 12px; font-weight: 700; 
      cursor: pointer; height: 42px; font-size: 14px;
    }
    .btn-search:hover { opacity: 0.9; }

    .btn-search-pink { 
      background: var(--pink); color: white; border: none; 
      padding: 0 24px; border-radius: 12px; font-weight: 700; 
      cursor: pointer; height: 42px; font-size: 14px;
    }
    .btn-search-pink:hover { opacity: 0.9; }

    #studentNameInput, #studentNameInput2 { width: 180px; }

    /* ë±ƒì§€ ìŠ¤íƒ€ì¼ */
    .badge { padding: 4px 10px; border-radius: 99px; font-size: 12px; font-weight: 700; display: inline-block; }
    .badge-done { background: #dcfce7; color: #166534; } /* ì™„ë£Œ */
    .badge-yet { background: #f3f4f6; color: #9ca3af; } /* ë¯¸ì œì¶œ/ë¯¸ì™„ */
    .badge-fail { background: #fee2e2; color: #991b1b; } /* ê³¼ë½/ì§„í–‰ì¤‘ */
    .badge-new { background: #fee2e2; color: #991b1b; }

    .assign-select { padding: 6px 10px; border-radius: 8px; border: 1px solid #d1d5db; font-size: 13px; }
    .btn-save { padding: 6px 12px; background: var(--mint); color: #064e3b; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 12px; margin-left: 4px; }
    .btn-save:hover { opacity: 0.9; }

    /* =========================================
       [NEW] ìˆ™ì œ ê²°ê³¼ ì•„ì½”ë””ì–¸ ì¹´ë“œ ìŠ¤íƒ€ì¼
       ========================================= */
    .hw-list-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .hw-card {
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      overflow: hidden;
      background: #fff;
      transition: box-shadow 0.2s;
    }
    .hw-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    /* ì¹´ë“œ í—¤ë” (í´ë¦­ ì‹œ ì—´ë¦¼) */
    .hw-header {
      padding: 16px 20px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }
    .hw-header:hover { background-color: #f9fafb; }
    
    /* í—¤ë” ì™¼ìª½: í•™ìƒ ì´ë¦„, ë‹¨ì› */
    .hw-info { display: flex; align-items: center; gap: 12px; }
    .hw-student { font-weight: 800; font-size: 16px; color: #111; width: 80px; }
    .hw-unit { 
      font-weight: 700; color: var(--blue); font-size: 15px; 
      background: #e0f2fe; padding: 4px 10px; border-radius: 6px;
    }
    
    /* í—¤ë” ì˜¤ë¥¸ìª½: ìƒíƒœ ìš”ì•½ */
    .hw-summary { display: flex; align-items: center; gap: 15px; font-size: 14px; color: #6b7280; }
    .hw-time { font-size: 13px; color: #9ca3af; }

    /* ìƒì„¸ ë‚´ìš© (ê¸°ë³¸ ìˆ¨ê¹€) */
    .hw-body {
      display: none; /* JSë¡œ í† ê¸€ */
      background: #f8fafc;
      border-top: 1px solid #e5e7eb;
      padding: 10px 20px 20px 20px;
    }
    .hw-body.open { display: block; }

    /* ìƒì„¸ ë‚´ìš© ì•ˆì˜ ê° ì¤„ */
    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #e2e8f0;
      font-size: 14px;
    }
    .detail-row:last-child { border-bottom: none; }
    
    .detail-label { font-weight: 600; color: #4b5563; display: flex; align-items: center; gap: 6px; }
    .detail-score { font-weight: 700; }
    .score-pass { color: var(--pass-color); }
    .score-fail { color: var(--fail-color); }
    .score-none { color: #d1d5db; }
  </style>
</head>
<body>
<div class="page">
  <div class="title-big">ì„ ìƒë‹˜ ê´€ë¦¬ í˜ì´ì§€</div>
  <div class="subtitle">
    ë‚ ì§œë³„ ìˆ™ì œ ê²€ì‚¬, ë°˜ë³„ í•™ìƒ ì¡°íšŒ ë° ì‹ ì…ìƒ ë°˜ ë°°ì •ì„ í•  ìˆ˜ ìˆì–´ìš”.
  </div>

  <div class="top-bar">
    <div class="top-btns" style="margin-left: auto;"> 
      <button class="pill-btn btn-home" onclick="location.href='index.html'">ğŸ  í™ˆ</button>
      <button class="pill-btn btn-primary" onclick="location.href='board.html'">âœï¸ ê¸€ì“°ê¸°</button>
      <button class="pill-btn btn-secondary" onclick="location.href='homework-teacher.html'">ğŸ“š ì˜¨ë¼ì¸ ìˆ™ì œ</button>
      <button class="pill-btn btn-manage" onclick="location.reload()">ğŸ›  ê´€ë¦¬</button>
    </div>
  </div>

  <div class="section-card">
    <div class="card-title">ğŸ“… ë‚ ì§œë³„ ìˆ™ì œ ê²€ì‚¬</div>
    <div class="controls">
      <select id="classSelect" class="input-ui">
        <option value="">ë°˜ ì„ íƒ</option>
      </select>

      <input
        type="text"
        id="studentNameInput"
        class="input-ui"
        placeholder="í•™ìƒ ì´ë¦„ (ì„ íƒ)"
      >

      <input type="date" id="dateInput" class="input-ui">

      <button class="btn-search" onclick="loadHomework()">ì¡°íšŒí•˜ê¸°</button>
    </div>

    <div id="homeworkResultContainer" class="hw-list-container">
      <div style="text-align:center; padding: 40px; color:#9ca3af;">
        ë°˜ê³¼ ë‚ ì§œë¥¼ ì„ íƒí•˜ê³  [ì¡°íšŒí•˜ê¸°]ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.
      </div>
    </div>
  </div>

  <div class="section-card">
    <div class="card-title">ğŸ‘¥ ë°˜ë³„ í•™ìƒ ë³´ê¸°</div>
    <div class="controls">
      <select id="classSelect2" class="input-ui">
        <option value="">ë°˜ ì„ íƒ</option>
      </select>
      <input type="text" id="studentNameInput2" class="input-ui" placeholder="í•™ìƒ ì´ë¦„ (ì„ íƒ)">
      <button class="btn-search-pink" onclick="loadStudentsByClass()">ì¡°íšŒí•˜ê¸°</button>
    </div>
    <div class="table-wrap">
      <table id="studentsTable">
        <thead>
          <tr>
            <th width="14%">ì´ë¦„</th>
            <th width="16%">ì•„ì´ë””</th>
            <th width="18%">ì—°ë½ì²˜</th>
            <th width="14%">ë°˜</th>
            <th width="14%">ê°€ì…ì¼</th>
            <th width="14%">ë°˜ ë³€ê²½</th>
            <th width="10%">ì €ì¥</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="7" style="text-align:center; padding:30px; color:#888;">ë°˜ ë˜ëŠ” ì´ë¦„ìœ¼ë¡œ í•™ìƒì„ ì¡°íšŒí•  ìˆ˜ ìˆì–´ìš”.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="section-card">
    <div class="card-title">ğŸŒ± ì‹ ì…ìƒ ë°˜ ë°°ì •í•˜ê¸°</div>
    <div class="table-wrap">
      <table id="newStudentTable">
        <thead>
          <tr><th>ì´ë¦„</th><th>ì•„ì´ë””</th><th>ì—°ë½ì²˜</th><th>ìƒíƒœ</th><th>ë°˜ ì„ íƒ</th><th>ì €ì¥</th></tr>
        </thead>
        <tbody>
          <tr><td colspan="6" style="text-align:center; padding:30px; color:#888;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // 1. Supabase ì„¤ì •
  const SUPABASE_URL = "https://bpdisxjhhibrgfpvtlmv.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZGlzeGpoaGlicmdmcHZ0bG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTkxODQsImV4cCI6MjA3OTUzNTE4NH0.jDZ6BGirOPuWUnt4ykjhng4PLft2ZjBuYAFzApUnlYU";

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let classList = [];
  let lastStudentsQuery = { classId: "", nameFilter: "" };

  document.addEventListener("DOMContentLoaded", async () => {
    // ì˜¤ëŠ˜ ë‚ ì§œ ì„¸íŒ…
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    document.getElementById("dateInput").value = `${yyyy}-${mm}-${dd}`;

    await loadClasses(); 
    loadNewStudents();    
  });

  // --- [1] ë°˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ---
  async function loadClasses() {
    const { data, error } = await supabaseClient.from('classes').select('*').order('name');

    const select1 = document.getElementById("classSelect");
    const select2 = document.getElementById("classSelect2");
    if (select1) select1.innerHTML = '<option value="">ë°˜ ì„ íƒ</option>';
    if (select2) select2.innerHTML = '<option value="">ë°˜ ì„ íƒ</option>';

    if (error) {
      console.error("ë°˜ ëª©ë¡ ì—ëŸ¬:", error);
      return;
    }
    classList = data;
    data.forEach(cls => {
      const opt1 = document.createElement("option");
      opt1.value = cls.id;
      opt1.textContent = cls.name;
      if (select1) select1.appendChild(opt1);

      const opt2 = document.createElement("option");
      opt2.value = cls.id;
      opt2.textContent = cls.name;
      if (select2) select2.appendChild(opt2);
    });
  }

  // ============================================================
  // [ìˆ˜ì •ë¨] ìˆ™ì œ ê²°ê³¼ ì¡°íšŒ í•¨ìˆ˜
  // ============================================================
  // ============================================================
  // [ìˆ˜ì •ë¨] ìˆ™ì œ ê²°ê³¼ ì¡°íšŒ í•¨ìˆ˜ (í•™ìƒ ë“±ë¡ ìˆ™ì œ í¬í•¨)
  // ============================================================
  // ============================================================
  // [ìˆ˜ì • ì™„ë£Œ] ìˆ™ì œ ê²°ê³¼ ì¡°íšŒ í•¨ìˆ˜ (ì„¤ì •ê°’ tasks ë°˜ì˜)
  // ============================================================
  // ============================================================
  // [ìµœì¢… ìˆ˜ì •] í•™ìƒë³„ ê°œë³„ ìˆ™ì œ + ê³µí†µ ìˆ™ì œ ë¶„ë¦¬ ì¡°íšŒ ë¡œì§
  // ============================================================
  async function loadHomework() {
    const classId = document.getElementById("classSelect").value;
    const dateVal = document.getElementById("dateInput").value;
    const nameFilter = document.getElementById("studentNameInput").value.trim();
    const container = document.getElementById("homeworkResultContainer");

    if (!classId) return alert("ë°˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    if (!dateVal) return alert("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

    container.innerHTML = `<div style="text-align:center; padding:30px;">ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</div>`;

    try {
      // 1. í•™ìƒ ëª…ë‹¨ ê°€ì ¸ì˜¤ê¸°
      let q = supabaseClient.from('students').select('id, name, login_id').eq('class_id', classId).order('name');
      if (nameFilter) q = q.ilike('name', `%${nameFilter}%`);
      const { data: students } = await q;

      if (!students || students.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding:40px; color:#888;">ì¡°íšŒëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }
      const loginIds = students.map(s => s.login_id);

      // 2. ìˆ™ì œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì„ ìƒë‹˜ ê³µí†µ + í•™ìƒ ê°œë³„)
      const [teacherVocab, teacherSentence, studentHW] = await Promise.all([
        supabaseClient.from('vocab_homework').select('*').eq('class_id', classId).eq('due_date', dateVal),
        supabaseClient.from('sentence_homework').select('*').eq('class_id', classId).eq('due_date', dateVal),
        // í•™ìƒ ìˆ™ì œëŠ” 'ëˆ„ê°€(student_login_id)' ëƒˆëŠ”ì§€ë„ ì¤‘ìš”í•¨
        supabaseClient.from('student_homework').select('*').in('student_login_id', loginIds).eq('due_date', dateVal)
      ]);

      // 3. [í•µì‹¬] ê³µí†µ ìˆ™ì œì™€ ê°œë³„ ìˆ™ì œ ì¡±ë³´ ë§Œë“¤ê¸°
      
      // A. ì„ ìƒë‹˜ ê³µí†µ ìˆ™ì œ (ëª¨ë“  í•™ìƒì—ê²Œ ì ìš©)
      const commonUnitsMap = {}; 
      const parseCommon = (list, type) => {
        (list || []).forEach(row => {
          // ì„¤ì •ê°’(tasks) íŒŒì‹± ë¡œì§ (ì´ì „ê³¼ ë™ì¼)
          let req = row.tasks;
          if (!req && type === 'vocab') {
             if (row.count_meaning !== undefined) {
               req = { meaning: row.count_meaning, english: row.count_english, listening: row.count_listening, sentence: row.count_sentence };
             } else {
               req = { meaning: 1, english: 1, listening: 1, sentence: 1 };
             }
          }
          if (!req && type !== 'vocab') req = null; 

          String(row.set_numbers).split(',').forEach(s => {
            const k = s.trim().replace(/\s+/g, '');
            if(k) commonUnitsMap[k] = req;
          });
        });
      };
      parseCommon(teacherVocab.data, 'vocab');
      parseCommon(teacherSentence.data, 'sentence');

      // B. í•™ìƒ ê°œë³„ ìˆ™ì œ (í•´ë‹¹ í•™ìƒì—ê²Œë§Œ ì ìš©)
      const personalUnitsMap = {}; // { 'joy1003': {'3-1': req, ...}, ... }
      
      (studentHW.data || []).forEach(row => {
        const sId = row.student_login_id;
        if (!personalUnitsMap[sId]) personalUnitsMap[sId] = {};

        // í•™ìƒ ìˆ™ì œëŠ” tasksê°€ í™•ì‹¤íˆ ìˆê±°ë‚˜ ê¸°ë³¸ê°’ì„ ì”€
        let req = row.tasks || { meaning: 1, english: 1, listening: 1, sentence: 1 };

        String(row.set_numbers).split(',').forEach(s => {
          const k = s.trim().replace(/\s+/g, '');
          if(k) personalUnitsMap[sId][k] = req;
        });
      });

      // 4. ê²°ê³¼ ì¡°íšŒë¥¼ ìœ„í•´ 'í•„ìš”í•œ ëª¨ë“  ë‹¨ì›'ì˜ í•©ì§‘í•© êµ¬í•˜ê¸°
      const allTargetUnitsSet = new Set(Object.keys(commonUnitsMap));
      Object.values(personalUnitsMap).forEach(uMap => {
        Object.keys(uMap).forEach(k => allTargetUnitsSet.add(k));
      });
      const allTargetUnits = [...allTargetUnitsSet];

      if (allTargetUnits.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding:40px; color:#888;">ğŸ“… ${dateVal} ë§ˆê°ì¸ ìˆ™ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      // 5. ê²°ê³¼ ë°ì´í„° í•œ ë²ˆì— ê°€ì ¸ì˜¤ê¸° (íš¨ìœ¨ì„±)
      const { data: vResults } = await supabaseClient.from('vocab_results').select('*').in('student_login_id', loginIds).in('unit_key', allTargetUnits);
      const { data: sResults } = await supabaseClient.from('sentence_results').select('*').in('student_login_id', loginIds).in('unit_key', allTargetUnits);
      const allResults = [...(vResults||[]), ...(sResults||[])];

      // 6. ë Œë”ë§ (í•™ìƒë³„ë¡œ 'ìê¸° ìˆ™ì œ'ë§Œ ì¶”ë ¤ì„œ ì¹´ë“œ ìƒì„±)
      container.innerHTML = ""; 

      students.forEach(student => {
        // â˜… [ì—¬ê¸°ê°€ í•µì‹¬] ì´ í•™ìƒì´ í•´ì•¼ í•  ìˆ™ì œ = ê³µí†µ ìˆ™ì œ + ë‚´ ê°œë³„ ìˆ™ì œ
        // (Object.assignì„ ì¨ì„œ ë‚´ ê°œë³„ ì„¤ì •ì´ ìˆë‹¤ë©´ ê³µí†µ ì„¤ì •ë³´ë‹¤ ìš°ì„ ìˆœìœ„ë¥¼ ê°–ê²Œ ë³‘í•©)
        const myHomeworkMap = { ...commonUnitsMap };
        const myPersonal = personalUnitsMap[student.login_id] || {};
        Object.assign(myHomeworkMap, myPersonal);

        const myUnits = Object.keys(myHomeworkMap).sort();

        // ìˆ™ì œê°€ ì•„ì˜ˆ ì—†ëŠ” í•™ìƒì€ ê±´ë„ˆë›°ê±°ë‚˜ 'ìˆ™ì œ ì—†ìŒ' í‘œì‹œ (ì—¬ê¸°ì„  ì¹´ë“œ ìƒì„± X)
        if (myUnits.length === 0) return;

        myUnits.forEach(unit => {
          const req = myHomeworkMap[unit] || { meaning: 1, english: 1, listening: 1, sentence: 1 };
          
          // ë‚´ ê²°ê³¼ë§Œ í•„í„°ë§
          const myUnitResults = allResults.filter(r => r.student_login_id === student.login_id && r.unit_key === unit);
          
          const modes = ['meaning', 'english', 'listening', 'sentence'];
          const modeLabels = { meaning: 'ëœ» ì°¾ê¸°', english: 'ì˜ì–´ ì°¾ê¸°', listening: 'ë“£ê³  ì°¾ê¸°', sentence: 'ë¬¸ì¥ ë¹ˆì¹¸' };
          
          let lastSubmitTime = null;
          let activeModesCount = 0;
          let passedModesCount = 0;
          let isSubmitted = false;
          let detailRowsHTML = "";

          modes.forEach(mode => {
            const requiredCount = Number(req[mode] || 0);
            if (requiredCount > 0) activeModesCount++;

            const myModeResults = myUnitResults.filter(r => r.mode === mode);
            
            // í†µê³¼ íšŸìˆ˜ ê³„ì‚° (90ì  ì´ìƒ)
            const passCount = myModeResults.filter(r => {
               const score = r.total_count ? Math.round((r.correct_count / r.total_count)*100) : 0;
               return score >= 90;
            }).length;

            if (myModeResults.length > 0) {
              isSubmitted = true;
              myModeResults.forEach(r => {
                const t = new Date(r.submitted_at);
                if (!lastSubmitTime || t > lastSubmitTime) lastSubmitTime = t;
              });
            }

            const isModePassed = (requiredCount > 0 && passCount >= requiredCount);
            if (isModePassed) passedModesCount++;

            // ìƒì„¸ HTML
            let scoreHTML = "";
            if (requiredCount === 0) {
               scoreHTML = `<span class="score-none">-</span>`; 
            } else {
               const colorClass = isModePassed ? 'score-pass' : (passCount > 0 ? 'score-fail' : 'score-none');
               const statusText = isModePassed ? 'Completed' : 'Progress';
               scoreHTML = `<span class="${colorClass}">${passCount} / ${requiredCount}íšŒ (${statusText})</span>`;
            }

            detailRowsHTML += `
              <div class="detail-row">
                <div class="detail-label">ğŸ”¹ ${modeLabels[mode]}</div>
                <div class="detail-score">${scoreHTML}</div>
              </div>
            `;
          });

          // ë±ƒì§€ ìƒíƒœ
          let statusBadge = "";
          const finalTotal = activeModesCount === 0 ? 1 : activeModesCount;

          if (!isSubmitted) {
            statusBadge = `<span class="badge badge-yet">ë¯¸ì œì¶œ</span>`;
          } else if (passedModesCount >= activeModesCount && activeModesCount > 0) {
            statusBadge = `<span class="badge badge-done">ì™„ë£Œ (All Pass)</span>`;
          } else {
            statusBadge = `<span class="badge badge-fail">ì§„í–‰ì¤‘ (${passedModesCount}/${finalTotal})</span>`;
          }

          // ì‹œê°„ ë° ì§€ê° ì²´í¬
          let timeStr = "-";
          if (lastSubmitTime) {
            const y = lastSubmitTime.getFullYear();
            const m = String(lastSubmitTime.getMonth()+1).padStart(2,'0');
            const d = String(lastSubmitTime.getDate()).padStart(2,'0');
            const h = String(lastSubmitTime.getHours()).padStart(2,'0');
            const min = String(lastSubmitTime.getMinutes()).padStart(2,'0');
            timeStr = `${y}-${m}-${d} ${h}:${min}`;
            
            const due = new Date(dateVal);
            due.setHours(23, 59, 59);
            if (lastSubmitTime > due) timeStr += " <span style='color:red'>(ì§€ê°)</span>";
          }

          const detailId = `detail-${student.id}-${unit}`;
          const cardHTML = `
            <div class="hw-card">
              <div class="hw-header" onclick="toggleDetail('${detailId}')">
                <div class="hw-info">
                  <span class="hw-student">${student.name}</span>
                  <span class="hw-unit">Unit ${unit}</span>
                </div>
                <div class="hw-summary">
                  ${statusBadge}
                  <span class="hw-time">${timeStr}</span>
                  <span style="font-size:12px;">â–¼</span>
                </div>
              </div>
              <div id="${detailId}" class="hw-body">
                ${detailRowsHTML}
              </div>
            </div>
          `;

          container.innerHTML += cardHTML;
        });
      });

    } catch (e) {
      console.error(e);
      container.innerHTML = `<div style="text-align:center; padding:30px; color:red;">ì˜¤ë¥˜ ë°œìƒ: ${e.message}</div>`;
    }
  }
  // ì•„ì½”ë””ì–¸ í† ê¸€ í•¨ìˆ˜
  function toggleDetail(id) {
    const el = document.getElementById(id);
    if (el) el.classList.toggle('open');
  }


  // --- [ì•„ë˜ëŠ” ê¸°ì¡´ ì½”ë“œ ìœ ì§€] ---
  // --- [2] ì‹ ì…ìƒ(ë°˜ ì—†ëŠ” í•™ìƒ) ê°€ì ¸ì˜¤ê¸° ---
  async function loadNewStudents() {
    const tbody = document.querySelector("#newStudentTable tbody");
    const { data, error } = await supabaseClient
      .from('students').select('*').is('class_id', null).order('created_at', { ascending: false });

    if (error) return;
    tbody.innerHTML = "";
    if (!data || data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:30px; color:#999;">ì‹ ê·œ í•™ìƒ(ë¯¸ë°°ì •)ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
      return;
    }
    data.forEach(student => {
      const tr = document.createElement("tr");
      let options = '<option value="">ì„ íƒ</option>';
      classList.forEach(c => { options += `<option value="${c.id}">${c.name}</option>`; });
      tr.innerHTML = `
        <td style="font-weight:bold;">${student.name}</td>
        <td>${student.login_id}</td>
        <td>${student.parent_phone || '-'}</td>
        <td><span class="badge badge-new">ë¯¸ë°°ì •</span></td>
        <td><select class="assign-select" id="sel-${student.id}">${options}</select></td>
        <td><button class="btn-save" onclick="saveClass('${student.id}')">ì €ì¥</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  // --- [3] ë°˜ ë°°ì • ì €ì¥ ---
  async function saveClass(studentId) {
    const sel = document.getElementById(`sel-${studentId}`);
    if (!sel.value) { alert("ë°˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
    const { error } = await supabaseClient.from('students').update({ class_id: sel.value }).eq('id', studentId);
    if (error) { alert("ì €ì¥ ì‹¤íŒ¨"); return; }
    alert("ë°˜ ë°°ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    loadNewStudents();
    if (lastStudentsQuery.classId) loadStudentsByClass(true);
  }

  // --- [4] ë°˜ë³„ í•™ìƒ ì¡°íšŒ ---
  async function loadStudentsByClass(isRerun = false) {
    const classId = document.getElementById("classSelect2").value;
    const nameFilter = document.getElementById("studentNameInput2").value.trim();
    const tbody = document.querySelector("#studentsTable tbody");

    if (!classId && !nameFilter) { alert("ë°˜ ë˜ëŠ” í•™ìƒ ì´ë¦„ ì¤‘ í•˜ë‚˜ëŠ” ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
    if (!isRerun) lastStudentsQuery = { classId, nameFilter };
    const activeClassId = isRerun ? lastStudentsQuery.classId : classId;
    const activeNameFilter = isRerun ? lastStudentsQuery.nameFilter : nameFilter;

    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:30px;">ì¡°íšŒ ì¤‘...</td></tr>`;
    try {
      let query = supabaseClient.from('students').select('id, name, login_id, parent_phone, class_id, created_at').order('name');
      if (activeClassId) query = query.eq('class_id', activeClassId);
      if (activeNameFilter) query = query.ilike('name', `%${activeNameFilter}%`);
      const { data: students, error } = await query;
      
      tbody.innerHTML = "";
      if (!students || students.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:30px;">ì¡°ê±´ì— ë§ëŠ” í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
        return;
      }
      const classNameById = new Map(classList.map(c => [c.id, c.name]));
      students.forEach(s => {
        const tr = document.createElement("tr");
        const className = s.class_id ? (classNameById.get(s.class_id) || s.class_id) : 'ë¯¸ë°°ì •';
        const joinDate = s.created_at ? new Date(s.created_at).toLocaleDateString('ko-KR') : '-';
        let options = `<option value="">ë¯¸ë°°ì •</option>`;
        classList.forEach(c => {
          const selected = s.class_id === c.id ? "selected" : "";
          options += `<option value="${c.id}" ${selected}>${c.name}</option>`;
        });
        tr.innerHTML = `
          <td style="font-weight:700;">${s.name}</td>
          <td>${s.login_id || '-'}</td>
          <td>${s.parent_phone || '-'}</td>
          <td>${className}</td>
          <td>${joinDate}</td>
          <td><select class="assign-select" id="cls-${s.id}">${options}</select></td>
          <td><button class="btn-save" onclick="updateStudentClass('${s.id}')">ì €ì¥</button></td>
        `;
        tbody.appendChild(tr);
      });
    } catch (err) { tbody.innerHTML = `<tr><td colspan="7">ì˜¤ë¥˜</td></tr>`; }
  }

  async function updateStudentClass(studentId) {
    const sel = document.getElementById(`cls-${studentId}`);
    if (!sel) return;
    const { error } = await supabaseClient.from('students').update({ class_id: sel.value || null }).eq('id', studentId);
    if (error) { alert("ì €ì¥ ì‹¤íŒ¨"); return; }
    alert("ë°˜ ë³€ê²½ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    loadNewStudents();
    loadStudentsByClass(true);
  }
</script>
</body>
</html>



