<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì„ ìƒë‹˜ ê´€ë¦¬ í˜ì´ì§€ - Blossom English</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* === ìŠ¤íƒ€ì¼ === */
    :root { --pink: #FF6FB5; --mint: #9AD7A0; --blue: #00AEEF; --bg: #f3f4f6; }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Pretendard Variable", sans-serif; }
    body { background: var(--bg); padding: 40px 20px; color: #111827; }
    .page { max-width: 1000px; margin: 0 auto; }
    
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .brand { font-size: 24px; font-weight: 800; color: #1f2937; }

    /* ìƒë‹¨ ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .top-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .link-btn {
      border-radius: 999px;
      border: none;
      padding: 8px 18px;
      font-size: 14px;
      cursor: pointer;
      background: var(--blue);
      color: #ffffff;
      white-space: nowrap;
    }
    #home-btn {
      background: var(--mint);
      color: #ffffff;
    }
    #back-btn {
      background: #e5e7eb;
      color: #374151;
    }
    #back-btn:hover {
      background: #d1d5db;
    }
    
    .section-card { background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .card-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #f3f4f6; color: #374151; }

    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 700px; }
    th { background: #f9fafb; color: #4b5563; font-weight: 600; text-align: left; padding: 12px; border-bottom: 1px solid #e5e7eb; }
    td { padding: 12px; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
    
    /* ì»¨íŠ¸ë¡¤ëŸ¬ */
    .controls { display: flex; gap: 8px; margin-bottom: 16px; align-items: center; flex-wrap: wrap; }
    .input-ui { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; height: 38px; outline: none; }
    .btn-search { background: var(--blue); color: white; border: none; padding: 0 20px; border-radius: 6px; font-weight: 600; cursor: pointer; height: 38px; }
    .btn-search:hover { filter: brightness(0.9); }

    /* âœ… í•™ìƒ ì´ë¦„ ì…ë ¥ì¹¸ ë„ˆë¹„ ì¡°ì • */
    #studentNameInput {
      width: 160px; /* í•„ìš”í•˜ë©´ 140~200px ì•ˆì—ì„œ ì¡°ì • ê°€ëŠ¥ */
    }
    
    /* ë±ƒì§€ */
    .badge { padding: 4px 8px; border-radius: 99px; font-size: 11px; font-weight: 700; display: inline-block; }
    .badge-done { background: #dcfce7; color: #166534; }
    .badge-yet { background: #f3f4f6; color: #9ca3af; }
    .badge-new { background: #fee2e2; color: #991b1b; }
    
    .assign-select { padding: 6px; border-radius: 4px; border: 1px solid #d1d5db; }
    .btn-save { padding: 6px 10px; background: var(--mint); color: #064e3b; border: none; border-radius: 4px; cursor: pointer; font-weight: 700; font-size: 12px; margin-left: 4px; }
  </style>
</head>
<body>
<div class="page">
  <div class="header">
    <div class="brand">ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ ê´€ë¦¬ í˜ì´ì§€</div>
    <div class="top-actions">
      <button class="link-btn" id="back-btn" type="button" onclick="history.back()">ë’¤ë¡œ</button>
      <button class="link-btn" id="home-btn" type="button" onclick="window.location.href='index.html'">Home</button>
    </div>
  </div>

  <!-- âœ… 1. ë‚ ì§œë³„ ìˆ™ì œ ê²€ì‚¬ ì¹´ë“œ -->
  <div class="section-card">
    <div class="card-title">ğŸ“… ë‚ ì§œë³„ ìˆ™ì œ ê²€ì‚¬</div>
    <div class="controls">
      <select id="classSelect" class="input-ui">
        <option value="">ë°˜ ì„ íƒ</option>
      </select>

      <!-- âœ… í•™ìƒ ì´ë¦„(ì„ íƒ) -->
      <input 
        type="text" 
        id="studentNameInput" 
        class="input-ui" 
        placeholder="í•™ìƒ ì´ë¦„ (ì„ íƒ)"
      >

      <input type="date" id="dateInput" class="input-ui">
      
      <button class="btn-search" onclick="loadHomework()">ì¡°íšŒí•˜ê¸°</button>
    </div>

    <div class="table-wrap">
      <table id="homeworkTable">
        <thead>
          <tr>
            <th width="15%">ì´ë¦„</th>
            <th width="15%">ìƒíƒœ</th>
            <th width="20%">ì ìˆ˜ / ëª¨ë“œ</th>
            <th width="20%">ë‹¨ì›(Unit)</th>
            <th width="30%">ì œì¶œ ì‹œê°„</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="5" style="text-align:center; padding:20px;">ë°˜ ë˜ëŠ” ì´ë¦„, ë‚ ì§œë¥¼ ì„ íƒí•˜ê³  [ì¡°íšŒí•˜ê¸°]ë¥¼ ëˆ„ë¥´ì„¸ìš”.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- âœ… 2. ì‹ ì…ìƒ ë°˜ ë°°ì •í•˜ê¸° ì¹´ë“œ -->
  <div class="section-card">
    <div class="card-title">ğŸŒ± ì‹ ì…ìƒ ë°˜ ë°°ì •í•˜ê¸°</div>
    <div class="table-wrap">
      <table id="newStudentTable">
        <thead>
          <tr><th>ì´ë¦„</th><th>ì•„ì´ë””</th><th>ì—°ë½ì²˜</th><th>ìƒíƒœ</th><th>ë°˜ ì„ íƒ</th><th>ì €ì¥</th></tr>
        </thead>
        <tbody>
          <tr><td colspan="6" style="text-align:center; padding:20px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // 1. Supabase ì„¤ì •
  const SUPABASE_URL = "https://bpdisxjhhibrgfpvtlmv.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZGlzeGpoaGlicmdmcHZ0bG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTkxODQsImV4cCI6MjA3OTUzNTE4NH0.jDZ6BGirOPuWUnt4ykjhng4PLft2ZjBuYAFzApUnlYU";
  
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let classList = [];

  // í˜ì´ì§€ ì‹œì‘ ì‹œ ìë™ ì‹¤í–‰
  document.addEventListener("DOMContentLoaded", async () => {
    // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¸íŒ… (YYYY-MM-DD)
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    document.getElementById("dateInput").value = `${yyyy}-${mm}-${dd}`;
    
    await loadClasses(); // ë°˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    loadNewStudents();   // ì‹ ì…ìƒ ê°€ì ¸ì˜¤ê¸°
  });

  // --- [1] ë°˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ---
  async function loadClasses() {
    const { data, error } = await supabaseClient.from('classes').select('*').order('name');
    
    const select = document.getElementById("classSelect");
    select.innerHTML = '<option value="">ë°˜ ì„ íƒ</option>';

    if (error) { 
      console.error("ë°˜ ëª©ë¡ ì—ëŸ¬:", error);
      return; 
    }
    
    classList = data;
    
    data.forEach(cls => {
      const opt = document.createElement("option");
      opt.value = cls.id;
      opt.textContent = cls.name;
      select.appendChild(opt);
    });
  }

  // --- [2] ì‹ ì…ìƒ(ë°˜ ì—†ëŠ” í•™ìƒ) ê°€ì ¸ì˜¤ê¸° ---
  async function loadNewStudents() {
    const tbody = document.querySelector("#newStudentTable tbody");
    
    const { data, error } = await supabaseClient
      .from('students')
      .select('*')
      .is('class_id', null)
      .order('created_at', { ascending: false }); // ìµœì‹  ê°€ì… ìˆœ

    if (error) { 
      console.error(error); 
      return; 
    }

    tbody.innerHTML = "";
    if (!data || data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px; color:#999;">ì‹ ê·œ í•™ìƒ(ë¯¸ë°°ì •)ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
      return;
    }

    data.forEach(student => {
      const tr = document.createElement("tr");
      
      let options = '<option value="">ì„ íƒ</option>';
      classList.forEach(c => {
        options += `<option value="${c.id}">${c.name}</option>`;
      });

      tr.innerHTML = `
        <td style="font-weight:bold;">${student.name}</td>
        <td>${student.login_id}</td>
        <td>${student.parent_phone || '-'}</td>
        <td><span class="badge badge-new">ë¯¸ë°°ì •</span></td>
        <td><select class="assign-select" id="sel-${student.id}">${options}</select></td>
        <td><button class="btn-save" onclick="saveClass('${student.id}')">ì €ì¥</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  // --- [3] ë°˜ ë°°ì • ì €ì¥ ---
  async function saveClass(studentId) {
    const sel = document.getElementById(`sel-${studentId}`);
    if (!sel.value) { alert("ë°˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

    const { error } = await supabaseClient
      .from('students')
      .update({ class_id: sel.value })
      .eq('id', studentId);

    if (error) { 
      alert("ì €ì¥ ì‹¤íŒ¨: " + error.message); 
      return; 
    }
    
    alert("ë°˜ ë°°ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    loadNewStudents(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
  }

  // --- [4] ìˆ™ì œ ê²°ê³¼ ì¡°íšŒ (ë°˜/ì´ë¦„ ì¤‘ í•˜ë‚˜ë§Œ ì„ íƒí•´ë„ OK) ---
  async function loadHomework() {
    const classId = document.getElementById("classSelect").value;
    const dateVal = document.getElementById("dateInput").value;
    const nameFilter = document.getElementById("studentNameInput").value.trim();
    const tbody = document.querySelector("#homeworkTable tbody");

    // âœ… ë°˜/ì´ë¦„ ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ìˆì–´ë„ OK, ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ê²½ê³ 
    if (!classId && !nameFilter) {
      alert("ë°˜ ë˜ëŠ” í•™ìƒ ì´ë¦„ ì¤‘ í•˜ë‚˜ëŠ” ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    if (!dateVal) { 
      alert("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); 
      return; 
    }

    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px;">ì¡°íšŒ ì¤‘...</td></tr>`;

    try {
      // 1. í•™ìƒ ëª…ë‹¨ ì¡°íšŒ (ì¡°ê±´ ì¡°í•©)
      let query = supabaseClient
        .from('students')
        .select('id, name, login_id')
        .order('name');

      if (classId) {
        query = query.eq('class_id', classId);
      }
      if (nameFilter) {
        // ë¶€ë¶„ ì¼ì¹˜ ê²€ìƒ‰
        query = query.ilike('name', `%${nameFilter}%`);
      }

      const { data: students, error: studentError } = await query;

      if (studentError) throw studentError;

      if (!students || students.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px;">ì¡°ê±´ì— ë§ëŠ” í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
        return;
      }

      // 2. í•´ë‹¹ ë‚ ì§œì˜ ìˆ™ì œ ê²°ê³¼ ì¡°íšŒ
      const loginIds = students.map(s => s.login_id);
      
      const start = dateVal + " 00:00:00";
      const end   = dateVal + " 23:59:59";

      const { data: results, error: resultError } = await supabaseClient
        .from('vocab_results')
        .select('*')
        .in('student_login_id', loginIds)
        .gte('submitted_at', start)
        .lte('submitted_at', end)
        .order('submitted_at', { ascending: false });

      if (resultError) throw resultError;

      // 3. í‘œ ë§Œë“¤ê¸°
      tbody.innerHTML = "";
      
      students.forEach(std => {
        const myResults = (results || []).filter(r => r.student_login_id === std.login_id);
        
        if (myResults.length > 0) {
          myResults.forEach(res => {
            const tr = document.createElement("tr");
            const timeStr = new Date(res.submitted_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            
            tr.innerHTML = `
              <td style="font-weight:700;">${std.name}</td>
              <td><span class="badge badge-done">ì œì¶œ ì™„ë£Œ</span></td>
              <td>${res.correct_count}ì  <span style="color:#888; font-size:12px;">(${res.mode})</span></td>
              <td style="font-weight:bold; color:var(--blue);">${res.unit || '-'}</td>
              <td>${timeStr}</td>
            `;
            tbody.appendChild(tr);
          });
        } else {
          const tr = document.createElement("tr");
          tr.style.backgroundColor = "#fff5f5";
          tr.innerHTML = `
            <td>${std.name}</td>
            <td><span class="badge badge-yet">ë¯¸ì œì¶œ</span></td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
          `;
          tbody.appendChild(tr);
        }
      });

    } catch (err) {
      console.error(err);
      tbody.innerHTML = `<tr><td colspan="5">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}</td></tr>`;
    }
  }
</script>
</body>
</html>
