<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>초바영 학습 게시판 - 블라썸잉글리쉬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Pretendard Variable", -apple-system, BlinkMacSystemFont,
        system-ui, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    body { background: #f4f6fb; padding: 30px 0 60px; }

    .page { max-width: 900px; margin: 0 auto; padding: 0 20px; position: relative; }

    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }

    .home-btn {
      background: #9AD7A0; color: white; padding: 6px 16px; border-radius: 999px;
      border: none; cursor: pointer; font-size: 13px; font-weight: 600;
    }
    .home-btn:hover { background: #7EC987; }

    #login-status { display: flex; gap: 10px; align-items: center; }
    #login-status span { font-size: 14px; color: #374151; font-weight: 600; }
    #login-status button {
      border: none; background: #FF6FB5; color: white; padding: 6px 14px;
      border-radius: 999px; cursor: pointer; font-size: 13px; font-weight: 600;
    }
    #login-status button:hover { background: #ff5aa8; }

    .title-big { font-size: 28px; font-weight: 900; margin-bottom: 6px; margin-top: 16px; }
    .subtitle { font-size: 15px; color: #6b7280; margin-bottom: 24px; }

    .write-box {
      background: #ffffff; border-radius: 20px; padding: 18px 20px 20px;
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08); margin-bottom: 24px;
    }
    .write-title { font-size: 16px; font-weight: 700; margin-bottom: 12px; }

    .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .form-row input {
      flex: 1; border-radius: 999px; border: 1px solid #e5e7eb;
      padding: 8px 14px; font-size: 14px;
    }
    .form-row input:focus {
      outline: none; border-color: #60a5fa;
      box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.3);
    }

    .write-box button {
      border: none; background: #6B7280; color: white; padding: 8px 18px;
      border-radius: 999px; cursor: pointer; font-size: 14px; font-weight: 600;
    }
    .write-box button:hover { background: #4B5563; }

    .post-list { display: flex; flex-direction: column; gap: 14px; }

    .post-card {
      background: #ffffff; border-radius: 18px; padding: 14px 16px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
      display: flex; justify-content: space-between; align-items: center; gap: 12px;
    }

    .post-main { flex: 1; }
    .post-title { font-size: 15px; font-weight: 700; margin-bottom: 4px; }
    .post-meta { font-size: 12px; color: #9ca3af; }

    .post-actions { display: flex; align-items: center; gap: 6px; }
    .post-actions a {
      border-radius: 999px; border: none; background: #00AEEF; color: white;
      padding: 7px 14px; font-size: 13px; font-weight: 600; text-decoration: none;
      cursor: pointer; display: inline-block;
    }
    .post-actions a:hover { background: #0099D4; }

    .post-actions button {
      border-radius: 999px; border: none; background: #e5e7eb; color: #374151;
      padding: 6px 10px; font-size: 12px; font-weight: 600; cursor: pointer;
    }
    .post-actions button:hover { background: #d1d5db; }

    .post-actions .danger { background: #ffe4e6; color: #9f1239; }
    .post-actions .danger:hover { background: #fecdd3; }

    .empty-text { font-size: 14px; color: #9ca3af; text-align: center; margin-top: 20px; }
    .loading-text { font-size: 14px; color: #6b7280; text-align: center; margin-top: 20px; }

    @media (max-width: 600px) {
      .top-bar { flex-direction: column; align-items: flex-start; gap: 10px; }
      .form-row { flex-direction: column; }
    }
  </style>
</head>

<body>
<div class="page">

  <div class="top-bar">
    <button class="home-btn" onclick="location.href='index.html'">Home</button>

    <div id="login-status">
      <span id="login-name"></span>
      <button id="login-btn" onclick="location.href='login.html'">로그인</button>
      <button id="logout-btn" style="display:none;" onclick="logoutUser()">로그아웃</button>
    </div>
  </div>

  <div id="chobaeng-title" class="title-big">초바영 학습 게시판</div>
  <div id="chobaeng-subtitle" class="subtitle">초바영 학습 영상을 모아서 한 번에 볼 수 있어요.</div>

  <!-- 글쓰기 (선생님 전용) -->
  <div class="write-box" id="write-box">
    <div class="write-title">새 초바영 영상 추가 (유튜브 링크)</div>
    <form id="post-form">
      <div class="form-row">
        <input type="text" id="title-input" placeholder="예) 초바영 1단계 Day 1" required />
      </div>
      <div class="form-row">
        <input type="url" id="url-input" placeholder="유튜브 링크를 붙여넣기 해주세요" required />
      </div>
      <button type="submit" id="submit-btn">추가하기</button>
    </form>
  </div>

  <div id="post-list" class="post-list"></div>
  <div id="loading-text" class="loading-text" style="display:none;">불러오는 중...</div>
  <div id="empty-text" class="empty-text" style="display:none;">등록된 초바영 영상이 아직 없어요.</div>

</div>

<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
<script>
  // ✅ 프로젝트/anon 키는 문법 게시판에서 쓰던 것과 동일하게 유지
  const supa = supabase.createClient(
    "https://bpdisxjhhibrgfpvtlmv.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZGlzeGpoaGlicmdmcHZ0bG12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTkxODQsImV4cCI6MjA3OTUzNTE4NH0.jDZ6BGirOPuWUnt4ykjhng4PLft2ZjBuYAFzApUnlYU"
  );

  // ✅ 이 페이지는 chobaeng_videos만 사용
  const TABLE_NAME = "chobaeng_videos";

  let currentRole = "guest";
  let editingPostId = null;

  // ---------- 레벨 ----------
  const LEVEL_LABELS = {
    "1": "1단계 파닉스",
    "2": "2단계 패턴편",
    "3": "3단계 실전편 1",
    "4": "4단계 실전편 1 · 600제",
    "5": "5단계 실전편 2 · 700제",
    "6": "6단계 실전편 2"
  };

  function getLevelFromUrl() {
    const params = new URLSearchParams(window.location.search);
    const lv = params.get("level") || "1";
    if (!LEVEL_LABELS[lv]) return "1";
    return lv;
  }

  const CURRENT_LEVEL = getLevelFromUrl();
  const CURRENT_LEVEL_LABEL = LEVEL_LABELS[CURRENT_LEVEL];

  document.getElementById("chobaeng-title").textContent = `초바영 ${CURRENT_LEVEL_LABEL} 게시판`;
  document.getElementById("chobaeng-subtitle").textContent =
    `${CURRENT_LEVEL_LABEL} 초바영 학습 영상을 모아서 한 번에 볼 수 있어요.`;

  // ---------- 로그인 ----------
  async function checkLogin() {
    const loginName = document.getElementById("login-name");
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");

    // 학생(localStorage)
    const student = localStorage.getItem("blossom_student");
    if (student) {
      try {
        const s = JSON.parse(student);
        currentRole = "student";
        loginName.textContent = `${s.name} 학생`;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        return;
      } catch {
        localStorage.removeItem("blossom_student");
      }
    }

    // 선생님(supabase auth)
    const { data, error } = await supa.auth.getUser();
    if (error) console.warn("getUser error:", error.message);

    if (data && data.user) {
      const name = data.user.user_metadata?.display_name || data.user.email;
      currentRole = "teacher";
      loginName.textContent = `${name} 선생님`;
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      return;
    }

    // 게스트
    currentRole = "guest";
    loginName.textContent = "";
    loginBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
  }

  async function logoutUser() {
    localStorage.removeItem("blossom_student");
    await supa.auth.signOut();
    location.reload();
  }

  // ---------- UI ----------
  const writeBoxEl = document.getElementById("write-box");
  const form = document.getElementById("post-form");
  const titleInput = document.getElementById("title-input");
  const urlInput = document.getElementById("url-input");
  const submitBtn = document.getElementById("submit-btn");

  function applyRoleUi() {
    writeBoxEl.style.display = (currentRole === "teacher") ? "block" : "none";
  }

  // ---------- DB ----------
  async function fetchPosts() {
    const loadingEl = document.getElementById("loading-text");
    const emptyEl = document.getElementById("empty-text");
    const listEl = document.getElementById("post-list");

    loadingEl.style.display = "block";
    emptyEl.style.display = "none";
    listEl.innerHTML = "";

    const { data, error } = await supa
      .from(TABLE_NAME)
      .select("id, level, title, url, created_at")
      .eq("level", CURRENT_LEVEL)
      .order("created_at", { ascending: false });

    loadingEl.style.display = "none";

    if (error) {
      console.error("fetch error:", error);
      emptyEl.style.display = "block";
      emptyEl.textContent = "불러오기 실패: " + error.message;
      return [];
    }

    if (!data || data.length === 0) {
      emptyEl.style.display = "block";
      emptyEl.textContent = "등록된 초바영 영상이 아직 없어요.";
      return [];
    }

    return data;
  }

  function renderPosts(posts) {
    const listEl = document.getElementById("post-list");
    const emptyEl = document.getElementById("empty-text");

    listEl.innerHTML = "";

    if (!posts || posts.length === 0) {
      emptyEl.style.display = "block";
      emptyEl.textContent = "등록된 초바영 영상이 아직 없어요.";
      return;
    } else {
      emptyEl.style.display = "none";
    }

    posts.forEach((post) => {
      const card = document.createElement("div");
      card.className = "post-card";

      const main = document.createElement("div");
      main.className = "post-main";

      const title = document.createElement("div");
      title.className = "post-title";
      title.textContent = post.title;

      const meta = document.createElement("div");
      meta.className = "post-meta";
      const date = post.created_at ? new Date(post.created_at) : null;
      meta.textContent = date
        ? `등록: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`
        : "등록: -";

      main.appendChild(title);
      main.appendChild(meta);

      const actions = document.createElement("div");
      actions.className = "post-actions";

      const link = document.createElement("a");
      link.href = post.url;
      link.target = "_blank";
      link.rel = "noopener noreferrer";
      link.textContent = "영상 보기";
      actions.appendChild(link);

      if (currentRole === "teacher") {
        const editBtn = document.createElement("button");
        editBtn.type = "button";
        editBtn.textContent = "수정";
        editBtn.onclick = () => {
          editingPostId = post.id;
          titleInput.value = post.title;
          urlInput.value = post.url;
          submitBtn.textContent = "수정 완료";
          window.scrollTo({ top: 0, behavior: "smooth" });
        };
        actions.appendChild(editBtn);

        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.className = "danger";
        delBtn.textContent = "삭제";
        delBtn.onclick = async () => {
          const ok = confirm("정말 삭제할까요?");
          if (!ok) return;
          await deletePost(post.id);
        };
        actions.appendChild(delBtn);
      }

      card.appendChild(main);
      card.appendChild(actions);
      listEl.appendChild(card);
    });
  }

  async function refresh() {
    const posts = await fetchPosts();
    renderPosts(posts);
  }

  async function insertPost({ title, url }) {
    const { error } = await supa
      .from(TABLE_NAME)
      .insert([{ level: CURRENT_LEVEL, title, url }]);

    if (error) {
      console.error("insert error:", error);
      alert("저장 실패: " + error.message);
      return false;
    }
    return true;
  }

  async function updatePost(id, { title, url }) {
    const { error } = await supa
      .from(TABLE_NAME)
      .update({ title, url })
      .eq("id", id);

    if (error) {
      console.error("update error:", error);
      alert("수정 실패: " + error.message);
      return false;
    }
    return true;
  }

  async function deletePost(id) {
    const { error } = await supa
      .from(TABLE_NAME)
      .delete()
      .eq("id", id);

    if (error) {
      console.error("delete error:", error);
      alert("삭제 실패: " + error.message);
      return;
    }

    if (editingPostId === id) {
      editingPostId = null;
      submitBtn.textContent = "추가하기";
      titleInput.value = "";
      urlInput.value = "";
    }

    await refresh();
  }

  // ---------- submit ----------
  form.addEventListener("submit", async function (e) {
    e.preventDefault();

    if (currentRole !== "teacher") {
      alert("선생님만 등록/수정할 수 있어요.");
      return;
    }

    const title = titleInput.value.trim();
    const url = urlInput.value.trim();
    if (!title || !url) return;

    try { new URL(url); } catch {
      alert("올바른 링크(URL)를 입력해 주세요.");
      return;
    }

    submitBtn.disabled = true;

    if (editingPostId) {
      const ok = await updatePost(editingPostId, { title, url });
      if (ok) {
        editingPostId = null;
        submitBtn.textContent = "추가하기";
        titleInput.value = "";
        urlInput.value = "";
        await refresh();
      }
    } else {
      const ok = await insertPost({ title, url });
      if (ok) {
        titleInput.value = "";
        urlInput.value = "";
        await refresh();
      }
    }

    submitBtn.disabled = false;
  });

  // ---------- init ----------
  (async function init() {
    await checkLogin();
    applyRoleUi();
    await refresh();
  })();
</script>
</body>
</html>
